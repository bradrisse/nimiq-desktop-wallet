require=function e(t,r,n){function s(i,o){if(!r[i]){if(!t[i]){var u="function"==typeof require&&require;if(!o&&u)return u(i,!0);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[i]={exports:{}};t[i][0].call(l.exports,function(e){var r=t[i][1][e];return s(r||e)},l,l.exports,e,t,r,n)}return r[i].exports}for(var a="function"==typeof require&&require,i=0;i<n.length;i++)s(n[i]);return s}({1:[function(e,t,r){e("../../modules/es6.string.iterator");e("../../modules/es6.array.from");t.exports=e("../../modules/_core").Array.from},{"../../modules/_core":21,"../../modules/es6.array.from":84,"../../modules/es6.string.iterator":96}],2:[function(e,t,r){e("../modules/web.dom.iterable");e("../modules/es6.string.iterator");t.exports=e("../modules/core.get-iterator")},{"../modules/core.get-iterator":83,"../modules/es6.string.iterator":96,"../modules/web.dom.iterable":100}],3:[function(e,t,r){var n=e("../../modules/_core"),a=n.JSON||(n.JSON={stringify:JSON.stringify});t.exports=function stringify(e){return a.stringify.apply(a,arguments)}},{"../../modules/_core":21}],4:[function(e,t,r){e("../../modules/es6.math.clz32");t.exports=e("../../modules/_core").Math.clz32},{"../../modules/_core":21,"../../modules/es6.math.clz32":86}],5:[function(e,t,r){e("../../modules/es6.math.fround");t.exports=e("../../modules/_core").Math.fround},{"../../modules/_core":21,"../../modules/es6.math.fround":87}],6:[function(e,t,r){e("../../modules/es6.math.imul");t.exports=e("../../modules/_core").Math.imul},{"../../modules/_core":21,"../../modules/es6.math.imul":88}],7:[function(e,t,r){e("../../modules/es6.math.trunc");t.exports=e("../../modules/_core").Math.trunc},{"../../modules/_core":21,"../../modules/es6.math.trunc":89}],8:[function(e,t,r){e("../../modules/es6.number.is-integer");t.exports=e("../../modules/_core").Number.isInteger},{"../../modules/_core":21,"../../modules/es6.number.is-integer":90}],9:[function(e,t,r){e("../../modules/es6.number.max-safe-integer");t.exports=9007199254740991},{"../../modules/es6.number.max-safe-integer":91}],10:[function(e,t,r){e("../../modules/es6.object.freeze");t.exports=e("../../modules/_core").Object.freeze},{"../../modules/_core":21,"../../modules/es6.object.freeze":92}],11:[function(e,t,r){e("../../modules/es6.object.keys");t.exports=e("../../modules/_core").Object.keys},{"../../modules/_core":21,"../../modules/es6.object.keys":93}],12:[function(e,t,r){e("../../modules/es7.object.values");t.exports=e("../../modules/_core").Object.values},{"../../modules/_core":21,"../../modules/es7.object.values":97}],13:[function(e,t,r){e("../modules/es6.object.to-string");e("../modules/es6.string.iterator");e("../modules/web.dom.iterable");e("../modules/es6.promise");e("../modules/es7.promise.finally");e("../modules/es7.promise.try");t.exports=e("../modules/_core").Promise},{"../modules/_core":21,"../modules/es6.object.to-string":94,"../modules/es6.promise":95,"../modules/es6.string.iterator":96,"../modules/es7.promise.finally":98,"../modules/es7.promise.try":99,"../modules/web.dom.iterable":100}],14:[function(e,t,r){t.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},{}],15:[function(e,t,r){t.exports=function(){}},{}],16:[function(e,t,r){t.exports=function(e,t,r,n){if(!(e instanceof t)||n!==undefined&&n in e)throw TypeError(r+": incorrect invocation!");return e}},{}],17:[function(e,t,r){var n=e("./_is-object");t.exports=function(e){if(!n(e))throw TypeError(e+" is not an object!");return e}},{"./_is-object":40}],18:[function(e,t,r){var n=e("./_to-iobject"),a=e("./_to-length"),i=e("./_to-absolute-index");t.exports=function(e){return function(t,r,s){var o,u=n(t),c=a(u.length),l=i(s,c);if(e&&r!=r){for(;c>l;)if((o=u[l++])!=o)return!0}else for(;c>l;l++)if((e||l in u)&&u[l]===r)return e||l||0;return!e&&-1}}},{"./_to-absolute-index":74,"./_to-iobject":76,"./_to-length":77}],19:[function(e,t,r){var n=e("./_cof"),a=e("./_wks")("toStringTag"),i="Arguments"==n(function(){return arguments}());t.exports=function(e){var t,r,s;return e===undefined?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(r){}}(t=Object(e),a))?r:i?n(t):"Object"==(s=n(t))&&"function"==typeof t.callee?"Arguments":s}},{"./_cof":20,"./_wks":81}],20:[function(e,t,r){var n={}.toString;t.exports=function(e){return n.call(e).slice(8,-1)}},{}],21:[function(e,t,r){var n=t.exports={version:"2.5.3"};"number"==typeof __e&&(__e=n)},{}],22:[function(e,t,r){"use strict";var n=e("./_object-dp"),a=e("./_property-desc");t.exports=function(e,t,r){t in e?n.f(e,t,a(0,r)):e[t]=r}},{"./_object-dp":54,"./_property-desc":64}],23:[function(e,t,r){var n=e("./_a-function");t.exports=function(e,t,r){n(e);if(t===undefined)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,a){return e.call(t,r,n,a)}}return function(){return e.apply(t,arguments)}}},{"./_a-function":14}],24:[function(e,t,r){t.exports=function(e){if(e==undefined)throw TypeError("Can't call method on  "+e);return e}},{}],25:[function(e,t,r){t.exports=!e("./_fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},{"./_fails":29}],26:[function(e,t,r){var n=e("./_is-object"),a=e("./_global").document,i=n(a)&&n(a.createElement);t.exports=function(e){return i?a.createElement(e):{}}},{"./_global":31,"./_is-object":40}],27:[function(e,t,r){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},{}],28:[function(e,t,r){var n=e("./_global"),a=e("./_core"),i=e("./_ctx"),s=e("./_hide"),o=function(e,t,r){var u,c,l,h=e&o.F,f=e&o.G,_=e&o.S,d=e&o.P,p=e&o.B,g=e&o.W,y=f?a:a[t]||(a[t]={}),v=y.prototype,k=f?n:_?n[t]:(n[t]||{}).prototype;f&&(r=t);for(u in r)if(!((c=!h&&k&&k[u]!==undefined)&&u in y)){l=c?k[u]:r[u];y[u]=f&&"function"!=typeof k[u]?r[u]:p&&c?i(l,n):g&&k[u]==l?function(e){var t=function(t,r,n){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,r)}return new e(t,r,n)}return e.apply(this,arguments)};t.prototype=e.prototype;return t}(l):d&&"function"==typeof l?i(Function.call,l):l;if(d){(y.virtual||(y.virtual={}))[u]=l;e&o.R&&v&&!v[u]&&s(v,u,l)}}};o.F=1;o.G=2;o.S=4;o.P=8;o.B=16;o.W=32;o.U=64;o.R=128;t.exports=o},{"./_core":21,"./_ctx":23,"./_global":31,"./_hide":33}],29:[function(e,t,r){t.exports=function(e){try{return!!e()}catch(t){return!0}}},{}],30:[function(e,t,r){var n=e("./_ctx"),a=e("./_iter-call"),i=e("./_is-array-iter"),s=e("./_an-object"),o=e("./_to-length"),u=e("./core.get-iterator-method"),c={},l={};(r=t.exports=function(e,t,r,h,f){var _,d,p,g,y=f?function(){return e}:u(e),v=n(r,h,t?2:1),k=0;if("function"!=typeof y)throw TypeError(e+" is not iterable!");if(i(y)){for(_=o(e.length);_>k;k++)if((g=t?v(s(d=e[k])[0],d[1]):v(e[k]))===c||g===l)return g}else for(p=y.call(e);!(d=p.next()).done;)if((g=a(p,v,d.value,t))===c||g===l)return g}).BREAK=c;r.RETURN=l},{"./_an-object":17,"./_ctx":23,"./_is-array-iter":38,"./_iter-call":41,"./_to-length":77,"./core.get-iterator-method":82}],31:[function(e,t,r){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},{}],32:[function(e,t,r){var n={}.hasOwnProperty;t.exports=function(e,t){return n.call(e,t)}},{}],33:[function(e,t,r){var n=e("./_object-dp"),a=e("./_property-desc");t.exports=e("./_descriptors")?function(e,t,r){return n.f(e,t,a(1,r))}:function(e,t,r){e[t]=r;return e}},{"./_descriptors":25,"./_object-dp":54,"./_property-desc":64}],34:[function(e,t,r){var n=e("./_global").document;t.exports=n&&n.documentElement},{"./_global":31}],35:[function(e,t,r){t.exports=!e("./_descriptors")&&!e("./_fails")(function(){return 7!=Object.defineProperty(e("./_dom-create")("div"),"a",{get:function(){return 7}}).a})},{"./_descriptors":25,"./_dom-create":26,"./_fails":29}],36:[function(e,t,r){t.exports=function(e,t,r){var n=r===undefined;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},{}],37:[function(e,t,r){var n=e("./_cof");t.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==n(e)?e.split(""):Object(e)}},{"./_cof":20}],38:[function(e,t,r){var n=e("./_iterators"),a=e("./_wks")("iterator"),i=Array.prototype;t.exports=function(e){return e!==undefined&&(n.Array===e||i[a]===e)}},{"./_iterators":46,"./_wks":81}],39:[function(e,t,r){var n=e("./_is-object"),a=Math.floor;t.exports=function isInteger(e){return!n(e)&&isFinite(e)&&a(e)===e}},{"./_is-object":40}],40:[function(e,t,r){t.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},{}],41:[function(e,t,r){var n=e("./_an-object");t.exports=function(e,t,r,a){try{return a?t(n(r)[0],r[1]):t(r)}catch(s){var i=e["return"];i!==undefined&&n(i.call(e));throw s}}},{"./_an-object":17}],42:[function(e,t,r){"use strict";var n=e("./_object-create"),a=e("./_property-desc"),i=e("./_set-to-string-tag"),s={};e("./_hide")(s,e("./_wks")("iterator"),function(){return this});t.exports=function(e,t,r){e.prototype=n(s,{next:a(1,r)});i(e,t+" Iterator")}},{"./_hide":33,"./_object-create":53,"./_property-desc":64,"./_set-to-string-tag":68,"./_wks":81}],43:[function(e,t,r){"use strict";var n=e("./_library"),a=e("./_export"),i=e("./_redefine"),s=e("./_hide"),o=e("./_has"),u=e("./_iterators"),c=e("./_iter-create"),l=e("./_set-to-string-tag"),h=e("./_object-gpo"),f=e("./_wks")("iterator"),_=!([].keys&&"next"in[].keys()),d=function(){return this};t.exports=function(e,t,r,p,g,y,v){c(r,t,p);var k,m,b,C=function(e){if(!_&&e in T)return T[e];switch(e){case"keys":return function keys(){return new r(this,e)};case"values":return function values(){return new r(this,e)}}return function entries(){return new r(this,e)}},w=t+" Iterator",A="values"==g,S=!1,T=e.prototype,x=T[f]||T["@@iterator"]||g&&T[g],E=!_&&x||C(g),I=g?A?C("entries"):E:undefined,P="Array"==t&&T.entries||x;if(P&&(b=h(P.call(new e)))!==Object.prototype&&b.next){l(b,w,!0);n||o(b,f)||s(b,f,d)}if(A&&x&&"values"!==x.name){S=!0;E=function values(){return x.call(this)}}n&&!v||!_&&!S&&T[f]||s(T,f,E);u[t]=E;u[w]=d;if(g){k={values:A?E:C("values"),keys:y?E:C("keys"),entries:I};if(v)for(m in k)m in T||i(T,m,k[m]);else a(a.P+a.F*(_||S),t,k)}return k}},{"./_export":28,"./_has":32,"./_hide":33,"./_iter-create":42,"./_iterators":46,"./_library":47,"./_object-gpo":56,"./_redefine":66,"./_set-to-string-tag":68,"./_wks":81}],44:[function(e,t,r){var n=e("./_wks")("iterator"),a=!1;try{var i=[7][n]();i["return"]=function(){a=!0};Array.from(i,function(){throw 2})}catch(s){}t.exports=function(e,t){if(!t&&!a)return!1;var r=!1;try{var i=[7],o=i[n]();o.next=function(){return{done:r=!0}};i[n]=function(){return o};e(i)}catch(s){}return r}},{"./_wks":81}],45:[function(e,t,r){t.exports=function(e,t){return{value:t,done:!!e}}},{}],46:[function(e,t,r){t.exports={}},{}],47:[function(e,t,r){t.exports=!0},{}],48:[function(e,t,r){var n=e("./_math-sign"),a=Math.pow,i=a(2,-52),s=a(2,-23),o=a(2,127)*(2-s),u=a(2,-126);t.exports=Math.fround||function fround(e){var t,r,a=Math.abs(e),c=n(e);return a<u?c*(a/u/s+1/i-1/i)*u*s:(r=(t=(1+s/i)*a)-(t-a))>o||r!=r?c*Infinity:c*r}},{"./_math-sign":49}],49:[function(e,t,r){t.exports=Math.sign||function sign(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},{}],50:[function(e,t,r){var n=e("./_uid")("meta"),a=e("./_is-object"),i=e("./_has"),s=e("./_object-dp").f,o=0,u=Object.isExtensible||function(){return!0},c=!e("./_fails")(function(){return u(Object.preventExtensions({}))}),l=function(e){s(e,n,{value:{i:"O"+ ++o,w:{}}})},h=t.exports={KEY:n,NEED:!1,fastKey:function(e,t){if(!a(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!i(e,n)){if(!u(e))return"F";if(!t)return"E";l(e)}return e[n].i},getWeak:function(e,t){if(!i(e,n)){if(!u(e))return!0;if(!t)return!1;l(e)}return e[n].w},onFreeze:function(e){c&&h.NEED&&u(e)&&!i(e,n)&&l(e);return e}}},{"./_fails":29,"./_has":32,"./_is-object":40,"./_object-dp":54,"./_uid":80}],51:[function(e,t,r){var n=e("./_global"),a=e("./_task").set,i=n.MutationObserver||n.WebKitMutationObserver,s=n.process,o=n.Promise,u="process"==e("./_cof")(s);t.exports=function(){var e,t,r,c=function(){var n,a;u&&(n=s.domain)&&n.exit();for(;e;){a=e.fn;e=e.next;try{a()}catch(i){e?r():t=undefined;throw i}}t=undefined;n&&n.enter()};if(u)r=function(){s.nextTick(c)};else if(!i||n.navigator&&n.navigator.standalone)if(o&&o.resolve){var l=o.resolve();r=function(){l.then(c)}}else r=function(){a.call(n,c)};else{var h=!0,f=document.createTextNode("");new i(c).observe(f,{characterData:!0});r=function(){f.data=h=!h}}return function(n){var a={fn:n,next:undefined};t&&(t.next=a);if(!e){e=a;r()}t=a}}},{"./_cof":20,"./_global":31,"./_task":73}],52:[function(e,t,r){"use strict";var n=e("./_a-function");t.exports.f=function(e){return new function PromiseCapability(e){var t,r;this.promise=new e(function(e,n){if(t!==undefined||r!==undefined)throw TypeError("Bad Promise constructor");t=e;r=n});this.resolve=n(t);this.reject=n(r)}(e)}},{"./_a-function":14}],53:[function(e,t,r){var n=e("./_an-object"),a=e("./_object-dps"),i=e("./_enum-bug-keys"),s=e("./_shared-key")("IE_PROTO"),o=function(){},u=function(){var t,r=e("./_dom-create")("iframe"),n=i.length;r.style.display="none";e("./_html").appendChild(r);r.src="javascript:";(t=r.contentWindow.document).open();t.write("<script>document.F=Object<\/script>");t.close();u=t.F;for(;n--;)delete u.prototype[i[n]];return u()};t.exports=Object.create||function create(e,t){var r;if(null!==e){o.prototype=n(e);r=new o;o.prototype=null;r[s]=e}else r=u();return t===undefined?r:a(r,t)}},{"./_an-object":17,"./_dom-create":26,"./_enum-bug-keys":27,"./_html":34,"./_object-dps":55,"./_shared-key":69}],54:[function(e,t,r){var n=e("./_an-object"),a=e("./_ie8-dom-define"),i=e("./_to-primitive"),s=Object.defineProperty;r.f=e("./_descriptors")?Object.defineProperty:function defineProperty(e,t,r){n(e);t=i(t,!0);n(r);if(a)try{return s(e,t,r)}catch(o){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");"value"in r&&(e[t]=r.value);return e}},{"./_an-object":17,"./_descriptors":25,"./_ie8-dom-define":35,"./_to-primitive":79}],55:[function(e,t,r){var n=e("./_object-dp"),a=e("./_an-object"),i=e("./_object-keys");t.exports=e("./_descriptors")?Object.defineProperties:function defineProperties(e,t){a(e);for(var r,s=i(t),o=s.length,u=0;o>u;)n.f(e,r=s[u++],t[r]);return e}},{"./_an-object":17,"./_descriptors":25,"./_object-dp":54,"./_object-keys":58}],56:[function(e,t,r){var n=e("./_has"),a=e("./_to-object"),i=e("./_shared-key")("IE_PROTO"),s=Object.prototype;t.exports=Object.getPrototypeOf||function(e){e=a(e);return n(e,i)?e[i]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},{"./_has":32,"./_shared-key":69,"./_to-object":78}],57:[function(e,t,r){var n=e("./_has"),a=e("./_to-iobject"),i=e("./_array-includes")(!1),s=e("./_shared-key")("IE_PROTO");t.exports=function(e,t){var r,o=a(e),u=0,c=[];for(r in o)r!=s&&n(o,r)&&c.push(r);for(;t.length>u;)n(o,r=t[u++])&&(~i(c,r)||c.push(r));return c}},{"./_array-includes":18,"./_has":32,"./_shared-key":69,"./_to-iobject":76}],58:[function(e,t,r){var n=e("./_object-keys-internal"),a=e("./_enum-bug-keys");t.exports=Object.keys||function keys(e){return n(e,a)}},{"./_enum-bug-keys":27,"./_object-keys-internal":57}],59:[function(e,t,r){r.f={}.propertyIsEnumerable},{}],60:[function(e,t,r){var n=e("./_export"),a=e("./_core"),i=e("./_fails");t.exports=function(e,t){var r=(a.Object||{})[e]||Object[e],s={};s[e]=t(r);n(n.S+n.F*i(function(){r(1)}),"Object",s)}},{"./_core":21,"./_export":28,"./_fails":29}],61:[function(e,t,r){var n=e("./_object-keys"),a=e("./_to-iobject"),i=e("./_object-pie").f;t.exports=function(e){return function(t){for(var r,s=a(t),o=n(s),u=o.length,c=0,l=[];u>c;)i.call(s,r=o[c++])&&l.push(e?[r,s[r]]:s[r]);return l}}},{"./_object-keys":58,"./_object-pie":59,"./_to-iobject":76}],62:[function(e,t,r){t.exports=function(e){try{return{e:!1,v:e()}}catch(t){return{e:!0,v:t}}}},{}],63:[function(e,t,r){var n=e("./_an-object"),a=e("./_is-object"),i=e("./_new-promise-capability");t.exports=function(e,t){n(e);if(a(t)&&t.constructor===e)return t;var r=i.f(e);(0,r.resolve)(t);return r.promise}},{"./_an-object":17,"./_is-object":40,"./_new-promise-capability":52}],64:[function(e,t,r){t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},{}],65:[function(e,t,r){var n=e("./_hide");t.exports=function(e,t,r){for(var a in t)r&&e[a]?e[a]=t[a]:n(e,a,t[a]);return e}},{"./_hide":33}],66:[function(e,t,r){t.exports=e("./_hide")},{"./_hide":33}],67:[function(e,t,r){"use strict";var n=e("./_global"),a=e("./_core"),i=e("./_object-dp"),s=e("./_descriptors"),o=e("./_wks")("species");t.exports=function(e){var t="function"==typeof a[e]?a[e]:n[e];s&&t&&!t[o]&&i.f(t,o,{configurable:!0,get:function(){return this}})}},{"./_core":21,"./_descriptors":25,"./_global":31,"./_object-dp":54,"./_wks":81}],68:[function(e,t,r){var n=e("./_object-dp").f,a=e("./_has"),i=e("./_wks")("toStringTag");t.exports=function(e,t,r){e&&!a(e=r?e:e.prototype,i)&&n(e,i,{configurable:!0,value:t})}},{"./_has":32,"./_object-dp":54,"./_wks":81}],69:[function(e,t,r){var n=e("./_shared")("keys"),a=e("./_uid");t.exports=function(e){return n[e]||(n[e]=a(e))}},{"./_shared":70,"./_uid":80}],70:[function(e,t,r){var n=e("./_global"),a=n["__core-js_shared__"]||(n["__core-js_shared__"]={});t.exports=function(e){return a[e]||(a[e]={})}},{"./_global":31}],71:[function(e,t,r){var n=e("./_an-object"),a=e("./_a-function"),i=e("./_wks")("species");t.exports=function(e,t){var r,s=n(e).constructor;return s===undefined||(r=n(s)[i])==undefined?t:a(r)}},{"./_a-function":14,"./_an-object":17,"./_wks":81}],72:[function(e,t,r){var n=e("./_to-integer"),a=e("./_defined");t.exports=function(e){return function(t,r){var i,s,o=String(a(t)),u=n(r),c=o.length;return u<0||u>=c?e?"":undefined:(i=o.charCodeAt(u))<55296||i>56319||u+1===c||(s=o.charCodeAt(u+1))<56320||s>57343?e?o.charAt(u):i:e?o.slice(u,u+2):s-56320+(i-55296<<10)+65536}}},{"./_defined":24,"./_to-integer":75}],73:[function(e,t,r){var n,a,i,s=e("./_ctx"),o=e("./_invoke"),u=e("./_html"),c=e("./_dom-create"),l=e("./_global"),h=l.process,f=l.setImmediate,_=l.clearImmediate,d=l.MessageChannel,p=l.Dispatch,g=0,y={},v=function(){var e=+this;if(y.hasOwnProperty(e)){var t=y[e];delete y[e];t()}},k=function(e){v.call(e.data)};if(!f||!_){f=function setImmediate(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);y[++g]=function(){o("function"==typeof e?e:Function(e),t)};n(g);return g};_=function clearImmediate(e){delete y[e]};if("process"==e("./_cof")(h))n=function(e){h.nextTick(s(v,e,1))};else if(p&&p.now)n=function(e){p.now(s(v,e,1))};else if(d){i=(a=new d).port2;a.port1.onmessage=k;n=s(i.postMessage,i,1)}else if(l.addEventListener&&"function"==typeof postMessage&&!l.importScripts){n=function(e){l.postMessage(e+"","*")};l.addEventListener("message",k,!1)}else n="onreadystatechange"in c("script")?function(e){u.appendChild(c("script")).onreadystatechange=function(){u.removeChild(this);v.call(e)}}:function(e){setTimeout(s(v,e,1),0)}}t.exports={set:f,clear:_}},{"./_cof":20,"./_ctx":23,"./_dom-create":26,"./_global":31,"./_html":34,"./_invoke":36}],74:[function(e,t,r){var n=e("./_to-integer"),a=Math.max,i=Math.min;t.exports=function(e,t){return(e=n(e))<0?a(e+t,0):i(e,t)}},{"./_to-integer":75}],75:[function(e,t,r){var n=Math.ceil,a=Math.floor;t.exports=function(e){return isNaN(e=+e)?0:(e>0?a:n)(e)}},{}],76:[function(e,t,r){var n=e("./_iobject"),a=e("./_defined");t.exports=function(e){return n(a(e))}},{"./_defined":24,"./_iobject":37}],77:[function(e,t,r){var n=e("./_to-integer"),a=Math.min;t.exports=function(e){return e>0?a(n(e),9007199254740991):0}},{"./_to-integer":75}],78:[function(e,t,r){var n=e("./_defined");t.exports=function(e){return Object(n(e))}},{"./_defined":24}],79:[function(e,t,r){var n=e("./_is-object");t.exports=function(e,t){if(!n(e))return e;var r,a;if(t&&"function"==typeof(r=e.toString)&&!n(a=r.call(e)))return a;if("function"==typeof(r=e.valueOf)&&!n(a=r.call(e)))return a;if(!t&&"function"==typeof(r=e.toString)&&!n(a=r.call(e)))return a;throw TypeError("Can't convert object to primitive value")}},{"./_is-object":40}],80:[function(e,t,r){var n=0,a=Math.random();t.exports=function(e){return"Symbol(".concat(e===undefined?"":e,")_",(++n+a).toString(36))}},{}],81:[function(e,t,r){var n=e("./_shared")("wks"),a=e("./_uid"),i=e("./_global").Symbol,s="function"==typeof i;(t.exports=function(e){return n[e]||(n[e]=s&&i[e]||(s?i:a)("Symbol."+e))}).store=n},{"./_global":31,"./_shared":70,"./_uid":80}],82:[function(e,t,r){var n=e("./_classof"),a=e("./_wks")("iterator"),i=e("./_iterators");t.exports=e("./_core").getIteratorMethod=function(e){if(e!=undefined)return e[a]||e["@@iterator"]||i[n(e)]}},{"./_classof":19,"./_core":21,"./_iterators":46,"./_wks":81}],83:[function(e,t,r){var n=e("./_an-object"),a=e("./core.get-iterator-method");t.exports=e("./_core").getIterator=function(e){var t=a(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return n(t.call(e))}},{"./_an-object":17,"./_core":21,"./core.get-iterator-method":82}],84:[function(e,t,r){"use strict";var n=e("./_ctx"),a=e("./_export"),i=e("./_to-object"),s=e("./_iter-call"),o=e("./_is-array-iter"),u=e("./_to-length"),c=e("./_create-property"),l=e("./core.get-iterator-method");a(a.S+a.F*!e("./_iter-detect")(function(e){Array.from(e)}),"Array",{from:function from(e){var t,r,a,h,f=i(e),_="function"==typeof this?this:Array,d=arguments.length,p=d>1?arguments[1]:undefined,g=p!==undefined,y=0,v=l(f);g&&(p=n(p,d>2?arguments[2]:undefined,2));if(v==undefined||_==Array&&o(v))for(r=new _(t=u(f.length));t>y;y++)c(r,y,g?p(f[y],y):f[y]);else for(h=v.call(f),r=new _;!(a=h.next()).done;y++)c(r,y,g?s(h,p,[a.value,y],!0):a.value);r.length=y;return r}})},{"./_create-property":22,"./_ctx":23,"./_export":28,"./_is-array-iter":38,"./_iter-call":41,"./_iter-detect":44,"./_to-length":77,"./_to-object":78,"./core.get-iterator-method":82}],85:[function(e,t,r){"use strict";var n=e("./_add-to-unscopables"),a=e("./_iter-step"),i=e("./_iterators"),s=e("./_to-iobject");t.exports=e("./_iter-define")(Array,"Array",function(e,t){this._t=s(e);this._i=0;this._k=t},function(){var e=this._t,t=this._k,r=this._i++;if(!e||r>=e.length){this._t=undefined;return a(1)}return a(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])},"values");i.Arguments=i.Array;n("keys");n("values");n("entries")},{"./_add-to-unscopables":15,"./_iter-define":43,"./_iter-step":45,"./_iterators":46,"./_to-iobject":76}],86:[function(e,t,r){var n=e("./_export");n(n.S,"Math",{clz32:function clz32(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}})},{"./_export":28}],87:[function(e,t,r){var n=e("./_export");n(n.S,"Math",{fround:e("./_math-fround")})},{"./_export":28,"./_math-fround":48}],88:[function(e,t,r){var n=e("./_export"),a=Math.imul;n(n.S+n.F*e("./_fails")(function(){return-5!=a(4294967295,5)||2!=a.length}),"Math",{imul:function imul(e,t){var r=+e,n=+t,a=65535&r,i=65535&n;return 0|a*i+((65535&r>>>16)*i+a*(65535&n>>>16)<<16>>>0)}})},{"./_export":28,"./_fails":29}],89:[function(e,t,r){var n=e("./_export");n(n.S,"Math",{trunc:function trunc(e){return(e>0?Math.floor:Math.ceil)(e)}})},{"./_export":28}],90:[function(e,t,r){var n=e("./_export");n(n.S,"Number",{isInteger:e("./_is-integer")})},{"./_export":28,"./_is-integer":39}],91:[function(e,t,r){var n=e("./_export");n(n.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},{"./_export":28}],92:[function(e,t,r){var n=e("./_is-object"),a=e("./_meta").onFreeze;e("./_object-sap")("freeze",function(e){return function freeze(t){return e&&n(t)?e(a(t)):t}})},{"./_is-object":40,"./_meta":50,"./_object-sap":60}],93:[function(e,t,r){var n=e("./_to-object"),a=e("./_object-keys");e("./_object-sap")("keys",function(){return function keys(e){return a(n(e))}})},{"./_object-keys":58,"./_object-sap":60,"./_to-object":78}],94:[function(e,t,r){},{}],95:[function(e,t,r){"use strict";var n,a,i,s,o=e("./_library"),u=e("./_global"),c=e("./_ctx"),l=e("./_classof"),h=e("./_export"),f=e("./_is-object"),_=e("./_a-function"),d=e("./_an-instance"),p=e("./_for-of"),g=e("./_species-constructor"),y=e("./_task").set,v=e("./_microtask")(),k=e("./_new-promise-capability"),m=e("./_perform"),b=e("./_promise-resolve"),C=u.TypeError,w=u.process,A=u.Promise,S="process"==l(w),T=function(){},x=a=k.f,E=!!function(){try{var t=A.resolve(1),r=(t.constructor={})[e("./_wks")("species")]=function(e){e(T,T)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(T)instanceof r}catch(n){}}(),I=function(e){var t;return!(!f(e)||"function"!=typeof(t=e.then))&&t},P=function(e,t){if(!e._n){e._n=!0;var r=e._c;v(function(){for(var n=e._v,a=1==e._s,i=0,s=function(t){var r,i,s=a?t.ok:t.fail,o=t.resolve,u=t.reject,c=t.domain;try{if(s){if(!a){2==e._h&&R(e);e._h=1}if(!0===s)r=n;else{c&&c.enter();r=s(n);c&&c.exit()}r===t.promise?u(C("Promise-chain cycle")):(i=I(r))?i.call(r,o,u):o(r)}else u(n)}catch(l){u(l)}};r.length>i;)s(r[i++]);e._c=[];e._n=!1;t&&!e._h&&N(e)})}},N=function(e){y.call(u,function(){var t,r,n,a=e._v,i=O(e);if(i){t=m(function(){S?w.emit("unhandledRejection",a,e):(r=u.onunhandledrejection)?r({promise:e,reason:a}):(n=u.console)&&n.error&&n.error("Unhandled promise rejection",a)});e._h=S||O(e)?2:1}e._a=undefined;if(i&&t.e)throw t.v})},O=function(e){return 1!==e._h&&0===(e._a||e._c).length},R=function(e){y.call(u,function(){var t;S?w.emit("rejectionHandled",e):(t=u.onrejectionhandled)&&t({promise:e,reason:e._v})})},M=function(e){var t=this;if(!t._d){t._d=!0;(t=t._w||t)._v=e;t._s=2;t._a||(t._a=t._c.slice());P(t,!0)}},B=function(e){var t,r=this;if(!r._d){r._d=!0;r=r._w||r;try{if(r===e)throw C("Promise can't be resolved itself");if(t=I(e))v(function(){var n={_w:r,_d:!1};try{t.call(e,c(B,n,1),c(M,n,1))}catch(a){M.call(n,a)}});else{r._v=e;r._s=1;P(r,!1)}}catch(n){M.call({_w:r,_d:!1},n)}}};if(!E){A=function Promise(e){d(this,A,"Promise","_h");_(e);n.call(this);try{e(c(B,this,1),c(M,this,1))}catch(t){M.call(this,t)}};(n=function Promise(e){this._c=[];this._a=undefined;this._s=0;this._d=!1;this._v=undefined;this._h=0;this._n=!1}).prototype=e("./_redefine-all")(A.prototype,{then:function then(e,t){var r=x(g(this,A));r.ok="function"!=typeof e||e;r.fail="function"==typeof t&&t;r.domain=S?w.domain:undefined;this._c.push(r);this._a&&this._a.push(r);this._s&&P(this,!1);return r.promise},"catch":function(e){return this.then(undefined,e)}});i=function(){var e=new n;this.promise=e;this.resolve=c(B,e,1);this.reject=c(M,e,1)};k.f=x=function(e){return e===A||e===s?new i(e):a(e)}}h(h.G+h.W+h.F*!E,{Promise:A});e("./_set-to-string-tag")(A,"Promise");e("./_set-species")("Promise");s=e("./_core").Promise;h(h.S+h.F*!E,"Promise",{reject:function reject(e){var t=x(this);(0,t.reject)(e);return t.promise}});h(h.S+h.F*(o||!E),"Promise",{resolve:function resolve(e){return b(o&&this===s?A:this,e)}});h(h.S+h.F*!(E&&e("./_iter-detect")(function(e){A.all(e)["catch"](T)})),"Promise",{all:function all(e){var t=this,r=x(t),n=r.resolve,a=r.reject,i=m(function(){var r=[],i=0,s=1;p(e,!1,function(e){var o=i++,u=!1;r.push(undefined);s++;t.resolve(e).then(function(e){if(!u){u=!0;r[o]=e;--s||n(r)}},a)});--s||n(r)});i.e&&a(i.v);return r.promise},race:function race(e){var t=this,r=x(t),n=r.reject,a=m(function(){p(e,!1,function(e){t.resolve(e).then(r.resolve,n)})});a.e&&n(a.v);return r.promise}})},{"./_a-function":14,"./_an-instance":16,"./_classof":19,"./_core":21,"./_ctx":23,"./_export":28,"./_for-of":30,"./_global":31,"./_is-object":40,"./_iter-detect":44,"./_library":47,"./_microtask":51,"./_new-promise-capability":52,"./_perform":62,"./_promise-resolve":63,"./_redefine-all":65,"./_set-species":67,"./_set-to-string-tag":68,"./_species-constructor":71,"./_task":73,"./_wks":81}],96:[function(e,t,r){"use strict";var n=e("./_string-at")(!0);e("./_iter-define")(String,"String",function(e){this._t=String(e);this._i=0},function(){var e,t=this._t,r=this._i;if(r>=t.length)return{value:undefined,done:!0};e=n(t,r);this._i+=e.length;return{value:e,done:!1}})},{"./_iter-define":43,"./_string-at":72}],97:[function(e,t,r){var n=e("./_export"),a=e("./_object-to-array")(!1);n(n.S,"Object",{values:function values(e){return a(e)}})},{"./_export":28,"./_object-to-array":61}],98:[function(e,t,r){"use strict";var n=e("./_export"),a=e("./_core"),i=e("./_global"),s=e("./_species-constructor"),o=e("./_promise-resolve");n(n.P+n.R,"Promise",{"finally":function(e){var t=s(this,a.Promise||i.Promise),r="function"==typeof e;return this.then(r?function(r){return o(t,e()).then(function(){return r})}:e,r?function(r){return o(t,e()).then(function(){throw r})}:e)}})},{"./_core":21,"./_export":28,"./_global":31,"./_promise-resolve":63,"./_species-constructor":71}],99:[function(e,t,r){"use strict";var n=e("./_export"),a=e("./_new-promise-capability"),i=e("./_perform");n(n.S,"Promise",{"try":function(e){var t=a.f(this),r=i(e);(r.e?t.reject:t.resolve)(r.v);return t.promise}})},{"./_export":28,"./_new-promise-capability":52,"./_perform":62}],100:[function(e,t,r){e("./es6.array.iterator");for(var n=e("./_global"),a=e("./_hide"),i=e("./_iterators"),s=e("./_wks")("toStringTag"),o="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),u=0;u<o.length;u++){var c=o[u],l=n[c],h=l&&l.prototype;h&&!h[s]&&a(h,s,c);i[c]=i.Array}},{"./_global":31,"./_hide":33,"./_iterators":46,"./_wks":81,"./es6.array.iterator":85}],101:[function(e,t,r){var n=function(){return this}()||Function("return this")(),a=n.regeneratorRuntime&&Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime")>=0,i=a&&n.regeneratorRuntime;n.regeneratorRuntime=undefined;t.exports=e("./runtime");if(a)n.regeneratorRuntime=i;else try{delete n.regeneratorRuntime}catch(s){n.regeneratorRuntime=undefined}},{"./runtime":102}],102:[function(e,t,r){!function(e){"use strict";var r,n=Object.prototype,a=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",o=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag",c="object"==typeof t,l=e.regeneratorRuntime;if(l)c&&(t.exports=l);else{(l=e.regeneratorRuntime=c?t.exports:{}).wrap=wrap;var h="suspendedStart",f="suspendedYield",_="executing",d="completed",p={},g={};g[s]=function(){return this};var y=Object.getPrototypeOf,v=y&&y(y(values([])));v&&v!==n&&a.call(v,s)&&(g=v);var k=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(g);GeneratorFunction.prototype=k.constructor=GeneratorFunctionPrototype;GeneratorFunctionPrototype.constructor=GeneratorFunction;GeneratorFunctionPrototype[u]=GeneratorFunction.displayName="GeneratorFunction";l.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))};l.mark=function(e){if(Object.setPrototypeOf)Object.setPrototypeOf(e,GeneratorFunctionPrototype);else{e.__proto__=GeneratorFunctionPrototype;u in e||(e[u]="GeneratorFunction")}e.prototype=Object.create(k);return e};l.awrap=function(e){return{__await:e}};defineIteratorMethods(AsyncIterator.prototype);AsyncIterator.prototype[o]=function(){return this};l.AsyncIterator=AsyncIterator;l.async=function(e,t,r,n){var a=new AsyncIterator(wrap(e,t,r,n));return l.isGeneratorFunction(t)?a:a.next().then(function(e){return e.done?e.value:a.next()})};defineIteratorMethods(k);k[u]="Generator";k[s]=function(){return this};k.toString=function(){return"[object Generator]"};l.keys=function(e){var t=[];for(var r in e)t.push(r);t.reverse();return function next(){for(;t.length;){var r=t.pop();if(r in e){next.value=r;next.done=!1;return next}}next.done=!0;return next}};l.values=values;Context.prototype={constructor:Context,reset:function(e){this.prev=0;this.next=0;this.sent=this._sent=r;this.done=!1;this.delegate=null;this.method="next";this.arg=r;this.tryEntries.forEach(resetTryEntry);if(!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=r)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function handle(n,a){s.type="throw";s.arg=e;t.next=n;if(a){t.method="next";t.arg=r}return!!a}for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n],s=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var o=a.call(i,"catchLoc"),u=a.call(i,"finallyLoc");if(o&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(o){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&a.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};s.type=e;s.arg=t;if(i){this.method="next";this.next=i.finallyLoc;return p}return this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;if("break"===e.type||"continue"===e.type)this.next=e.arg;else if("return"===e.type){this.rval=this.arg=e.arg;this.method="return";this.next="end"}else"normal"===e.type&&t&&(this.next=t);return p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e){this.complete(r.completion,r.afterLoc);resetTryEntry(r);return p}}},"catch":function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;resetTryEntry(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){this.delegate={iterator:values(e),resultName:t,nextLoc:n};"next"===this.method&&(this.arg=r);return p}}}function wrap(e,t,r,n){var a=t&&t.prototype instanceof Generator?t:Generator,i=Object.create(a.prototype),s=new Context(n||[]);i._invoke=function makeInvokeMethod(e,t,r){var n=h;return function invoke(a,i){if(n===_)throw new Error("Generator is already running");if(n===d){if("throw"===a)throw i;return doneResult()}r.method=a;r.arg=i;for(;;){var s=r.delegate;if(s){var o=maybeInvokeDelegate(s,r);if(o){if(o===p)continue;return o}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===h){n=d;throw r.arg}r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=_;var u=tryCatch(e,t,r);if("normal"===u.type){n=r.done?d:f;if(u.arg===p)continue;return{value:u.arg,done:r.done}}if("throw"===u.type){n=d;r.method="throw";r.arg=u.arg}}}}(e,r,s);return i}function tryCatch(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(n){return{type:"throw",arg:n}}}function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}function defineIteratorMethods(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function AsyncIterator(e){var t;this._invoke=function enqueue(r,n){function callInvokeWithMethodAndArg(){return new Promise(function(t,i){!function invoke(t,r,n,i){var s=tryCatch(e[t],e,r);if("throw"!==s.type){var o=s.arg,u=o.value;return u&&"object"==typeof u&&a.call(u,"__await")?Promise.resolve(u.__await).then(function(e){invoke("next",e,n,i)},function(e){invoke("throw",e,n,i)}):Promise.resolve(u).then(function(e){o.value=e;n(o)},i)}i(s.arg)}(r,n,t,i)})}return t=t?t.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(e,t){var n=e.iterator[t.method];if(n===r){t.delegate=null;if("throw"===t.method){if(e.iterator["return"]){t.method="return";t.arg=r;maybeInvokeDelegate(e,t);if("throw"===t.method)return p}t.method="throw";t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var a=tryCatch(n,e.iterator,t.arg);if("throw"===a.type){t.method="throw";t.arg=a.arg;t.delegate=null;return p}var i=a.arg;if(!i){t.method="throw";t.arg=new TypeError("iterator result is not an object");t.delegate=null;return p}if(!i.done)return i;t[e.resultName]=i.value;t.next=e.nextLoc;if("return"!==t.method){t.method="next";t.arg=r}t.delegate=null;return p}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]);if(2 in e){t.finallyLoc=e[2];t.afterLoc=e[3]}this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal";delete t.arg;e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}];e.forEach(pushTryEntry,this);this.reset(!0)}function values(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function next(){for(;++n<e.length;)if(a.call(e,n)){next.value=e[n];next.done=!1;return next}next.value=r;next.done=!0;return next};return i.next=i}}return{next:doneResult}}function doneResult(){return{value:r,done:!0}}}(function(){return this}()||Function("return this")())},{}],"babel-runtime/core-js/array/from":[function(e,t,r){t.exports={"default":e("core-js/library/fn/array/from"),__esModule:!0}},{"core-js/library/fn/array/from":1}],"babel-runtime/core-js/get-iterator":[function(e,t,r){t.exports={"default":e("core-js/library/fn/get-iterator"),__esModule:!0}},{"core-js/library/fn/get-iterator":2}],"babel-runtime/core-js/json/stringify":[function(e,t,r){t.exports={"default":e("core-js/library/fn/json/stringify"),__esModule:!0}},{"core-js/library/fn/json/stringify":3}],"babel-runtime/core-js/math/clz32":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/clz32"),__esModule:!0}},{"core-js/library/fn/math/clz32":4}],"babel-runtime/core-js/math/fround":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/fround"),__esModule:!0}},{"core-js/library/fn/math/fround":5}],"babel-runtime/core-js/math/imul":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/imul"),__esModule:!0}},{"core-js/library/fn/math/imul":6}],"babel-runtime/core-js/math/trunc":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/trunc"),__esModule:!0}},{"core-js/library/fn/math/trunc":7}],"babel-runtime/core-js/number/is-integer":[function(e,t,r){t.exports={"default":e("core-js/library/fn/number/is-integer"),__esModule:!0}},{"core-js/library/fn/number/is-integer":8}],"babel-runtime/core-js/number/max-safe-integer":[function(e,t,r){t.exports={"default":e("core-js/library/fn/number/max-safe-integer"),__esModule:!0}},{"core-js/library/fn/number/max-safe-integer":9}],"babel-runtime/core-js/object/freeze":[function(e,t,r){t.exports={"default":e("core-js/library/fn/object/freeze"),__esModule:!0}},{"core-js/library/fn/object/freeze":10}],"babel-runtime/core-js/object/keys":[function(e,t,r){t.exports={"default":e("core-js/library/fn/object/keys"),__esModule:!0}},{"core-js/library/fn/object/keys":11}],"babel-runtime/core-js/object/values":[function(e,t,r){t.exports={"default":e("core-js/library/fn/object/values"),__esModule:!0}},{"core-js/library/fn/object/values":12}],"babel-runtime/core-js/promise":[function(e,t,r){t.exports={"default":e("core-js/library/fn/promise"),__esModule:!0}},{"core-js/library/fn/promise":13}],"babel-runtime/helpers/asyncToGenerator":[function(e,t,r){"use strict";r.__esModule=!0;var n=function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}(e("../core-js/promise"));r["default"]=function(e){return function(){var t=e.apply(this,arguments);return new n["default"](function(e,r){return function step(a,i){try{var s=t[a](i),o=s.value}catch(u){r(u);return}if(!s.done)return n["default"].resolve(o).then(function(e){step("next",e)},function(e){step("throw",e)});e(o)}("next")})}}},{"../core-js/promise":"babel-runtime/core-js/promise"}],"babel-runtime/regenerator":[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":101}]},{},[]);var Proxy,_getOwnPropertyNames=require("babel-runtime/core-js/object/get-own-property-names"),_getOwnPropertyNames2=_interopRequireDefault(_getOwnPropertyNames),_isNan=require("babel-runtime/core-js/number/is-nan"),_isNan2=_interopRequireDefault(_isNan),_isFinite=require("babel-runtime/core-js/number/is-finite"),_isFinite2=_interopRequireDefault(_isFinite),_is=require("babel-runtime/core-js/object/is"),_is2=_interopRequireDefault(_is),_log=require("babel-runtime/core-js/math/log2"),_log2=_interopRequireDefault(_log),_maxSafeInteger=require("babel-runtime/core-js/number/max-safe-integer"),_maxSafeInteger2=_interopRequireDefault(_maxSafeInteger),_isInteger=require("babel-runtime/core-js/number/is-integer"),_isInteger2=_interopRequireDefault(_isInteger),_toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_iterator177=require("babel-runtime/core-js/symbol/iterator"),_iterator178=_interopRequireDefault(_iterator177),_from=require("babel-runtime/core-js/array/from"),_from2=_interopRequireDefault(_from),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_set2=require("babel-runtime/core-js/set"),_set3=_interopRequireDefault(_set2),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}if("undefined"==typeof JDB)var JDB={};!function(e){e="undefined"!=typeof e?e:{};var t=function(){function Class(){(0,_classCallCheck3["default"])(this,Class)}(0,_createClass3["default"])(Class,null,[{key:"register",value:function register(t){"undefined"!=typeof e&&(e[t.name]=t)}}]);return Class}();t.register(t);var r=function(){function IDBTools(){(0,_classCallCheck3["default"])(this,IDBTools)}(0,_createClass3["default"])(IDBTools,null,[{key:"convertKeyRange",value:function convertKeyRange(e){return e instanceof S?e.exactMatch?IDBKeyRange.only(e.lower):e.lower!==undefined&&e.upper===undefined?IDBKeyRange.lowerBound(e.lower,e.lowerOpen):e.upper!==undefined&&e.lower===undefined?IDBKeyRange.upperBound(e.upper,e.upperOpen):IDBKeyRange.bound(e.lower,e.upper,e.lowerOpen,e.upperOpen):e}}]);return IDBTools}();t.register(r);var n=function(){function LogNative(){(0,_classCallCheck3["default"])(this,LogNative);this._global_level=y.TRACE;this._tag_levels={};try{if(window.localStorage)try{var e=window.localStorage.getItem("log_tag_levels");e&&"string"==typeof e&&(e=JSON.parse(e));e&&"object"===("undefined"==typeof e?"undefined":(0,_typeof3["default"])(e))&&(this._tag_levels=e)}catch(t){console.warn("Failed to load log configuration from local storage.")}}catch(t){}}(0,_createClass3["default"])(LogNative,[{key:"isLoggable",value:function isLoggable(e,t){return e&&this._tag_levels[e]?this._tag_levels[e]<=t:this._tag_levels["*"]?this._tag_levels["*"]<=t:this._global_level<=t}},{key:"setLoggable",value:function setLoggable(e,t){e&&e.name&&(e=e.name);this._tag_levels[e]=t;window.localStorage&&window.localStorage.setItem("log_tag_levels",(0,_stringify2["default"])(this._tag_levels))}},{key:"msg",value:function msg(e,t,r){t&&t.name&&(t=t.name);if(this.isLoggable(t,e)){t&&r.unshift(t+":");r.unshift("["+y.Level.toStringTag(e)+" "+(new Date).toTimeString().substr(0,8)+"]");console.error&&e>=y.ERROR?console.error.apply(console,r):console.warn&&e>=y.WARNING?console.warn.apply(console,r):console.info&&e>=y.INFO?console.info.apply(console,r):console.debug&&e>=y.DEBUG?console.debug.apply(console,r):console.trace&&e<=y.TRACE?console.trace.apply(console,r):console.log.apply(console,r)}}}]);return LogNative}();t.register(n);var a=function(){function EncodedTransaction(e){(0,_classCallCheck3["default"])(this,EncodedTransaction);this._tableName=e;this._modified=new _map2["default"];this._removed=new _set3["default"];this._truncated=!1}(0,_createClass3["default"])(EncodedTransaction,[{key:"truncate",value:function truncate(){this._truncated=!0;this._modified.clear();this._removed.clear()}},{key:"put",value:function put(e,t){this._removed["delete"](e);this._modified.set(e,t)}},{key:"remove",value:function remove(e){this._removed.add(e);this._modified["delete"](e)}},{key:"tableName",get:function get(){return this._tableName}},{key:"modified",get:function get(){return this._modified}},{key:"removed",get:function get(){return this._removed}},{key:"truncated",get:function get(){return this._truncated}}]);return EncodedTransaction}();t.register(a);var i=function(){function IDBBackend(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;(0,_classCallCheck3["default"])(this,IDBBackend);this._db=e;this._tableName=t;this._indices=new _map2["default"];this._indicesToDelete=[];this._codec=r}(0,_createClass3["default"])(IDBBackend,[{key:"init",value:function init(e){var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._indicesToDelete);!(t=(a=i.next()).done);t=!0){var s=a.value;e.deleteIndex(s)}}catch(g){r=!0;n=g}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}delete this._indicesToDelete;var o=!0,u=!1,c=undefined;try{for(var l,h=(0,_getIterator3["default"])(this._indices);!(o=(l=h.next()).done);o=!0){var f=(0,_slicedToArray3["default"])(l.value,2),_=f[0],d=f[1],p=Array.isArray(d.keyPath)?d.keyPath.join("."):d.keyPath;e.createIndex(_,p,{unique:!1,multiEntry:d.multiEntry})}}catch(g){u=!0;c=g}finally{try{!o&&h["return"]&&h["return"]()}finally{if(u)throw c}}}},{key:"decode",value:function decode(e,t){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.decode(e,t):e}},{key:"encode",value:function encode(e){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.encode(e):e}},{key:"get",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee(e){var t,r=this;return _regenerator2["default"].wrap(function _callee$(n){for(;;)switch(n.prev=n.next){case 0:t=this._backend;return n.abrupt("return",new _promise2["default"](function(n,a){var i=t.transaction([r._tableName]).objectStore(r._tableName).get(e);i.onsuccess=function(t){return n(r.decode(t.target.result,e))};i.onerror=a}));case 2:case"end":return n.stop()}},_callee,this)}));return function get(t){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee2(e,t){var r,n=this;return _regenerator2["default"].wrap(function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:r=this._backend;return a.abrupt("return",new _promise2["default"](function(a,i){var s=r.transaction([n._tableName],"readwrite").objectStore(n._tableName).put(n.encode(t),e);s.onsuccess=function(e){return a(e.target.result)};s.onerror=i}));case 2:case"end":return a.stop()}},_callee2,this)}));return function put(t,r){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee3(e){var t,r=this;return _regenerator2["default"].wrap(function _callee3$(n){for(;;)switch(n.prev=n.next){case 0:t=this._backend;return n.abrupt("return",new _promise2["default"](function(n,a){var i=t.transaction([r._tableName],"readwrite").objectStore(r._tableName)["delete"](e);i.onsuccess=function(e){return n(e.target.result)};i.onerror=a}));case 2:case"end":return n.stop()}},_callee3,this)}));return function remove(t){return e.apply(this,arguments)}}()},{key:"values",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee4(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:if(!(null!==n&&n instanceof E)){a.next=2;break}return a.abrupt("return",n.values(this));case 2:n=r.convertKeyRange(n);e=this._backend;return a.abrupt("return",new _promise2["default"](function(r,a){var i=[],s=e.transaction([t._tableName],"readonly").objectStore(t._tableName).openCursor(n);s.onsuccess=function(e){var n=e.target.result;if(n){i.push(t.decode(n.value,n.primaryKey));n["continue"]()}else r(i)};s.onerror=function(){return a(s.error)}}));case 5:case"end":return a.stop()}},_callee4,this)}));return function values(){return e.apply(this,arguments)}}()},{key:"keys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee5(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:if(!(null!==n&&n instanceof E)){a.next=2;break}return a.abrupt("return",n.keys(this));case 2:n=r.convertKeyRange(n);e=this._backend;return a.abrupt("return",new _promise2["default"](function(r,a){var i=new _set3["default"],s=e.transaction([t._tableName],"readonly").objectStore(t._tableName),o=s.openKeyCursor?s.openKeyCursor(n):s.openCursor(n);o.onsuccess=function(e){var t=e.target.result;if(t){i.add(t.primaryKey);t["continue"]()}else r(i)};o.onerror=function(){return a(o.error)}}));case 5:case"end":return a.stop()}},_callee5,this)}));return function keys(){return e.apply(this,arguments)}}()},{key:"keyStream",value:function keyStream(e){var t=this,n=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;a=r.convertKeyRange(a);var i=this._backend;return new _promise2["default"](function(r,s){var o=i.transaction([t._tableName],"readonly").objectStore(t._tableName),u=o.openKeyCursor?o.openKeyCursor(a,n?"next":"prev"):o.openCursor(a,n?"next":"prev");u.onsuccess=function(t){var n=t.target.result;n&&e(n.primaryKey)?n["continue"]():r()};u.onerror=function(){return s(u.error)}})}},{key:"valueStream",value:function valueStream(e){var t=this,n=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;a=r.convertKeyRange(a);var i=this._backend;return new _promise2["default"](function(r,s){var o=i.transaction([t._tableName],"readonly").objectStore(t._tableName).openCursor(a,n?"next":"prev");o.onsuccess=function(t){var n=t.target.result;n&&e(n.value,n.primaryKey)?n["continue"]():r()};o.onerror=function(){return s(o.error)}})}},{key:"maxValue",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee6(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);e=this._backend;return a.abrupt("return",new _promise2["default"](function(r,a){var i=e.transaction([t._tableName],"readonly").objectStore(t._tableName).openCursor(n,"prev");i.onsuccess=function(e){var n=e.target.result;r(n?t.decode(n.value,n.primaryKey):undefined)};i.onerror=function(){return a(i.error)}}));case 3:case"end":return a.stop()}},_callee6,this)}));return function maxValue(){return e.apply(this,arguments)}}()},{key:"maxKey",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee7(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee7$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);e=this._backend;return a.abrupt("return",new _promise2["default"](function(r,a){var i=e.transaction([t._tableName],"readonly").objectStore(t._tableName),s=i.openKeyCursor?i.openKeyCursor(n,"prev"):i.openCursor(n,"prev");s.onsuccess=function(){return r(s.result?s.result.primaryKey:undefined)};s.onerror=function(){return a(s.error)}}));case 3:case"end":return a.stop()}},_callee7,this)}));return function maxKey(){return e.apply(this,arguments)}}()},{key:"minValue",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee8(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee8$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);e=this._backend;return a.abrupt("return",new _promise2["default"](function(r,a){var i=e.transaction([t._tableName],"readonly").objectStore(t._tableName).openCursor(n,"next");i.onsuccess=function(e){var n=e.target.result;r(n?t.decode(n.value,n.primaryKey):undefined)};i.onerror=function(){return a(i.error)}}));case 3:case"end":return a.stop()}},_callee8,this)}));return function minValue(){return e.apply(this,arguments)}}()},{key:"minKey",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee9(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee9$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);e=this._backend;return a.abrupt("return",new _promise2["default"](function(r,a){var i=e.transaction([t._tableName],"readonly").objectStore(t._tableName),s=i.openKeyCursor?i.openKeyCursor(n,"next"):i.openCursor(n,"next");s.onsuccess=function(){return r(s.result?s.result.primaryKey:undefined)};s.onerror=function(){return a(s.error)}}));case 3:case"end":return a.stop()}},_callee9,this)}));return function minKey(){return e.apply(this,arguments)}}()},{key:"count",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee10(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee10$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);e=this._backend;return a.abrupt("return",new _promise2["default"](function(r,a){var i=e.transaction([t._tableName],"readonly").objectStore(t._tableName).count(n);i.onsuccess=function(){return r(i.result)};i.onerror=function(){return a(i.error)}}));case 3:case"end":return a.stop()}},_callee10,this)}));return function count(){return e.apply(this,arguments)}}()},{key:"index",value:function index(e){return this._indices.get(e)}},{key:"_apply",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee11(e){var t,r=this;return _regenerator2["default"].wrap(function _callee11$(n){for(;;)switch(n.prev=n.next){case 0:t=this._backend;return n.abrupt("return",new _promise2["default"](function(n,a){var i=t.transaction([r._tableName],"readwrite"),s=i.objectStore(r._tableName);e._truncated&&s.clear();var o=!0,u=!1,c=undefined;try{for(var l,h=(0,_getIterator3["default"])(e._removed);!(o=(l=h.next()).done);o=!0){var f=l.value;s["delete"](f)}}catch(b){u=!0;c=b}finally{try{!o&&h["return"]&&h["return"]()}finally{if(u)throw c}}var _=!0,d=!1,p=undefined;try{for(var g,y=(0,_getIterator3["default"])(e._modified);!(_=(g=y.next()).done);_=!0){var v=(0,_slicedToArray3["default"])(g.value,2),k=v[0],m=v[1];s.put(r.encode(m),k)}}catch(b){d=!0;p=b}finally{try{!_&&y["return"]&&y["return"]()}finally{if(d)throw p}}i.oncomplete=function(){return n(!0)};i.onerror=a;i.onabort=a}));case 2:case"end":return n.stop()}},_callee11,this)}));return function _apply(t){return e.apply(this,arguments)}}()},{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee12(){var e,t=this;return _regenerator2["default"].wrap(function _callee12$(r){for(;;)switch(r.prev=r.next){case 0:e=this._backend;return r.abrupt("return",new _promise2["default"](function(r,n){var a=e.transaction([t._tableName],"readonly").objectStore(t._tableName).clear();a.onsuccess=r;a.onerror=function(){return n(a.error)}}));case 2:case"end":return r.stop()}},_callee12,this)}));return function truncate(){return e.apply(this,arguments)}}()},{key:"createIndex",value:function createIndex(e,t){var r=arguments.length>2&&arguments[2]!==undefined&&arguments[2];if(this._db.connected)throw new Error("Cannot create index while connected");var n=new o(this,e,t=t||e,r);this._indices.set(e,n)}},{key:"deleteIndex",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee13(e){return _regenerator2["default"].wrap(function _callee13$(t){for(;;)switch(t.prev=t.next){case 0:if(!this._db.connected){t.next=2;break}throw new Error("Cannot delete index while connected");case 2:this._indicesToDelete.push(e);case 3:case"end":return t.stop()}},_callee13,this)}));return function deleteIndex(t){return e.apply(this,arguments)}}()},{key:"close",value:function close(){return this._db.close()}},{key:"applyCombined",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee14(e){var t,r,n,i,s,o,u,c,l,h,f,_,d,p,g;return _regenerator2["default"].wrap(function _callee14$(y){for(;;)switch(y.prev=y.next){case 0:t=new a(this._tableName);e._truncated&&t.truncate();r=!0;n=!1;i=undefined;y.prev=5;for(s=(0,_getIterator3["default"])(e._removed);!(r=(o=s.next()).done);r=!0){u=o.value;t.remove(u)}y.next=13;break;case 9:y.prev=9;y.t0=y["catch"](5);n=!0;i=y.t0;case 13:y.prev=13;y.prev=14;!r&&s["return"]&&s["return"]();case 16:y.prev=16;if(!n){y.next=19;break}throw i;case 19:return y.finish(16);case 20:return y.finish(13);case 21:c=!0;l=!1;h=undefined;y.prev=24;for(f=(0,_getIterator3["default"])(e._modified);!(c=(_=f.next()).done);c=!0){d=(0,_slicedToArray3["default"])(_.value,2),p=d[0],g=d[1];t.put(p,this.encode(g))}y.next=32;break;case 28:y.prev=28;y.t1=y["catch"](24);l=!0;h=y.t1;case 32:y.prev=32;y.prev=33;!c&&f["return"]&&f["return"]();case 35:y.prev=35;if(!l){y.next=38;break}throw h;case 38:return y.finish(35);case 39:return y.finish(32);case 40:return y.abrupt("return",t);case 41:case"end":return y.stop()}},_callee14,this,[[5,9,13,21],[14,,16,20],[24,28,32,40],[33,,35,39]])}));return function applyCombined(t){return e.apply(this,arguments)}}()},{key:"isSynchronous",value:function isSynchronous(){return!1}},{key:"connected",get:function get(){return this._db.connected}},{key:"_backend",get:function get(){if(!this.connected)throw new Error("Requires a connected database");return this._db.backend}},{key:"indices",get:function get(){return this._indices}},{key:"backend",get:function get(){return this._db.backend}},{key:"tableName",get:function get(){return this._tableName}}]);return IDBBackend}();t.register(i);var s=function(){function JungleDB(e,t,r){(0,_classCallCheck3["default"])(this,JungleDB);if(t<=0)throw new Error("The version provided must not be less or equal to 0");this._databaseDir=e;this._dbVersion=t;this._onUpgradeNeeded=r;this._connected=!1;this._objectStores=new _map2["default"];this._objectStoreBackends=new _map2["default"];this._objectStoresToDelete=[]}(0,_createClass3["default"])(JungleDB,[{key:"connect",value:function connect(){if(this._db)return _promise2["default"].resolve(this._db);var e=this._indexedDB.open(this._databaseDir,this._dbVersion),t=this;return new _promise2["default"](function(r,n){e.onsuccess=function(){t._connected=!0;t._db=e.result;r(e.result)};e.onerror=n;e.onupgradeneeded=function(e){return t._initDB(e)}})}},{key:"_initDB",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee15(e){var t,r,n,a,i,s,o,u,c,l,h,f,_,d,p,g;return _regenerator2["default"].wrap(function _callee15$(y){for(;;)switch(y.prev=y.next){case 0:t=e.target.result;r=!0;n=!1;a=undefined;y.prev=4;for(i=(0,_getIterator3["default"])(this._objectStoresToDelete);!(r=(s=i.next()).done);r=!0){o=s.value;t.deleteObjectStore(o)}y.next=12;break;case 8:y.prev=8;y.t0=y["catch"](4);n=!0;a=y.t0;case 12:y.prev=12;y.prev=13;!r&&i["return"]&&i["return"]();case 15:y.prev=15;if(!n){y.next=18;break}throw a;case 18:return y.finish(15);case 19:return y.finish(12);case 20:delete this._objectStoresToDelete;u=!0;c=!1;l=undefined;y.prev=24;for(h=(0,_getIterator3["default"])(this._objectStoreBackends);!(u=(f=h.next()).done);u=!0){_=(0,_slicedToArray3["default"])(f.value,2),d=_[0],p=_[1];g=t.createObjectStore(d);p.init(g)}y.next=32;break;case 28:y.prev=28;y.t1=y["catch"](24);c=!0;l=y.t1;case 32:y.prev=32;y.prev=33;!u&&h["return"]&&h["return"]();case 35:y.prev=35;if(!c){y.next=38;break}throw l;case 38:return y.finish(35);case 39:return y.finish(32);case 40:delete this._objectStoreBackends;if(!this._onUpgradeNeeded){y.next=44;break}y.next=44;return this._onUpgradeNeeded();case 44:case"end":return y.stop()}},_callee15,this,[[4,8,12,20],[13,,15,19],[24,28,32,40],[33,,35,39]])}));return function _initDB(t){return e.apply(this,arguments)}}()},{key:"getObjectStore",value:function getObjectStore(e){return this._objectStores.get(e)}},{key:"createObjectStore",value:function createObjectStore(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null,r=!(arguments.length>2&&arguments[2]!==undefined)||arguments[2];if(this._connected)throw new Error("Cannot create ObjectStore while connected");if(this._objectStores.has(e))return this._objectStores.get(e);var n=r?new i(this,e,t):new A(e,t),a=new C(n),s=new T(a,this,e);this._objectStores.set(e,s);this._objectStoreBackends.set(e,n);return s}},{key:"deleteObjectStore",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee16(e){return _regenerator2["default"].wrap(function _callee16$(t){for(;;)switch(t.prev=t.next){case 0:if(!this._connected){t.next=2;break}throw new Error("Cannot delete ObjectStore while connected");case 2:this._objectStoresToDelete.push(e);case 3:case"end":return t.stop()}},_callee16,this)}));return function deleteObjectStore(t){return e.apply(this,arguments)}}()},{key:"close",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee17(){return _regenerator2["default"].wrap(function _callee17$(e){for(;;)switch(e.prev=e.next){case 0:if(this._connected){this._connected=!1;this.backend.close()}case 1:case"end":return e.stop()}},_callee17,this)}));return function close(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee18(){var e=this;return _regenerator2["default"].wrap(function _callee18$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this.close();case 2:return t.abrupt("return",new _promise2["default"](function(t,r){var n=e._indexedDB.deleteDatabase(e._databaseDir);n.onsuccess=t;n.onerror=r}));case 3:case"end":return t.stop()}},_callee18,this)}));return function destroy(){return e.apply(this,arguments)}}()},{key:"toString",value:function toString(){return"JungleDB{name="+this._databaseDir+"}"}},{key:"_indexedDB",get:function get(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB}},{key:"backend",get:function get(){return this._db}},{key:"connected",get:function get(){return this._connected}}],[{key:"createVolatileObjectStore",value:function createVolatileObjectStore(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return new T(new A("",e),null)}},{key:"commitCombined",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee19(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];var i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m,b,C,w;return _regenerator2["default"].wrap(function _callee19$(r){for(;;)switch(r.prev=r.next){case 0:if(!(e instanceof M)){r.next=54;break}i=[];s=[];o=[];r.next=6;return _promise2["default"].all(e.transactions.map(function(e){return e.objectStore._backend.applyCombined(e)}));case 6:u=r.sent;c=!0;l=!1;h=undefined;r.prev=10;f=(0,_getIterator3["default"])(u);case 12:if(c=(_=f.next()).done){r.next=38;break}d=_.value;p=d;Array.isArray(d)||(p=[d]);g=!0;y=!1;v=undefined;r.prev=19;for(k=(0,_getIterator3["default"])(p);!(g=(m=k.next()).done);g=!0)if("function"==typeof(b=m.value))i.push(b);else{s.push(b);o.push(b.tableName)}r.next=27;break;case 23:r.prev=23;r.t0=r["catch"](19);y=!0;v=r.t0;case 27:r.prev=27;r.prev=28;!g&&k["return"]&&k["return"]();case 30:r.prev=30;if(!y){r.next=33;break}throw v;case 33:return r.finish(30);case 34:return r.finish(27);case 35:c=!0;r.next=12;break;case 38:r.next=44;break;case 40:r.prev=40;r.t1=r["catch"](10);l=!0;h=r.t1;case 44:r.prev=44;r.prev=45;!c&&f["return"]&&f["return"]();case 47:r.prev=47;if(!l){r.next=50;break}throw h;case 50:return r.finish(47);case 51:return r.finish(44);case 52:C=null!==e.backend?e.backend.backend:null;return r.abrupt("return",new _promise2["default"](function(e,t){if(o.length>0){var r=C.transaction(o,"readwrite"),n=!0,a=!1,u=undefined;try{for(var c,l=(0,_getIterator3["default"])(s);!(n=(c=l.next()).done);n=!0){var h=c.value,f=r.objectStore(h.tableName);h.truncated&&f.clear();var _=!0,d=!1,p=undefined;try{for(var g,y=(0,_getIterator3["default"])(h.removed);!(_=(g=y.next()).done);_=!0){var v=g.value;f["delete"](v)}}catch(E){d=!0;p=E}finally{try{!_&&y["return"]&&y["return"]()}finally{if(d)throw p}}var k=!0,m=!1,b=undefined;try{for(var w,A=(0,_getIterator3["default"])(h.modified);!(k=(w=A.next()).done);k=!0){var S=(0,_slicedToArray3["default"])(w.value,2),T=S[0],x=S[1];f.put(x,T)}}catch(E){m=!0;b=E}finally{try{!k&&A["return"]&&A["return"]()}finally{if(m)throw b}}}}catch(E){a=!0;u=E}finally{try{!n&&l["return"]&&l["return"]()}finally{if(a)throw u}}r.oncomplete=function(){_promise2["default"].all(i.map(function(e){return e()})).then(function(){e(!0)})};r.onerror=t;r.onabort=t}else _promise2["default"].all(i.map(function(e){return e()})).then(function(){e(!0)})}));case 54:n.push(e);n.push(t);if(n.every(function(e){return e instanceof P})){r.next=58;break}throw new Error("Invalid arguments supplied");case 58:w=new(Function.prototype.bind.apply(M,[null].concat(n)));return r.abrupt("return",w.commit());case 60:case"end":return r.stop()}},_callee19,this,[[10,40,44,52],[19,23,27,35],[28,,30,34],[45,,47,51]])}));return function commitCombined(t,r){return e.apply(this,arguments)}}()}]);return JungleDB}();t.register(s);var o=function(){function PersistentIndex(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined&&arguments[3];(0,_classCallCheck3["default"])(this,PersistentIndex);this._objectStore=e;this._indexName=t;this._keyPath=r;this._multiEntry=n}(0,_createClass3["default"])(PersistentIndex,[{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee20(){return _regenerator2["default"].wrap(function _callee20$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee20,this)}));return function truncate(){return e.apply(this,arguments)}}()},{key:"_index",value:function _index(e){return e.transaction([this._objectStore.tableName],"readonly").objectStore(this._objectStore.tableName).index(this._indexName)}},{key:"values",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee21(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee21$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);a.next=3;return this._objectStore.backend;case 3:e=a.sent;return a.abrupt("return",new _promise2["default"](function(r,a){var i=[],s=t._index(e).openCursor(n);s.onsuccess=function(e){var n=e.target.result;if(n){i.push(t._objectStore.decode(n.value,n.primaryKey));n["continue"]()}else r(i)};s.onerror=function(){return a(s.error)}}));case 5:case"end":return a.stop()}},_callee21,this)}));return function values(){return e.apply(this,arguments)}}()},{key:"keys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee22(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee22$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);a.next=3;return this._objectStore.backend;case 3:e=a.sent;return a.abrupt("return",new _promise2["default"](function(r,a){var i=new _set3["default"],s=t._index(e),o=s.openKeyCursor?s.openKeyCursor(n):s.openCursor(n);o.onsuccess=function(e){var t=e.target.result;if(t){i.add(t.primaryKey);t["continue"]()}else r(i)};o.onerror=function(){return a(o.error)}}));case 5:case"end":return a.stop()}},_callee22,this)}));return function keys(){return e.apply(this,arguments)}}()},{key:"maxValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee23(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee23$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);a.next=3;return this._objectStore.backend;case 3:e=a.sent;return a.abrupt("return",new _promise2["default"](function(r,a){var i=[],s=null,o=t._index(e).openCursor(n,"prev");o.onsuccess=function(e){var n=e.target.result;null===s&&(s=n.key);if(n&&s===n.key){i.push(t._objectStore.decode(n.value,n.primaryKey));n["continue"]()}else r(i)};o.onerror=function(){return a(o.error)}}));case 5:case"end":return a.stop()}},_callee23,this)}));return function maxValues(){return e.apply(this,arguments)}}()},{key:"maxKeys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee24(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee24$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);a.next=3;return this._objectStore.backend;case 3:e=a.sent;return a.abrupt("return",new _promise2["default"](function(r,a){var i=new _set3["default"],s=null,o=t._index(e),u=o.openKeyCursor?o.openKeyCursor(n,"prev"):o.openCursor(n,"prev");u.onsuccess=function(e){var t=e.target.result;null===s&&(s=t.key);if(t&&s===t.key){i.add(t.primaryKey);t["continue"]()}else r(i)};u.onerror=function(){return a(u.error)}}));case 5:case"end":return a.stop()}},_callee24,this)}));return function maxKeys(){return e.apply(this,arguments)}}()},{key:"minValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee25(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee25$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);a.next=3;return this._objectStore.backend;case 3:e=a.sent;return a.abrupt("return",new _promise2["default"](function(r,a){var i=[],s=null,o=t._index(e).openCursor(n,"next");o.onsuccess=function(e){var n=e.target.result;null===s&&(s=n.key);if(n&&s===n.key){i.push(t._objectStore.decode(n.value,n.primaryKey));n["continue"]()}else r(i)};o.onerror=function(){return a(o.error)}}));case 5:case"end":return a.stop()}},_callee25,this)}));return function minValues(){return e.apply(this,arguments)}}()},{key:"minKeys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee26(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee26$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);a.next=3;return this._objectStore.backend;case 3:e=a.sent;return a.abrupt("return",new _promise2["default"](function(r,a){var i=new _set3["default"],s=null,o=t._index(e),u=o.openKeyCursor?o.openKeyCursor(n,"next"):o.openCursor(n,"next");u.onsuccess=function(e){var t=e.target.result;null===s&&(s=t.key);if(t&&s===t.key){i.add(t.primaryKey);t["continue"]()}else r(i)};u.onerror=function(){return a(u.error)}}));case 5:case"end":return a.stop()}},_callee26,this)}));return function minKeys(){return e.apply(this,arguments)}}()},{key:"count",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee27(){var e,t=this,n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee27$(a){for(;;)switch(a.prev=a.next){case 0:n=r.convertKeyRange(n);a.next=3;return this._objectStore.backend;case 3:e=a.sent;return a.abrupt("return",new _promise2["default"](function(r,a){var i=t._index(e).count(n);i.onsuccess=function(){return r(i.result)};i.onerror=function(){return a(i.error)}}));case 5:case"end":return a.stop()}},_callee27,this)}));return function count(){return e.apply(this,arguments)}}()},{key:"keyPath",get:function get(){return this._keyPath}},{key:"multiEntry",get:function get(){return this._multiEntry}}]);return PersistentIndex}();t.register(o);Array.prototype.iterator=function(){var e=this,t=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0],r=t?0:this.length-1;return{next:function next(){return r>=0&&r<e.length?e[t?r++:r--]:undefined},hasNext:function hasNext(){return r>=0&&r<e.length},peek:function peek(){return r>=0&&r<e.length?e[r]:undefined}}};var u=function(){function Node(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];(0,_classCallCheck3["default"])(this,Node);this._keys=t;this._id=e}(0,_createClass3["default"])(Node,[{key:"toJSON",value:function toJSON(){return{_id:this._id,_keys:this._keys}}},{key:"id",get:function get(){return this._id}},{key:"keys",get:function get(){return this._keys}}],[{key:"fromJSON",value:function fromJSON(e){return!0===e.isLeaf?c.fromJSON(e):!1===e.isLeaf?l.fromJSON(e):undefined}}]);return Node}();t.register(u);var c=function(e){(0,_inherits3["default"])(LeafNode,e);function LeafNode(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];(0,_classCallCheck3["default"])(this,LeafNode);if(t.length!==r.length)throw new Error("Keys and records must have the same length");var n=(0,_possibleConstructorReturn3["default"])(this,(LeafNode.__proto__||(0,_getPrototypeOf2["default"])(LeafNode)).call(this,e,t));n._records=r;n.prevLeaf=null;n.nextLeaf=null;return n}(0,_createClass3["default"])(LeafNode,[{key:"isLeaf",value:function isLeaf(){return!0}},{key:"toJSON",value:function toJSON(){var e=(0,_get3["default"])(LeafNode.prototype.__proto__||(0,_getPrototypeOf2["default"])(LeafNode.prototype),"toJSON",this).call(this);e.isLeaf=!0;e._records=this._records;e.prevLeaf=this.prevLeaf?this.prevLeaf.id:this.prevLeaf;e.nextLeaf=this.nextLeaf?this.nextLeaf.id:this.nextLeaf;return e}},{key:"getItem",value:function getItem(e,t){var r=this._keys;if(t===h.NEAR_MODE.GE){for(var n=0,a=r.length;n<a;++n)if(e<=r[n])return n}else if(t===h.NEAR_MODE.LE){for(var i=r.length-1;i>=0;--i)if(e>=r[i])return i}else for(var s=0,o=r.length;s<o;++s)if(e===r[s])return s;return-1}},{key:"addKey",value:function addKey(e,t){for(var r=this._keys.length,n=0,a=r;n<a;++n){if(e===this._keys[n])return-1;if(e<=this._keys[n]){r=n;break}}this._keys.splice(r,0,e);this._records.splice(r,0,t);return r}},{key:"split",value:function split(e){for(var t=Math.floor(this._keys.length/2),r=[],n=[],a=0;a<t;++a){r.unshift(this._keys.pop());n.unshift(this._records.pop())}var i=new LeafNode(e,r,n);i.prevLeaf=this;i.nextLeaf=this.nextLeaf;null!==this.nextLeaf&&(this.nextLeaf.prevLeaf=i);this.nextLeaf=i;return i}},{key:"merge",value:function merge(e,t,r){for(var n=0,a=e.keys.length;n<a;++n){this._keys.push(e.keys[n]);this._records.push(e.records[n])}this.nextLeaf=e.nextLeaf;null!==e.nextLeaf&&(e.nextLeaf.prevLeaf=this);e.prevLeaf=null;e.nextLeaf=null;for(var i=t.keys.length-1,s=i;s>=0;--s)if(t.keys[s]===r){i=s;break}t.keys.splice(i,1);t.nodePointers.splice(i+1,1)}},{key:"records",get:function get(){return this._records}}],[{key:"fromJSON",value:function fromJSON(e){var t=new LeafNode(e._id,e._keys,e._records);t.prevLeaf=e.prevLeaf;t.nextLeaf=e.nextLeaf;return t}}]);return LeafNode}(u);t.register(c);var l=function(e){(0,_inherits3["default"])(InnerNode,e);function InnerNode(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];(0,_classCallCheck3["default"])(this,InnerNode);var n=(0,_possibleConstructorReturn3["default"])(this,(InnerNode.__proto__||(0,_getPrototypeOf2["default"])(InnerNode)).call(this,e,t));n._nodePointers=r;return n}(0,_createClass3["default"])(InnerNode,[{key:"isLeaf",value:function isLeaf(){return!1}},{key:"toJSON",value:function toJSON(){for(var e=(0,_get3["default"])(InnerNode.prototype.__proto__||(0,_getPrototypeOf2["default"])(InnerNode.prototype),"toJSON",this).call(this),t=[],r=0;r<this._nodePointers.length;++r)t.push(this._nodePointers[r]?this._nodePointers[r].id:this._nodePointers[r]);e.isLeaf=!1;e._nodePointers=t;return e}},{key:"getItem",value:function getItem(e){for(var t=this._keys.length,r=0;r<t;++r)if(e<this._keys[r])return r;return this._keys.length}},{key:"addKey",value:function addKey(e,t,r){for(var n=this._keys.length,a=n,i=0;i<n;++i)if(e<=this._keys[i]){a=i;break}this._keys.splice(a,0,e);this._nodePointers.splice(a,0,t);this._nodePointers[a+1]=r}},{key:"split",value:function split(e){for(var t=Math.ceil(this._keys.length/2)-1,r=[this._nodePointers.pop()],n=[],a=t-1;a>=0;--a){n.unshift(this._keys.pop());r.unshift(this._nodePointers.pop())}return new InnerNode(e,n,r)}},{key:"merge",value:function merge(e,t,r){var n=t.keys[r];this._keys.push(n);for(var a=0,i=e.keys.length;a<i;++a){this._keys.push(e.keys[a]);this._nodePointers.push(e.nodePointers[a])}this._nodePointers.push(e.nodePointers[e.nodePointers.length-1]);t.keys.splice(r,1);t.nodePointers.splice(r+1,1);return n}},{key:"nodePointers",get:function get(){return this._nodePointers}}],[{key:"fromJSON",value:function fromJSON(e){return new InnerNode(e._id,e._keys,e._nodePointers)}}]);return InnerNode}(u);t.register(l);var h=function(){function BTree(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:7;(0,_classCallCheck3["default"])(this,BTree);this._nodeId=0;this._root=new c(this._nodeId++);this._maxkey=e-1;this._minkyl=Math.floor(e/2);this._minkyn=Math.floor(this._maxkey/2);this._leaf=null;this._item=-1;this._key=null;this._record=null;this._length=0;this._eof=!0;this._found=!1}(0,_createClass3["default"])(BTree,[{key:"transaction",value:function transaction(){return new f(this)}},{key:"insert",value:function insert(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null,n=[];this._leaf=this._root;for(;!this._leaf.isLeaf();){n.push(this._leaf);this._item=this._leaf.getItem(e);this._leaf=this._leaf.nodePointers[this._item]}this._item=this._leaf.addKey(e,t);this._key=e;this._eof=!1;if(-1===this._item){this._found=!0;this._item=this._leaf.getItem(e,!1);this._record=this._leaf.records[this._item]}else{BTree._modifyNode(r,this._leaf);this._found=!1;this._record=t;this._length++;if(this._leaf.keys.length>this._maxkey){var a=this._leaf,i=this._leaf.split(this._nodeId++);BTree._modifyNode(r,a);BTree._modifyNode(r,i);var s=i.keys[0];this._item=this._leaf.getItem(e,!1);if(-1===this._item){this._leaf=this._leaf.nextLeaf;this._item=this._leaf.getItem(e,!1)}for(;;){if(0===n.length){var o=new l(this._nodeId++);o.keys[0]=s;o.nodePointers[0]=a;o.nodePointers[1]=i;BTree._modifyNode(r,o);this._root=o;break}var u=n.pop();u.addKey(s,a,i);BTree._modifyNode(r,u);if(u.keys.length<=this._maxkey)break;a=u;i=u.split(this._nodeId++);BTree._modifyNode(r,a);BTree._modifyNode(r,i);s=u.keys.pop()}}}return!this._found}},{key:"remove",value:function remove(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null,r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if("undefined"==typeof e){if(-1===this._item){this._eof=!0;this._found=!1;return!1}e=this._leaf.keys[this._item]}this._del(e,t,r);if(this._found){this.seek(e,BTree.NEAR_MODE.GE);this._found=!0}else{this._item=-1;this._eof=!0;this._key=null;this._record=null}return this._found}},{key:"seek",value:function seek(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:BTree.NEAR_MODE.NONE;this._leaf=this._root;for(;!this._leaf.isLeaf();){this._item=this._leaf.getItem(e);this._leaf=this._leaf.nodePointers[this._item]}this._item=this._leaf.getItem(e,t);if(t===BTree.NEAR_MODE.GE&&-1===this._item&&null!==this._leaf.nextLeaf){this._leaf=this._leaf.nextLeaf;this._item=0}if(t===BTree.NEAR_MODE.LE&&-1===this._item&&null!==this._leaf.prevLeaf){this._leaf=this._leaf.prevLeaf;this._item=this._leaf.records.length-1}if(-1===this._item){this._eof=!0;this._key=null;this._found=!1;this._record=null}else{this._eof=!1;this._found=this._leaf.keys[this._item]===e;this._key=this._leaf.keys[this._item];this._record=this._leaf.records[this._item]}return!this._eof}},{key:"skip",value:function skip(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;"number"!=typeof e&&(e=1);-1!==this._item&&null!==this._leaf||(this._eof=!0);if(e>0){for(;!this._eof&&this._leaf.keys.length-this._item-1<e;){e=e-this._leaf.keys.length+this._item;this._leaf=this._leaf.nextLeaf;null===this._leaf?this._eof=!0:this._item=0}this._eof||(this._item=this._item+e)}else{e=-e;for(;!this._eof&&this._item<e;){e=e-this._item-1;this._leaf=this._leaf.prevLeaf;null===this._leaf?this._eof=!0:this._item=this._leaf.keys.length-1}this._eof||(this._item=this._item-e)}if(this._eof){this._item=-1;this._found=!1;this._key=null;this._record=null}else{this._found=!0;this._key=this._leaf.keys[this._item];this._record=this._leaf.records[this._item]}return this._found}},{key:"goto",value:function goto(e){if(e<0){this.goBottom();this._eof||this.skip(e+1)}else{this.goTop();this._eof||this.skip(e-1)}return this._found}},{key:"keynum",value:function keynum(){if(null===this._leaf||-1===this._item)return-1;for(var e=this._item+1,t=this._leaf;null!==t.prevLeaf;)e+=(t=t.prevLeaf).keys.length;return e}},{key:"goTop",value:function goTop(){this._leaf=this._root;for(;!this._leaf.isLeaf();)this._leaf=this._leaf.nodePointers[0];if(0===this._leaf.keys.length){this._item=-1;this._eof=!0;this._found=!1;this._key=null;this._record=null}else{this._item=0;this._eof=!1;this._found=!0;this._key=this._leaf.keys[0];this._record=this._leaf.records[0]}return this._found}},{key:"goBottom",value:function goBottom(){this._leaf=this._root;for(;!this._leaf.isLeaf();)this._leaf=this._leaf.nodePointers[this._leaf.nodePointers.length-1];if(0===this._leaf.keys.length){this._item=-1;this._eof=!0;this._found=!1;this._key=null;this._record=null}else{this._item=this._leaf.keys.length-1;this._eof=!1;this._found=!0;this._key=this._leaf.keys[this._item];this._record=this._leaf.records[this._item]}return this._found}},{key:"pack",value:function pack(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null,t=void 0,r=void 0;this.goTop(0);if(this._leaf===this._root)return!1;for(var n=new c(this._nodeId++),a=0,i=this._leaf,s=0,o=[],u=[];;){BTree._modifyNode(e,n);BTree._modifyNode(e,i);n.keys[a]=i.keys[s];n.records[a]=i.records[s];0===a&&u.push(n);if(s===i.keys.length-1){if(null===i.nextLeaf)break;i=i.nextLeaf;s=0}else s++;if(a===this._maxkey-1){var h=new c(this._nodeId++);n.nextLeaf=h;h.prevLeaf=n;n=h;a=0}else a++}var f=this._minkyl-n.keys.length;i=n.prevLeaf;if(f>0&&null!==i){BTree._modifyNode(e,i);for(r=f-1;r>=0;--r){n.keys.unshift(i.keys.pop());n.records.unshift(i.records.pop())}}for(r=1,t=u.length;r<t;++r)o.push(u[r].keys[0]);o[o.length]=null;for(var _=void 0,d=void 0;null!==o[0];){_=o;d=u;o=[];u=[];a=this._maxkey+1;r=0;t=_.length;for(;r<t;r++){if(a>this._maxkey){n=new l(this._nodeId++);a=0;u.push(n)}n.keys[a]=_[r];n.nodePointers[a]=d[r];a++;BTree._modifyNode(e,n)}if((f=this._minkyn-n.keys.length+1)>0&&u.length>1){i=u[u.length-2];BTree._modifyNode(e,i);for(r=f-1;r>=0;--r){n.keys.unshift(i.keys.pop());n.nodePointers.unshift(i.nodePointers.pop())}}r=0;t=u.length;for(;r<t;++r)o.push(u[r].keys.pop())}this._root=u[0];this.goTop();return this._found}},{key:"_del",value:function _del(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null,r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null,n=[],a=null,i=-1;this._leaf=this._root;for(;!this._leaf.isLeaf();){n.push(this._leaf);a=this._leaf;i=this._leaf.getItem(e);this._leaf=this._leaf.nodePointers[i]}this._item=this._leaf.getItem(e,!1);if(-1!==this._item){this._found=!0;this._leaf.keys.splice(this._item,1);this._leaf.records.splice(this._item,1);BTree._modifyNode(t,this._leaf);this._length--;if(this._leaf!==this._root)if(this._leaf.keys.length>=this._minkyl)0===this._item&&BTree._fixNodes(n,e,this._leaf.keys[0],t);else{var s=void 0,o=0===i?null:a.nodePointers[i-1];if(null!==o&&o.keys.length>this._minkyl){s=0===this._item?e:this._leaf.keys[0];this._leaf.keys.unshift(o.keys.pop());this._leaf.records.unshift(o.records.pop());BTree._fixNodes(n,s,this._leaf.keys[0],t);BTree._modifyNode(t,o)}else{var u=i===a.keys.length?null:a.nodePointers[i+1];if(null!==u&&u.keys.length>this._minkyl){this._leaf.keys.push(u.keys.shift());this._leaf.records.push(u.records.shift());0===this._item&&BTree._fixNodes(n,e,this._leaf.keys[0],t);BTree._fixNodes(n,this._leaf.keys[this._leaf.keys.length-1],u.keys[0],t);BTree._modifyNode(t,u)}else{if(null!==o){s=0===this._item?e:this._leaf.keys[0];o.merge(this._leaf,a,s);BTree._modifyNode(t,o);BTree._modifyNode(r,this._leaf);this._leaf=o}else{s=u.keys[0];this._leaf.merge(u,a,s);BTree._modifyNode(t,this._leaf);BTree._modifyNode(r,u);0===this._item&&BTree._fixNodes(n,e,this._leaf.keys[0],t)}if(1!==n.length||0!==a.keys.length)for(var c=n.pop(),l=void 0;c.keys.length<this._minkyn&&n.length>0;){if(null!==(u=(l=(a=n.pop()).getItem(s))===a.keys.length?null:a.nodePointers[l+1])&&u.keys.length>this._minkyn){c.keys.push(a.keys[l]);a.keys[l]=u.keys.shift();c.nodePointers.push(u.nodePointers.shift());BTree._modifyNode(t,c);BTree._modifyNode(t,u);BTree._modifyNode(t,a);break}if(null!==(o=0===l?null:a.nodePointers[l-1])&&o.keys.length>this._minkyn){c.keys.unshift(a.keys[l-1]);a.keys[l-1]=o.keys.pop();c.nodePointers.unshift(o.nodePointers.pop());BTree._modifyNode(t,c);BTree._modifyNode(t,o);BTree._modifyNode(t,a);break}if(null!==o){s=o.merge(c,a,l-1);BTree._modifyNode(r,c);BTree._modifyNode(t,o);c=o}else if(null!==u){s=c.merge(u,a,l);BTree._modifyNode(r,u);BTree._modifyNode(t,c)}if(0===n.length&&0===a.keys.length){this._root=c;break}c=a}else this._root=this._leaf}}}}else this._found=!1}},{key:"goToLowerBound",value:function goToLowerBound(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];if(e!==undefined){var r=this.seek(e,BTree.NEAR_MODE.GE);r&&t&&(r=this.skip());return r}return this.goTop()}},{key:"goToUpperBound",value:function goToUpperBound(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];if(e!==undefined){var r=this.seek(e,BTree.NEAR_MODE.LE);r&&t&&(r=this.skip(-1));return r}return this.goBottom()}},{key:"dump",value:function dump(e){e.clear();for(var t=[this._root];t.length>0;){var r=t.shift();e.set(r.id,r.toJSON());if(r.isLeaf()){r.prevLeaf&&t.push(r.prevLeaf);r.nextLeaf&&t.push(r.nextLeaf)}else for(var n=0;n<r.nodePointers.length;++n)r.nodePointers[n]&&t.push(r.nodePointers[n])}return this._root.id}},{key:"length",get:function get(){return this._length}},{key:"currentKey",get:function get(){return this._key}},{key:"currentRecord",get:function get(){return this._record}}],[{key:"_fixNodes",value:function _fixNodes(e,t,r,n){var a=void 0,i=e.length,s=!0;do{for(var o=(a=e[--i].keys).length-1;o>=0;--o)if(a[o]===t){a[o]=r;BTree._modifyNode(n,e[i]);s=!1;break}}while(s&&i>0)}},{key:"_modifyNode",value:function _modifyNode(e,t){e instanceof _set3["default"]&&t!==undefined&&e.add(t)}},{key:"loadFromJSON",value:function loadFromJSON(e,t,r){var n=new BTree(r),a=t.get(e);n._root=a;for(var i=[a],s=0;i.length>0;){var o=i.shift();s=Math.max(o.id,s);if(o.isLeaf()){var u=t.get(prevLeaf);o.prevLeaf=u||null;o.prevLeaf&&i.push(o.prevLeaf);u=t.get(nextLeaf);o.nextLeaf=u||null;o.nextLeaf&&i.push(o.nextLeaf)}else for(var c=0;c<o.nodePointers.length;++c){var l=t.get(o.nodePointers[c]);(l=l||null)&&i.push(l);o.nodePointers[c]=l}}n._nodeId=s+1}}]);return BTree}();h.NEAR_MODE={NONE:0,LE:1,GE:2};t.register(h);var f=function(){function TreeTransaction(e){(0,_classCallCheck3["default"])(this,TreeTransaction);this._tree=e;this._modified=new _set3["default"];this._removed=new _set3["default"]}(0,_createClass3["default"])(TreeTransaction,[{key:"merge",value:function merge(e){if(!(e instanceof TreeTransaction))return this;this._removed=this._removed.union(e.removed);this._modified=this._modified.union(e.modified).difference(this._removed);return this}},{key:"insert",value:function insert(e,t){return this._tree.insert(e,t,this._modified)}},{key:"remove",value:function remove(e){return this._tree.remove(e,this._modified,this._removed)}},{key:"seek",value:function seek(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:h.NEAR_MODE.NONE;return this._tree.seek(e,t)}},{key:"skip",value:function skip(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;return this._tree.skip(e)}},{key:"goto",value:function goto(e){return this._tree.goto(e)}},{key:"keynum",value:function keynum(){return this._tree.keynum()}},{key:"goTop",value:function goTop(){return this._tree.goTop()}},{key:"goBottom",value:function goBottom(){return this._tree.goBottom()}},{key:"pack",value:function pack(){return this._tree.pack()}},{key:"goToLowerBound",value:function goToLowerBound(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];return this._tree.goToLowerBound(e,t)}},{key:"goToUpperBound",value:function goToUpperBound(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];return this._tree.goToUpperBound(e,t)}},{key:"modified",get:function get(){return this._modified}},{key:"removed",get:function get(){return this._removed}},{key:"root",get:function get(){return this._tree._root}},{key:"length",get:function get(){return this._tree.length}},{key:"currentKey",get:function get(){return this._tree.currentKey}},{key:"currentRecord",get:function get(){this._tree.currentLeaf!==undefined&&this._modified.add(this._tree.currentLeaf);return this._tree.currentRecord}}]);return TreeTransaction}();t.register(f);var _=function(){function BufferUtils(){(0,_classCallCheck3["default"])(this,BufferUtils)}(0,_createClass3["default"])(BufferUtils,null,[{key:"_codePointTextDecoder",value:function _codePointTextDecoder(e){if("undefined"==typeof TextDecoder)throw new Error("TextDecoder not supported");if(null===BufferUtils._ISO_8859_15_DECODER)throw new Error("TextDecoder does not supprot iso-8859-15");if(BufferUtils._ISO_8859_15_DECODER===undefined)try{BufferUtils._ISO_8859_15_DECODER=new TextDecoder("iso-8859-15")}finally{BufferUtils._ISO_8859_15_DECODER=null}return BufferUtils._ISO_8859_15_DECODER.decode(e).replace("","").replace("","").replace("","").replace("","").replace("","").replace("","").replace("","").replace("","")}},{key:"_tripletToBase64",value:function _tripletToBase64(e){return BufferUtils._BASE64_LOOKUP[e>>18&63]+BufferUtils._BASE64_LOOKUP[e>>12&63]+BufferUtils._BASE64_LOOKUP[e>>6&63]+BufferUtils._BASE64_LOOKUP[63&e]}},{key:"_base64encodeChunk",value:function _base64encodeChunk(e,t,r){for(var n=void 0,a=[],i=t;i<r;i+=3){n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]);a.push(BufferUtils._tripletToBase64(n))}return a.join("")}},{key:"_base64fromByteArray",value:function _base64fromByteArray(e){for(var t=void 0,r=e.length,n=r%3,a="",i=[],s=0,o=r-n;s<o;s+=16383)i.push(BufferUtils._base64encodeChunk(e,s,s+16383>o?o:s+16383));if(1===n){t=e[r-1];a+=BufferUtils._BASE64_LOOKUP[t>>2];a+=BufferUtils._BASE64_LOOKUP[t<<4&63];a+="=="}else if(2===n){t=(e[r-2]<<8)+e[r-1];a+=BufferUtils._BASE64_LOOKUP[t>>10];a+=BufferUtils._BASE64_LOOKUP[t>>4&63];a+=BufferUtils._BASE64_LOOKUP[t<<2&63];a+="="}i.push(a);return i.join("")}},{key:"toBase64",value:function toBase64(e){if("undefined"!=typeof Buffer&&"undefined"==typeof window)return new Buffer(e).toString("base64");if("undefined"!=typeof TextDecoder&&null!==BufferUtils._ISO_8859_15_DECODER)try{return btoa(BufferUtils._codePointTextDecoder(new Uint8Array(e)))}catch(t){}return BufferUtils._base64fromByteArray(new Uint8Array(e))}},{key:"fromBase64",value:function fromBase64(e){return Uint8Array.from(atob(e),function(e){return e.charCodeAt(0)})}}]);return BufferUtils}();_.BASE64_ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";_._BASE64_LOOKUP=[];for(var d=0,p=_.BASE64_ALPHABET.length;d<p;++d)_._BASE64_LOOKUP[d]=_.BASE64_ALPHABET[d];t.register(_);var g=function(){function JSONUtils(){(0,_classCallCheck3["default"])(this,JSONUtils)}(0,_createClass3["default"])(JSONUtils,null,[{key:"stringify",value:function stringify(e){return(0,_stringify2["default"])(e,JSONUtils.jsonifyType)}},{key:"parse",value:function parse(e){return JSON.parse(e,JSONUtils.parseType)}},{key:"parseType",value:function parseType(e,t){if(t[JSONUtils.TYPE_SYMBOL])switch(t[JSONUtils.TYPE_SYMBOL]){case"Uint8Array":return _.fromBase64(t[JSONUtils.VALUE_SYMBOL]);case"Set":return _set3["default"].from(t[JSONUtils.VALUE_SYMBOL])}return t}},{key:"jsonifyType",value:function jsonifyType(e,t){return t instanceof Uint8Array?JSONUtils.typedObject("Uint8Array",_.toBase64(t)):t instanceof _set3["default"]?JSONUtils.typedObject("Set",(0,_from2["default"])(t)):t}},{key:"typedObject",value:function typedObject(e,t){var r={};r[JSONUtils.TYPE_SYMBOL]=e;r[JSONUtils.VALUE_SYMBOL]=t;return r}}]);return JSONUtils}();g.TYPE_SYMBOL="__";g.VALUE_SYMBOL="value";t.register(g);var y=function(){(0,_createClass3["default"])(Log,null,[{key:"instance",get:function get(){Log._instance||(Log._instance=new Log(new n));return Log._instance}}]);function Log(e){(0,_classCallCheck3["default"])(this,Log);this._native=e}(0,_createClass3["default"])(Log,[{key:"setLoggable",value:function setLoggable(e,t){this._native.setLoggable(e,t)}},{key:"msg",value:function msg(e,t,r){if(this._native.isLoggable(t,e)){for(var n=0;n<r.length;++n){"function"==typeof r[n]&&(r[n]=r[n]());"object"===(0,_typeof3["default"])(r[n])&&("function"==typeof r[n].toString?r[n]=r[n].toString():r[n].constructor&&r[n].constructor.name?r[n]="{Object: "+r[n].constructor.name+"}":r[n]="{Object}")}this._native.msg(e,t,r)}}},{key:"level",get:function get(){return this._native._global_level},set:function set(e){this._native._global_level=e}}],[{key:"d",value:function d(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.DEBUG,e,n)}},{key:"e",value:function e(t,r){for(var n=arguments.length,a=Array(n>2?n-2:0),i=2;i<n;i++)a[i-2]=arguments[i];if(arguments.length>=2){t=arguments[0];a=Array.prototype.slice.call(arguments,1)}else{t=undefined;a=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.ERROR,t,a)}},{key:"i",value:function i(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.INFO,e,n)}},{key:"v",value:function v(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.VERBOSE,e,n)}},{key:"w",value:function w(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.WARNING,e,n)}},{key:"t",value:function t(e,r){for(var n=arguments.length,a=Array(n>2?n-2:0),i=2;i<n;i++)a[i-2]=arguments[i];if(arguments.length>=2){e=arguments[0];a=Array.prototype.slice.call(arguments,1)}else{e=undefined;a=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.TRACE,e,a)}}]);return Log}();y.Level={TRACE:1,VERBOSE:2,DEBUG:3,INFO:4,WARNING:5,ERROR:6,ASSERT:7,toStringTag:function toStringTag(e){switch(e){case y.TRACE:return"T";case y.VERBOSE:return"V";case y.DEBUG:return"D";case y.INFO:return"I";case y.WARNING:return"W";case y.ERROR:return"E";case y.ASSERT:return"A";default:return"*"}}};y.TRACE=y.Level.TRACE;y.VERBOSE=y.Level.VERBOSE;y.DEBUG=y.Level.DEBUG;y.INFO=y.Level.INFO;y.WARNING=y.Level.WARNING;y.ERROR=y.Level.ERROR;y.ASSERT=y.Level.ASSERT;y._instance=null;y.d.tag=function(e){return y.d.bind(null,e)};y.e.tag=function(e){return y.e.bind(null,e)};y.i.tag=function(e){return y.i.bind(null,e)};y.v.tag=function(e){return y.v.bind(null,e)};y.w.tag=function(e){return y.w.bind(null,e)};y.t.tag=function(e){return y.t.bind(null,e)};t.register(y);var v=function(){function LRUMap(e){(0,_classCallCheck3["default"])(this,LRUMap);this._maxSize=e;this._map=new _map2["default"];this._numAccesses=new _map2["default"];this._accessQueue=[]}(0,_createClass3["default"])(LRUMap,[{key:"clear",value:function clear(){this._numAccesses.clear();this._accessQueue=[];return this._map.clear()}},{key:"delete",value:function _delete(e){return this._map["delete"](e)}},{key:"entries",value:function entries(){return this._map.entries()}},{key:"forEach",value:function forEach(e,t){return this._map.forEach(e,t)}},{key:"get",value:function get(e){this.access(e);return this._map.get(e)}},{key:"has",value:function has(e){return this._map.has(e)}},{key:"keys",value:function keys(){return this._map.keys()}},{key:"evict",value:function evict(){for(var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;e>0&&this._accessQueue.length>0;){var t=this._accessQueue.shift(),r=this._numAccesses.get(t);--r;this._numAccesses.set(t,r);if(0===r){this._numAccesses["delete"](t);this["delete"](t)&&--e}}}},{key:"access",value:function access(e){if(this._map.has(e)){var t=0;this._numAccesses.has(e)&&(t=this._numAccesses.get(e));++t;this._numAccesses.set(e,t);this._accessQueue.push(e)}}},{key:"set",value:function set(e,t){this.size>=this._maxSize&&this.evict();this._map.set(e,t);this.access(e)}},{key:"values",value:function values(){return this._map.values()}},{key:_iterator178["default"],value:function value(){return this._map.entries()}},{key:"size",get:function get(){return this._map.size}}]);return LRUMap}();t.register(v);var k=function(){function ObjectUtils(){(0,_classCallCheck3["default"])(this,ObjectUtils)}(0,_createClass3["default"])(ObjectUtils,null,[{key:"byKeyPath",value:function byKeyPath(e,t){if(!Array.isArray(t))return e[t];var r=e,n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(t);!(n=(s=o.next()).done);n=!0){var u=s.value;if(r===undefined)return undefined;r=r[u]}}catch(c){a=!0;i=c}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}return r}}]);return ObjectUtils}();t.register(k);var m=function(){(0,_createClass3["default"])(Observable,null,[{key:"WILDCARD",get:function get(){return"*"}}]);function Observable(){(0,_classCallCheck3["default"])(this,Observable);this._listeners=new _map2["default"]}(0,_createClass3["default"])(Observable,[{key:"on",value:function on(e,t){if(this._listeners.has(e))return this._listeners.get(e).push(t)-1;this._listeners.set(e,[t]);return 0}},{key:"off",value:function off(e,t){this._listeners.has(e)&&this._listeners.get(e)[t]&&delete this._listeners.get(e)[t]}},{key:"fire",value:function fire(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(this._listeners.has(e))for(var a in this._listeners.get(e)){this._listeners.get(e)[a].apply(null,r)}if(this._listeners.has(Observable.WILDCARD))for(var i in this._listeners.get(Observable.WILDCARD)){this._listeners.get(Observable.WILDCARD)[i].apply(null,arguments)}}},{key:"bubble",value:function bubble(e){for(var t=this,r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];var i=!0,s=!1,o=undefined;try{for(var u,c=function _loop(){var r=u.value,n=void 0;n=r==Observable.WILDCARD?function callback(){this.fire.apply(this,arguments)}:function callback(){this.fire.apply(this,[r].concat(Array.prototype.slice.call(arguments)))};e.on(r,n.bind(t))},l=(0,_getIterator3["default"])(n);!(i=(u=l.next()).done);i=!0)c()}catch(h){s=!0;o=h}finally{try{!i&&l["return"]&&l["return"]()}finally{if(s)throw o}}}}]);return Observable}();t.register(m);_set3["default"].prototype.union=function(e){var t=new _set3["default"](this),r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(e);!(r=(i=s.next()).done);r=!0){var o=i.value;t.add(o)}}catch(u){n=!0;a=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}return t};_set3["default"].prototype.intersection=function(e){var t=new _set3["default"],r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(e);!(r=(i=s.next()).done);r=!0){var o=i.value;this.has(o)&&t.add(o)}}catch(u){n=!0;a=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}return t};_set3["default"].prototype.difference=function(e){var t=new _set3["default"](this),r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(e);!(r=(i=s.next()).done);r=!0){var o=i.value;t["delete"](o)}}catch(u){n=!0;a=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}return t};_set3["default"].prototype.equals=function(e){if(this.size!==e.size)return!1;var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(e);!(t=(a=i.next()).done);t=!0){var s=a.value;if(!this.has(s))return!1}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return!0};Set.from=function(e){return e&&"function"==typeof e[_iterator178["default"]]&&"string"!=typeof e?new _set3["default"](e):new _set3["default"]([e])};Set.sampleElement=function(e){return e.size>0?e.values().next().value:undefined};var b=function(e){(0,_inherits3["default"])(Synchronizer,e);function Synchronizer(){(0,_classCallCheck3["default"])(this,Synchronizer);var e=(0,_possibleConstructorReturn3["default"])(this,(Synchronizer.__proto__||(0,_getPrototypeOf2["default"])(Synchronizer)).call(this));e._queue=[];e._working=!1;return e}(0,_createClass3["default"])(Synchronizer,[{key:"push",value:function push(e){var t=this;return new _promise2["default"](function(r,n){t._queue.push({fn:e,resolve:r,error:n});t._working||t._doWork()["catch"](y.w.tag(Synchronizer))})}},{key:"_doWork",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee28(){var e,t;return _regenerator2["default"].wrap(function _callee28$(r){for(;;)switch(r.prev=r.next){case 0:this._working=!0;this.fire("work-start",this);case 2:if(!this._queue.length){r.next=16;break}e=this._queue.shift();r.prev=4;r.next=7;return e.fn();case 7:t=r.sent;e.resolve(t);r.next=14;break;case 11:r.prev=11;r.t0=r["catch"](4);e.error&&e.error(r.t0);case 14:r.next=2;break;case 16:this._working=!1;this.fire("work-end",this);case 18:case"end":return r.stop()}},_callee28,this,[[4,11]])}));return function _doWork(){return e.apply(this,arguments)}}()},{key:"working",get:function get(){return this._working}}]);return Synchronizer}(m);t.register(b);var C=function(){function CachedBackend(e){(0,_classCallCheck3["default"])(this,CachedBackend);this._backend=e;this._cache=new v(CachedBackend.MAX_CACHE_SIZE)}(0,_createClass3["default"])(CachedBackend,[{key:"_retrieveValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee29(e){var t,r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee29$(u){for(;;)switch(u.prev=u.next){case 0:t=[];r=!0;n=!1;a=undefined;u.prev=4;for(i=(0,_getIterator3["default"])(e);!(r=(s=i.next()).done);r=!0){o=s.value;t.push(this.get(o))}u.next=12;break;case 8:u.prev=8;u.t0=u["catch"](4);n=!0;a=u.t0;case 12:u.prev=12;u.prev=13;!r&&i["return"]&&i["return"]();case 15:u.prev=15;if(!n){u.next=18;break}throw a;case 18:return u.finish(15);case 19:return u.finish(12);case 20:return u.abrupt("return",_promise2["default"].all(t));case 21:case"end":return u.stop()}},_callee29,this,[[4,8,12,20],[13,,15,19]])}));return function _retrieveValues(t){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee30(e){var t;return _regenerator2["default"].wrap(function _callee30$(r){for(;;)switch(r.prev=r.next){case 0:if(!this._cache.has(e)){r.next=2;break}return r.abrupt("return",this._cache.get(e));case 2:r.next=4;return this._backend.get(e);case 4:t=r.sent;this._cache.set(e,t);return r.abrupt("return",t);case 7:case"end":return r.stop()}},_callee30,this)}));return function get(t){return e.apply(this,arguments)}}()},{key:"put",value:function put(e,t){this._cache.set(e,t);return this._backend.put(e,t)}},{key:"remove",value:function remove(e){this._cache["delete"](e);return this._backend.remove(e)}},{key:"keys",value:function keys(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return this._backend.keys(e)}},{key:"values",value:function values(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return this._backend.values(e)}},{key:"keyStream",value:function keyStream(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return this._backend.keyStream(e,t,r)}},{key:"valueStream",value:function valueStream(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return this._backend.valueStream(e,t,r)}},{key:"maxValue",value:function maxValue(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return this._backend.maxValue(e)}},{key:"maxKey",value:function maxKey(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return this._backend.maxKey(e)}},{key:"minKey",value:function minKey(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return this._backend.minKey(e)}},{key:"minValue",value:function minValue(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return this._backend.minValue(e)}},{key:"count",value:function count(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return this._backend.count(e)}},{key:"commit",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee31(e){return _regenerator2["default"].wrap(function _callee31$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Unsupported operation");case 1:case"end":return e.stop()}},_callee31,this)}));return function commit(t){return e.apply(this,arguments)}}()},{key:"abort",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee32(e){return _regenerator2["default"].wrap(function _callee32$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Unsupported operation");case 1:case"end":return e.stop()}},_callee32,this)}));return function abort(t){return e.apply(this,arguments)}}()},{key:"_apply",value:function _apply(e){this._applyLocally(e);return this._backend._apply(e)}},{key:"_applyLocally",value:function _applyLocally(e){e._truncated&&this._cache.clear();var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(e._removed);!(t=(a=i.next()).done);t=!0){var s=a.value;this._cache["delete"](s)}}catch(p){r=!0;n=p}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}var o=!0,u=!1,c=undefined;try{for(var l,h=(0,_getIterator3["default"])(e._modified);!(o=(l=h.next()).done);o=!0){var f=(0,_slicedToArray3["default"])(l.value,2),_=f[0],d=f[1];this._cache.set(_,d)}}catch(p){u=!0;c=p}finally{try{!o&&h["return"]&&h["return"]()}finally{if(u)throw c}}}},{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee33(){return _regenerator2["default"].wrap(function _callee33$(e){for(;;)switch(e.prev=e.next){case 0:this._cache.clear();return e.abrupt("return",this._backend.truncate());case 2:case"end":return e.stop()}},_callee33,this)}));return function truncate(){return e.apply(this,arguments)}}()},{key:"index",value:function index(e){return this._backend.index(e)}},{key:"createIndex",value:function createIndex(e,t){var r=arguments.length>2&&arguments[2]!==undefined&&arguments[2];return this._backend.createIndex(e,t,r)}},{key:"deleteIndex",value:function deleteIndex(e){return this._backend.deleteIndex(e)}},{key:"close",value:function close(){return this._backend.close()}},{key:"transaction",value:function transaction(){throw new Error("Unsupported operation")}},{key:"applyCombined",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee34(e){var t=this;return _regenerator2["default"].wrap(function _callee34$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._backend.applyCombined(e);case 2:r.t0=r.sent;r.t1=function(){return t._applyLocally(e)};return r.abrupt("return",[r.t0,r.t1]);case 5:case"end":return r.stop()}},_callee34,this)}));return function applyCombined(t){return e.apply(this,arguments)}}()},{key:"isSynchronous",value:function isSynchronous(){return!1}},{key:"connected",get:function get(){return this._backend.connected}},{key:"indices",get:function get(){return this._backend.indices}}]);return CachedBackend}();C.MAX_CACHE_SIZE=5e3;t.register(C);var w=function(){function InMemoryIndex(e,t){var r=arguments.length>2&&arguments[2]!==undefined&&arguments[2],n=arguments.length>3&&arguments[3]!==undefined&&arguments[3];(0,_classCallCheck3["default"])(this,InMemoryIndex);this._objectStore=e;this._keyPath=t;this._multiEntry=r;this._unique=n;this._tree=new h}(0,_createClass3["default"])(InMemoryIndex,[{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee35(){return _regenerator2["default"].wrap(function _callee35$(e){for(;;)switch(e.prev=e.next){case 0:this._tree=new h;case 1:case"end":return e.stop()}},_callee35,this)}));return function truncate(){return e.apply(this,arguments)}}()},{key:"_indexKey",value:function _indexKey(e,t){return this.keyPath?t===undefined?undefined:k.byKeyPath(t,this.keyPath):e}},{key:"_insert",value:function _insert(e,t,r){r=r||this._tree;this._multiEntry&&Array.isArray(t)||(t=[t]);var n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(t);!(n=(s=o.next()).done);n=!0){var u=s.value;if(r.seek(u)){if(this._unique)throw new Error("Uniqueness constraint violated for key "+e+" on path "+this._keyPath);r.currentRecord.add(e)}else r.insert(u,this._unique?e:_set3["default"].from(e))}}catch(c){a=!0;i=c}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}}},{key:"put",value:function put(e,t,r){var n=this._tree.transaction(),a=this._indexKey(e,r),i=this._indexKey(e,t);a!==undefined&&this._remove(e,a,n);i!==undefined&&this._insert(e,i,n);return n}},{key:"remove",value:function remove(e,t){var r=this._tree.transaction();if(t!==undefined){var n=this._indexKey(e,t);this._remove(e,n,r)}return r}},{key:"_remove",value:function _remove(e,t,r){r=r||this._tree;this._multiEntry&&Array.isArray(t)||(t=[t]);var n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(t);!(n=(s=o.next()).done);n=!0){var u=s.value;r.seek(u)&&(!this._unique&&r.currentRecord.size>1?r.currentRecord["delete"](e):r.remove(u))}}catch(c){a=!0;i=c}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}}},{key:"_retrieveValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee36(e){var t,r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee36$(u){for(;;)switch(u.prev=u.next){case 0:t=[];r=!0;n=!1;a=undefined;u.prev=4;for(i=(0,_getIterator3["default"])(e);!(r=(s=i.next()).done);r=!0){o=s.value;t.push(this._objectStore.get(o))}u.next=12;break;case 8:u.prev=8;u.t0=u["catch"](4);n=!0;a=u.t0;case 12:u.prev=12;u.prev=13;!r&&i["return"]&&i["return"]();case 15:u.prev=15;if(!n){u.next=18;break}throw a;case 18:return u.finish(15);case 19:return u.finish(12);case 20:return u.abrupt("return",_promise2["default"].all(t));case 21:case"end":return u.stop()}},_callee36,this,[[4,8,12,20],[13,,15,19]])}));return function _retrieveValues(t){return e.apply(this,arguments)}}()},{key:"values",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee37(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee37$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.keys(t);case 2:e=r.sent;return r.abrupt("return",this._retrieveValues(e));case 4:case"end":return r.stop()}},_callee37,this)}));return function values(){return e.apply(this,arguments)}}()},{key:"keys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee38(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee38$(r){for(;;)switch(r.prev=r.next){case 0:e=new _set3["default"];if(!(t instanceof S&&t.exactMatch)){r.next=4;break}this._tree.seek(t.lower)&&(e=_set3["default"].from(this._tree.currentRecord));return r.abrupt("return",e);case 4:if(t instanceof S){r.next=8;break}this._tree.goTop();r.next=10;break;case 8:if(this._tree.goToLowerBound(t.lower,t.lowerOpen)){r.next=10;break}return r.abrupt("return",e);case 10:if(t instanceof S&&!t.includes(this._tree.currentKey)){r.next=16;break}e=e.union(_set3["default"].from(this._tree.currentRecord));if(this._tree.skip()){r.next=14;break}return r.abrupt("break",16);case 14:r.next=10;break;case 16:return r.abrupt("return",e);case 17:case"end":return r.stop()}},_callee38,this)}));return function keys(){return e.apply(this,arguments)}}()},{key:"keyStream",value:function keyStream(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!this._unique)throw new Error("Unsupported operation for non-unique indices");if(r instanceof S){if(t){if(!this._tree.goToLowerBound(r.lower,r.lowerOpen))return _promise2["default"].resolve()}else if(!this._tree.goToUpperBound(r.upper,r.upperOpen))return _promise2["default"].resolve()}else t?this._tree.goTop():this._tree.goBottom();for(;(!(r instanceof S)||r.includes(this._tree.currentKey))&&e(this._tree.currentRecord)&&this._tree.skip(t?1:-1););return _promise2["default"].resolve()}},{key:"valueStream",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee39(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return _regenerator2["default"].wrap(function _callee39$(n){for(;;)switch(n.prev=n.next){case 0:if(this._unique){n.next=2;break}throw new Error("Unsupported operation for non-unique indices");case 2:if(r instanceof S){n.next=6;break}t?this._tree.goTop():this._tree.goBottom();n.next=13;break;case 6:if(!t){n.next=11;break}if(this._tree.goToLowerBound(r.lower,r.lowerOpen)){n.next=9;break}return n.abrupt("return");case 9:n.next=13;break;case 11:if(this._tree.goToUpperBound(r.upper,r.upperOpen)){n.next=13;break}return n.abrupt("return");case 13:if(r instanceof S&&!r.includes(this._tree.currentKey)){n.next=25;break}n.t0=e;n.next=17;return this._objectStore.get(this._tree.currentRecord);case 17:n.t1=n.sent;n.t2=this._tree.currentRecord;if((0,n.t0)(n.t1,n.t2)){n.next=21;break}return n.abrupt("break",25);case 21:if(this._tree.skip(t?1:-1)){n.next=23;break}return n.abrupt("break",25);case 23:n.next=13;break;case 25:case"end":return n.stop()}},_callee39,this)}));return function valueStream(t){return e.apply(this,arguments)}}()},{key:"maxValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee40(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee40$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.maxKeys(t);case 2:e=r.sent;return r.abrupt("return",this._retrieveValues(e));case 4:case"end":return r.stop()}},_callee40,this)}));return function maxValues(){return e.apply(this,arguments)}}()},{key:"maxKeys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee41(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee41$(r){for(;;)switch(r.prev=r.next){case 0:e=t instanceof S;if(this._tree.goToUpperBound(e?t.upper:undefined,!!e&&t.upperOpen)){r.next=3;break}return r.abrupt("return",new _set3["default"]);case 3:return r.abrupt("return",_set3["default"].from(this._tree.currentRecord));case 4:case"end":return r.stop()}},_callee41,this)}));return function maxKeys(){return e.apply(this,arguments)}}()},{key:"minValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee42(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee42$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.minKeys(t);case 2:e=r.sent;return r.abrupt("return",this._retrieveValues(e));case 4:case"end":return r.stop()}},_callee42,this)}));return function minValues(){return e.apply(this,arguments)}}()},{key:"minKeys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee43(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee43$(r){for(;;)switch(r.prev=r.next){case 0:e=t instanceof S;if(this._tree.goToLowerBound(e?t.lower:undefined,!!e&&t.lowerOpen)){r.next=3;break}return r.abrupt("return",new _set3["default"]);case 3:return r.abrupt("return",_set3["default"].from(this._tree.currentRecord));case 4:case"end":return r.stop()}},_callee43,this)}));return function minKeys(){return e.apply(this,arguments)}}()},{key:"count",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee44(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee44$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this.keys(e);case 2:return t.abrupt("return",t.sent.size);case 3:case"end":return t.stop()}},_callee44,this)}));return function count(){return e.apply(this,arguments)}}()},{key:"keyPath",get:function get(){return this._keyPath}},{key:"multiEntry",get:function get(){return this._multiEntry}}]);return InMemoryIndex}();t.register(w);var A=function(){function InMemoryBackend(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;(0,_classCallCheck3["default"])(this,InMemoryBackend);this._cache=new _map2["default"];this._indices=new _map2["default"];this._primaryIndex=new w(this,undefined,!1,!0);this._tableName=e;this._codec=t}(0,_createClass3["default"])(InMemoryBackend,[{key:"getSync",value:function getSync(e){return this.decode(this._cache.get(e),e)}},{key:"get",value:function get(e){return _promise2["default"].resolve(this.getSync(e))}},{key:"putSync",value:function putSync(e,t){var r=this.getSync(e);this._cache.set(e,this.encode(t));this._primaryIndex.put(e,t,r);var n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(this._indices.values());!(n=(s=o.next()).done);n=!0){s.value.put(e,t,r)}}catch(u){a=!0;i=u}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}}},{key:"put",value:function put(e,t){this.putSync(e,t);return _promise2["default"].resolve()}},{key:"removeSync",value:function removeSync(e){var t=this.getSync(e);this._cache["delete"](e);this._primaryIndex.remove(e,t);var r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(this._indices.values());!(r=(i=s.next()).done);r=!0){i.value.remove(e,t)}}catch(o){n=!0;a=o}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}}},{key:"remove",value:function remove(e){this.removeSync(e);return _promise2["default"].resolve()}},{key:"values",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee45(){var e,t,r,n,a,i,s,o=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee45$(u){for(;;)switch(u.prev=u.next){case 0:if(!(null!==o&&o instanceof E)){u.next=2;break}return u.abrupt("return",o.values(this));case 2:e=[];t=!0;r=!1;n=undefined;u.prev=6;a=(0,_getIterator3["default"])(this.keys(o));case 8:if(t=(i=a.next()).done){u.next=18;break}s=i.value;u.t0=e;u.next=13;return this.get(s);case 13:u.t1=u.sent;u.t0.push.call(u.t0,u.t1);case 15:t=!0;u.next=8;break;case 18:u.next=24;break;case 20:u.prev=20;u.t2=u["catch"](6);r=!0;n=u.t2;case 24:u.prev=24;u.prev=25;!t&&a["return"]&&a["return"]();case 27:u.prev=27;if(!r){u.next=30;break}throw n;case 30:return u.finish(27);case 31:return u.finish(24);case 32:return u.abrupt("return",_promise2["default"].resolve(e));case 33:case"end":return u.stop()}},_callee45,this,[[6,20,24,32],[25,,27,31]])}));return function values(){return e.apply(this,arguments)}}()},{key:"keys",value:function keys(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return null!==e&&e instanceof E?e.keys(this):this._primaryIndex.keys(e)}},{key:"keyStream",value:function keyStream(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return this._primaryIndex.keyStream(e,t,r)}},{key:"valueStream",value:function valueStream(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return this._primaryIndex.valueStream(e,t,r)}},{key:"maxValue",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee46(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee46$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.maxKey(t);case 2:e=r.sent;return r.abrupt("return",this.get(e));case 4:case"end":return r.stop()}},_callee46,this)}));return function maxValue(){return e.apply(this,arguments)}}()},{key:"maxKey",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee47(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee47$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._primaryIndex.maxKeys(t);case 2:e=r.sent;return r.abrupt("return",_set3["default"].sampleElement(e));case 4:case"end":return r.stop()}},_callee47,this)}));return function maxKey(){return e.apply(this,arguments)}}()},{key:"minValue",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee48(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee48$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.minKey(t);case 2:e=r.sent;return r.abrupt("return",this.get(e));case 4:case"end":return r.stop()}},_callee48,this)}));return function minValue(){return e.apply(this,arguments)}}()},{key:"minKey",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee49(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee49$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._primaryIndex.minKeys(t);case 2:e=r.sent;return r.abrupt("return",_set3["default"].sampleElement(e));case 4:case"end":return r.stop()}},_callee49,this)}));return function minKey(){return e.apply(this,arguments)}}()},{key:"count",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee50(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee50$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this.keys(e);case 2:return t.abrupt("return",t.sent.size);case 3:case"end":return t.stop()}},_callee50,this)}));return function count(){return e.apply(this,arguments)}}()},{key:"index",value:function index(e){return this._indices.get(e)}},{key:"_apply",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee51(e){var t,r,n,a,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m,b;return _regenerator2["default"].wrap(function _callee51$(C){for(;;)switch(C.prev=C.next){case 0:if(!e._truncated){C.next=3;break}C.next=3;return this.truncate();case 3:t=!0;r=!1;n=undefined;C.prev=6;a=(0,_getIterator3["default"])(e._removed);case 8:if(t=(i=a.next()).done){C.next=15;break}s=i.value;C.next=12;return this._cache["delete"](s);case 12:t=!0;C.next=8;break;case 15:C.next=21;break;case 17:C.prev=17;C.t0=C["catch"](6);r=!0;n=C.t0;case 21:C.prev=21;C.prev=22;!t&&a["return"]&&a["return"]();case 24:C.prev=24;if(!r){C.next=27;break}throw n;case 27:return C.finish(24);case 28:return C.finish(21);case 29:o=!0;u=!1;c=undefined;C.prev=32;l=(0,_getIterator3["default"])(e._modified);case 34:if(o=(h=l.next()).done){C.next=41;break}f=(0,_slicedToArray3["default"])(h.value,2),_=f[0],d=f[1];C.next=38;return this._cache.set(_,this.encode(d));case 38:o=!0;C.next=34;break;case 41:C.next=47;break;case 43:C.prev=43;C.t1=C["catch"](32);u=!0;c=C.t1;case 47:C.prev=47;C.prev=48;!o&&l["return"]&&l["return"]();case 50:C.prev=50;if(!u){C.next=53;break}throw c;case 53:return C.finish(50);case 54:return C.finish(47);case 55:p=[InMemoryBackend._indexApply(this._primaryIndex,e)];g=!0;y=!1;v=undefined;C.prev=59;for(k=(0,_getIterator3["default"])(this._indices.values());!(g=(m=k.next()).done);g=!0){b=m.value;p.push(InMemoryBackend._indexApply(b,e))}C.next=67;break;case 63:C.prev=63;C.t2=C["catch"](59);y=!0;v=C.t2;case 67:C.prev=67;C.prev=68;!g&&k["return"]&&k["return"]();case 70:C.prev=70;if(!y){C.next=73;break}throw v;case 73:return C.finish(70);case 74:return C.finish(67);case 75:return C.abrupt("return",_promise2["default"].all(p));case 76:case"end":return C.stop()}},_callee51,this,[[6,17,21,29],[22,,24,28],[32,43,47,55],[48,,50,54],[59,63,67,75],[68,,70,74]])}));return function _apply(t){return e.apply(this,arguments)}}()},{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee52(){var e,t,r,n,a,i,s;return _regenerator2["default"].wrap(function _callee52$(o){for(;;)switch(o.prev=o.next){case 0:this._cache.clear();e=[this._primaryIndex.truncate()];t=!0;r=!1;n=undefined;o.prev=5;for(a=(0,_getIterator3["default"])(this._indices.values());!(t=(i=a.next()).done);t=!0){s=i.value;e.push(s.truncate())}o.next=13;break;case 9:o.prev=9;o.t0=o["catch"](5);r=!0;n=o.t0;case 13:o.prev=13;o.prev=14;!t&&a["return"]&&a["return"]();case 16:o.prev=16;if(!r){o.next=19;break}throw n;case 19:return o.finish(16);case 20:return o.finish(13);case 21:return o.abrupt("return",_promise2["default"].all(e));case 22:case"end":return o.stop()}},_callee52,this,[[5,9,13,21],[14,,16,20]])}));return function truncate(){return e.apply(this,arguments)}}()},{key:"map",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee53(e){var t,r,n,a,i,s,o,u;return _regenerator2["default"].wrap(function _callee53$(c){for(;;)switch(c.prev=c.next){case 0:t=!0;r=!1;n=undefined;c.prev=3;for(a=(0,_getIterator3["default"])(this._cache);!(t=(i=a.next()).done);t=!0){s=(0,_slicedToArray3["default"])(i.value,2),o=s[0],u=s[1];e(o,u)}c.next=11;break;case 7:c.prev=7;c.t0=c["catch"](3);r=!0;n=c.t0;case 11:c.prev=11;c.prev=12;!t&&a["return"]&&a["return"]();case 14:c.prev=14;if(!r){c.next=17;break}throw n;case 17:return c.finish(14);case 18:return c.finish(11);case 19:case"end":return c.stop()}},_callee53,this,[[3,7,11,19],[12,,14,18]])}));return function map(t){return e.apply(this,arguments)}}()},{key:"createIndex",value:function createIndex(e,t){var r=arguments.length>2&&arguments[2]!==undefined&&arguments[2],n=new w(this,t=t||e,r);this._indices.set(e,n)}},{key:"decode",value:function decode(e,t){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.decode(e,t):e}},{key:"encode",value:function encode(e){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.encode(e):e}},{key:"applyCombined",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee54(e){var t=this;return _regenerator2["default"].wrap(function _callee54$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",function(){return t._apply(e)});case 1:case"end":return r.stop()}},_callee54,this)}));return function applyCombined(t){return e.apply(this,arguments)}}()},{key:"isSynchronous",value:function isSynchronous(){return!0}},{key:"isCached",value:function isCached(e){return!0}},{key:"connected",get:function get(){return!0}},{key:"indices",get:function get(){return this._indices}},{key:"tableName",get:function get(){return this._tableName}}],[{key:"_indexApply",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee55(e,t){var r,n,a,i,s,o,u,c,l,h,f,_,d,p;return _regenerator2["default"].wrap(function _callee55$(g){for(;;)switch(g.prev=g.next){case 0:if(!t._truncated){g.next=3;break}g.next=3;return e.truncate();case 3:r=!0;n=!1;a=undefined;g.prev=6;i=(0,_getIterator3["default"])(t._removed);case 8:if(r=(s=i.next()).done){g.next=15;break}o=s.value;g.next=12;return e.remove(o,t._originalValues.get(o));case 12:r=!0;g.next=8;break;case 15:g.next=21;break;case 17:g.prev=17;g.t0=g["catch"](6);n=!0;a=g.t0;case 21:g.prev=21;g.prev=22;!r&&i["return"]&&i["return"]();case 24:g.prev=24;if(!n){g.next=27;break}throw a;case 27:return g.finish(24);case 28:return g.finish(21);case 29:u=!0;c=!1;l=undefined;g.prev=32;h=(0,_getIterator3["default"])(t._modified);case 34:if(u=(f=h.next()).done){g.next=41;break}_=(0,_slicedToArray3["default"])(f.value,2),d=_[0],p=_[1];g.next=38;return e.put(d,p,t._originalValues.get(d));case 38:u=!0;g.next=34;break;case 41:g.next=47;break;case 43:g.prev=43;g.t1=g["catch"](32);c=!0;l=g.t1;case 47:g.prev=47;g.prev=48;!u&&h["return"]&&h["return"]();case 50:g.prev=50;if(!c){g.next=53;break}throw l;case 53:return g.finish(50);case 54:return g.finish(47);case 55:case"end":return g.stop()}},_callee55,this,[[6,17,21,29],[22,,24,28],[32,43,47,55],[48,,50,54]])}));return function _indexApply(t,r){return e.apply(this,arguments)}}()}]);return InMemoryBackend}();t.register(A);var S=function(){function KeyRange(e,t,r,n){(0,_classCallCheck3["default"])(this,KeyRange);this._lower=e;this._upper=t;this._lowerOpen=r;this._upperOpen=n}(0,_createClass3["default"])(KeyRange,[{key:"includes",value:function includes(e){return(this._lower===undefined||this._lower<e||!this._lowerOpen&&this._lower===e)&&(this._upper===undefined||this._upper>e||!this._upperOpen&&this._upper===e)}},{key:"lower",get:function get(){return this._lower}},{key:"upper",get:function get(){return this._upper}},{key:"lowerOpen",get:function get(){return this._lowerOpen}},{key:"upperOpen",get:function get(){return this._upperOpen}},{key:"exactMatch",get:function get(){return this._lower===this._upper&&!this._lowerOpen&&!this.upperOpen}}],[{key:"upperBound",value:function upperBound(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];return new KeyRange(undefined,e,!1,t)}},{key:"lowerBound",value:function lowerBound(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];return new KeyRange(e,undefined,t,!1)}},{key:"bound",value:function bound(e,t){return new KeyRange(e,t,arguments.length>2&&arguments[2]!==undefined&&arguments[2],arguments.length>3&&arguments[3]!==undefined&&arguments[3])}},{key:"only",value:function only(e){return new KeyRange(e,e,!1,!1)}}]);return KeyRange}();t.register(S);var T=function(){function ObjectStore(e,t,r){(0,_classCallCheck3["default"])(this,ObjectStore);this._backend=e;this._db=t;this._name=r;this._stateStack=[];this._backendInfo=new x(this._backend,null);this._transactions=new _map2["default"];this._transactions.set(ObjectStore.BACKEND_ID,this._backendInfo);this._snapshotManager=new R;this._synchronizer=new b}(0,_createClass3["default"])(ObjectStore,[{key:"get",value:function get(e){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.get(e)}},{key:"put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee56(e,t){var r;return _regenerator2["default"].wrap(function _callee56$(n){for(;;)switch(n.prev=n.next){case 0:if(this._backend.connected){n.next=2;break}throw new Error("JungleDB is not connected");case 2:r=this.transaction();n.next=5;return r.put(e,t);case 5:return n.abrupt("return",r.commit());case 6:case"end":return n.stop()}},_callee56,this)}));return function put(t,r){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee57(e){var t;return _regenerator2["default"].wrap(function _callee57$(r){for(;;)switch(r.prev=r.next){case 0:if(this._backend.connected){r.next=2;break}throw new Error("JungleDB is not connected");case 2:t=this.transaction();r.next=5;return t.remove(e);case 5:return r.abrupt("return",t.commit());case 6:case"end":return r.stop()}},_callee57,this)}));return function remove(t){return e.apply(this,arguments)}}()},{key:"keys",value:function keys(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!this._backend.connected)throw new Error("JungleDB is not connected");return null!==e&&e instanceof E?e.keys(this._currentState):this._currentState.keys(e)}},{key:"values",value:function values(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!this._backend.connected)throw new Error("JungleDB is not connected");return null!==e&&e instanceof E?e.values(this._currentState):this._currentState.values(e)}},{key:"keyStream",value:function keyStream(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return this._currentState.keyStream(e,t,r)}},{key:"valueStream",value:function valueStream(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return this._currentState.valueStream(e,t,r)}},{key:"maxValue",value:function maxValue(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.maxValue(e)}},{key:"maxKey",value:function maxKey(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.maxKey(e)}},{key:"minKey",value:function minKey(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.minKey(e)}},{key:"minValue",value:function minValue(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.minValue(e)}},{key:"count",value:function count(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.count(e)}},{key:"commit",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee58(e){return _regenerator2["default"].wrap(function _callee58$(t){for(;;)switch(t.prev=t.next){case 0:if(this._isCommittable(e)){t.next=4;break}t.next=3;return this.abort(e);case 3:return t.abrupt("return",!1);case 4:t.next=6;return this._commitInternal(e);case 6:return t.abrupt("return",!0);case 7:case"end":return t.stop()}},_callee58,this)}));return function commit(t){return e.apply(this,arguments)}}()},{key:"_isCommittable",value:function _isCommittable(e){if(!this._backend.connected)throw new Error("JungleDB is not connected");if(!(e instanceof P&&e.state===P.STATE.OPEN&&this._transactions.has(e.id)))throw new Error("Can only commit open transactions");return this._transactions.get(e.id).isCommittable()}},{key:"_commitBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee59(){return _regenerator2["default"].wrap(function _callee59$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Cannot commit object stores");case 1:case"end":return e.stop()}},_callee59,this)}));return function _commitBackend(){return e.apply(this,arguments)}}()},{key:"_commitInternal",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee60(e){var t;return _regenerator2["default"].wrap(function _callee60$(r){for(;;)switch(r.prev=r.next){case 0:t=this._transactions.get(e.id);if(!(this._stateStack.length>=ObjectStore.MAX_STACK_SIZE)){r.next=4;break}y.e(ObjectStore,"Transaction stack size exceeded "+this.toStringFull());throw new Error("Transaction stack size exceeded");case 4:this._stateStack.push(t);t.close();if(!t.isFlushable()){r.next=9;break}r.next=9;return this._flattenState(e);case 9:case"end":return r.stop()}},_callee60,this)}));return function _commitInternal(t){return e.apply(this,arguments)}}()},{key:"_setParent",value:function _setParent(e){throw new Error("Unsupported operation")}},{key:"abort",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee61(e){var t;return _regenerator2["default"].wrap(function _callee61$(r){for(;;)switch(r.prev=r.next){case 0:if(this._backend.connected){r.next=2;break}throw new Error("JungleDB is not connected");case 2:if(!(e instanceof O)){r.next=4;break}return r.abrupt("return",this._snapshotManager.abortSnapshot(e));case 4:if(e instanceof P&&e.state===P.STATE.OPEN&&this._transactions.has(e.id)){r.next=6;break}throw new Error("Can only abort open transactions");case 6:(t=this._transactions.get(e.id)).abort();if(!t.parent||0!==t.parent.numOpenChildren){r.next=11;break}r.next=11;return this._flattenState();case 11:return r.abrupt("return",!0);case 12:case"end":return r.stop()}},_callee61,this)}));return function abort(t){return e.apply(this,arguments)}}()},{key:"_flattenState",value:function _flattenState(e){var t=this;return this._synchronizer.push(function(){return t._flattenStateInternal(e)})}},{key:"_flattenStateInternal",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee62(e){var t,r,n,a=this;return _regenerator2["default"].wrap(function _callee62$(i){for(;;)switch(i.prev=i.next){case 0:if(!(e&&e instanceof P)){i.next=21;break}if((t=this._transactions.get(e.id)).isFlushable()){i.next=4;break}return i.abrupt("return",!1);case 4:r=t.parent.transaction;n=function cleanup(){t.flush();a._transactions["delete"](e.id);var r=a._stateStack.indexOf(t);r>=0&&a._stateStack.splice(r,1);a._flattenState()["catch"](y.w.tag(ObjectStore))};if(null!==e.dependency){i.next=16;break}if(!t.parent.isBackend()){i.next=10;break}i.next=10;return this._snapshotManager.applyTx(e,r);case 10:i.next=12;return r._apply(e);case 12:n();return i.abrupt("return",!0);case 16:i.next=18;return e.dependency.onFlushable(e,n,function(){return a._snapshotManager.applyTx(e,r)});case 18:return i.abrupt("return",i.sent);case 19:i.next=36;break;case 21:if(!(this._stateStack.length>0)){i.next=28;break}i.next=24;return this._flattenStateInternal(this._currentState);case 24:if(i.sent){i.next=26;break}return i.abrupt("break",28);case 26:i.next=21;break;case 28:if(!(this._stateStack.length>0)){i.next=35;break}i.next=31;return this._flattenStateInternal(this._stateStack[0].transaction);case 31:if(i.sent){i.next=33;break}return i.abrupt("break",35);case 33:i.next=28;break;case 35:return i.abrupt("return",!1);case 36:case"end":return i.stop()}},_callee62,this)}));return function _flattenStateInternal(t){return e.apply(this,arguments)}}()},{key:"index",value:function index(e){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.index(e)}},{key:"createIndex",value:function createIndex(e,t){var r=arguments.length>2&&arguments[2]!==undefined&&arguments[2];return this._backend.createIndex(e,t,r)}},{key:"deleteIndex",value:function deleteIndex(e){return this._backend.deleteIndex(e)}},{key:"transaction",value:function transaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];if(!this._backend.connected)throw new Error("JungleDB is not connected");var t=new P(this,this._currentState,this,e);this._transactions.set(t.id,new x(t,this._currentStateInfo));return t}},{key:"synchronousTransaction",value:function synchronousTransaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];if(!this._backend.connected)throw new Error("JungleDB is not connected");var t=new N(this,this._currentState,this,e);this._transactions.set(t.id,new x(t,this._currentStateInfo));return t}},{key:"isSynchronous",value:function isSynchronous(){return!1}},{key:"snapshot",value:function snapshot(){return this._currentStateId!==ObjectStore.BACKEND_ID?this._currentState.snapshot():this._snapshotManager.createSnapshot(this,this._currentState)}},{key:"_apply",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee63(e){return _regenerator2["default"].wrap(function _callee63$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Unsupported operation");case 1:case"end":return e.stop()}},_callee63,this)}));return function _apply(t){return e.apply(this,arguments)}}()},{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee64(){var e;return _regenerator2["default"].wrap(function _callee64$(t){for(;;)switch(t.prev=t.next){case 0:if(this._backend.connected){t.next=2;break}throw new Error("JungleDB is not connected");case 2:e=this.transaction();t.next=5;return e.truncate();case 5:return t.abrupt("return",e.commit());case 6:case"end":return t.stop()}},_callee64,this)}));return function truncate(){return e.apply(this,arguments)}}()},{key:"close",value:function close(){if(this._stateStack.length>0)throw new Error("Cannot close database while transactions are active");return this._backend.close()}},{key:"toStringFull",value:function toStringFull(){var e=this;return"ObjectStore{\n    stack=["+this._stateStack.map(function(t){return"{tx="+t.toStringShort()+", open="+(e._openTransactions.get(t.id)?e._openTransactions.get(t.id).size:0)+"}"})+"],\n    db="+this._db+"/"+(this._name?this._name:"unnamed")+"\n}"}},{key:"toString",value:function toString(){return"ObjectStore{stackSize="+this._stateStack.length+", db="+this._db+"/"+(this._name?this._name:"unnamed")+"}"}},{key:"jungleDB",get:function get(){return this._db}},{key:"connected",get:function get(){return this._backend.connected}},{key:"_currentState",get:function get(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].transaction:this._backend}},{key:"_currentStateInfo",get:function get(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1]:this._backendInfo}},{key:"_currentStateId",get:function get(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].id:ObjectStore.BACKEND_ID}},{key:"indices",get:function get(){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.indices}}]);return ObjectStore}();T.MAX_STACK_SIZE=10;T.BACKEND_ID="backend";t.register(T);var x=function(){function TransactionInfo(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];(0,_classCallCheck3["default"])(this,TransactionInfo);this.transaction=e;this.children=r;this._parentInfo=t;this._open=!0;this._parentInfo&&this._parentInfo.addChild(this)}(0,_createClass3["default"])(TransactionInfo,[{key:"addChild",value:function addChild(e){this.children.push(e)}},{key:"removeChild",value:function removeChild(e){var t=this.children.indexOf(e);t>=0&&this.children.splice(t,1)}},{key:"flush",value:function flush(){if(!this.isBackend()){var e=this.parent;this.parent.removeChild(this);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this.children.slice());!(t=(a=i.next()).done);t=!0){a.value.parent=e}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}this.children=[];this._parentInfo=null}}},{key:"abort",value:function abort(){this.isBackend()||this.parent.removeChild(this)}},{key:"close",value:function close(){this._open=!1}},{key:"isBackend",value:function isBackend(){return null===this._parentInfo}},{key:"isOpen",value:function isOpen(){return this._open}},{key:"isCommittable",value:function isCommittable(){return this._parentInfo&&this._parentInfo.children.every(function(e){return e.isOpen()})}},{key:"isFlushable",value:function isFlushable(){return this.parent&&0===this.parent.numOpenChildren&&(null===this.transaction.dependency||this.parent.isBackend())}},{key:"parent",get:function get(){return this._parentInfo},set:function set(e){this.parent.removeChild(this);this._parentInfo=e;this.parent.addChild(this);this.transaction._setParent(e.transaction)}},{key:"id",get:function get(){return this.isBackend()?T.BACKEND_ID:this.transaction.id}},{key:"numOpenChildren",get:function get(){return this.children.filter(function(e){return e.isOpen()}).length}}]);return TransactionInfo}(),E=function(){(0,_createClass3["default"])(Query,null,[{key:"_parseKeyRange",value:function _parseKeyRange(e,t,r){switch(e){case Query.OPERATORS.GT:return S.lowerBound(t,!0);case Query.OPERATORS.GE:return S.lowerBound(t,!1);case Query.OPERATORS.LT:return S.upperBound(t,!0);case Query.OPERATORS.LE:return S.upperBound(t,!1);case Query.OPERATORS.EQ:return S.only(t);case Query.OPERATORS.BETWEEN:return S.bound(t,r,!0,!0);case Query.OPERATORS.WITHIN:return S.bound(t,r,!1,!1)}throw new Error("Unknown operator")}},{key:"and",value:function and(e){return new Query((0,_from2["default"])(arguments),Query.OPERATORS.AND)}},{key:"or",value:function or(e){return new Query((0,_from2["default"])(arguments),Query.OPERATORS.OR)}},{key:"max",value:function max(e){return new Query(e,Query.OPERATORS.MAX)}},{key:"min",value:function min(e){return new Query(e,Query.OPERATORS.MIN)}},{key:"lt",value:function lt(e,t){return new Query(e,Query.OPERATORS.LT,t)}},{key:"le",value:function le(e,t){return new Query(e,Query.OPERATORS.LE,t)}},{key:"gt",value:function gt(e,t){return new Query(e,Query.OPERATORS.GT,t)}},{key:"ge",value:function ge(e,t){return new Query(e,Query.OPERATORS.GE,t)}},{key:"eq",value:function eq(e,t){return new Query(e,Query.OPERATORS.EQ,t)}},{key:"between",value:function between(e,t,r){return new Query(e,Query.OPERATORS.BETWEEN,t,r)}},{key:"within",value:function within(e,t,r){return new Query(e,Query.OPERATORS.WITHIN,t,r)}}]);function Query(e,t,r,n){(0,_classCallCheck3["default"])(this,Query);if(Array.isArray(e)){if(e.some(function(e){return!(e instanceof Query)}))throw new Error("Invalid query");if(Query.COMBINED_OPERATORS.indexOf(t)<0)throw new Error("Unknown operator");this._queryType=Query.Type.COMBINED;this._queries=e;this._op=t}else{if(Query.RANGE_OPERATORS.indexOf(t)>=0){this._queryType=Query.Type.RANGE;this._keyRange=Query._parseKeyRange(t,r,n)}else{if(!(Query.ADVANCED_OPERATORS.indexOf(t)>=0))throw new Error("Unknown operator");this._queryType=Query.Type.ADVANCED;this._op=t}this._indexName=e}}(0,_createClass3["default"])(Query,[{key:"values",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee65(e){var t,r,n,a,i,s,o,u;return _regenerator2["default"].wrap(function _callee65$(c){for(;;)switch(c.prev=c.next){case 0:c.next=2;return this._execute(e);case 2:t=c.sent;r=[];n=!0;a=!1;i=undefined;c.prev=7;for(s=(0,_getIterator3["default"])(t);!(n=(o=s.next()).done);n=!0){u=o.value;r.push(e.get(u))}c.next=15;break;case 11:c.prev=11;c.t0=c["catch"](7);a=!0;i=c.t0;case 15:c.prev=15;c.prev=16;!n&&s["return"]&&s["return"]();case 18:c.prev=18;if(!a){c.next=21;break}throw i;case 21:return c.finish(18);case 22:return c.finish(15);case 23:return c.abrupt("return",_promise2["default"].all(r));case 24:case"end":return c.stop()}},_callee65,this,[[7,11,15,23],[16,,18,22]])}));return function values(t){return e.apply(this,arguments)}}()},{key:"keys",value:function keys(e){return this._execute(e)}},{key:"_execute",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee66(e){return _regenerator2["default"].wrap(function _callee66$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=this._queryType;t.next=t.t0===Query.Type.COMBINED?3:t.t0===Query.Type.ADVANCED?4:t.t0===Query.Type.RANGE?5:6;break;case 3:return t.abrupt("return",_promise2["default"].resolve(this._executeCombined(e)));case 4:return t.abrupt("return",_promise2["default"].resolve(this._executeAdvanced(e)));case 5:return t.abrupt("return",this._executeRange(e));case 6:return t.abrupt("return",_promise2["default"].resolve(new _set3["default"]));case 7:case"end":return t.stop()}},_callee66,this)}));return function _execute(t){return e.apply(this,arguments)}}()},{key:"_executeCombined",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee67(e){var t,r,n,a,i,s,o,u,c,l,h,f,_,d,p,g,y;return _regenerator2["default"].wrap(function _callee67$(v){for(;;)switch(v.prev=v.next){case 0:t=[];r=!0;n=!1;a=undefined;v.prev=4;for(i=(0,_getIterator3["default"])(this._queries);!(r=(s=i.next()).done);r=!0){o=s.value;t.push(o._execute(e))}v.next=12;break;case 8:v.prev=8;v.t0=v["catch"](4);n=!0;a=v.t0;case 12:v.prev=12;v.prev=13;!r&&i["return"]&&i["return"]();case 15:v.prev=15;if(!n){v.next=18;break}throw a;case 18:return v.finish(15);case 19:return v.finish(12);case 20:v.next=22;return _promise2["default"].all(t);case 22:u=v.sent;if(this._op!==Query.OPERATORS.AND){v.next=55;break}if(0!==u.length){v.next=28;break}return v.abrupt("return",new _set3["default"]);case 28:if(1!==u.length){v.next=30;break}return v.abrupt("return",u[0]);case 30:c=u.shift();l=new _set3["default"];h=!0;f=!1;_=undefined;v.prev=35;d=function _loop2(){var e=g.value;u.every(function(t){return t.has(e)})&&l.add(e)};for(p=(0,_getIterator3["default"])(c);!(h=(g=p.next()).done);h=!0)d();v.next=44;break;case 40:v.prev=40;v.t1=v["catch"](35);f=!0;_=v.t1;case 44:v.prev=44;v.prev=45;!h&&p["return"]&&p["return"]();case 47:v.prev=47;if(!f){v.next=50;break}throw _;case 50:return v.finish(47);case 51:return v.finish(44);case 52:return v.abrupt("return",l);case 55:if(this._op!==Query.OPERATORS.OR){v.next=59;break}if("object"!==("undefined"==typeof(y=function(){var e=new _set3["default"],t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(u);!(t=(a=i.next()).done);t=!0){a.value.forEach(function(t){return e.add(t)})}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return{v:e}}())?"undefined":(0,_typeof3["default"])(y))){v.next=59;break}return v.abrupt("return",y.v);case 59:return v.abrupt("return",new _set3["default"]);case 60:case"end":return v.stop()}},_callee67,this,[[4,8,12,20],[13,,15,19],[35,40,44,52],[45,,47,51]])}));return function _executeCombined(t){return e.apply(this,arguments)}}()},{key:"_executeAdvanced",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee68(e){var t,r;return _regenerator2["default"].wrap(function _callee68$(n){for(;;)switch(n.prev=n.next){case 0:t=e.index(this._indexName);r=new _set3["default"];n.t0=this._op;n.next=n.t0===Query.OPERATORS.MAX?5:n.t0===Query.OPERATORS.MIN?9:13;break;case 5:n.next=7;return t.maxKeys();case 7:r=n.sent;return n.abrupt("break",13);case 9:n.next=11;return t.minKeys();case 11:r=n.sent;return n.abrupt("break",13);case 13:return n.abrupt("return",new _set3["default"](r));case 14:case"end":return n.stop()}},_callee68,this)}));return function _executeAdvanced(t){return e.apply(this,arguments)}}()},{key:"_executeRange",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee69(e){var t;return _regenerator2["default"].wrap(function _callee69$(r){for(;;)switch(r.prev=r.next){case 0:t=e.index(this._indexName);r.t0=_set3["default"];r.next=4;return t.keys(this._keyRange);case 4:r.t1=r.sent;return r.abrupt("return",new r.t0(r.t1));case 6:case"end":return r.stop()}},_callee69,this)}));return function _executeRange(t){return e.apply(this,arguments)}}()}]);return Query}();E.OPERATORS={GT:0,GE:1,LT:2,LE:3,EQ:4,BETWEEN:7,WITHIN:8,MAX:9,MIN:10,AND:11,OR:12};E.RANGE_OPERATORS=[E.OPERATORS.GT,E.OPERATORS.GE,E.OPERATORS.LT,E.OPERATORS.LE,E.OPERATORS.EQ,E.OPERATORS.BETWEEN,E.OPERATORS.WITHIN];E.ADVANCED_OPERATORS=[E.OPERATORS.MAX,E.OPERATORS.MIN];E.COMBINED_OPERATORS=[E.OPERATORS.AND,E.OPERATORS.OR];E.Type={RANGE:0,ADVANCED:1,COMBINED:2};t.register(E);var I=function(e){(0,_inherits3["default"])(TransactionIndex,e);(0,_createClass3["default"])(TransactionIndex,[{key:"_index",get:function get(){return this._backend.index(this._databaseDir)}}],[{key:"derive",value:function derive(e,t){var r=new _map2["default"],n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(t.indices);!(n=(s=o.next()).done);n=!0){var u=(0,_slicedToArray3["default"])(s.value,2),c=u[0],l=u[1];r.set(c,new TransactionIndex(e,t,c,l.keyPath,l.multiEntry))}}catch(h){a=!0;i=h}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}return r}}]);function TransactionIndex(e,t,r,n){var a=arguments.length>4&&arguments[4]!==undefined&&arguments[4];(0,_classCallCheck3["default"])(this,TransactionIndex);var i=(0,_possibleConstructorReturn3["default"])(this,(TransactionIndex.__proto__||(0,_getPrototypeOf2["default"])(TransactionIndex)).call(this,e,n,a));i._backend=t;i._databaseDir=r;return i}(0,_createClass3["default"])(TransactionIndex,[{key:"keys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee70(){var e,t,r,n,a,i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee70$(s){for(;;)switch(s.prev=s.next){case 0:e=[];this._objectStore._truncated?e.push(new _set3["default"]):e.push(this._index.keys(i));e.push(w.prototype.keys.call(this,i));s.next=5;return _promise2["default"].all(e);case 5:t=s.sent;r=(0,_slicedToArray3["default"])(t,2);n=r[0];a=r[1];n=(n=n.difference(this._objectStore._removed)).difference(this._objectStore._modified.keys());return s.abrupt("return",n.union(a));case 12:case"end":return s.stop()}},_callee70,this)}));return function keys(){return e.apply(this,arguments)}}()},{key:"values",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee71(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee71$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.keys(t);case 2:e=r.sent;return r.abrupt("return",w.prototype._retrieveValues.call(this,e));case 4:case"end":return r.stop()}},_callee71,this)}));return function values(){return e.apply(this,arguments)}}()},{key:"maxValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee72(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee72$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.maxKeys(t);case 2:e=r.sent;return r.abrupt("return",w.prototype._retrieveValues.call(this,e));case 4:case"end":return r.stop()}},_callee72,this)}));return function maxValues(){return e.apply(this,arguments)}}()},{key:"maxKeys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee73(){var e,t,r,n,a,i,s,o,u,c,l=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee73$(h){for(;;)switch(h.prev=h.next){case 0:e=void 0;if(!this._objectStore._truncated){h.next=5;break}e=new _set3["default"];h.next=8;break;case 5:h.next=7;return this._index.maxKeys(l);case 7:e=h.sent;case 8:t=_set3["default"].sampleElement(e);h.next=11;return this._backend.get(t);case 11:r=h.sent;n=t?k.byKeyPath(r,this.keyPath):undefined;e=(e=e.difference(this._objectStore._removed)).difference(this._objectStore._modified.keys());case 15:if(t===undefined||0!==e.size){h.next=32;break}a=S.upperBound(n,!0);h.next=19;return this._index.maxKeys(a);case 19:e=h.sent;t=_set3["default"].sampleElement(e);h.next=23;return this._backend.get(t);case 23:i=h.sent;n=t?k.byKeyPath(i,this.keyPath):undefined;e=(e=e.difference(this._objectStore._removed)).difference(this._objectStore._modified.keys());if(!n||null===l||l.includes(n)){h.next=30;break}e=new _set3["default"];return h.abrupt("break",32);case 30:h.next=15;break;case 32:h.next=34;return w.prototype.maxKeys.call(this,l);case 34:s=h.sent;if(0!==e.size){h.next=39;break}return h.abrupt("return",s);case 39:if(0!==s.size){h.next=41;break}return h.abrupt("return",e);case 41:h.next=43;return this._objectStore.get(_set3["default"].sampleElement(s));case 43:o=h.sent;u=n;c=k.byKeyPath(o,this.keyPath);if(!(u>c)){h.next=50;break}return h.abrupt("return",e);case 50:if(!(u<c)){h.next=52;break}return h.abrupt("return",s);case 52:return h.abrupt("return",e.union(s));case 53:case"end":return h.stop()}},_callee73,this)}));return function maxKeys(){return e.apply(this,arguments)}}()},{key:"minValues",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee74(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee74$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.minKeys(t);case 2:e=r.sent;return r.abrupt("return",w.prototype._retrieveValues.call(this,e));case 4:case"end":return r.stop()}},_callee74,this)}));return function minValues(){return e.apply(this,arguments)}}()},{key:"minKeys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee75(){var e,t,r,n,a,i,s,o,u,c,l=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee75$(h){for(;;)switch(h.prev=h.next){case 0:e=void 0;if(!this._objectStore._truncated){h.next=5;break}e=new _set3["default"];h.next=8;break;case 5:h.next=7;return this._index.minKeys(l);case 7:e=h.sent;case 8:t=_set3["default"].sampleElement(e);h.next=11;return this._backend.get(t);case 11:r=h.sent;n=t?k.byKeyPath(r,this.keyPath):undefined;e=(e=e.difference(this._objectStore._removed)).difference(this._objectStore._modified.keys());case 15:if(t===undefined||0!==e.size){h.next=32;break}a=S.lowerBound(n,!0);h.next=19;return this._index.minKeys(a);case 19:e=h.sent;t=_set3["default"].sampleElement(e);h.next=23;return this._backend.get(t);case 23:i=h.sent;n=t?k.byKeyPath(i,this.keyPath):undefined;e=(e=e.difference(this._objectStore._removed)).difference(this._objectStore._modified.keys());if(!n||null===l||l.includes(n)){h.next=30;break}e=new _set3["default"];return h.abrupt("break",32);case 30:h.next=15;break;case 32:h.next=34;return w.prototype.minKeys.call(this,l);case 34:s=h.sent;if(0!==e.size){h.next=39;break}return h.abrupt("return",s);case 39:if(0!==s.size){h.next=41;break}return h.abrupt("return",e);case 41:h.next=43;return this._objectStore.get(_set3["default"].sampleElement(s));case 43:o=h.sent;u=n;c=k.byKeyPath(o,this.keyPath);if(!(u<c)){h.next=50;break}return h.abrupt("return",e);case 50:if(!(u>c)){h.next=52;break}return h.abrupt("return",s);case 52:return h.abrupt("return",e.union(s));case 53:case"end":return h.stop()}},_callee75,this)}));return function minKeys(){return e.apply(this,arguments)}}()},{key:"count",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee76(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee76$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this.keys(e);case 2:return t.abrupt("return",t.sent.size);case 3:case"end":return t.stop()}},_callee76,this)}));return function count(){return e.apply(this,arguments)}}()}]);return TransactionIndex}(w);t.register(I);var P=function(){function Transaction(e,t,r){var n=this,a=!(arguments.length>3&&arguments[3]!==undefined)||arguments[3];(0,_classCallCheck3["default"])(this,Transaction);this._id=Transaction._instanceCount++;this._objectStore=e;this._parent=t;this._managingBackend=r||t;this._modified=new _map2["default"];this._removed=new _set3["default"];this._originalValues=new _map2["default"];this._truncated=!1;this._indices=I.derive(this,t);this._state=Transaction.STATE.OPEN;this._nested=new _set3["default"];this._nestedCommitted=!1;this._dependency=null;this._snapshotManager=new R;this._startTime=Date.now();this._enableWatchdog=a;this._enableWatchdog&&(this._watchdog=setTimeout(function(){y.w(Transaction,"Violation: tx id "+n._id+" took longer than expected (still open after "+Transaction.WATCHDOG_TIMER/1e3+"s), "+n.toString()+".")},Transaction.WATCHDOG_TIMER))}(0,_createClass3["default"])(Transaction,[{key:"_apply",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee77(e){return _regenerator2["default"].wrap(function _callee77$(t){for(;;)switch(t.prev=t.next){case 0:if(e instanceof Transaction){t.next=2;break}throw new Error("Can only apply transactions");case 2:t.next=4;return this._snapshotManager.applyTx(e,this);case 4:this._applySync(e);case 5:case"end":return t.stop()}},_callee77,this)}));return function _apply(t){return e.apply(this,arguments)}}()},{key:"_applySync",value:function _applySync(e){e._truncated&&this._truncateSync();var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(e._modified);!(t=(a=i.next()).done);t=!0){var s=(0,_slicedToArray3["default"])(a.value,2),o=s[0],u=s[1],c=void 0;if(this._originalValues.has(o))c=this._originalValues.get(o);else{c=e._originalValues.get(o);this._originalValues.set(o,c)}this._put(o,u,c)}}catch(g){r=!0;n=g}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}var l=!0,h=!1,f=undefined;try{for(var _,d=(0,_getIterator3["default"])(e._removed);!(l=(_=d.next()).done);l=!0){o=_.value;var p=void 0;if(this._originalValues.has(o))p=this._originalValues.get(o);else{p=e._originalValues.get(o);this._originalValues.set(o,p)}this._remove(o,p)}}catch(g){h=!0;f=g}finally{try{!l&&d["return"]&&d["return"]()}finally{if(h)throw f}}}},{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee78(){return _regenerator2["default"].wrap(function _callee78$(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._truncateSync());case 1:case"end":return e.stop()}},_callee78,this)}));return function truncate(){return e.apply(this,arguments)}}()},{key:"_truncateSync",value:function _truncateSync(){if(this._state!==Transaction.STATE.OPEN)throw new Error("Transaction already closed");this._truncated=!0;this._modified.clear();this._removed.clear();this._originalValues.clear();var e=!0,t=!1,r=undefined;try{for(var n,a=(0,_getIterator3["default"])(this._indices.values());!(e=(n=a.next()).done);e=!0){n.value.truncate()}}catch(i){t=!0;r=i}finally{try{!e&&a["return"]&&a["return"]()}finally{if(t)throw r}}}},{key:"commit",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee79(e){return _regenerator2["default"].wrap(function _callee79$(t){for(;;)switch(t.prev=t.next){case 0:if(e===undefined){t.next=8;break}if(this._isCommittable(e)){t.next=5;break}t.next=4;return this.abort(e);case 4:return t.abrupt("return",!1);case 5:t.next=7;return this._commitInternal(e);case 7:return t.abrupt("return",!0);case 8:if(null===this._dependency){t.next=10;break}return t.abrupt("return",this._dependency.commit());case 10:return t.abrupt("return",this._commitBackend());case 11:case"end":return t.stop()}},_callee79,this)}));return function commit(t){return e.apply(this,arguments)}}()},{key:"_commitBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee80(){var e;return _regenerator2["default"].wrap(function _callee80$(t){for(;;)switch(t.prev=t.next){case 0:if(this._state===Transaction.STATE.OPEN){t.next=2;break}throw new Error("Transaction already closed or in nested state");case 2:this._enableWatchdog&&clearTimeout(this._watchdog);e=Date.now();t.next=6;return this._managingBackend.commit(this);case 6:if(!t.sent){t.next=13;break}this._state=Transaction.STATE.COMMITTED;this._performanceCheck(e,"commit");this._performanceCheck();return t.abrupt("return",!0);case 13:this._state=Transaction.STATE.CONFLICTED;this._performanceCheck(e,"commit");this._performanceCheck();return t.abrupt("return",!1);case 17:case"end":return t.stop()}},_callee80,this)}));return function _commitBackend(){return e.apply(this,arguments)}}()},{key:"_performanceCheck",value:function _performanceCheck(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this._startTime,t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null,r=Date.now()-e;t=t?" function '"+t+"'":"";r>Transaction.WATCHDOG_TIMER&&y.w(Transaction,"Violation: tx id "+this._id+t+" took "+(r/1e3).toFixed(2)+"s ("+this.toString()+").")}},{key:"_isCommittable",value:function _isCommittable(e){if(e!==undefined){if(!this._nested.has(e)||e.state!==Transaction.STATE.OPEN)throw new Error("Can only commit open, nested transactions");return!this._nestedCommitted}return this._managingBackend._isCommittable(this)}},{key:"_commitInternal",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee81(e){return _regenerator2["default"].wrap(function _callee81$(t){for(;;)switch(t.prev=t.next){case 0:this._nested["delete"](e);this._nestedCommitted=!0;t.next=4;return this._apply(e);case 4:if(0===this._nested.size){this._state=Transaction.STATE.OPEN;this._nestedCommitted=!1}case 5:case"end":return t.stop()}},_callee81,this)}));return function _commitInternal(t){return e.apply(this,arguments)}}()},{key:"_setParent",value:function _setParent(e){this._parent=e}},{key:"abort",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee82(e){return _regenerator2["default"].wrap(function _callee82$(t){for(;;)switch(t.prev=t.next){case 0:if(e===undefined){t.next=8;break}if(!(e instanceof O)){t.next=3;break}return t.abrupt("return",this._snapshotManager.abortSnapshot(e));case 3:if(this._nested.has(e)&&e.state===Transaction.STATE.OPEN){t.next=5;break}throw new Error("Can only abort open, nested transactions");case 5:this._nested["delete"](e);if(0===this._nested.size){this._state=Transaction.STATE.OPEN;this._nestedCommitted=!1}return t.abrupt("return",!0);case 8:if(null===this._dependency){t.next=10;break}return t.abrupt("return",this._dependency.abort());case 10:return t.abrupt("return",this._abortBackend());case 11:case"end":return t.stop()}},_callee82,this)}));return function abort(t){return e.apply(this,arguments)}}()},{key:"_abortBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee83(){var e;return _regenerator2["default"].wrap(function _callee83$(t){for(;;)switch(t.prev=t.next){case 0:if(this._state!==Transaction.STATE.ABORTED&&this._state!==Transaction.STATE.CONFLICTED){t.next=2;break}return t.abrupt("return",!0);case 2:if(this._state===Transaction.STATE.OPEN||this._state===Transaction.STATE.NESTED){t.next=4;break}throw new Error("Transaction already closed");case 4:if(this._state!==Transaction.STATE.NESTED){t.next=7;break}t.next=7;return _promise2["default"].all((0,_from2["default"])(this._nested).map(function(e){return e.abort()}));case 7:this._enableWatchdog&&clearTimeout(this._watchdog);e=Date.now();t.next=11;return this._managingBackend.abort(this);case 11:this._state=Transaction.STATE.ABORTED;this._performanceCheck(e,"abort");this._performanceCheck();return t.abrupt("return",!0);case 15:case"end":return t.stop()}},_callee83,this)}));return function _abortBackend(){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee84(e){return _regenerator2["default"].wrap(function _callee84$(t){for(;;)switch(t.prev=t.next){case 0:if(!this._removed.has(e)){t.next=2;break}return t.abrupt("return",undefined);case 2:if(!this._modified.has(e)){t.next=4;break}return t.abrupt("return",this._modified.get(e));case 4:if(!this._truncated){t.next=6;break}return t.abrupt("return",undefined);case 6:t.next=8;return this._parent.get(e);case 8:return t.abrupt("return",t.sent);case 9:case"end":return t.stop()}},_callee84,this)}));return function get(t){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee85(e,t){var r;return _regenerator2["default"].wrap(function _callee85$(n){for(;;)switch(n.prev=n.next){case 0:if(this._state===Transaction.STATE.OPEN){n.next=2;break}throw new Error("Transaction already closed");case 2:n.next=4;return this.get(e);case 4:r=n.sent;this._originalValues.has(e)||this._originalValues.set(e,r);this._put(e,t,r);case 7:case"end":return n.stop()}},_callee85,this)}));return function put(t,r){return e.apply(this,arguments)}}()},{key:"_put",value:function _put(e,t,r){this._removed["delete"](e);this._modified.set(e,t);var n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(this._indices.values());!(n=(s=o.next()).done);n=!0){s.value.put(e,t,r)}}catch(u){a=!0;i=u}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}}},{key:"remove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee86(e){var t;return _regenerator2["default"].wrap(function _callee86$(r){for(;;)switch(r.prev=r.next){case 0:if(this._state===Transaction.STATE.OPEN){r.next=2;break}throw new Error("Transaction already closed");case 2:r.next=4;return this.get(e);case 4:if((t=r.sent)!==undefined){this._originalValues.has(e)||this._originalValues.set(e,t);this._remove(e,t)}case 6:case"end":return r.stop()}},_callee86,this)}));return function remove(t){return e.apply(this,arguments)}}()},{key:"_remove",value:function _remove(e,t){this._removed.add(e);this._modified["delete"](e);var r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(this._indices.values());!(r=(i=s.next()).done);r=!0){i.value.remove(e,t)}}catch(o){n=!0;a=o}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}}},{key:"keys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee87(){var e,t,r,n,a,i,s,o=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee87$(u){for(;;)switch(u.prev=u.next){case 0:if(!(null!==o&&o instanceof E)){u.next=2;break}return u.abrupt("return",o.keys(this));case 2:e=new _set3["default"];if(this._truncated){u.next=7;break}u.next=6;return this._parent.keys(o);case 6:e=u.sent;case 7:e=e.difference(this._removed);t=!0;r=!1;n=undefined;u.prev=11;for(a=(0,_getIterator3["default"])(this._modified.keys());!(t=(i=a.next()).done);t=!0){s=i.value;(null===o||o.includes(s))&&e.add(s)}u.next=19;break;case 15:u.prev=15;u.t0=u["catch"](11);r=!0;n=u.t0;case 19:u.prev=19;u.prev=20;!t&&a["return"]&&a["return"]();case 22:u.prev=22;if(!r){u.next=25;break}throw n;case 25:return u.finish(22);case 26:return u.finish(19);case 27:return u.abrupt("return",e);case 28:case"end":return u.stop()}},_callee87,this,[[11,15,19,27],[20,,22,26]])}));return function keys(){return e.apply(this,arguments)}}()},{key:"values",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee88(){var e,t,r,n,a,i,s,o,u=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee88$(c){for(;;)switch(c.prev=c.next){case 0:if(!(null!==u&&u instanceof E)){c.next=2;break}return c.abrupt("return",u.values(this));case 2:c.next=4;return this.keys(u);case 4:e=c.sent;t=[];r=!0;n=!1;a=undefined;c.prev=9;for(i=(0,_getIterator3["default"])(e);!(r=(s=i.next()).done);r=!0){o=s.value;t.push(this.get(o))}c.next=17;break;case 13:c.prev=13;c.t0=c["catch"](9);n=!0;a=c.t0;case 17:c.prev=17;c.prev=18;!r&&i["return"]&&i["return"]();case 20:c.prev=20;if(!n){c.next=23;break}throw a;case 23:return c.finish(20);case 24:return c.finish(17);case 25:return c.abrupt("return",_promise2["default"].all(t));case 26:case"end":return c.stop()}},_callee88,this,[[9,13,17,25],[18,,20,24]])}));return function values(){return e.apply(this,arguments)}}()},{key:"keyStream",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee89(e){var t,r,n,a=this,i=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return _regenerator2["default"].wrap(function _callee89$(o){for(;;)switch(o.prev=o.next){case 0:t=(0,_from2["default"])(this._modified.keys());s instanceof S&&(t=t.filter(function(e){return s.includes(e)}));t=t.sort();r=t.iterator(i);if(this._truncated){o.next=10;break}n=!1;o.next=8;return this._parent.keyStream(function(t){for(;r.hasNext()&&(i&&r.peek()<t||!i&&r.peek()>t);){var s=r.next();if(!e(s)){n=!0;return!1}}if(r.hasNext()&&r.peek()===t){var o=r.next();if(!e(o)){n=!0;return!1}return!0}if(!a._removed.has(t)&&!e(t)){n=!0;return!1}return!0},i,s);case 8:if(!n){o.next=10;break}return o.abrupt("return");case 10:if(!r.hasNext()){o.next=15;break}if(e(r.next())){o.next=13;break}return o.abrupt("break",15);case 13:o.next=10;break;case 15:case"end":return o.stop()}},_callee89,this)}));return function keyStream(t){return e.apply(this,arguments)}}()},{key:"valueStream",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee90(e){var t,r,n,a,i,s=this,o=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],u=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return _regenerator2["default"].wrap(function _callee90$(c){for(;;)switch(c.prev=c.next){case 0:t=(0,_from2["default"])(this._modified.keys());u instanceof S&&(t=t.filter(function(e){return u.includes(e)}));t=t.sort();r=t.iterator(o);if(this._truncated){c.next=10;break}n=!1;c.next=8;return this._parent.valueStream(function(t,a){for(;r.hasNext()&&(o&&r.peek()<a||!o&&r.peek()>a);){var i=r.next(),u=s._modified.get(i);if(!e(u,i)){n=!0;return!1}}if(r.hasNext()&&r.peek()===a){var c=r.next(),l=s._modified.get(c);if(!e(l,c)){n=!0;return!1}return!0}if(!s._removed.has(a)&&!e(t,a)){n=!0;return!1}return!0},o,u);case 8:if(!n){c.next=10;break}return c.abrupt("return");case 10:if(!r.hasNext()){c.next=19;break}a=r.next();c.next=14;return this.get(a);case 14:i=c.sent;if(e(i,a)){c.next=17;break}return c.abrupt("break",19);case 17:c.next=10;break;case 19:case"end":return c.stop()}},_callee90,this)}));return function valueStream(t){return e.apply(this,arguments)}}()},{key:"maxValue",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee91(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee91$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.maxKey(t);case 2:e=r.sent;return r.abrupt("return",this.get(e));case 4:case"end":return r.stop()}},_callee91,this)}));return function maxValue(){return e.apply(this,arguments)}}()},{key:"maxKey",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee92(){var e,t,r,n,a,i,s,o,u=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee92$(c){for(;;)switch(c.prev=c.next){case 0:e=undefined;if(this._truncated){c.next=5;break}c.next=4;return this._parent.maxKey(u);case 4:e=c.sent;case 5:if(e===undefined||!this._removed.has(e)){c.next=15;break}t=S.upperBound(e,!0);c.next=9;return this._parent.maxKey(t);case 9:e=c.sent;if(null===u||u.includes(e)){c.next=13;break}e=undefined;return c.abrupt("break",15);case 13:c.next=5;break;case 15:r=!0;n=!1;a=undefined;c.prev=18;for(i=(0,_getIterator3["default"])(this._modified.keys());!(r=(s=i.next()).done);r=!0){o=s.value;(null===u||u.includes(o))&&(e===undefined||o>e)&&(e=o)}c.next=26;break;case 22:c.prev=22;c.t0=c["catch"](18);n=!0;a=c.t0;case 26:c.prev=26;c.prev=27;!r&&i["return"]&&i["return"]();case 29:c.prev=29;if(!n){c.next=32;break}throw a;case 32:return c.finish(29);case 33:return c.finish(26);case 34:return c.abrupt("return",e);case 35:case"end":return c.stop()}},_callee92,this,[[18,22,26,34],[27,,29,33]])}));return function maxKey(){return e.apply(this,arguments)}}()},{key:"minValue",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee93(){var e,t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee93$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.minKey(t);case 2:e=r.sent;return r.abrupt("return",this.get(e));case 4:case"end":return r.stop()}},_callee93,this)}));return function minValue(){return e.apply(this,arguments)}}()},{key:"minKey",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee94(){var e,t,r,n,a,i,s,o,u=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee94$(c){for(;;)switch(c.prev=c.next){case 0:e=undefined;if(this._truncated){c.next=5;break}c.next=4;return this._parent.minKey(u);case 4:e=c.sent;case 5:if(e===undefined||!this._removed.has(e)){c.next=15;break}t=S.lowerBound(e,!0);c.next=9;return this._parent.minKey(t);case 9:e=c.sent;if(null===u||u.includes(e)){c.next=13;break}e=undefined;return c.abrupt("break",15);case 13:c.next=5;break;case 15:r=!0;n=!1;a=undefined;c.prev=18;for(i=(0,_getIterator3["default"])(this._modified.keys());!(r=(s=i.next()).done);r=!0){o=s.value;(null===u||u.includes(o))&&(e===undefined||o<e)&&(e=o)}c.next=26;break;case 22:c.prev=22;c.t0=c["catch"](18);n=!0;a=c.t0;case 26:c.prev=26;c.prev=27;!r&&i["return"]&&i["return"]();case 29:c.prev=29;if(!n){c.next=32;break}throw a;case 32:return c.finish(29);case 33:return c.finish(26);case 34:return c.abrupt("return",e);case 35:case"end":return c.stop()}},_callee94,this,[[18,22,26,34],[27,,29,33]])}));return function minKey(){return e.apply(this,arguments)}}()},{key:"count",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee95(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return _regenerator2["default"].wrap(function _callee95$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this.keys(e);case 2:return t.abrupt("return",t.sent.size);case 3:case"end":return t.stop()}},_callee95,this)}));return function count(){return e.apply(this,arguments)}}()},{key:"index",value:function index(e){return this._indices.get(e)}},{key:"createIndex",value:function createIndex(){throw new Error("Cannot create index in transaction")}},{key:"deleteIndex",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee96(){return _regenerator2["default"].wrap(function _callee96$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Cannot delete index in transaction");case 1:case"end":return e.stop()}},_callee96,this)}));return function deleteIndex(){return e.apply(this,arguments)}}()},{key:"close",value:function close(){return this.abort()}},{key:"transaction",value:function transaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];if(this._state!==Transaction.STATE.OPEN&&this._state!==Transaction.STATE.NESTED)throw new Error("Transaction already closed");var t=new Transaction(this._objectStore,this,this,e);this._nested.add(t);this._state=Transaction.STATE.NESTED;return t}},{key:"synchronousTransaction",value:function synchronousTransaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];if(this._state!==Transaction.STATE.OPEN&&this._state!==Transaction.STATE.NESTED)throw new Error("Transaction already closed");var t=new N(this._objectStore,this,this,e);this._nested.add(t);this._state=Transaction.STATE.NESTED;return t}},{key:"isSynchronous",value:function isSynchronous(){return!1}},{key:"snapshot",value:function snapshot(){if(this.state!==Transaction.STATE.COMMITTED){var snapshot=this._managingBackend.snapshot();snapshot.inherit(this);return snapshot}return this._snapshotManager.createSnapshot(this._objectStore,this)}},{key:"toString",value:function toString(){return"Transaction{id="+this._id+", changes="+(this._modified.size+this._removed.size)+", truncated="+this._truncated+", objectStore="+this._objectStore+", state="+this._state+", dependency="+this._dependency+"}"}},{key:"toStringShort",value:function toStringShort(){return"Transaction{id="+this._id+", changes="+(this._modified.size+this._removed.size)+", truncated="+this._truncated+", state="+this._state+", dependency="+this._dependency+"}"}},{key:"objectStore",get:function get(){return this._objectStore}},{key:"nested",get:function get(){return this._managingBackend instanceof Transaction}},{key:"dependency",get:function get(){return this._dependency}},{key:"connected",get:function get(){return this._managingBackend.connected}},{key:"id",get:function get(){return this._id}},{key:"indices",get:function get(){return this._indices}},{key:"state",get:function get(){return this._state}}]);return Transaction}();P.WATCHDOG_TIMER=5e3;P.STATE={OPEN:0,COMMITTED:1,ABORTED:2,CONFLICTED:3,NESTED:4};P._instanceCount=0;t.register(P);var N=function(e){(0,_inherits3["default"])(SynchronousTransaction,e);function SynchronousTransaction(e,t,r){var n=!(arguments.length>3&&arguments[3]!==undefined)||arguments[3];(0,_classCallCheck3["default"])(this,SynchronousTransaction);var a=(0,_possibleConstructorReturn3["default"])(this,(SynchronousTransaction.__proto__||(0,_getPrototypeOf2["default"])(SynchronousTransaction)).call(this,e,t,r,n));a._cache=new _map2["default"];return a}(0,_createClass3["default"])(SynchronousTransaction,[{key:"preload",value:function preload(e){var t=this;e=e.filter(function(e){return!t.isCached(e)});return _promise2["default"].all(e.map(function(e){return t.get(e)}))}},{key:"isCached",value:function isCached(e){return this._cache.has(e)||!!this._parent.isSynchronous()&&this._parent.isCached(e)}},{key:"get",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee97(e){var t;return _regenerator2["default"].wrap(function _callee97$(r){for(;;)switch(r.prev=r.next){case 0:if(t=this.getSync(e,!1)){r.next=6;break}r.next=4;return P.prototype.get.call(this,e);case 4:t=r.sent;this._cache.set(e,t);case 6:return r.abrupt("return",t);case 7:case"end":return r.stop()}},_callee97,this)}));return function get(t){return e.apply(this,arguments)}}()},{key:"_getCached",value:function _getCached(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=this._cache.get(e);if(!r&&this._parent.isSynchronous())return this._parent.getSync(e,t);if(t&&!r)throw new Error("Missing key in cache: "+e);return r}},{key:"getSync",value:function getSync(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1];return this._removed.has(e)?undefined:this._modified.has(e)?this._modified.get(e):this._truncated?undefined:this._getCached(e,t)}},{key:"putSync",value:function putSync(e,t){if(this._state!==P.STATE.OPEN)throw new Error("Transaction already closed");var r=this.getSync(e,!1);this._originalValues.has(e)||this._originalValues.set(e,r);this._put(e,t,r)}},{key:"removeSync",value:function removeSync(e){if(this._state!==P.STATE.OPEN)throw new Error("Transaction already closed");var t=this.getSync(e,!1);this._originalValues.has(e)||this._originalValues.set(e,t);this._remove(e,t)}},{key:"snapshot",value:function snapshot(){throw new Error("Invalid call on SynchronousTransaction")}},{key:"isSynchronous",value:function isSynchronous(){return!0}},{key:"_commitBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee98(){var e,t,r,n,a,i,s,o,u,c,l,h,f;return _regenerator2["default"].wrap(function _callee98$(_){for(;;)switch(_.prev=_.next){case 0:if(this._truncated){_.next=69;break}e=!0;t=!1;r=undefined;_.prev=4;n=(0,_getIterator3["default"])(this._modified.keys());case 6:if(e=(a=n.next()).done){_.next=22;break}i=a.value;if(!this._originalValues.get(i)){_.next=10;break}return _.abrupt("continue",19);case 10:_.t0=this._originalValues;_.t1=i;_.t2=this._getCached(i,!1);if(_.t2){_.next=17;break}_.next=16;return this._parent.get(i);case 16:_.t2=_.sent;case 17:_.t3=_.t2;_.t0.set.call(_.t0,_.t1,_.t3);case 19:e=!0;_.next=6;break;case 22:_.next=28;break;case 24:_.prev=24;_.t4=_["catch"](4);t=!0;r=_.t4;case 28:_.prev=28;_.prev=29;!e&&n["return"]&&n["return"]();case 31:_.prev=31;if(!t){_.next=34;break}throw r;case 34:return _.finish(31);case 35:return _.finish(28);case 36:s=!0;o=!1;u=undefined;_.prev=39;c=(0,_getIterator3["default"])(new _set3["default"](this._removed).values());case 41:if(s=(l=c.next()).done){_.next=55;break}h=l.value;if(!this._originalValues.get(h)){_.next=45;break}return _.abrupt("continue",52);case 45:_.t5=this._getCached(h,!1);if(_.t5){_.next=50;break}_.next=49;return this._parent.get(h);case 49:_.t5=_.sent;case 50:(f=_.t5)?this._originalValues.set(h,f):this._removed["delete"](h);case 52:s=!0;_.next=41;break;case 55:_.next=61;break;case 57:_.prev=57;_.t6=_["catch"](39);o=!0;u=_.t6;case 61:_.prev=61;_.prev=62;!s&&c["return"]&&c["return"]();case 64:_.prev=64;if(!o){_.next=67;break}throw u;case 67:return _.finish(64);case 68:return _.finish(61);case 69:return _.abrupt("return",P.prototype._commitBackend.call(this));case 70:case"end":return _.stop()}},_callee98,this,[[4,24,28,36],[29,,31,35],[39,57,61,69],[62,,64,68]])}));return function _commitBackend(){return e.apply(this,arguments)}}()}]);return SynchronousTransaction}(P);t.register(N);var O=function(e){(0,_inherits3["default"])(Snapshot,e);function Snapshot(e,t){(0,_classCallCheck3["default"])(this,Snapshot);return(0,_possibleConstructorReturn3["default"])(this,(Snapshot.__proto__||(0,_getPrototypeOf2["default"])(Snapshot)).call(this,e,t,e,!1))}(0,_createClass3["default"])(Snapshot,[{key:"inherit",value:function inherit(e){if(!(e instanceof P))throw new Error("Can only inherit transactions");return(0,_get3["default"])(Snapshot.prototype.__proto__||(0,_getPrototypeOf2["default"])(Snapshot.prototype),"_applySync",this).call(this,e)}},{key:"_apply",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee99(e){var t,r,n,a,i,s,o,u,c,l,h,f,_,d,p=this;return _regenerator2["default"].wrap(function _callee99$(g){for(;;)switch(g.prev=g.next){case 0:if(e instanceof P){g.next=2;break}throw new Error("Can only apply transactions");case 2:if(!e._truncated){g.next=5;break}g.next=5;return this.valueStream(function(e,t){p._modified.has(t)||p._put(t,e);return!0});case 5:t=!0;r=!1;n=undefined;g.prev=8;a=(0,_getIterator3["default"])(e._modified);case 10:if(t=(i=a.next()).done){g.next=19;break}s=(0,_slicedToArray3["default"])(i.value,2),o=s[0],u=s[1];if(!this._modified.has(o)){g.next=14;break}return g.abrupt("continue",16);case 14:(c=e._originalValues.get(o))?this._put(o,c,u):this._remove(o,u);case 16:t=!0;g.next=10;break;case 19:g.next=25;break;case 21:g.prev=21;g.t0=g["catch"](8);r=!0;n=g.t0;case 25:g.prev=25;g.prev=26;!t&&a["return"]&&a["return"]();case 28:g.prev=28;if(!r){g.next=31;break}throw n;case 31:return g.finish(28);case 32:return g.finish(25);case 33:l=!0;h=!1;f=undefined;g.prev=36;_=(0,_getIterator3["default"])(e._removed);case 38:if(l=(d=_.next()).done){g.next=46;break}o=d.value;if(!this._modified.has(o)){g.next=42;break}return g.abrupt("continue",43);case 42:this._put(o,e._originalValues.get(o));case 43:l=!0;g.next=38;break;case 46:g.next=52;break;case 48:g.prev=48;g.t1=g["catch"](36);h=!0;f=g.t1;case 52:g.prev=52;g.prev=53;!l&&_["return"]&&_["return"]();case 55:g.prev=55;if(!h){g.next=58;break}throw f;case 58:return g.finish(55);case 59:return g.finish(52);case 60:case"end":return g.stop()}},_callee99,this,[[8,21,25,33],[26,,28,32],[36,48,52,60],[53,,55,59]])}));return function _apply(t){return e.apply(this,arguments)}}()},{key:"truncate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee100(){return _regenerator2["default"].wrap(function _callee100$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Unsupported operation on snapshots");case 1:case"end":return e.stop()}},_callee100,this)}));return function truncate(){return e.apply(this,arguments)}}()},{key:"commit",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee101(e){return _regenerator2["default"].wrap(function _callee101$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Cannot commit snapshots");case 1:case"end":return e.stop()}},_callee101,this)}));return function commit(t){return e.apply(this,arguments)}}()},{key:"_isCommittable",value:function _isCommittable(e){return!1}},{key:"_commitInternal",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee102(e){return _regenerator2["default"].wrap(function _callee102$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Cannot commit snapshots");case 1:case"end":return e.stop()}},_callee102,this)}));return function _commitInternal(t){return e.apply(this,arguments)}}()},{key:"_commitBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee103(){return _regenerator2["default"].wrap(function _callee103$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Cannot commit snapshots");case 1:case"end":return e.stop()}},_callee103,this)}));return function _commitBackend(){return e.apply(this,arguments)}}()},{key:"abort",value:function abort(e){return this._abortBackend()}},{key:"_abortBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee104(){var e,t,r,n,a;return _regenerator2["default"].wrap(function _callee104$(i){for(;;)switch(i.prev=i.next){case 0:if(this._state===P.STATE.OPEN){i.next=2;break}throw new Error("Snapshot already closed");case 2:i.next=4;return this._managingBackend.abort(this);case 4:if(i.sent){i.next=7;break}return i.abrupt("return",!1);case 7:this._state=P.STATE.ABORTED;this._truncated=!0;this._modified.clear();this._removed.clear();this._originalValues.clear();e=!0;t=!1;r=undefined;i.prev=15;for(n=(0,_getIterator3["default"])(this._indices.values());!(e=(a=n.next()).done);e=!0)a.value.truncate();i.next=23;break;case 19:i.prev=19;i.t0=i["catch"](15);t=!0;r=i.t0;case 23:i.prev=23;i.prev=24;!e&&n["return"]&&n["return"]();case 26:i.prev=26;if(!t){i.next=29;break}throw r;case 29:return i.finish(26);case 30:return i.finish(23);case 31:return i.abrupt("return",!0);case 32:case"end":return i.stop()}},_callee104,this,[[15,19,23,31],[24,,26,30]])}));return function _abortBackend(){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee105(e,t){return _regenerator2["default"].wrap(function _callee105$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Unsupported operation on snapshots");case 1:case"end":return e.stop()}},_callee105,this)}));return function put(t,r){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee106(e){return _regenerator2["default"].wrap(function _callee106$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Unsupported operation on snapshots");case 1:case"end":return e.stop()}},_callee106,this)}));return function remove(t){return e.apply(this,arguments)}}()},{key:"createIndex",value:function createIndex(){throw new Error("Unsupported operation on snapshots")}},{key:"deleteIndex",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee107(){return _regenerator2["default"].wrap(function _callee107$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Unsupported operation on snapshots");case 1:case"end":return e.stop()}},_callee107,this)}));return function deleteIndex(){return e.apply(this,arguments)}}()},{key:"close",value:function close(){return this.abort()}},{key:"transaction",value:function transaction(){throw new Error("Unsupported operation on snapshots")}},{key:"snapshot",value:function snapshot(){throw new Error("Unsupported operation on snapshots")}}]);return Snapshot}(P);t.register(O);var R=function(){function SnapshotManager(){(0,_classCallCheck3["default"])(this,SnapshotManager);this._snapshots=new _set3["default"]}(0,_createClass3["default"])(SnapshotManager,[{key:"createSnapshot",value:function createSnapshot(e,t){var r=new O(e,t);this._snapshots.add(r);return r}},{key:"abortSnapshot",value:function abortSnapshot(e){return this._snapshots["delete"](e)}},{key:"applyTx",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee108(e,t){var r,n,a,i,s,o,u,c,l,h,f,_,d;return _regenerator2["default"].wrap(function _callee108$(p){for(;;)switch(p.prev=p.next){case 0:if(e instanceof P){p.next=2;break}throw new Error("Can only apply transactions");case 2:r=[];n=!0;a=!1;i=undefined;p.prev=6;for(s=(0,_getIterator3["default"])(this._snapshots);!(n=(o=s.next()).done);n=!0){u=o.value;r.push(u._apply(e))}p.next=14;break;case 10:p.prev=10;p.t0=p["catch"](6);a=!0;i=p.t0;case 14:p.prev=14;p.prev=15;!n&&s["return"]&&s["return"]();case 17:p.prev=17;if(!a){p.next=20;break}throw i;case 20:return p.finish(17);case 21:return p.finish(14);case 22:c=!0;l=!1;h=undefined;p.prev=25;for(f=(0,_getIterator3["default"])(e._snapshotManager);!(c=(_=f.next()).done);c=!0){(d=_.value)._backend=t;this._snapshots.add(d)}p.next=33;break;case 29:p.prev=29;p.t1=p["catch"](25);l=!0;h=p.t1;case 33:p.prev=33;p.prev=34;!c&&f["return"]&&f["return"]();case 36:p.prev=36;if(!l){p.next=39;break}throw h;case 39:return p.finish(36);case 40:return p.finish(33);case 41:return p.abrupt("return",_promise2["default"].all(r));case 42:case"end":return p.stop()}},_callee108,this,[[6,10,14,22],[15,,17,21],[25,29,33,41],[34,,36,40]])}));return function applyTx(t,r){return e.apply(this,arguments)}}()},{key:_iterator178["default"],value:function value(){return this._snapshots.values()}}]);return SnapshotManager}();t.register(R);var M=function(){function CombinedTransaction(){(0,_classCallCheck3["default"])(this,CombinedTransaction);for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];if(!this.isConsistent(t))throw new Error("Given set of transactions violates rules for combined transactions");this._transactions=t;this._flushable=new _map2["default"];this._preprocessing=[];this._dependency=this}(0,_createClass3["default"])(CombinedTransaction,[{key:"isConsistent",value:function isConsistent(e){var t=new _set3["default"];this._jdb=null;var r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(e);!(r=(i=s.next()).done);r=!0){var o=i.value;if(o.state!==P.STATE.OPEN)return!1;if(o.nested)return!1;if(t.has(o._objectStore))return!1;if(null===this._jdb)this._jdb=o._objectStore.jungleDB;else if(this._jdb!==o._objectStore.jungleDB&&null!==o._objectStore.jungleDB)return!1;t.add(o._objectStore)}}catch(u){n=!0;a=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}return!0}},{key:"onFlushable",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee109(e){var t,r,n,a,i,o,u,c,l,h,f,_,d=this,p=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null,g=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return _regenerator2["default"].wrap(function _callee109$(y){for(;;)switch(y.prev=y.next){case 0:this._flushable.set(e,p);null!==g&&this._preprocessing.push(g);if(!this._transactions.every(function(e){return d._flushable.has(e)})){y.next=47;break}t=[];r=!0;n=!1;a=undefined;y.prev=7;for(i=(0,_getIterator3["default"])(this._preprocessing);!(r=(o=i.next()).done);r=!0){u=o.value;t.push(u())}y.next=15;break;case 11:y.prev=11;y.t0=y["catch"](7);n=!0;a=y.t0;case 15:y.prev=15;y.prev=16;!r&&i["return"]&&i["return"]();case 18:y.prev=18;if(!n){y.next=21;break}throw a;case 21:return y.finish(18);case 22:return y.finish(15);case 23:y.next=25;return _promise2["default"].all(t);case 25:y.next=27;return s.commitCombined(this);case 27:c=!0;l=!1;h=undefined;y.prev=30;for(f=(0,_getIterator3["default"])(this._flushable.values());!(c=(_=f.next()).done);c=!0)(0,_.value)();y.next=38;break;case 34:y.prev=34;y.t1=y["catch"](30);l=!0;h=y.t1;case 38:y.prev=38;y.prev=39;!c&&f["return"]&&f["return"]();case 41:y.prev=41;if(!l){y.next=44;break}throw h;case 44:return y.finish(41);case 45:return y.finish(38);case 46:return y.abrupt("return",!0);case 47:return y.abrupt("return",!1);case 48:case"end":return y.stop()}},_callee109,this,[[7,11,15,23],[16,,18,22],[30,34,38,46],[39,,41,45]])}));return function onFlushable(t){return e.apply(this,arguments)}}()},{key:"commit",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee110(){return _regenerator2["default"].wrap(function _callee110$(e){for(;;)switch(e.prev=e.next){case 0:if(!this._isCommittable()){e.next=4;break}e.next=3;return this._commitBackend();case 3:return e.abrupt("return",!0);case 4:e.next=6;return this.abort();case 6:return e.abrupt("return",!1);case 7:case"end":return e.stop()}},_callee110,this)}));return function commit(){return e.apply(this,arguments)}}()},{key:"abort",value:function abort(){return this._abortBackend()}},{key:"_abortBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee111(){return _regenerator2["default"].wrap(function _callee111$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return _promise2["default"].all(this._transactions.map(function(e){return e._abortBackend()}));case 2:e.t0=function(e){return e};return e.abrupt("return",e.sent.every(e.t0));case 4:case"end":return e.stop()}},_callee111,this)}));return function _abortBackend(){return e.apply(this,arguments)}}()},{key:"transaction",value:function transaction(e){throw new Error("Unsupported operation")}},{key:"snapshot",value:function snapshot(){throw new Error("Unsupported operation")}},{key:"_isCommittable",value:function _isCommittable(){return this._transactions.every(function(e){return e._isCommittable()})}},{key:"_commitBackend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee112(){return _regenerator2["default"].wrap(function _callee112$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return _promise2["default"].all(this._transactions.map(function(e){return e._commitBackend()}));case 2:e.t0=function(e){return e};return e.abrupt("return",e.sent.every(e.t0));case 4:case"end":return e.stop()}},_callee112,this)}));return function _commitBackend(){return e.apply(this,arguments)}}()},{key:"_commitInternal",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee113(e){return _regenerator2["default"].wrap(function _callee113$(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Cannot commit transactions to a combined transaction");case 1:case"end":return e.stop()}},_callee113,this)}));return function _commitInternal(t){return e.apply(this,arguments)}}()},{key:"_setParent",value:function _setParent(e){throw new Error("Unsupported operation")}},{key:"toString",value:function toString(){return"CombinedTransaction{size="+this._transactions.length+", states=["+this._transactions.map(function(e){return e.state})+"]}"}},{key:"backend",get:function get(){return this._jdb}},{key:"transactions",get:function get(){return this._transactions}},{key:"_dependency",set:function set(e){var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._transactions);!(t=(a=i.next()).done);t=!0){a.value._dependency=e}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"dependency",get:function get(){return this}},{key:"objectStore",get:function get(){throw new Error("Unsupported operation")}}]);return CombinedTransaction}();t.register(M);e._loaded=!0;"function"==typeof e._onload&&e._onload()}(JDB);if("undefined"==typeof Nimiq)var Nimiq="undefined"!=typeof window?window:{};!function(e){(Nimiq=e="undefined"!=typeof e?e:{})._currentScript||(Nimiq._currentScript=document.currentScript);if(!Nimiq._currentScript){var t=document.getElementsByTagName("script");Nimiq._currentScript=t[t.length-1]}Nimiq._path||(Nimiq._currentScript&&-1!==Nimiq._currentScript.src.indexOf("/")?Nimiq._path=Nimiq._currentScript.src.substring(0,Nimiq._currentScript.src.lastIndexOf("/")+1):Nimiq._path="./");var r=function(){function Class(){(0,_classCallCheck3["default"])(this,Class)}(0,_createClass3["default"])(Class,null,[{key:"register",value:function register(t){"undefined"!=typeof e&&(e[t.name]=t)}}]);return Class}();r.register(r);var n=function(){function LogNative(){(0,_classCallCheck3["default"])(this,LogNative);this._global_level=a.INFO;this._tag_levels={};try{if(window.localStorage)try{var e=window.localStorage.getItem("log_tag_levels");e&&"string"==typeof e&&(e=JSON.parse(e));e&&"object"===("undefined"==typeof e?"undefined":(0,_typeof3["default"])(e))&&(this._tag_levels=e)}catch(t){console.warn("Failed to load log configuration from local storage.")}}catch(t){}}(0,_createClass3["default"])(LogNative,[{key:"isLoggable",value:function isLoggable(e,t){return e&&this._tag_levels[e]?this._tag_levels[e]<=t:this._tag_levels["*"]?this._tag_levels["*"]<=t:this._global_level<=t}},{key:"setLoggable",value:function setLoggable(e,t){e&&e.name&&(e=e.name);this._tag_levels[e]=t;window.localStorage&&window.localStorage.setItem("log_tag_levels",(0,_stringify2["default"])(this._tag_levels))}},{key:"msg",value:function msg(e,t,r){t&&t.name&&(t=t.name);if(this.isLoggable(t,e)){t&&r.unshift(t+":");r.unshift("["+a.Level.toStringTag(e)+" "+(new Date).toTimeString().substr(0,8)+"]");console.error&&e>=a.ERROR?console.error.apply(console,r):console.warn&&e>=a.WARNING?console.warn.apply(console,r):console.info&&e>=a.INFO?console.info.apply(console,r):console.debug&&e>=a.DEBUG?console.debug.apply(console,r):console.trace&&e<=a.TRACE?console.trace.apply(console,r):console.log.apply(console,r)}}}]);return LogNative}();r.register(n);var a=function(){(0,_createClass3["default"])(Log,null,[{key:"instance",get:function get(){Log._instance||(Log._instance=new Log(new n));return Log._instance}}]);function Log(e){(0,_classCallCheck3["default"])(this,Log);this._native=e}(0,_createClass3["default"])(Log,[{key:"setLoggable",value:function setLoggable(e,t){this._native.setLoggable(e,t)}},{key:"msg",value:function msg(e,t,r){if(this._native.isLoggable(t,e)){for(var n=0;n<r.length;++n){"function"==typeof r[n]&&(r[n]=r[n]());"object"===(0,_typeof3["default"])(r[n])&&("function"==typeof r[n].toString?r[n]=r[n].toString():r[n].constructor&&r[n].constructor.name?r[n]="{Object: "+r[n].constructor.name+"}":r[n]="{Object}")}this._native.msg(e,t,r)}}},{key:"level",get:function get(){return this._native._global_level},set:function set(e){this._native._global_level=e}}],[{key:"d",value:function d(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.DEBUG,e,n)}},{key:"e",value:function e(t,r){for(var n=arguments.length,a=Array(n>2?n-2:0),i=2;i<n;i++)a[i-2]=arguments[i];if(arguments.length>=2){t=arguments[0];a=Array.prototype.slice.call(arguments,1)}else{t=undefined;a=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.ERROR,t,a)}},{key:"i",value:function i(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.INFO,e,n)}},{key:"v",value:function v(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.VERBOSE,e,n)}},{key:"w",value:function w(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];if(arguments.length>=2){e=arguments[0];n=Array.prototype.slice.call(arguments,1)}else{e=undefined;n=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.WARNING,e,n)}},{key:"t",value:function t(e,r){for(var n=arguments.length,a=Array(n>2?n-2:0),i=2;i<n;i++)a[i-2]=arguments[i];if(arguments.length>=2){e=arguments[0];a=Array.prototype.slice.call(arguments,1)}else{e=undefined;a=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.TRACE,e,a)}}]);return Log}();a.Level={TRACE:1,VERBOSE:2,DEBUG:3,INFO:4,WARNING:5,ERROR:6,ASSERT:7,toStringTag:function toStringTag(e){switch(e){case a.TRACE:return"T";case a.VERBOSE:return"V";case a.DEBUG:return"D";case a.INFO:return"I";case a.WARNING:return"W";case a.ERROR:return"E";case a.ASSERT:return"A";default:return"*"}}};a.TRACE=a.Level.TRACE;a.VERBOSE=a.Level.VERBOSE;a.DEBUG=a.Level.DEBUG;a.INFO=a.Level.INFO;a.WARNING=a.Level.WARNING;a.ERROR=a.Level.ERROR;a.ASSERT=a.Level.ASSERT;a._instance=null;a.d.tag=function(e){return a.d.bind(null,e)};a.e.tag=function(e){return a.e.bind(null,e)};a.i.tag=function(e){return a.i.bind(null,e)};a.v.tag=function(e){return a.v.bind(null,e)};a.w.tag=function(e){return a.w.bind(null,e)};a.t.tag=function(e){return a.t.bind(null,e)};r.register(a);var i=function(){(0,_createClass3["default"])(Observable,null,[{key:"WILDCARD",get:function get(){return"*"}}]);function Observable(){(0,_classCallCheck3["default"])(this,Observable);this._listeners=new _map2["default"]}(0,_createClass3["default"])(Observable,[{key:"on",value:function on(e,t){if(this._listeners.has(e))return this._listeners.get(e).push(t)-1;this._listeners.set(e,[t]);return 0}},{key:"off",value:function off(e,t){this._listeners.has(e)&&this._listeners.get(e)[t]&&delete this._listeners.get(e)[t]}},{key:"fire",value:function fire(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(this._listeners.has(e))for(var a in this._listeners.get(e)){this._listeners.get(e)[a].apply(null,r)}if(this._listeners.has(Observable.WILDCARD))for(var i in this._listeners.get(Observable.WILDCARD)){this._listeners.get(Observable.WILDCARD)[i].apply(null,arguments)}}},{key:"bubble",value:function bubble(e){for(var t=this,r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];var i=!0,s=!1,o=undefined;try{for(var u,c=function _loop3(){var r=u.value,n=void 0;n=r==Observable.WILDCARD?function callback(){this.fire.apply(this,arguments)}:function callback(){this.fire.apply(this,[r].concat(Array.prototype.slice.call(arguments)))};e.on(r,n.bind(t))},l=(0,_getIterator3["default"])(n);!(i=(u=l.next()).done);i=!0)c()}catch(h){s=!0;o=h}finally{try{!i&&l["return"]&&l["return"]()}finally{if(s)throw o}}}}]);return Observable}();r.register(i);var s=function(e){(0,_inherits3["default"])(DataChannel,e);function DataChannel(){(0,_classCallCheck3["default"])(this,DataChannel);var e=(0,_possibleConstructorReturn3["default"])(this,(DataChannel.__proto__||(0,_getPrototypeOf2["default"])(DataChannel)).call(this));e._buffer=null;e._msgType=0;e._receivingTag=-1;e._sendingTag=0;e._expectedMessagesByType=new _map2["default"];e._timers=new _;return e}(0,_createClass3["default"])(DataChannel,[{key:"isExpectingMessage",value:function isExpectingMessage(e){return this._expectedMessagesByType.has(e)}},{key:"expectMessage",value:function expectMessage(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:DataChannel.MESSAGE_TIMEOUT,n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:DataChannel.CHUNK_TIMEOUT;Array.isArray(e)||(e=[e]);if(0!==e.length){var a=new o(e,t,r,n),i=!0,s=!1,u=undefined;try{for(var c,l=(0,_getIterator3["default"])(e);!(i=(c=l.next()).done);i=!0){var h=c.value;this._expectedMessagesByType.set(h,a)}}catch(f){s=!0;u=f}finally{try{!i&&l["return"]&&l["return"]()}finally{if(s)throw u}}this._timers.resetTimeout("chunk-"+a.id,this._onTimeout.bind(this,a),n);this._timers.resetTimeout("msg-"+a.id,this._onTimeout.bind(this,a),r)}}},{key:"close",value:function close(){throw new Error("Not implemented")}},{key:"_onClose",value:function _onClose(){this._timers.clearAll();this.fire("close",this)}},{key:"_error",value:function _error(e){this.fire("error",e,this);a.e(DataChannel,e);this.close()}},{key:"_onMessage",value:function _onMessage(e){try{if(this.readyState!==DataChannel.ReadyState.OPEN)return;var t=new T(e);if(0===t.byteLength)return;if(t.byteLength>DataChannel.CHUNK_SIZE_MAX){this._error("Received chunk larger than maximum chunk size, discarding");return}var r=t.readUint8(),n=t.byteLength-t.readPos,i=t.read(n);if(null===this._buffer&&r===(this._receivingTag+1)%I.UINT8_MAX){var s=new T(i),o=Je.peekLength(s);if(o>DataChannel.MESSAGE_SIZE_MAX){this._error("Received message with excessive message size "+o+" > "+DataChannel.MESSAGE_SIZE_MAX);return}this._buffer=new T(o);this._receivingTag=r;this._msgType=Je.peekType(s)}if(null===this._buffer){a.e(DataChannel,"Message does not start next tag "+(this._receivingTag+1)+" (but "+r+"), but buffer is null");return}if(r!==this._receivingTag){this._error("Received message with wrong message tag "+r+", expected "+this._receivingTag);return}var u=this._buffer.byteLength-this._buffer.writePos;if(n>u){this._error("Received chunk larger than remaining bytes to read, discarding");return}this._buffer.write(i);u-=n;var c=this._expectedMessagesByType.get(this._msgType);if(0===u){if(c){this._timers.clearTimeout("chunk-"+c.id);this._timers.clearTimeout("msg-"+c.id);var l=!0,h=!1,f=undefined;try{for(var _,d=(0,_getIterator3["default"])(c.types);!(l=(_=d.next()).done);l=!0){var p=_.value;this._expectedMessagesByType["delete"](p)}}catch(y){h=!0;f=y}finally{try{!l&&d["return"]&&d["return"]()}finally{if(h)throw f}}}var g=this._buffer.buffer;this._buffer=null;this.fire("message",g,this)}else{c&&this._timers.resetTimeout("chunk-"+c.id,this._onTimeout.bind(this,c),c.chunkTimeout);this.fire("chunk",this._buffer)}}catch(v){this._error("Error occurred while parsing incoming message, "+v.message)}}},{key:"_onTimeout",value:function _onTimeout(e){if(e){this._timers.clearTimeout("chunk-"+e.id);this._timers.clearTimeout("msg-"+e.id);var t=!0,r=!1,n=undefined;try{for(var i,s=(0,_getIterator3["default"])(e.types);!(t=(i=s.next()).done);t=!0){var o=i.value;this._expectedMessagesByType["delete"](o)}}catch(u){r=!0;n=u}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}e.timeoutCallback()}a.e(DataChannel,"Timeout while receiving chunked message");this._buffer=null}},{key:"send",value:function send(e){C.that(e.byteLength<=DataChannel.MESSAGE_SIZE_MAX,"DataChannel.send() max message size exceeded");var t=this._sendingTag;this._sendingTag=(this._sendingTag+1)%I.UINT8_MAX;this._sendChunked(e,t)}},{key:"_sendChunked",value:function _sendChunked(e,t){for(var r=e.byteLength,n=null;r>0;){var a=null;if(r+1>=DataChannel.CHUNK_SIZE_MAX){(a=new T(DataChannel.CHUNK_SIZE_MAX)).writeUint8(t);n=new Uint8Array(e.buffer,e.byteLength-r,DataChannel.CHUNK_SIZE_MAX-1)}else{(a=new T(r+1)).writeUint8(t);n=new Uint8Array(e.buffer,e.byteLength-r,r)}a.write(n);this.sendChunk(a);r-=n.byteLength}}},{key:"sendChunk",value:function sendChunk(e){throw new Error("Not implemented")}},{key:"readyState",get:function get(){throw new Error("Not implemented")}}]);return DataChannel}(i);s.CHUNK_SIZE_MAX=16384;s.MESSAGE_SIZE_MAX=10485760;s.CHUNK_TIMEOUT=5e3;s.MESSAGE_TIMEOUT=s.MESSAGE_SIZE_MAX/s.CHUNK_SIZE_MAX*s.CHUNK_TIMEOUT;var o=function ExpectedMessage(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:s.MESSAGE_TIMEOUT,n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:s.CHUNK_TIMEOUT;(0,_classCallCheck3["default"])(this,ExpectedMessage);this.id=e.join(":");this.types=e;this.timeoutCallback=t;this.msgTimeout=r;this.chunkTimeout=n};s.ReadyState={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};s.ReadyState.fromString=function(e){switch(e){case"connecting":return s.ReadyState.CONNECTING;case"open":return s.ReadyState.OPEN;case"closing":return s.ReadyState.CLOSING;case"closed":return s.ReadyState.CLOSED;default:throw new Error("Invalid string")}};r.register(s);var u=function(){function CryptoLib(){(0,_classCallCheck3["default"])(this,CryptoLib)}(0,_createClass3["default"])(CryptoLib,null,[{key:"instance",get:function get(){if(!CryptoLib._instance){var e={};e.getRandomValues=(window.crypto||window.msCrypto).getRandomValues.bind(window.crypto);CryptoLib._instance=e}return CryptoLib._instance}}]);return CryptoLib}();u._instance=null;r.register(u);var c=function(){function WebRtcFactory(){(0,_classCallCheck3["default"])(this,WebRtcFactory)}(0,_createClass3["default"])(WebRtcFactory,null,[{key:"newPeerConnection",value:function newPeerConnection(e){return new RTCPeerConnection(e)}},{key:"newSessionDescription",value:function newSessionDescription(e){return new RTCSessionDescription(e)}},{key:"newIceCandidate",value:function newIceCandidate(e){return new RTCIceCandidate(e)}}]);return WebRtcFactory}();r.register(c);var l=function(){function WebSocketFactory(){(0,_classCallCheck3["default"])(this,WebSocketFactory)}(0,_createClass3["default"])(WebSocketFactory,null,[{key:"newWebSocketServer",value:function newWebSocketServer(){return new i}},{key:"newWebSocket",value:function newWebSocket(e){return new WebSocket(e)}}]);return WebSocketFactory}();r.register(l);var h=function(){function Services(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:Services.NONE,t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Services.NONE;(0,_classCallCheck3["default"])(this,Services);this._provided=e;this._accepted=t}(0,_createClass3["default"])(Services,[{key:"provided",get:function get(){return this._provided},set:function set(e){this._provided=e}},{key:"accepted",get:function get(){return this._accepted},set:function set(e){this._accepted=e}}],[{key:"isFullNode",value:function isFullNode(e){return 0!=(e&Services.FULL)}},{key:"isLightNode",value:function isLightNode(e){return 0!=(e&Services.LIGHT)}},{key:"isNanoNode",value:function isNanoNode(e){return e===Services.NANO}}]);return Services}();h.NONE=0;h.NANO=1;h.LIGHT=2;h.FULL=4;r.register(h);var f=function(e){(0,_inherits3["default"])(Synchronizer,e);function Synchronizer(){(0,_classCallCheck3["default"])(this,Synchronizer);var e=(0,_possibleConstructorReturn3["default"])(this,(Synchronizer.__proto__||(0,_getPrototypeOf2["default"])(Synchronizer)).call(this));e._queue=[];e._working=!1;return e}(0,_createClass3["default"])(Synchronizer,[{key:"push",value:function push(e){var t=this;return new _promise2["default"](function(r,n){t._queue.push({fn:e,resolve:r,reject:n});t._working||t._doWork()["catch"](a.w.tag(Synchronizer))})}},{key:"clear",value:function clear(){var e=!0,t=!1,r=undefined;try{for(var n,a=(0,_getIterator3["default"])(this._queue);!(e=(n=a.next()).done);e=!0){var i=n.value;i.reject&&i.reject()}}catch(s){t=!0;r=s}finally{try{!e&&a["return"]&&a["return"]()}finally{if(t)throw r}}this._queue=[]}},{key:"_doWork",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee114(){var e,t;return _regenerator2["default"].wrap(function _callee114$(r){for(;;)switch(r.prev=r.next){case 0:this._working=!0;this.fire("work-start",this);case 2:if(!this._queue.length){r.next=16;break}e=this._queue.shift();r.prev=4;r.next=7;return e.fn();case 7:t=r.sent;e.resolve(t);r.next=14;break;case 11:r.prev=11;r.t0=r["catch"](4);e.reject&&e.reject(r.t0);case 14:r.next=2;break;case 16:this._working=!1;this.fire("work-end",this);case 18:case"end":return r.stop()}},_callee114,this,[[4,11]])}));return function _doWork(){return e.apply(this,arguments)}}()},{key:"working",get:function get(){return this._working}}]);return Synchronizer}(i);r.register(f);var _=function(){function Timers(){(0,_classCallCheck3["default"])(this,Timers);this._timeouts={};this._intervals={}}(0,_createClass3["default"])(Timers,[{key:"setTimeout",value:function(e){function setTimeout(t,r,n){return e.apply(this,arguments)}setTimeout.toString=function(){return e.toString()};return setTimeout}(function(e,t,r){if(this._timeouts[e])throw"Duplicate timeout for key "+e;this._timeouts[e]=setTimeout(t,r)})},{key:"clearTimeout",value:function(e){function clearTimeout(t){return e.apply(this,arguments)}clearTimeout.toString=function(){return e.toString()};return clearTimeout}(function(e){clearTimeout(this._timeouts[e]);delete this._timeouts[e]})},{key:"resetTimeout",value:function resetTimeout(e,t,r){clearTimeout(this._timeouts[e]);this._timeouts[e]=setTimeout(t,r)}},{key:"timeoutExists",value:function timeoutExists(e){return this._timeouts[e]!==undefined}},{key:"setInterval",value:function(e){function setInterval(t,r,n){return e.apply(this,arguments)}setInterval.toString=function(){return e.toString()};return setInterval}(function(e,t,r){if(this._intervals[e])throw"Duplicate interval for key "+e;this._intervals[e]=setInterval(t,r)})},{key:"clearInterval",value:function(e){function clearInterval(t){return e.apply(this,arguments)}clearInterval.toString=function(){return e.toString()};return clearInterval}(function(e){clearInterval(this._intervals[e]);delete this._intervals[e]})},{key:"resetInterval",value:function resetInterval(e,t,r){clearInterval(this._intervals[e]);this._intervals[e]=setInterval(t,r)}},{key:"intervalExists",value:function intervalExists(e){return this._intervals[e]!==undefined}},{key:"clearAll",value:function clearAll(){for(var e in this._timeouts)this.clearTimeout(e);for(var t in this._intervals)this.clearInterval(t)}}]);return Timers}();r.register(_);var d=function(){function Version(){(0,_classCallCheck3["default"])(this,Version)}(0,_createClass3["default"])(Version,null,[{key:"isCompatible",value:function isCompatible(e){return e>=Version.CODE}}]);return Version}();d.CODE=1;r.register(d);var p=function(){function Time(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;(0,_classCallCheck3["default"])(this,Time);this._offset=e}(0,_createClass3["default"])(Time,[{key:"now",value:function now(){return Date.now()+this._offset}},{key:"offset",set:function set(e){this._offset=e}}]);return Time}();r.register(p);var g=function(){function ArrayUtils(){(0,_classCallCheck3["default"])(this,ArrayUtils)}(0,_createClass3["default"])(ArrayUtils,null,[{key:"randomElement",value:function randomElement(e){return e[Math.floor(Math.random()*e.length)]}},{key:"subarray",value:function subarray(e,t,r){function clamp(e,t,r){return e<t?t:e>r?r:e}t===undefined&&(t=0);r===undefined&&(r=e.byteLength);t=clamp(t,0,e.byteLength);var n=(r=clamp(r,0,e.byteLength))-t;n<0&&(n=0);return new Uint8Array(e.buffer,e.byteOffset+t,n)}},{key:"k_combinations",value:_regenerator2["default"].mark(function k_combinations(e,t){var r,n,a,i,s,o=this;return _regenerator2["default"].wrap(function k_combinations$(u){for(;;)switch(u.prev=u.next){case 0:r=e.length;if(!(t>r)){u.next=3;break}return u.abrupt("return");case 3:n=(0,_from2["default"])(new Array(t),function(e,t){return t});u.next=6;return n.map(function(t){return e[t]});case 6:a=(0,_from2["default"])(new Array(t),function(e,r){return t-r-1});i=_regenerator2["default"].mark(function _loop4(){var i,s,u,c,l,h,f,_,d,p,g,y,v;return _regenerator2["default"].wrap(function _loop4$(o){for(;;)switch(o.prev=o.next){case 0:i=t-1,s=!1;u=!0;c=!1;l=undefined;o.prev=4;h=(0,_getIterator3["default"])(a);case 6:if(u=(f=h.next()).done){o.next=14;break}i=f.value;if(n[i]===i+r-t){o.next=11;break}s=!0;return o.abrupt("break",14);case 11:u=!0;o.next=6;break;case 14:o.next=20;break;case 16:o.prev=16;o.t0=o["catch"](4);c=!0;l=o.t0;case 20:o.prev=20;o.prev=21;!u&&h["return"]&&h["return"]();case 23:o.prev=23;if(!c){o.next=26;break}throw l;case 26:return o.finish(23);case 27:return o.finish(20);case 28:if(s){o.next=30;break}return o.abrupt("return",{v:void 0});case 30:n[i]+=1;_=!0;d=!1;p=undefined;o.prev=34;for(g=(0,_getIterator3["default"])((0,_from2["default"])(new Array(t-i-1),function(e,t){return i+t+1}));!(_=(y=g.next()).done);_=!0){v=y.value;n[v]=n[v-1]+1}o.next=42;break;case 38:o.prev=38;o.t1=o["catch"](34);d=!0;p=o.t1;case 42:o.prev=42;o.prev=43;!_&&g["return"]&&g["return"]();case 45:o.prev=45;if(!d){o.next=48;break}throw p;case 48:return o.finish(45);case 49:return o.finish(42);case 50:o.next=52;return n.map(function(t){return e[t]});case 52:case"end":return o.stop()}},_loop4,o,[[4,16,20,28],[21,,23,27],[34,38,42,50],[43,,45,49]])});case 8:0;return u.delegateYield(i(),"t0",10);case 10:if("object"!==("undefined"==typeof(s=u.t0)?"undefined":(0,_typeof3["default"])(s))){u.next=13;break}return u.abrupt("return",s.v);case 13:u.next=8;break;case 15:case"end":return u.stop()}},k_combinations,this)})}]);return ArrayUtils}();r.register(g);var y=function(){function HashMap(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:HashMap._hash;(0,_classCallCheck3["default"])(this,HashMap);this._map=new _map2["default"];this._fnHash=e}(0,_createClass3["default"])(HashMap,[{key:"get",value:function get(e){return this._map.get(this._fnHash(e))}},{key:"put",value:function put(e,t){this._map.set(this._fnHash(e),t)}},{key:"remove",value:function remove(e){this._map["delete"](this._fnHash(e))}},{key:"clear",value:function clear(){this._map.clear()}},{key:"contains",value:function contains(e){return this._map.has(this._fnHash(e))}},{key:"keys",value:function keys(){return(0,_from2["default"])(this._map.keys())}},{key:"keyIterator",value:function keyIterator(){return this._map.keys()}},{key:"values",value:function values(){return(0,_from2["default"])(this._map.values())}},{key:"valueIterator",value:function valueIterator(){return this._map.values()}},{key:"isEmpty",value:function isEmpty(){return 0===this._map.size}},{key:"length",get:function get(){return this._map.size}}],[{key:"_hash",value:function _hash(e){return e.hashCode?e.hashCode():e.toString()}}]);return HashMap}();r.register(y);var v=function(){function HashSet(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:HashSet._hash;(0,_classCallCheck3["default"])(this,HashSet);this._map=new _map2["default"];this._fnHash=e}(0,_createClass3["default"])(HashSet,[{key:"add",value:function add(e){this._map.set(this._fnHash(e),e)}},{key:"addAll",value:function addAll(e){var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(e);!(t=(a=i.next()).done);t=!0){var s=a.value;this.add(s)}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"get",value:function get(e){return this._map.get(this._fnHash(e))}},{key:"remove",value:function remove(e){this._map["delete"](this._fnHash(e))}},{key:"removeAll",value:function removeAll(e){var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(e);!(t=(a=i.next()).done);t=!0){var s=a.value;this.remove(s)}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"clear",value:function clear(){this._map.clear()}},{key:"contains",value:function contains(e){return this._map.has(this._fnHash(e))}},{key:"values",value:function values(){return(0,_from2["default"])(this._map.values())}},{key:"valueIterator",value:function valueIterator(){return this._map.values()}},{key:_iterator178["default"],value:function value(){return this.valueIterator()}},{key:"isEmpty",value:function isEmpty(){return 0===this._map.size}},{key:"length",get:function get(){return this._map.size}}],[{key:"_hash",value:function _hash(e){return e.hashCode?e.hashCode():e.toString()}}]);return HashSet}();r.register(v);var k=function(){function LimitIterable(e,t){(0,_classCallCheck3["default"])(this,LimitIterable);this._iterator=e[_iterator178["default"]]?(0,_getIterator3["default"])(e):e;this._limit=t}(0,_createClass3["default"])(LimitIterable,[{key:_iterator178["default"],value:function value(){return LimitIterable.iterator(this._iterator,this._limit)}}],[{key:"iterator",value:function iterator(e,t){var r=0;return{next:function next(){var n=r++>=t,next=e.next();return{value:n?undefined:next.value,done:n||next.done}}}}}]);return LimitIterable}();r.register(k);var m=function(){function Queue(e){(0,_classCallCheck3["default"])(this,Queue);this._queue=[];this._fnHash=e||Queue._hash}(0,_createClass3["default"])(Queue,[{key:"enqueue",value:function enqueue(e){this._queue.push(e)}},{key:"dequeue",value:function dequeue(){return this._queue.shift()}},{key:"peek",value:function peek(){return this._queue[0]}},{key:"indexOf",value:function indexOf(e){for(var t=this._fnHash(e),r=0;r<this._queue.length;++r)if(t===this._fnHash(this._queue[r]))return r;return-1}},{key:"remove",value:function remove(e){var t=this.indexOf(e);t>-1&&this._queue.splice(t,1)}},{key:"dequeueMulti",value:function dequeueMulti(e){return this._queue.splice(0,e)}},{key:"dequeueUntil",value:function dequeueUntil(e){var t=this.indexOf(e);return t>-1?this._queue.splice(0,t+1):[]}},{key:"clear",value:function clear(){this._queue=[]}},{key:"values",value:function values(){return this._queue}},{key:"length",get:function get(){return this._queue.length}}],[{key:"_hash",value:function _hash(e){return e.hashCode?e.hashCode():e.toString()}}]);return Queue}();r.register(m);var b=function(){function SortedList(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[],t=arguments[1];(0,_classCallCheck3["default"])(this,SortedList);this._list=e;this._compare=t||SortedList._compare}(0,_createClass3["default"])(SortedList,[{key:"indexOf",value:function indexOf(e){for(var t=0,r=this._list.length-1,n=null,a=null;t<=r;){n=Math.round((t+r)/2);a=this._list[n];if(this._compare(a,e)<0)t=n+1;else{if(!(this._compare(a,e)>0))return n;r=n-1}}return-1}},{key:"_insertionIndex",value:function _insertionIndex(e){for(var t=0,r=this._list.length-1,n=null,a=null;t<=r;){n=Math.round((t+r)/2);a=this._list[n];if(this._compare(a,e)<0)t=n+1;else{if(!(this._compare(a,e)>0))break;r=n-1}}return t}},{key:"add",value:function add(e){this._list.splice(this._insertionIndex(e),0,e)}},{key:"shift",value:function shift(){return this._list.shift()}},{key:"pop",value:function pop(){return this._list.pop()}},{key:"remove",value:function remove(e){var t=this.indexOf(e);t>-1&&this._list.splice(t,1)}},{key:"clear",value:function clear(){this._list=[]}},{key:"values",value:function values(){return this._list}},{key:"copy",value:function copy(){return new SortedList(this._list.slice(),this._compare)}},{key:"length",get:function get(){return this._list.length}}],[{key:"_compare",value:function _compare(e,t){return e.compare?e.compare(t):e>t?1:e<t?-1:0}}]);return SortedList}();r.register(b);var C=function(){function Assert(){(0,_classCallCheck3["default"])(this,Assert)}(0,_createClass3["default"])(Assert,null,[{key:"that",value:function that(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"Assertion failed";if(!e)throw new Error(t)}}]);return Assert}();r.register(C);var w=function(){function BufferUtils(){(0,_classCallCheck3["default"])(this,BufferUtils)}(0,_createClass3["default"])(BufferUtils,null,[{key:"toAscii",value:function toAscii(e){return String.fromCharCode.apply(null,new Uint8Array(e))}},{key:"fromAscii",value:function fromAscii(e){for(var t=new Uint8Array(e.length),r=0;r<e.length;++r)t[r]=e.charCodeAt(r);return t}},{key:"_codePointTextDecoder",value:function _codePointTextDecoder(e){if("undefined"==typeof TextDecoder)throw new Error("TextDecoder not supported");if(null===BufferUtils._ISO_8859_15_DECODER)throw new Error("TextDecoder does not supprot iso-8859-15");if(BufferUtils._ISO_8859_15_DECODER===undefined)try{BufferUtils._ISO_8859_15_DECODER=new TextDecoder("iso-8859-15")}finally{BufferUtils._ISO_8859_15_DECODER=null}return BufferUtils._ISO_8859_15_DECODER.decode(e).replace("","").replace("","").replace("","").replace("","").replace("","").replace("","").replace("","").replace("","")}},{key:"_tripletToBase64",value:function _tripletToBase64(e){return BufferUtils._BASE64_LOOKUP[e>>18&63]+BufferUtils._BASE64_LOOKUP[e>>12&63]+BufferUtils._BASE64_LOOKUP[e>>6&63]+BufferUtils._BASE64_LOOKUP[63&e]}},{key:"_base64encodeChunk",value:function _base64encodeChunk(e,t,r){for(var n=void 0,a=[],i=t;i<r;i+=3){n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]);a.push(BufferUtils._tripletToBase64(n))}return a.join("")}},{key:"_base64fromByteArray",value:function _base64fromByteArray(e){for(var t=void 0,r=e.length,n=r%3,a="",i=[],s=0,o=r-n;s<o;s+=16383)i.push(BufferUtils._base64encodeChunk(e,s,s+16383>o?o:s+16383));if(1===n){t=e[r-1];a+=BufferUtils._BASE64_LOOKUP[t>>2];a+=BufferUtils._BASE64_LOOKUP[t<<4&63];a+="=="}else if(2===n){t=(e[r-2]<<8)+e[r-1];a+=BufferUtils._BASE64_LOOKUP[t>>10];a+=BufferUtils._BASE64_LOOKUP[t>>4&63];a+=BufferUtils._BASE64_LOOKUP[t<<2&63];a+="="}i.push(a);return i.join("")}},{key:"toBase64",value:function toBase64(e){if(M.isNodeJs())return new Buffer(e).toString("base64");if("undefined"!=typeof TextDecoder&&null!==BufferUtils._ISO_8859_15_DECODER)try{return btoa(BufferUtils._codePointTextDecoder(new Uint8Array(e)))}catch(t){}return BufferUtils._base64fromByteArray(new Uint8Array(e))}},{key:"fromBase64",value:function fromBase64(e){return new T(Uint8Array.from(atob(e),function(e){return e.charCodeAt(0)}))}},{key:"toBase64Url",value:function toBase64Url(e){return BufferUtils.toBase64(e).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,".")}},{key:"fromBase64Url",value:function fromBase64Url(e){return new T(Uint8Array.from(atob(e.replace(/_/g,"/").replace(/-/g,"+").replace(/\./g,"=")),function(e){return e.charCodeAt(0)}))}},{key:"toBase32",value:function toBase32(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:BufferUtils.BASE32_ALPHABET.NIMIQ,r=3,n=0,a=void 0,i=void 0,s="";for(i=0;i<e.length;i++){s+=t[31&(n|(a=e[i])>>r)];r>5&&(s+=t[31&a>>(r-=5)]);n=a<<(r=5-r);r=8-r}3!==r&&(s+=t[31&n]);for(;s.length%8!=0&&33===t.length;)s+=t[32];return s}},{key:"fromBase32",value:function fromBase32(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:BufferUtils.BASE32_ALPHABET.NIMIQ,r=[];t.toUpperCase().split("").forEach(function(e,t){e in r||(r[e]=t)});var n=void 0,a=8,i=0,s=[];e.toUpperCase().split("").forEach(function(e){if(33!==t.length||e!==t[32]){n=255&r[e];if((a-=5)>0)i|=n<<a;else if(a<0){s.push(i|n>>-a);i=n<<(a+=8)&255}else{s.push(i|n);a=8;i=0}}});8!==a&&0!==i&&s.push(i);return new Uint8Array(s)}},{key:"toHex",value:function toHex(e){for(var t="",r=0;r<e.length;r++){var n=e[r];t+=BufferUtils.HEX_ALPHABET[n>>>4];t+=BufferUtils.HEX_ALPHABET[15&n]}return t}},{key:"fromHex",value:function fromHex(e){e=e.trim();return B.isHexBytes(e)?new T(Uint8Array.from(e.match(/.{2}/g)||[],function(e){return parseInt(e,16)})):null}},{key:"concatTypedArrays",value:function concatTypedArrays(e,t){var r=new e.constructor(e.length+t.length);r.set(e,0);r.set(t,e.length);return r}},{key:"equals",value:function equals(e,t){if(e.length!==t.length)return!1;for(var r=new Uint8Array(e),n=new Uint8Array(t),a=0;a<e.length;a++)if(r[a]!==n[a])return!1;return!0}},{key:"compare",value:function compare(e,t){if(e.length<t.length)return-1;if(e.length>t.length)return 1;for(var r=0;r<e.length;r++){if(e[r]<t[r])return-1;if(e[r]>t[r])return 1}return 0}},{key:"xor",value:function xor(e,t){for(var r=new Uint8Array(e.byteLength),n=0;n<e.byteLength;++n)r[n]=e[n]^t[n];return r}}]);return BufferUtils}();w.BASE64_ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";w.BASE32_ALPHABET={RFC4648:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",RFC4648_HEX:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",NIMIQ:"0123456789ABCDEFGHJKLMNPQRSTUVXY"};w.HEX_ALPHABET="0123456789abcdef";w._BASE64_LOOKUP=[];for(var A=0,S=w.BASE64_ALPHABET.length;A<S;++A)w._BASE64_LOOKUP[A]=w.BASE64_ALPHABET[A];r.register(w);var T=function(e){(0,_inherits3["default"])(SerialBuffer,e);function SerialBuffer(e){(0,_classCallCheck3["default"])(this,SerialBuffer);var t=(0,_possibleConstructorReturn3["default"])(this,(SerialBuffer.__proto__||(0,_getPrototypeOf2["default"])(SerialBuffer)).call(this,e));t._view=new DataView(t.buffer);t._readPos=0;t._writePos=0;return t}(0,_createClass3["default"])(SerialBuffer,[{key:"subarray",value:function subarray(e,t){return g.subarray(this,e,t)}},{key:"reset",value:function reset(){this._readPos=0;this._writePos=0}},{key:"read",value:function read(e){var t=this.subarray(this._readPos,this._readPos+e);this._readPos+=e;return t}},{key:"write",value:function write(e){this.set(e,this._writePos);this._writePos+=e.byteLength}},{key:"readUint8",value:function readUint8(){return this._view.getUint8(this._readPos++)}},{key:"writeUint8",value:function writeUint8(e){this._view.setUint8(this._writePos++,e)}},{key:"readUint16",value:function readUint16(){var e=this._view.getUint16(this._readPos);this._readPos+=2;return e}},{key:"writeUint16",value:function writeUint16(e){this._view.setUint16(this._writePos,e);this._writePos+=2}},{key:"readUint32",value:function readUint32(){var e=this._view.getUint32(this._readPos);this._readPos+=4;return e}},{key:"writeUint32",value:function writeUint32(e){this._view.setUint32(this._writePos,e);this._writePos+=4}},{key:"readUint64",value:function readUint64(){var e=this._view.getUint32(this._readPos)*Math.pow(2,32)+this._view.getUint32(this._readPos+4);if(!I.isUint64(e))throw new Error("Malformed value");this._readPos+=8;return e}},{key:"writeUint64",value:function writeUint64(e){if(!I.isUint64(e))throw new Error("Malformed value");this._view.setUint32(this._writePos,Math.floor(e/Math.pow(2,32)));this._view.setUint32(this._writePos+4,e);this._writePos+=8}},{key:"readVarUint",value:function readVarUint(){var e=this.readUint8();return e<253?e:253===e?this.readUint16():254===e?this.readUint32():this.readUint64()}},{key:"writeVarUint",value:function writeVarUint(e){if(!I.isUint64(e))throw new Error("Malformed value");if(e<253)this.writeUint8(e);else if(e<=65535){this.writeUint8(253);this.writeUint16(e)}else if(e<=4294967295){this.writeUint8(254);this.writeUint32(e)}else{this.writeUint8(255);this.writeUint64(e)}}},{key:"readFloat64",value:function readFloat64(){var e=this._view.getFloat64(this._readPos);this._readPos+=8;return e}},{key:"writeFloat64",value:function writeFloat64(e){this._view.setFloat64(this._writePos,e);this._writePos+=8}},{key:"readString",value:function readString(e){var t=this.read(e);return w.toAscii(t)}},{key:"writeString",value:function writeString(e,t){if(B.isMultibyte(e)||e.length!==t)throw"Malformed value/length";var r=w.fromAscii(e);this.write(r)}},{key:"readPaddedString",value:function readPaddedString(e){for(var t=this.read(e),r=0;r<e&&0!==t[r];)r++;var n=new Uint8Array(t.buffer,t.byteOffset,r);return w.toAscii(n)}},{key:"writePaddedString",value:function writePaddedString(e,t){if(B.isMultibyte(e)||e.length>t)throw"Malformed value/length";var r=w.fromAscii(e);this.write(r);var n=t-r.byteLength;this.write(new Uint8Array(n))}},{key:"readVarLengthString",value:function readVarLengthString(){var e=this.readUint8();if(this._readPos+e>this.length)throw"Malformed length";var t=this.read(e);return w.toAscii(t)}},{key:"writeVarLengthString",value:function writeVarLengthString(e){if(B.isMultibyte(e)||!I.isUint8(e.length))throw new Error("Malformed value");var t=w.fromAscii(e);this.writeUint8(t.byteLength);this.write(t)}},{key:"readPos",get:function get(){return this._readPos},set:function set(e){if(e<0||e>this.byteLength)throw"Invalid readPos "+e;this._readPos=e}},{key:"writePos",get:function get(){return this._writePos},set:function set(e){if(e<0||e>this.byteLength)throw"Invalid writePos "+e;this._writePos=e}}],[{key:"varUintSize",value:function varUintSize(e){if(!I.isUint64(e))throw new Error("Malformed value");return e<253?1:e<=65535?3:e<=4294967295?5:9}},{key:"varLengthStringSize",value:function varLengthStringSize(e){if(B.isMultibyte(e)||!I.isUint8(e.length))throw new Error("Malformed value");return 1+e.length}}]);return SerialBuffer}(Uint8Array);r.register(T);var x=function(){function Crypto(){(0,_classCallCheck3["default"])(this,Crypto)}(0,_createClass3["default"])(Crypto,null,[{key:"prepareSyncCryptoWorker",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee115(){var e;return _regenerator2["default"].wrap(function _callee115$(t){for(;;)switch(t.prev=t.next){case 0:e=mr._workerImplementation[br.name];t.next=3;return e.init("crypto");case 3:Crypto._workerSync=e;return t.abrupt("return",e);case 5:case"end":return t.stop()}},_callee115,this)}));return function prepareSyncCryptoWorker(){return e.apply(this,arguments)}}()},{key:"_cryptoWorkerSync",value:function _cryptoWorkerSync(){if(null===Crypto._workerSync)throw new Error("Synchronous crypto worker not yet prepared");return Crypto._workerSync}},{key:"_cryptoWorkerAsync",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee116(){return _regenerator2["default"].wrap(function _callee116$(e){for(;;)switch(e.prev=e.next){case 0:if(Crypto._workerAsync){e.next=4;break}e.next=3;return mr.startWorkerPoolForProxy(br,"crypto",4);case 3:Crypto._workerAsync=e.sent;case 4:return e.abrupt("return",Crypto._workerAsync);case 5:case"end":return e.stop()}},_callee116,this)}));return function _cryptoWorkerAsync(){return e.apply(this,arguments)}}()},{key:"publicKeySerialize",value:function publicKeySerialize(e){return e}},{key:"publicKeyUnserialize",value:function publicKeyUnserialize(e){return e}},{key:"publicKeyDerive",value:function publicKeyDerive(e){return Crypto._cryptoWorkerSync().publicKeyDerive(e)}},{key:"privateKeySerialize",value:function privateKeySerialize(e){return e}},{key:"privateKeyUnserialize",value:function privateKeyUnserialize(e){return e}},{key:"privateKeyGenerate",value:function privateKeyGenerate(){var e=new Uint8Array(Crypto.privateKeySize);Crypto.lib.getRandomValues(e);return e}},{key:"keyPairGenerate",value:function keyPairGenerate(){return Crypto.keyPairDerive(Crypto.privateKeyGenerate())}},{key:"keyPairDerive",value:function keyPairDerive(e){return{privateKey:e,publicKey:Crypto.publicKeyDerive(e)}}},{key:"keyPairPrivate",value:function keyPairPrivate(e){return e.privateKey}},{key:"keyPairPublic",value:function keyPairPublic(e){return e.publicKey}},{key:"keyPairFromKeys",value:function keyPairFromKeys(e,t){return{privateKey:e,publicKey:t}}},{key:"signatureSerialize",value:function signatureSerialize(e){return e}},{key:"signatureUnserialize",value:function signatureUnserialize(e){return e}},{key:"signatureCreate",value:function signatureCreate(e,t,r){return Crypto._cryptoWorkerSync().signatureCreate(e,t,r)}},{key:"signatureVerify",value:function signatureVerify(e,t,r){return Crypto._cryptoWorkerSync().signatureVerify(e,t,r)}},{key:"blockVerify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee117(e,t,r){var n;return _regenerator2["default"].wrap(function _callee117$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return Crypto._cryptoWorkerAsync();case 2:n=a.sent;return a.abrupt("return",n.blockVerify(e,t,r,Se.GENESIS.HASH.serialize()));case 4:case"end":return a.stop()}},_callee117,this)}));return function blockVerify(t,r,n){return e.apply(this,arguments)}}()},{key:"blake2bSync",value:function blake2bSync(e){return Crypto._cryptoWorkerSync().computeBlake2b(e)}},{key:"blake2bAsync",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee118(e){var t;return _regenerator2["default"].wrap(function _callee118$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return Crypto._cryptoWorkerAsync();case 2:t=r.sent;return r.abrupt("return",t.computeBlake2b(e));case 4:case"end":return r.stop()}},_callee118,this)}));return function blake2bAsync(t){return e.apply(this,arguments)}}()},{key:"argon2d",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee119(e){var t;return _regenerator2["default"].wrap(function _callee119$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return Crypto._cryptoWorkerAsync();case 2:t=r.sent;return r.abrupt("return",t.computeArgon2d(e));case 4:case"end":return r.stop()}},_callee119,this)}));return function argon2d(t){return e.apply(this,arguments)}}()},{key:"sha256",value:function sha256(e){return Crypto._cryptoWorkerSync().computeSha256(e)}},{key:"commitmentPairGenerate",value:function commitmentPairGenerate(){var e=new Uint8Array(Crypto.randomnessSize);Crypto.lib.getRandomValues(e);return Crypto._cryptoWorkerSync().commitmentCreate(e)}},{key:"commitmentPairFromValues",value:function commitmentPairFromValues(e,t){return{secret:e,commitment:t}}},{key:"commitmentPairRandomSecret",value:function commitmentPairRandomSecret(e){return e.secret}},{key:"commitmentPairCommitment",value:function commitmentPairCommitment(e){return e.commitment}},{key:"randomSecretSerialize",value:function randomSecretSerialize(e){return e}},{key:"randomSecretUnserialize",value:function randomSecretUnserialize(e){return e}},{key:"commitmentSerialize",value:function commitmentSerialize(e){return e}},{key:"commitmentUnserialize",value:function commitmentUnserialize(e){return e}},{key:"partialSignatureSerialize",value:function partialSignatureSerialize(e){return e}},{key:"partialSignatureUnserialize",value:function partialSignatureUnserialize(e){return e}},{key:"hashPublicKeys",value:function hashPublicKeys(e){return Crypto._cryptoWorkerSync().publicKeysHash(e)}},{key:"delinearizePublicKey",value:function delinearizePublicKey(e,t){var r=Crypto._cryptoWorkerSync(),n=r.publicKeysHash(e);return r.publicKeyDelinearize(t,n)}},{key:"delinearizePrivateKey",value:function delinearizePrivateKey(e,t,r){var n=Crypto._cryptoWorkerSync(),a=n.publicKeysHash(e);return n.privateKeyDelinearize(r,t,a)}},{key:"delinearizeAndAggregatePublicKeys",value:function delinearizeAndAggregatePublicKeys(e){var t=Crypto._cryptoWorkerSync(),r=t.publicKeysHash(e);return t.publicKeysDelinearizeAndAggregate(e,r)}},{key:"delinearizedPartialSignatureCreate",value:function delinearizedPartialSignatureCreate(e,t,r,n,a,i){return Crypto._cryptoWorkerSync().delinearizedPartialSignatureCreate(r,e,t,n,a,i)}},{key:"aggregateCommitments",value:function aggregateCommitments(e){return Crypto._cryptoWorkerSync().commitmentsAggregate(e)}},{key:"aggregatePartialSignatures",value:function aggregatePartialSignatures(e){var t=Crypto._cryptoWorkerSync();return e.reduce(function(e,r){return t.scalarsAdd(e,r)})}},{key:"combinePartialSignatures",value:function combinePartialSignatures(e,t){var r=Crypto.aggregatePartialSignatures(t);return w.concatTypedArrays(e,r)}},{key:"kdf",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee120(e,t){var r,n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:256;return _regenerator2["default"].wrap(function _callee120$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return Crypto._cryptoWorkerAsync();case 2:r=a.sent;return a.abrupt("return",r.kdf(e,t,n));case 4:case"end":return a.stop()}},_callee120,this)}));return function kdf(t,r){return e.apply(this,arguments)}}()},{key:"manyPow",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee121(e){var t,r,n,a,i,s,o,u,c,l,h,f,_,d;return _regenerator2["default"].wrap(function _callee121$(p){for(;;)switch(p.prev=p.next){case 0:p.next=2;return Crypto._cryptoWorkerAsync();case 2:t=p.sent;r=t.poolSize||1;n=[];a=0;for(i=0;i<r;++i){n.push([]);for(;a<(i+1)/r*e.length;++a)n[i].push(e[a].serialize())}s=[];o=!0;u=!1;c=undefined;p.prev=11;for(l=(0,_getIterator3["default"])(n);!(o=(h=l.next()).done);o=!0){f=h.value;s.push(t.computeArgon2dBatch(f))}p.next=19;break;case 15:p.prev=15;p.t0=p["catch"](11);u=!0;c=p.t0;case 19:p.prev=19;p.prev=20;!o&&l["return"]&&l["return"]();case 22:p.prev=22;if(!u){p.next=25;break}throw c;case 25:return p.finish(22);case 26:return p.finish(19);case 27:p.next=29;return _promise2["default"].all(s);case 29:p.t1=function(e,t){return[].concat((0,_toConsumableArray3["default"])(e),(0,_toConsumableArray3["default"])(t))};p.t2=[];_=p.sent.reduce(p.t1,p.t2);for(d=0;d<e.length;++d)e[d]._pow=new U(_[d]);case 33:case"end":return p.stop()}},_callee121,this,[[11,15,19,27],[20,,22,26]])}));return function manyPow(t){return e.apply(this,arguments)}}()},{key:"lib",get:function get(){return u.instance}},{key:"publicKeyType",get:function get(){return Uint8Array}},{key:"publicKeySize",get:function get(){return 32}},{key:"privateKeyType",get:function get(){return Uint8Array}},{key:"privateKeySize",get:function get(){return 32}},{key:"keyPairType",get:function get(){return Object}},{key:"signatureType",get:function get(){return Uint8Array}},{key:"signatureSize",get:function get(){return 64}},{key:"hashType",get:function get(){return Uint8Array}},{key:"hashSize",get:function get(){return 32}},{key:"blake2bSize",get:function get(){return 32}},{key:"argon2dSize",get:function get(){return 32}},{key:"sha256Size",get:function get(){return 32}},{key:"randomnessSize",get:function get(){return 32}},{key:"commitmentPairType",get:function get(){return Object}},{key:"randomSecretType",get:function get(){return Uint8Array}},{key:"randomSecretSize",get:function get(){return 32}},{key:"commitmentType",get:function get(){return Uint8Array}},{key:"commitmentSize",get:function get(){return 32}},{key:"partialSignatureType",get:function get(){return Uint8Array}},{key:"partialSignatureSize",get:function get(){return 32}}]);return Crypto}();x._workerSync=null;x._workerAsync=null;r.register(x);var E=function(){function CRC32(){(0,_classCallCheck3["default"])(this,CRC32)}(0,_createClass3["default"])(CRC32,null,[{key:"_createTable",value:function _createTable(){for(var e=void 0,t=[],r=0;r<256;++r){e=r;for(var n=0;n<8;++n)e=1&e?CRC32._POLYNOMIAL^e>>>1:e>>>1;t[r]=e>>>0}return t}},{key:"compute",value:function compute(e){CRC32._table||(CRC32._table=CRC32._createTable());CRC32._hex_chars||(CRC32._hex_chars="0123456789abcdef".split(""));for(var t=new Uint8Array(e),r=-1,n="",a=0;a<t.length;++a)r=CRC32._table[255&(r^t[a])]^r>>>8;r^=-1;n+=CRC32._hex_chars[r>>28&15]+CRC32._hex_chars[r>>24&15]+CRC32._hex_chars[r>>20&15]+CRC32._hex_chars[r>>16&15]+CRC32._hex_chars[r>>12&15]+CRC32._hex_chars[r>>8&15]+CRC32._hex_chars[r>>4&15]+CRC32._hex_chars[15&r];return parseInt(n,16)}}]);return CRC32}();E._table=null;E._hex_chars=null;E._POLYNOMIAL=3988292384;r.register(E);var I=function(){function NumberUtils(){(0,_classCallCheck3["default"])(this,NumberUtils)}(0,_createClass3["default"])(NumberUtils,null,[{key:"isUint8",value:function isUint8(e){return(0,_isInteger2["default"])(e)&&e>=0&&e<=NumberUtils.UINT8_MAX}},{key:"isUint16",value:function isUint16(e){return(0,_isInteger2["default"])(e)&&e>=0&&e<=NumberUtils.UINT16_MAX}},{key:"isUint32",value:function isUint32(e){return(0,_isInteger2["default"])(e)&&e>=0&&e<=NumberUtils.UINT32_MAX}},{key:"isUint64",value:function isUint64(e){return(0,_isInteger2["default"])(e)&&e>=0&&e<=NumberUtils.UINT64_MAX}},{key:"randomUint32",value:function randomUint32(){return Math.floor(Math.random()*(NumberUtils.UINT32_MAX+1))}},{key:"randomUint64",value:function randomUint64(){return Math.floor(Math.random()*(NumberUtils.UINT64_MAX+1))}}]);return NumberUtils}();I.UINT8_MAX=255;I.UINT16_MAX=65535;I.UINT32_MAX=4294967295;I.UINT64_MAX=_maxSafeInteger2["default"];r.register(I);var P=function(){function MerkleTree(){(0,_classCallCheck3["default"])(this,MerkleTree)}(0,_createClass3["default"])(MerkleTree,null,[{key:"computeRoot",value:function computeRoot(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:MerkleTree._hash;return MerkleTree._computeRoot(e,t)}},{key:"_computeRoot",value:function _computeRoot(e,t){var r=e.length;if(0===r)return U.light(new Uint8Array(0));if(1===r)return t(e[0]);var n=Math.round(r/2),a=e.slice(0,n),i=e.slice(n),s=MerkleTree._computeRoot(a,t),o=MerkleTree._computeRoot(i,t);return U.light(w.concatTypedArrays(s.serialize(),o.serialize()))}},{key:"_hash",value:function _hash(e){if(e instanceof U)return e;if("function"==typeof e.hash)return e.hash();if("function"==typeof e.serialize)return U.light(e.serialize());if(e instanceof Uint8Array)return U.light(e);throw new Error("MerkleTree objects must be Uint8Array or have a .hash()/.serialize() method")}}]);return MerkleTree}();r.register(P);var N=function(){function MerklePath(e){(0,_classCallCheck3["default"])(this,MerklePath);if(!Array.isArray(e)||!I.isUint8(e.length)||e.some(function(e){return!(e instanceof O)}))throw new Error("Malformed nodes");this._nodes=e}(0,_createClass3["default"])(MerklePath,[{key:"computeRoot",value:function computeRoot(e){var t=(arguments.length>1&&arguments[1]!==undefined?arguments[1]:P._hash)(e),r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(this._nodes);!(r=(i=s.next()).done);r=!0){var o=i.value,u=o.left,c=o.hash,l=new T(2*c.serializedSize);u&&c.serialize(l);t.serialize(l);u||c.serialize(l);t=U.light(l)}}catch(h){n=!0;a=h}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}return t}},{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint8(this._nodes.length);e.write(MerklePath._compress(this._nodes));var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._nodes);!(t=(a=i.next()).done);t=!0){a.value.hash.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"equals",value:function equals(e){return e instanceof MerklePath&&this._nodes.length===e._nodes.length&&this._nodes.every(function(t,r){return t.equals(e._nodes[r])})}},{key:"serializedSize",get:function get(){return 1+Math.ceil(this._nodes.length/8)+this._nodes.reduce(function(e,t){return e+t.hash.serializedSize},0)}},{key:"nodes",get:function get(){return this._nodes}}],[{key:"compute",value:function compute(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:P._hash,n=r(t),a=[];MerklePath._compute(e,n,a,r);return new MerklePath(a)}},{key:"_compute",value:function _compute(e,t,r,n){var a=e.length,i=void 0;if(0===a)return{containsLeaf:!1,inner:i=U.light(new Uint8Array(0))};if(1===a)return{containsLeaf:(i=n(e[0])).equals(t),inner:i};var s=Math.round(a/2),o=e.slice(0,s),u=e.slice(s),c=MerklePath._compute(o,t,r,n),l=c.containsLeaf,h=c.inner,f=MerklePath._compute(u,t,r,n),_=f.containsLeaf,d=f.inner;i=U.light(w.concatTypedArrays(h.serialize(),d.serialize()));if(l){r.push(new O(d,!1));return{containsLeaf:!0,inner:i}}if(_){r.push(new O(h,!0));return{containsLeaf:!0,inner:i}}return{containsLeaf:!1,inner:i}}},{key:"_compress",value:function _compress(e){for(var t=e.length,r=Math.ceil(t/8),n=new Uint8Array(r),a=0;a<t;a++)e[a].left&&(n[Math.floor(a/8)]|=128>>>a%8);return n}},{key:"unserialize",value:function unserialize(e){for(var t=e.readUint8(),r=Math.ceil(t/8),n=e.read(r),a=[],i=0;i<t;i++){var s=0!=(n[Math.floor(i/8)]&128>>>i%8),o=U.unserialize(e);a.push(new O(o,s))}return new MerklePath(a)}}]);return MerklePath}();r.register(N);var O=function(){function MerklePathNode(e,t){(0,_classCallCheck3["default"])(this,MerklePathNode);this._hash=e;this._left=t}(0,_createClass3["default"])(MerklePathNode,[{key:"equals",value:function equals(e){return e instanceof MerklePathNode&&this._hash.equals(e.hash)&&this._left===e.left}},{key:"hash",get:function get(){return this._hash}},{key:"left",get:function get(){return this._left}}]);return MerklePathNode}();r.register(O);var R=function(){function MerkleProof(e,t){(0,_classCallCheck3["default"])(this,MerkleProof);if(!Array.isArray(e)||!I.isUint16(e.length))throw new Error("Malformed nodes");if(!Array.isArray(t)||!I.isUint16(t.length))throw new Error("Malformed operations");this._nodes=e;this._operations=t}(0,_createClass3["default"])(MerkleProof,[{key:"computeRoot",value:function computeRoot(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:P._hash,r=e.map(t),n=[],a=this._nodes.slice(),i=!0,s=!1,o=undefined;try{for(var u,c=(0,_getIterator3["default"])(this._operations);!(i=(u=c.next()).done);i=!0){switch(u.value){case MerkleProof.Operation.CONSUME_PROOF:if(0===a.length)throw new Error("Invalid operation.");n.push(a.shift());break;case MerkleProof.Operation.CONSUME_INPUT:if(0===r.length)throw new Error("Invalid operation.");n.push(r.shift());break;case MerkleProof.Operation.HASH:if(n.length<2)throw new Error("Invalid operation.");var l=n.splice(-2,2),h=new T(l.reduce(function(e,t){return e+t.serializedSize},0)),f=(0,_slicedToArray3["default"])(l,2),_=f[0],d=f[1];_.serialize(h);d.serialize(h);n.push(U.light(h));break;default:throw new Error("Invalid operation.")}}}catch(p){s=!0;o=p}finally{try{!i&&c["return"]&&c["return"]()}finally{if(s)throw o}}if(1!==n.length||0!==a.length||0!==r.length)throw Error("Did not consume all nodes.");return n[0]}},{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint16(this._operations.length);e.write(MerkleProof._compress(this._operations));e.writeUint16(this._nodes.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._nodes);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"equals",value:function equals(e){return e instanceof MerkleProof&&this._nodes.length===e._nodes.length&&this._nodes.every(function(t,r){return t.equals(e._nodes[r])})&&this._operations.length===e._operations.length&&this._operations.every(function(t,r){return t===e._operations[r]})}},{key:"serializedSize",get:function get(){return 4+Math.ceil(this._operations.length/4)+this._nodes.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"nodes",get:function get(){return this._nodes}}],[{key:"compute",value:function compute(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:P._hash,n=t.map(r),a=MerkleProof._compute(e,n,r),i=(a.containsLeaf,a.operations),s=a.path;a.inner;return new MerkleProof(s,i)}},{key:"computeWithAbsence",value:function computeWithAbsence(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:P._hash,a=new _set3["default"];(t=t.slice()).sort(r);for(var i=0,s=0;s<e.length&&i<t.length;){var o=e[s],u=r(o,t[i]);if(0===u){a.add(t[i]);++i}else if(u>0){s>0&&a.add(e[s-1]);a.add(o);++i}else++s}i<t.length&&e.length>0&&a.add(e[e.length-1]);return MerkleProof.compute(e,(0,_from2["default"])(a),n)}},{key:"_compute",value:function _compute(e,t,r){var n=e.length,a=void 0;if(0===n){a=U.light(new Uint8Array(0));return{containsLeaf:!1,operations:[MerkleProof.Operation.CONSUME_PROOF],path:[a],inner:a}}if(1===n){a=r(e[0]);var i=t.some(function(e){return a.equals(e)});return{containsLeaf:i,operations:[i?MerkleProof.Operation.CONSUME_INPUT:MerkleProof.Operation.CONSUME_PROOF],path:i?[]:[a],inner:a}}var s=Math.round(n/2),o=e.slice(0,s),u=e.slice(s),c=MerkleProof._compute(o,t,r),l=c.containsLeaf,h=c.operations,f=c.path,_=c.inner,d=MerkleProof._compute(u,t,r),p=d.containsLeaf,g=d.operations,y=d.path,v=d.inner;a=U.light(w.concatTypedArrays(_.serialize(),v.serialize()));if(!l&&!p)return{containsLeaf:!1,operations:[MerkleProof.Operation.CONSUME_PROOF],path:[a],inner:a};var k=h;k=k.concat(g);var m=f;m=m.concat(y);k.push(MerkleProof.Operation.HASH);return{containsLeaf:!0,operations:k,path:m,inner:a}}},{key:"_compress",value:function _compress(e){for(var t=e.length,r=Math.ceil(t/4),n=new Uint8Array(r),a=0;a<t;a++){var i=3&e[a];n[Math.floor(a/4)]|=i<<a%4*2}return n}},{key:"unserialize",value:function unserialize(e){for(var t=e.readUint16(),r=Math.ceil(t/4),n=e.read(r),a=[],i=0;i<t;i++){var s=n[Math.floor(i/4)]>>>i%4*2&3;a.push(s)}for(var o=e.readUint16(),u=[],c=0;c<o;c++)u.push(U.unserialize(e));return new MerkleProof(u,a)}}]);return MerkleProof}();R.Operation={CONSUME_PROOF:0,CONSUME_INPUT:1,HASH:2};r.register(R);var M=function(){function PlatformUtils(){(0,_classCallCheck3["default"])(this,PlatformUtils)}(0,_createClass3["default"])(PlatformUtils,null,[{key:"isBrowser",value:function isBrowser(){return"undefined"!=typeof window}},{key:"isNodeJs",value:function isNodeJs(){return!PlatformUtils.isBrowser()&&"object"===("undefined"==typeof process?"undefined":(0,_typeof3["default"])(process))&&"function"==typeof require}},{key:"supportsWebRTC",value:function supportsWebRTC(){return!!(PlatformUtils.isBrowser()?window.RTCPeerConnection||window.webkitRTCPeerConnection:null)}},{key:"isOnline",value:function isOnline(){return!PlatformUtils.isBrowser()||!("onLine"in window.navigator)||window.navigator.onLine}}]);return PlatformUtils}();r.register(M);var B=function(){function StringUtils(){(0,_classCallCheck3["default"])(this,StringUtils)}(0,_createClass3["default"])(StringUtils,null,[{key:"isMultibyte",value:function isMultibyte(e){return/[\uD800-\uDFFF]/.test(e)}},{key:"isHex",value:function isHex(e){return/[0-9A-Fa-f]*/.test(e)}},{key:"isHexBytes",value:function isHexBytes(e,t){return!!StringUtils.isHex(e)&&(e.length%2==0&&("number"!=typeof t||e.length/2===t))}},{key:"commonPrefix",value:function commonPrefix(e,t){for(var r=0;r<e.length&&e[r]===t[r];++r);return e.substr(0,r)}}]);return StringUtils}();r.register(B);var z=function(){function Policy(){(0,_classCallCheck3["default"])(this,Policy)}(0,_createClass3["default"])(Policy,null,[{key:"coinsToSatoshis",value:function coinsToSatoshis(e){return Math.round(e*Policy.SATOSHIS_PER_COIN)}},{key:"satoshisToCoins",value:function satoshisToCoins(e){return e/Policy.SATOSHIS_PER_COIN}},{key:"supplyAfter",value:function supplyAfter(e){for(var t=Math.floor(e/Policy._supplyCacheInterval)*Policy._supplyCacheInterval,r=(t=Math.max(0,Math.min(t,Policy._supplyCacheMax)))/Policy._supplyCacheInterval,n=Math.floor(e/Policy._supplyCacheInterval),a=0===t?Policy.INITIAL_SUPPLY:Policy._supplyCache.get(t),i=r;i<n;++i){t=i*Policy._supplyCacheInterval;var s=(i+1)*Policy._supplyCacheInterval-1;a=Policy._supplyAfter(a,s,t);Policy._supplyCache.set(s+1,a);Policy._supplyCacheMax=s+1}return Policy._supplyAfter(a,e,n*Policy._supplyCacheInterval)}},{key:"_supplyAfter",value:function _supplyAfter(e,t){for(var r=e,n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;n<=t;++n)r+=Policy._blockRewardAt(r,n);return r}},{key:"blockRewardAt",value:function blockRewardAt(e){var t=Policy.supplyAfter(e-1);return Policy._blockRewardAt(t,e)}},{key:"_blockRewardAt",value:function _blockRewardAt(e,t){if(t<=0)return 0;var r=Policy.TOTAL_SUPPLY-e;return t>=Policy.EMISSION_TAIL_START&&r>=Policy.EMISSION_TAIL_REWARD?Policy.EMISSION_TAIL_REWARD:(r-r%Policy.EMISSION_SPEED)/Policy.EMISSION_SPEED}}]);return Policy}();z.BLOCK_TIME=60;z.BLOCK_SIZE_MAX=1e6;z.BLOCK_TARGET_MAX=Math.pow(2,240);z.DIFFICULTY_BLOCK_WINDOW=120;z.DIFFICULTY_MAX_ADJUSTMENT_FACTOR=2;z.TRANSACTION_VALIDITY_WINDOW=120;z.SATOSHIS_PER_COIN=1e5;z.TOTAL_SUPPLY=21e14;z.INITIAL_SUPPLY=252e12;z.EMISSION_SPEED=Math.pow(2,22);z.EMISSION_TAIL_START=48692960;z.EMISSION_TAIL_REWARD=4e3;z.M=240;z.K=120;z.DELTA=.1;z.NUM_BLOCKS_VERIFICATION=250;z.NUM_SNAPSHOTS_MAX=20;z._supplyCache=new _map2["default"];z._supplyCacheMax=0;z._supplyCacheInterval=5e3;r.register(z);var L=function(){function Primitive(e,t,r){(0,_classCallCheck3["default"])(this,Primitive);if(t&&!(e instanceof t))throw new Error("Primitive: Invalid type");if(r!==undefined&&e.length!==undefined&&e.length!==r)throw new Error("Primitive: Invalid length");this._obj=e}(0,_createClass3["default"])(Primitive,[{key:"equals",value:function equals(e){return e instanceof Primitive&&w.equals(this.serialize(),e.serialize())}},{key:"compare",value:function compare(e){if("function"==typeof this._obj.compare)return this._obj.compare(e._obj);if(this._obj.prototype===e._obj.prototype)return w.compare(this.serialize(),e.serialize());throw new Error("Incomparable types: "+this._obj.constructor.name+" and "+e._obj.constructor.name)}},{key:"hashCode",value:function hashCode(){return this.toBase64()}},{key:"serialize",value:function serialize(e){}},{key:"toString",value:function toString(){return this.toBase64()}},{key:"toBase64",value:function toBase64(){return w.toBase64(this.serialize())}},{key:"toHex",value:function toHex(){return w.toHex(this.serialize())}}]);return Primitive}();r.register(L);var U=function(e){(0,_inherits3["default"])(Hash,e);(0,_createClass3["default"])(Hash,null,[{key:"copy",value:function copy(e){return e?new Hash(new Uint8Array(e._obj)):e}}]);function Hash(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Hash.Algorithm.BLAKE2B;(0,_classCallCheck3["default"])(this,Hash);null===e&&(e=new Uint8Array(Hash.getSize(t)));var r=(0,_possibleConstructorReturn3["default"])(this,(Hash.__proto__||(0,_getPrototypeOf2["default"])(Hash)).call(this,e,x.hashType,Hash.getSize(t)));r._algorithm=t;return r}(0,_createClass3["default"])(Hash,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(this._obj);return e}},{key:"subarray",value:function subarray(e,t){return this._obj.subarray(e,t)}},{key:"equals",value:function equals(e){return e instanceof Hash&&e._algorithm===this._algorithm&&(0,_get3["default"])(Hash.prototype.__proto__||(0,_getPrototypeOf2["default"])(Hash.prototype),"equals",this).call(this,e)}},{key:"serializedSize",get:function get(){return Hash.SIZE.get(this._algorithm)}},{key:"array",get:function get(){return this._obj}},{key:"algorithm",get:function get(){return this._algorithm}}],[{key:"light",value:function light(e){return Hash.blake2b(e)}},{key:"blake2b",value:function blake2b(e){return new Hash(x.blake2bSync(e),Hash.Algorithm.BLAKE2B)}},{key:"lightAsync",value:function lightAsync(e){return Hash.blake2bAsync(e)}},{key:"blake2bAsync",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee122(e){return _regenerator2["default"].wrap(function _callee122$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=Hash;t.next=3;return x.blake2bAsync(e);case 3:t.t1=t.sent;t.t2=Hash.Algorithm.BLAKE2B;return t.abrupt("return",new t.t0(t.t1,t.t2));case 6:case"end":return t.stop()}},_callee122,this)}));return function blake2bAsync(t){return e.apply(this,arguments)}}()},{key:"hard",value:function hard(e){return Hash.argon2d(e)}},{key:"argon2d",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee123(e){return _regenerator2["default"].wrap(function _callee123$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=Hash;t.next=3;return x.argon2d(e);case 3:t.t1=t.sent;t.t2=Hash.Algorithm.ARGON2D;return t.abrupt("return",new t.t0(t.t1,t.t2));case 6:case"end":return t.stop()}},_callee123,this)}));return function argon2d(t){return e.apply(this,arguments)}}()},{key:"sha256",value:function sha256(e){return new Hash(x.sha256(e),Hash.Algorithm.SHA256)}},{key:"compute",value:function compute(e,t){switch(t){case Hash.Algorithm.BLAKE2B:return Hash.blake2b(e);case Hash.Algorithm.SHA256:return Hash.sha256(e);default:throw new Error("Invalid hash algorithm")}}},{key:"unserialize",value:function unserialize(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Hash.Algorithm.BLAKE2B;return new Hash(e.read(Hash.getSize(t)),t)}},{key:"fromBase64",value:function fromBase64(e){return new Hash(w.fromBase64(e))}},{key:"fromHex",value:function fromHex(e){return new Hash(w.fromHex(e))}},{key:"fromString",value:function fromString(e){try{return Hash.fromHex(e)}catch(t){}try{return Hash.fromBase64(e)}catch(t){}throw new Error("Invalid hash format")}},{key:"isHash",value:function isHash(e){return e instanceof Hash}},{key:"getSize",value:function getSize(e){var t=Hash.SIZE.get(e);if(!t)throw new Error("Invalid hash algorithm");return t}}]);return Hash}(L);U.Algorithm={BLAKE2B:1,ARGON2D:2,SHA256:3};U.SIZE=new _map2["default"];U.SIZE.set(U.Algorithm.BLAKE2B,x.blake2bSize);U.SIZE.set(U.Algorithm.ARGON2D,x.argon2dSize);U.SIZE.set(U.Algorithm.SHA256,x.sha256Size);U.NULL=new U(new Uint8Array(x.hashSize));r.register(U);var D=function(e){(0,_inherits3["default"])(PrivateKey,e);function PrivateKey(e){(0,_classCallCheck3["default"])(this,PrivateKey);return(0,_possibleConstructorReturn3["default"])(this,(PrivateKey.__proto__||(0,_getPrototypeOf2["default"])(PrivateKey)).call(this,e,x.privateKeyType,x.privateKeySize))}(0,_createClass3["default"])(PrivateKey,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(x.privateKeySerialize(this._obj));return e}},{key:"overwrite",value:function overwrite(e){this._obj.set(e._obj)}},{key:"equals",value:function equals(e){return e instanceof PrivateKey&&(0,_get3["default"])(PrivateKey.prototype.__proto__||(0,_getPrototypeOf2["default"])(PrivateKey.prototype),"equals",this).call(this,e)}},{key:"serializedSize",get:function get(){return x.privateKeySize}}],[{key:"generate",value:function generate(){return new PrivateKey(x.privateKeyGenerate())}},{key:"unserialize",value:function unserialize(e){return new PrivateKey(x.privateKeyUnserialize(e.read(x.privateKeySize)))}}]);return PrivateKey}(L);r.register(D);var H=function(e){(0,_inherits3["default"])(PublicKey,e);(0,_createClass3["default"])(PublicKey,null,[{key:"copy",value:function copy(e){return e?new PublicKey(new Uint8Array(e._obj)):e}}]);function PublicKey(e){(0,_classCallCheck3["default"])(this,PublicKey);return(0,_possibleConstructorReturn3["default"])(this,(PublicKey.__proto__||(0,_getPrototypeOf2["default"])(PublicKey)).call(this,e,x.publicKeyType,x.publicKeySize))}(0,_createClass3["default"])(PublicKey,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(x.publicKeySerialize(this._obj));return e}},{key:"equals",value:function equals(e){return e instanceof PublicKey&&(0,_get3["default"])(PublicKey.prototype.__proto__||(0,_getPrototypeOf2["default"])(PublicKey.prototype),"equals",this).call(this,e)}},{key:"hash",value:function hash(){return U.light(this.serialize())}},{key:"hashAsync",value:function hashAsync(){return U.lightAsync(this.serialize())}},{key:"compare",value:function compare(e){return w.compare(this._obj,e._obj)}},{key:"toAddress",value:function toAddress(){return q.fromHash(this.hash())}},{key:"toPeerId",value:function toPeerId(){return new Dt(this.hash().subarray(0,16))}},{key:"serializedSize",get:function get(){return x.publicKeySize}}],[{key:"derive",value:function derive(e){return new PublicKey(x.publicKeyDerive(e._obj))}},{key:"sum",value:function sum(e){(e=e.slice()).sort(function(e,t){return e.compare(t)});return new PublicKey(x.delinearizeAndAggregatePublicKeys(e.map(function(e){return e._obj})))}},{key:"unserialize",value:function unserialize(e){return new PublicKey(x.publicKeyUnserialize(e.read(x.publicKeySize)))}}]);return PublicKey}(L);r.register(H);var G=function(e){(0,_inherits3["default"])(KeyPair,e);function KeyPair(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;(0,_classCallCheck3["default"])(this,KeyPair);var n=(0,_possibleConstructorReturn3["default"])(this,(KeyPair.__proto__||(0,_getPrototypeOf2["default"])(KeyPair)).call(this,e,x.keyPairType));n._locked=t;n._lockedInternally=t;n._lockSalt=r;n._internalPrivateKey=new D(x.keyPairPrivate(n._obj));return n}(0,_createClass3["default"])(KeyPair,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this._privateKey.serialize(e);this.publicKey.serialize(e);if(this._locked){e.writeUint8(1);e.write(this._lockSalt)}else e.writeUint8(0);return e}},{key:"exportEncrypted",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee124(e,t){var r,n,a;return _regenerator2["default"].wrap(function _callee124$(i){for(;;)switch(i.prev=i.next){case 0:r=this._locked;if(!this._locked){i.next=10;break}i.prev=2;i.next=5;return this.unlock(t||e);case 5:i.next=10;break;case 7:i.prev=7;i.t0=i["catch"](2);throw new Error("KeyPair is locked and lock key mismatches");case 10:n=new Uint8Array(KeyPair.EXPORT_SALT_LENGTH);x.lib.getRandomValues(n);(a=new T(this.encryptedSize)).writeUint8(1);a.writeUint8((0,_log2["default"])(KeyPair.EXPORT_KDF_ROUNDS));i.t1=a;i.next=18;return KeyPair._otpKdf(this.privateKey.serialize(),e,n,KeyPair.EXPORT_KDF_ROUNDS);case 18:i.t2=i.sent;i.t1.write.call(i.t1,i.t2);a.write(n);a.write(this.publicKey.hash().subarray(0,KeyPair.EXPORT_CHECKSUM_LENGTH));r&&this.relock();return i.abrupt("return",a);case 24:case"end":return i.stop()}},_callee124,this,[[2,7]])}));return function exportEncrypted(t,r){return e.apply(this,arguments)}}()},{key:"lock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee125(e,t){return _regenerator2["default"].wrap(function _callee125$(r){for(;;)switch(r.prev=r.next){case 0:if(!this._locked){r.next=2;break}throw new Error("KeyPair already locked");case 2:t&&(this._lockSalt=t);if(!this._lockSalt||0===this._lockSalt.length){this._lockSalt=new Uint8Array(32);x.lib.getRandomValues(this._lockSalt)}r.t0=this._internalPrivateKey;r.next=7;return this._otpPrivateKey(e);case 7:r.t1=r.sent;r.t0.overwrite.call(r.t0,r.t1);this._clearUnlockedPrivateKey();this._locked=!0;this._lockedInternally=!0;case 12:case"end":return r.stop()}},_callee125,this)}));return function lock(t,r){return e.apply(this,arguments)}}()},{key:"unlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee126(e){var t;return _regenerator2["default"].wrap(function _callee126$(r){for(;;)switch(r.prev=r.next){case 0:if(this._locked){r.next=2;break}throw new Error("KeyPair not locked");case 2:r.next=4;return this._otpPrivateKey(e);case 4:t=r.sent;if(!H.derive(t).equals(this.publicKey)){r.next=11;break}this._unlockedPrivateKey=t;this._locked=!1;r.next=12;break;case 11:throw new Error("Invalid key");case 12:case"end":return r.stop()}},_callee126,this)}));return function unlock(t){return e.apply(this,arguments)}}()},{key:"relock",value:function relock(){if(this._locked)throw new Error("KeyPair already locked");if(!this._lockedInternally)throw new Error("KeyPair was never locked");this._clearUnlockedPrivateKey();this._locked=!0}},{key:"_clearUnlockedPrivateKey",value:function _clearUnlockedPrivateKey(){if(this._lockedInternally&&!this._locked){this._unlockedPrivateKey.overwrite(D.unserialize(new T(this._unlockedPrivateKey.serializedSize)));this._unlockedPrivateKey=null}}},{key:"_otpPrivateKey",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee127(e){return _regenerator2["default"].wrap(function _callee127$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=D;t.next=3;return KeyPair._otpKdf(this._privateKey.serialize(),e,this._lockSalt,KeyPair.LOCK_KDF_ROUNDS);case 3:t.t1=t.sent;return t.abrupt("return",new t.t0(t.t1));case 5:case"end":return t.stop()}},_callee127,this)}));return function _otpPrivateKey(t){return e.apply(this,arguments)}}()},{key:"equals",value:function equals(e){return e instanceof KeyPair&&(0,_get3["default"])(KeyPair.prototype.__proto__||(0,_getPrototypeOf2["default"])(KeyPair.prototype),"equals",this).call(this,e)}},{key:"privateKey",get:function get(){if(this.isLocked)throw new Error("Wallet is locked");return this._privateKey}},{key:"_privateKey",get:function get(){return this._unlockedPrivateKey||this._internalPrivateKey}},{key:"publicKey",get:function get(){return this._publicKey||(this._publicKey=new H(x.keyPairPublic(this._obj)))}},{key:"serializedSize",get:function get(){return this._privateKey.serializedSize+this.publicKey.serializedSize+(this._locked?this._lockSalt.byteLength+1:1)}},{key:"encryptedSize",get:function get(){return 2+this.privateKey.serializedSize+KeyPair.EXPORT_SALT_LENGTH+KeyPair.EXPORT_CHECKSUM_LENGTH}},{key:"isLocked",get:function get(){return this._locked}}],[{key:"generate",value:function generate(){return new KeyPair(x.keyPairGenerate())}},{key:"fromPrivateKey",value:function fromPrivateKey(e){return new KeyPair(x.keyPairDerive(e._obj))}},{key:"fromHex",value:function fromHex(e){return KeyPair.unserialize(w.fromHex(e))}},{key:"fromEncrypted",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee128(e,t){var r,n,a,i,s,o,u,c;return _regenerator2["default"].wrap(function _callee128$(l){for(;;)switch(l.prev=l.next){case 0:if(1===e.readUint8()){l.next=3;break}throw new Error("Unsupported type");case 3:if(!((r=e.readUint8())>32)){l.next=6;break}throw new Error("Rounds out-of-bounds");case 6:n=Math.pow(2,r);a=D.unserialize(e);i=e.read(KeyPair.EXPORT_SALT_LENGTH);s=e.read(KeyPair.EXPORT_CHECKSUM_LENGTH);l.t0=D;l.next=13;return KeyPair._otpKdf(a.serialize(),t,i,n);case 13:l.t1=l.sent;o=new l.t0(l.t1);u=KeyPair.fromPrivateKey(o);c=u.publicKey.hash();if(w.equals(c.subarray(0,4),s)){l.next=19;break}throw new Error("Invalid key");case 19:return l.abrupt("return",u);case 20:case"end":return l.stop()}},_callee128,this)}));return function fromEncrypted(t,r){return e.apply(this,arguments)}}()},{key:"unserialize",value:function unserialize(e){var t=D.unserialize(e),r=H.unserialize(e),n=!1,a=null;if(e.readPos<e.byteLength){if(1===e.readUint8()){n=!0;a=e.read(32)}}return new KeyPair(x.keyPairFromKeys(t._obj,r._obj),n,a)}},{key:"_otpKdf",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee129(e,t,r,n){return _regenerator2["default"].wrap(function _callee129$(a){for(;;)switch(a.prev=a.next){case 0:a.t0=w;a.t1=e;a.next=4;return x.kdf(t,r,n);case 4:a.t2=a.sent;return a.abrupt("return",a.t0.xor.call(a.t0,a.t1,a.t2));case 6:case"end":return a.stop()}},_callee129,this)}));return function _otpKdf(t,r,n,a){return e.apply(this,arguments)}}()}]);return KeyPair}(L);G.LOCK_KDF_ROUNDS=256;G.EXPORT_KDF_ROUNDS=256;G.EXPORT_CHECKSUM_LENGTH=4;G.EXPORT_SALT_LENGTH=16;r.register(G);var K=function(e){(0,_inherits3["default"])(RandomSecret,e);function RandomSecret(e){(0,_classCallCheck3["default"])(this,RandomSecret);return(0,_possibleConstructorReturn3["default"])(this,(RandomSecret.__proto__||(0,_getPrototypeOf2["default"])(RandomSecret)).call(this,e,x.randomSecretType,x.randomSecretSize))}(0,_createClass3["default"])(RandomSecret,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(x.randomSecretSerialize(this._obj));return e}},{key:"equals",value:function equals(e){return e instanceof RandomSecret&&(0,_get3["default"])(RandomSecret.prototype.__proto__||(0,_getPrototypeOf2["default"])(RandomSecret.prototype),"equals",this).call(this,e)}},{key:"serializedSize",get:function get(){return x.randomSecretSize}}],[{key:"unserialize",value:function unserialize(e){return new RandomSecret(x.randomSecretUnserialize(e.read(x.randomSecretSize)))}}]);return RandomSecret}(L);r.register(K);var F=function(e){(0,_inherits3["default"])(Commitment,e);(0,_createClass3["default"])(Commitment,null,[{key:"copy",value:function copy(e){return e?new Commitment(new Uint8Array(e._obj)):e}},{key:"sum",value:function sum(e){return new Commitment(x.aggregateCommitments(e.map(function(e){return e._obj})))}}]);function Commitment(e){(0,_classCallCheck3["default"])(this,Commitment);return(0,_possibleConstructorReturn3["default"])(this,(Commitment.__proto__||(0,_getPrototypeOf2["default"])(Commitment)).call(this,e,x.commitmentType,x.commitmentSize))}(0,_createClass3["default"])(Commitment,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(x.commitmentSerialize(this._obj));return e}},{key:"equals",value:function equals(e){return e instanceof Commitment&&(0,_get3["default"])(Commitment.prototype.__proto__||(0,_getPrototypeOf2["default"])(Commitment.prototype),"equals",this).call(this,e)}},{key:"serializedSize",get:function get(){return x.commitmentSize}}],[{key:"unserialize",value:function unserialize(e){return new Commitment(x.commitmentUnserialize(e.read(x.commitmentSize)))}}]);return Commitment}(L);r.register(F);var j=function(e){(0,_inherits3["default"])(CommitmentPair,e);function CommitmentPair(e){(0,_classCallCheck3["default"])(this,CommitmentPair);return(0,_possibleConstructorReturn3["default"])(this,(CommitmentPair.__proto__||(0,_getPrototypeOf2["default"])(CommitmentPair)).call(this,e,x.commitmentPairType))}(0,_createClass3["default"])(CommitmentPair,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this.secret.serialize(e);this.commitment.serialize(e);return e}},{key:"equals",value:function equals(e){return e instanceof CommitmentPair&&(0,_get3["default"])(CommitmentPair.prototype.__proto__||(0,_getPrototypeOf2["default"])(CommitmentPair.prototype),"equals",this).call(this,e)}},{key:"secret",get:function get(){return this._secret||(this._secret=new K(x.commitmentPairRandomSecret(this._obj)))}},{key:"commitment",get:function get(){return this._commitment||(this._commitment=new F(x.commitmentPairCommitment(this._obj)))}},{key:"serializedSize",get:function get(){return this.secret.serializedSize+this.commitment.serializedSize}}],[{key:"generate",value:function generate(){return new CommitmentPair(x.commitmentPairGenerate())}},{key:"unserialize",value:function unserialize(e){var t=K.unserialize(e),r=F.unserialize(e);return new CommitmentPair(x.commitmentPairFromValues(t._obj,r._obj))}},{key:"fromHex",value:function fromHex(e){return this.unserialize(w.fromHex(e))}}]);return CommitmentPair}(L);j.SERIALIZED_SIZE=x.randomSecretSize+x.commitmentSize;r.register(j);var W=function(e){(0,_inherits3["default"])(Signature,e);(0,_createClass3["default"])(Signature,null,[{key:"copy",value:function copy(e){return e?new Signature(new Uint8Array(e._obj)):e}}]);function Signature(e){(0,_classCallCheck3["default"])(this,Signature);return(0,_possibleConstructorReturn3["default"])(this,(Signature.__proto__||(0,_getPrototypeOf2["default"])(Signature)).call(this,e,x.signatureType,x.signatureSize))}(0,_createClass3["default"])(Signature,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(x.signatureSerialize(this._obj));return e}},{key:"verify",value:function verify(e,t){return x.signatureVerify(e._obj,t,this._obj)}},{key:"equals",value:function equals(e){return e instanceof Signature&&(0,_get3["default"])(Signature.prototype.__proto__||(0,_getPrototypeOf2["default"])(Signature.prototype),"equals",this).call(this,e)}},{key:"serializedSize",get:function get(){return x.signatureSize}}],[{key:"create",value:function create(e,t,r){return new Signature(x.signatureCreate(e._obj,t._obj,r))}},{key:"fromPartialSignatures",value:function fromPartialSignatures(e,t){return new Signature(x.combinePartialSignatures(e._obj,t.map(function(e){return e._obj})))}},{key:"unserialize",value:function unserialize(e){return new Signature(x.signatureUnserialize(e.read(x.signatureSize)))}}]);return Signature}(L);r.register(W);var V=function(e){(0,_inherits3["default"])(PartialSignature,e);function PartialSignature(e){(0,_classCallCheck3["default"])(this,PartialSignature);return(0,_possibleConstructorReturn3["default"])(this,(PartialSignature.__proto__||(0,_getPrototypeOf2["default"])(PartialSignature)).call(this,e,x.partialSignatureType,x.partialSignatureSize))}(0,_createClass3["default"])(PartialSignature,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(x.partialSignatureSerialize(this._obj));return e}},{key:"equals",value:function equals(e){return e instanceof PartialSignature&&(0,_get3["default"])(PartialSignature.prototype.__proto__||(0,_getPrototypeOf2["default"])(PartialSignature.prototype),"equals",this).call(this,e)}},{key:"serializedSize",get:function get(){return x.partialSignatureSize}}],[{key:"create",value:function create(e,t,r,n,a,i){return new PartialSignature(x.delinearizedPartialSignatureCreate(e._obj,t._obj,r.map(function(e){return e._obj}),n._obj,a._obj,i))}},{key:"unserialize",value:function unserialize(e){return new PartialSignature(x.partialSignatureUnserialize(e.read(x.signatureSize)))}}]);return PartialSignature}(L);r.register(V);var q=function(e){(0,_inherits3["default"])(Address,e);(0,_createClass3["default"])(Address,null,[{key:"copy",value:function copy(e){return e?new Address(new Uint8Array(e._obj)):e}},{key:"fromHash",value:function fromHash(e){return new Address(e.subarray(0,Address.SERIALIZED_SIZE))}}]);function Address(e){(0,_classCallCheck3["default"])(this,Address);return(0,_possibleConstructorReturn3["default"])(this,(Address.__proto__||(0,_getPrototypeOf2["default"])(Address)).call(this,e,Uint8Array,Address.SERIALIZED_SIZE))}(0,_createClass3["default"])(Address,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(this._obj);return e}},{key:"subarray",value:function subarray(e,t){return this._obj.subarray(e,t)}},{key:"equals",value:function equals(e){return e instanceof Address&&(0,_get3["default"])(Address.prototype.__proto__||(0,_getPrototypeOf2["default"])(Address.prototype),"equals",this).call(this,e)}},{key:"toUserFriendlyAddress",value:function toUserFriendlyAddress(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0],t=w.toBase32(this.serialize()),r=("00"+(98-Address._ibanCheck(t+Address.CCODE+"00"))).slice(-2),n=Address.CCODE+r+t;e&&(n=n.replace(/.{4}/g,"$& ").trim());return n}},{key:"serializedSize",get:function get(){return Address.SERIALIZED_SIZE}}],[{key:"unserialize",value:function unserialize(e){return new Address(e.read(Address.SERIALIZED_SIZE))}},{key:"fromString",value:function fromString(e){try{return Address.fromUserFriendlyAddress(e)}catch(t){}try{return Address.fromHex(e)}catch(t){}try{return Address.fromBase64(e)}catch(t){}throw new Error("Invalid address format")}},{key:"fromBase64",value:function fromBase64(e){return new Address(w.fromBase64(e))}},{key:"fromHex",value:function fromHex(e){return new Address(w.fromHex(e))}},{key:"fromUserFriendlyAddress",value:function fromUserFriendlyAddress(e){if((e=e.replace(/ /g,"")).substr(0,2).toUpperCase()!==Address.CCODE)throw new Error("Invalid Address: Wrong country code");if(36!==e.length)throw new Error("Invalid Address: Should be 36 chars (ignoring spaces)");if(1!==Address._ibanCheck(e.substr(4)+e.substr(0,4)))throw new Error("Invalid Address: Checksum invalid");return new Address(w.fromBase32(e.substr(4)))}},{key:"_ibanCheck",value:function _ibanCheck(e){for(var t=e.split("").map(function(e){var t=e.toUpperCase().charCodeAt(0);return t>=48&&t<=57?e:(t-55).toString()}).join(""),r="",n=0;n<Math.ceil(t.length/6);n++)r=(parseInt(r+t.substr(6*n,6))%97).toString();return parseInt(r)}}]);return Address}(L);q.CCODE="NQ";q.SERIALIZED_SIZE=20;q.HEX_SIZE=40;q.NULL=new q(new Uint8Array(q.SERIALIZED_SIZE));q.CONTRACT_CREATION=new q(new Uint8Array(q.SERIALIZED_SIZE));r.register(q);var $=function(){function Account(e,t){(0,_classCallCheck3["default"])(this,Account);if(!I.isUint8(e))throw new Error("Malformed type");if(!I.isUint64(t))throw new Error("Malformed balance");this._type=e;this._balance=t}(0,_createClass3["default"])(Account,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint8(this._type);e.writeUint64(this._balance);return e}},{key:"equals",value:function equals(e){return w.equals(this.serialize(),e.serialize())}},{key:"toString",value:function toString(){return"Account{type="+this._type+", balance="+this._balance.toString()}},{key:"withBalance",value:function withBalance(e){throw new Error("Not yet implemented.")}},{key:"withOutgoingTransaction",value:function withOutgoingTransaction(e,t,r){if(arguments.length>3&&arguments[3]!==undefined&&arguments[3]){if(t<e.validityStartHeight||t>=e.validityStartHeight+z.TRANSACTION_VALIDITY_WINDOW)throw new Error("Validity Error!");return this.withBalance(this._balance+e.value+e.fee)}var n=this._balance-e.value-e.fee;if(n<0)throw new Error("Balance Error!");if(t<e.validityStartHeight||t>=e.validityStartHeight+z.TRANSACTION_VALIDITY_WINDOW)throw new Error("Validity Error!");if(r.containsTransaction(e))throw new Error("Double Transaction Error!");return this.withBalance(n)}},{key:"withIncomingTransaction",value:function withIncomingTransaction(e,t){if(arguments.length>2&&arguments[2]!==undefined&&arguments[2]){var r=this._balance-e.value;if(r<0)throw new Error("Balance Error!");return this.withBalance(r)}return this.withBalance(this._balance+e.value)}},{key:"withContractCommand",value:function withContractCommand(e,t){arguments.length>2&&arguments[2]!==undefined&&arguments[2];throw new Error("Not yet implemented")}},{key:"isInitial",value:function isInitial(){return this===Account.INITIAL}},{key:"isToBePruned",value:function isToBePruned(){return 0===this._balance&&!this.isInitial()}},{key:"serializedSize",get:function get(){return 9}},{key:"balance",get:function get(){return this._balance}},{key:"type",get:function get(){return this._type}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint8();e.readPos--;if(!Account.TYPE_MAP.has(t))throw new Error("Unknown account type");return Account.TYPE_MAP.get(t).unserialize(e)}}]);return Account}();$.Type={BASIC:0,VESTING:1,HTLC:2};$.TYPE_MAP=new _map2["default"];r.register($);var X=function(){function PrunedAccount(e,t){(0,_classCallCheck3["default"])(this,PrunedAccount);if(!(e instanceof q))throw new Error("Malformed address");this._address=e;this._account=t}(0,_createClass3["default"])(PrunedAccount,[{key:"compare",value:function compare(e){return this._address.compare(e._address)}},{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this._address.serialize(e);this._account.serialize(e);return this}},{key:"address",get:function get(){return this._address}},{key:"account",get:function get(){return this._account}},{key:"serializedSize",get:function get(){return this._address.serializedSize+this._account.serializedSize}}],[{key:"unserialize",value:function unserialize(e){return new PrunedAccount(q.unserialize(e),$.unserialize(e))}}]);return PrunedAccount}();r.register(X);var Y=function(e){(0,_inherits3["default"])(BasicAccount,e);(0,_createClass3["default"])(BasicAccount,null,[{key:"copy",value:function copy(e){return e?new BasicAccount(e._balance):e}}]);function BasicAccount(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;(0,_classCallCheck3["default"])(this,BasicAccount);return(0,_possibleConstructorReturn3["default"])(this,(BasicAccount.__proto__||(0,_getPrototypeOf2["default"])(BasicAccount)).call(this,$.Type.BASIC,e))}(0,_createClass3["default"])(BasicAccount,[{key:"equals",value:function equals(e){return e instanceof BasicAccount&&this._type===e._type&&this._balance===e._balance}},{key:"toString",value:function toString(){return"BasicAccount{balance="+this._balance+"}"}},{key:"withBalance",value:function withBalance(e){return new BasicAccount(e)}},{key:"withIncomingTransaction",value:function withIncomingTransaction(e,t){var r=arguments.length>2&&arguments[2]!==undefined&&arguments[2];if(!r){if(e.hasFlag(pe.Flag.CONTRACT_CREATION)!==(e.recipientType!==this._type))throw new Error("Data Error!")}return(0,_get3["default"])(BasicAccount.prototype.__proto__||(0,_getPrototypeOf2["default"])(BasicAccount.prototype),"withIncomingTransaction",this).call(this,e,t,r)}},{key:"withContractCommand",value:function withContractCommand(e,t){return!(arguments.length>2&&arguments[2]!==undefined&&arguments[2])&&e.recipientType!==this._type&&e.hasFlag(pe.Flag.CONTRACT_CREATION)?$.TYPE_MAP.get(e.recipientType).create(this._balance,t,e):this}},{key:"isInitial",value:function isInitial(){return 0===this._balance}}],[{key:"unserialize",value:function unserialize(e){if(e.readUint8()!==$.Type.BASIC)throw new Error("Invalid account type");return new BasicAccount(e.readUint64())}},{key:"verifyOutgoingTransaction",value:function verifyOutgoingTransaction(e){return ge.verifyTransaction(e)}},{key:"verifyIncomingTransaction",value:function verifyIncomingTransaction(e){return!(e.data.byteLength>64)}}]);return BasicAccount}($);$.INITIAL=new Y(0);$.TYPE_MAP.set($.Type.BASIC,Y);r.register(Y);var Z=function(e){(0,_inherits3["default"])(Contract,e);function Contract(e,t){(0,_classCallCheck3["default"])(this,Contract);return(0,_possibleConstructorReturn3["default"])(this,(Contract.__proto__||(0,_getPrototypeOf2["default"])(Contract)).call(this,e,t))}(0,_createClass3["default"])(Contract,[{key:"withIncomingTransaction",value:function withIncomingTransaction(e,t){var r=arguments.length>2&&arguments[2]!==undefined&&arguments[2];if(!r&&e.hasFlag(pe.Flag.CONTRACT_CREATION))throw new Error("Data error");return(0,_get3["default"])(Contract.prototype.__proto__||(0,_getPrototypeOf2["default"])(Contract.prototype),"withIncomingTransaction",this).call(this,e,t,r)}},{key:"withContractCommand",value:function withContractCommand(e,t){return arguments.length>2&&arguments[2]!==undefined&&arguments[2]&&e.hasFlag(pe.Flag.CONTRACT_CREATION)?new Y(this.balance):this}}],[{key:"verifyIncomingTransaction",value:function verifyIncomingTransaction(e){return!!e.recipient.equals(e.getContractCreationAddress())}}]);return Contract}($);r.register(Z);var J=function(e){(0,_inherits3["default"])(HashedTimeLockedContract,e);function HashedTimeLockedContract(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0,t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:q.NULL,r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:q.NULL,n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:U.NULL,a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1,i=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0,s=arguments.length>6&&arguments[6]!==undefined?arguments[6]:e;(0,_classCallCheck3["default"])(this,HashedTimeLockedContract);var o=(0,_possibleConstructorReturn3["default"])(this,(HashedTimeLockedContract.__proto__||(0,_getPrototypeOf2["default"])(HashedTimeLockedContract)).call(this,$.Type.HTLC,e));if(!(t instanceof q))throw new Error("Malformed address");if(!(r instanceof q))throw new Error("Malformed address");if(!(n instanceof U))throw new Error("Malformed address");if(!I.isUint8(a)||0===a)throw new Error("Malformed hashCount");if(!I.isUint32(i))throw new Error("Malformed timeout");if(!I.isUint64(s))throw new Error("Malformed totalAmount");o._sender=t;o._recipient=r;o._hashRoot=n;o._hashCount=a;o._timeout=i;o._totalAmount=s;return o}(0,_createClass3["default"])(HashedTimeLockedContract,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(HashedTimeLockedContract.prototype.__proto__||(0,_getPrototypeOf2["default"])(HashedTimeLockedContract.prototype),"serialize",this).call(this,e);this._sender.serialize(e);this._recipient.serialize(e);e.writeUint8(this._hashRoot.algorithm);this._hashRoot.serialize(e);e.writeUint8(this._hashCount);e.writeUint32(this._timeout);e.writeUint64(this._totalAmount);return e}},{key:"toString",value:function toString(){return"HashedTimeLockedContract{balance="+this._balance+", sender="+this._sender.toUserFriendlyAddress(!1)+", recipient="+this._sender.toUserFriendlyAddress(!1)+", amount="+this._totalAmount+"/"+this._hashCount+", timeout="+this._timeout+"}"}},{key:"equals",value:function equals(e){return e instanceof HashedTimeLockedContract&&this._type===e._type&&this._balance===e._balance&&this._sender.equals(e._sender)&&this._recipient.equals(e._recipient)&&this._hashRoot.equals(e._hashRoot)&&this._hashCount===e._hashCount&&this._timeout===e._timeout&&this._totalAmount===e._totalAmount}},{key:"withBalance",value:function withBalance(e){return new HashedTimeLockedContract(e,this._sender,this._recipient,this._hashRoot,this._hashCount,this._timeout,this._totalAmount)}},{key:"withOutgoingTransaction",value:function withOutgoingTransaction(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined&&arguments[3],a=new T(e.proof),i=0;switch(a.readUint8()){case HashedTimeLockedContract.ProofType.REGULAR_TRANSFER:if(this._timeout<t)throw new Error("Proof Error!");var s=a.readUint8(),o=a.readUint8();if(!U.unserialize(a,s).equals(this._hashRoot))throw new Error("Proof Error!");U.unserialize(a,s);if(!ge.unserialize(a).isSignedBy(this._recipient))throw new Error("Proof Error!");i=Math.max(0,Math.floor((1-o/this._hashCount)*this._totalAmount));break;case HashedTimeLockedContract.ProofType.EARLY_RESOLVE:if(!ge.unserialize(a).isSignedBy(this._recipient))throw new Error("Proof Error!");if(!ge.unserialize(a).isSignedBy(this._sender))throw new Error("Proof Error!");break;case HashedTimeLockedContract.ProofType.TIMEOUT_RESOLVE:if(this._timeout>=t)throw new Error("Proof Error!");if(!ge.unserialize(a).isSignedBy(this._sender))throw new Error("Proof Error!");break;default:throw new Error("Proof Error!")}if(!n){if(this._balance-e.value-e.fee<i)throw new Error("Balance Error!")}return(0,_get3["default"])(HashedTimeLockedContract.prototype.__proto__||(0,_getPrototypeOf2["default"])(HashedTimeLockedContract.prototype),"withOutgoingTransaction",this).call(this,e,t,r,n)}},{key:"withIncomingTransaction",value:function withIncomingTransaction(e,t){arguments.length>2&&arguments[2]!==undefined&&arguments[2];throw new Error("Illegal incoming transaction")}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(HashedTimeLockedContract.prototype.__proto__||(0,_getPrototypeOf2["default"])(HashedTimeLockedContract.prototype),"serializedSize",this)+this._sender.serializedSize+this._recipient.serializedSize+1+this._hashRoot.serializedSize+1+4+8}},{key:"sender",get:function get(){return this._sender}},{key:"recipient",get:function get(){return this._recipient}},{key:"hashRoot",get:function get(){return this._hashRoot}},{key:"hashCount",get:function get(){return this._hashCount}},{key:"timeout",get:function get(){return this._timeout}},{key:"totalAmount",get:function get(){return this._totalAmount}}],[{key:"create",value:function create(e,t,r){var n=new T(r.data),a=q.unserialize(n),i=q.unserialize(n),s=n.readUint8();return new HashedTimeLockedContract(e,a,i,U.unserialize(n,s),n.readUint8(),n.readUint32())}},{key:"unserialize",value:function unserialize(e){if(e.readUint8()!==$.Type.HTLC)throw new Error("Invalid account type");var t=e.readUint64(),r=q.unserialize(e),n=q.unserialize(e),a=e.readUint8();return new HashedTimeLockedContract(t,r,n,U.unserialize(e,a),e.readUint8(),e.readUint32(),e.readUint64())}},{key:"verifyOutgoingTransaction",value:function verifyOutgoingTransaction(e){try{var t=new T(e.proof);switch(t.readUint8()){case HashedTimeLockedContract.ProofType.REGULAR_TRANSFER:for(var r=t.readUint8(),n=t.readUint8(),a=U.unserialize(t,r),i=U.unserialize(t,r),s=0;s<n;++s)i=U.compute(i.array,r);if(!a.equals(i))return!1;if(!ge.unserialize(t).verify(null,e.serializeContent()))return!1;break;case HashedTimeLockedContract.ProofType.EARLY_RESOLVE:if(!ge.unserialize(t).verify(null,e.serializeContent()))return!1;if(!ge.unserialize(t).verify(null,e.serializeContent()))return!1;break;case HashedTimeLockedContract.ProofType.TIMEOUT_RESOLVE:if(!ge.unserialize(t).verify(null,e.serializeContent()))return!1;break;default:return!1}return t.readPos===t.byteLength}catch(o){return!1}}},{key:"verifyIncomingTransaction",value:function verifyIncomingTransaction(e){try{var t=new T(e.data);q.unserialize(t);q.unserialize(t);var r=t.readUint8();U.unserialize(t,r);t.readUint8();t.readUint32();return r!==U.Algorithm.ARGON2D&&(t.readPos===t.byteLength&&Z.verifyIncomingTransaction(e))}catch(n){return!1}}}]);return HashedTimeLockedContract}(Z);J.ProofType={REGULAR_TRANSFER:1,EARLY_RESOLVE:2,TIMEOUT_RESOLVE:3};$.TYPE_MAP.set($.Type.HTLC,J);r.register(J);var Q=function(e){(0,_inherits3["default"])(VestingContract,e);function VestingContract(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0,t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:q.NULL,r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0,n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0,a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:e,i=arguments.length>5&&arguments[5]!==undefined?arguments[5]:e;(0,_classCallCheck3["default"])(this,VestingContract);var s=(0,_possibleConstructorReturn3["default"])(this,(VestingContract.__proto__||(0,_getPrototypeOf2["default"])(VestingContract)).call(this,$.Type.VESTING,e));if(!(t instanceof q))throw new Error("Malformed address");if(!I.isUint32(r))throw new Error("Malformed vestingStart");if(!I.isUint32(n))throw new Error("Malformed vestingStepBlocks");if(!I.isUint64(a))throw new Error("Malformed vestingStepAmount");if(!I.isUint64(i))throw new Error("Malformed lowerCap");s._owner=t;s._vestingStart=r;s._vestingStepBlocks=n;s._vestingStepAmount=a;s._vestingTotalAmount=i;return s}(0,_createClass3["default"])(VestingContract,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(VestingContract.prototype.__proto__||(0,_getPrototypeOf2["default"])(VestingContract.prototype),"serialize",this).call(this,e);this._owner.serialize(e);e.writeUint32(this._vestingStart);e.writeUint32(this._vestingStepBlocks);e.writeUint64(this._vestingStepAmount);e.writeUint64(this._vestingTotalAmount);return e}},{key:"toString",value:function toString(){return"VestingAccount{balance="+this._balance+", owner="+this._owner.toUserFriendlyAddress()}},{key:"equals",value:function equals(e){return e instanceof VestingContract&&this._type===e._type&&this._balance===e._balance&&this._owner.equals(e._owner)&&this._vestingStart===e._vestingStart&&this._vestingStepBlocks===e._vestingStepBlocks&&this._vestingStepAmount===e._vestingStepAmount&&this._vestingTotalAmount===e._vestingTotalAmount}},{key:"withBalance",value:function withBalance(e){return new VestingContract(e,this._owner,this._vestingStart,this._vestingStepBlocks,this._vestingStepAmount,this._vestingTotalAmount)}},{key:"withOutgoingTransaction",value:function withOutgoingTransaction(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined&&arguments[3];if(!n){var a=this.getMinCap(t);if(this._balance-e.value-e.fee<a)throw new Error("Balance Error!");var i=new T(e.proof);if(!ge.unserialize(i).isSignedBy(this._owner))throw new Error("Proof Error!")}return(0,_get3["default"])(VestingContract.prototype.__proto__||(0,_getPrototypeOf2["default"])(VestingContract.prototype),"withOutgoingTransaction",this).call(this,e,t,r,n)}},{key:"withIncomingTransaction",value:function withIncomingTransaction(e,t){arguments.length>2&&arguments[2]!==undefined&&arguments[2];throw new Error("Illegal incoming transaction")}},{key:"getMinCap",value:function getMinCap(e){return this._vestingStepBlocks&&this._vestingStepAmount>0?Math.max(0,this._vestingTotalAmount-Math.floor((e-this._vestingStart)/this._vestingStepBlocks)*this._vestingStepAmount):0}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(VestingContract.prototype.__proto__||(0,_getPrototypeOf2["default"])(VestingContract.prototype),"serializedSize",this)+this._owner.serializedSize+4+4+8+8}},{key:"owner",get:function get(){return this._owner}},{key:"vestingStart",get:function get(){return this._vestingStart}},{key:"vestingStepBlocks",get:function get(){return this._vestingStepBlocks}},{key:"vestingStepAmount",get:function get(){return this._vestingStepAmount}},{key:"vestingTotalAmount",get:function get(){return this._vestingTotalAmount}}],[{key:"create",value:function create(e,t,r){var n=void 0,a=void 0,i=void 0,s=void 0,o=new T(r.data),u=q.unserialize(o);s=r.value;switch(r.data.length){case q.SERIALIZED_SIZE+4:n=0;a=o.readUint32();i=s;break;case q.SERIALIZED_SIZE+16:n=o.readUint32();a=o.readUint32();i=o.readUint64();break;case q.SERIALIZED_SIZE+24:n=o.readUint32();a=o.readUint32();i=o.readUint64();s=o.readUint64();break;default:throw new Error("Invalid transaction data")}return new VestingContract(e,u,n,a,i,s)}},{key:"unserialize",value:function unserialize(e){if(e.readUint8()!==$.Type.VESTING)throw new Error("Invalid account type");return new VestingContract(e.readUint64(),q.unserialize(e),e.readUint32(),e.readUint32(),e.readUint64(),e.readUint64())}},{key:"verifyOutgoingTransaction",value:function verifyOutgoingTransaction(e){var t=new T(e.proof);return!!ge.unserialize(t).verify(null,e.serializeContent())&&t.readPos===t.byteLength}},{key:"verifyIncomingTransaction",value:function verifyIncomingTransaction(e){switch(e.data.length){case q.SERIALIZED_SIZE+4:case q.SERIALIZED_SIZE+16:case q.SERIALIZED_SIZE+24:return Z.verifyIncomingTransaction(e);default:return!1}}}]);return VestingContract}(Z);$.TYPE_MAP.set($.Type.VESTING,Q);r.register(Q);var ee=function(){(0,_createClass3["default"])(AccountsTreeNode,null,[{key:"terminalNode",value:function terminalNode(e,t){return new AccountsTreeNode(AccountsTreeNode.TERMINAL,e,t)}},{key:"branchNode",value:function branchNode(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[],r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];if(t.length!==r.length)throw new Error("Invalid list of children for branch node");return new AccountsTreeNode(AccountsTreeNode.BRANCH,e,t,r)}},{key:"copy",value:function copy(e){return e?AccountsTreeNode.unserialize(new T(e)):e}}]);function AccountsTreeNode(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"",r=arguments[2],n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];(0,_classCallCheck3["default"])(this,AccountsTreeNode);this._type=e;this._prefix=t;if(this.isBranch()){this._childrenSuffixes=r;this._childrenHashes=n}else{if(!this.isTerminal())throw"Invalid AccountsTreeNode type: "+e;this._account=r}}(0,_createClass3["default"])(AccountsTreeNode,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint8(this._type);e.writeVarLengthString(this._prefix);if(this.isTerminal())this._account.serialize(e);else{var t=this._childrenSuffixes.reduce(function(e,t){return e+!!t},0);e.writeUint8(t);for(var r=0;r<this._childrenSuffixes.length;++r)if(this._childrenHashes[r]){e.writeVarLengthString(this._childrenSuffixes[r]);this._childrenHashes[r].serialize(e)}}return e}},{key:"stripDown",value:function stripDown(){return this.serialize()}},{key:"getChildHash",value:function getChildHash(e){return this._childrenHashes&&this._childrenHashes[this._getChildIndex(e)]}},{key:"getChild",value:function getChild(e){var t=this._childrenSuffixes&&this._childrenSuffixes[this._getChildIndex(e)];return t?this.prefix+t:t}},{key:"withChild",value:function withChild(e,t){var r=this._childrenSuffixes.slice()||[],n=this._childrenHashes.slice()||[];r[this._getChildIndex(e)]=e.substr(this.prefix.length);n[this._getChildIndex(e)]=t;return AccountsTreeNode.branchNode(this._prefix,r,n)}},{key:"withoutChild",value:function withoutChild(e){var t=this._childrenSuffixes.slice()||[],r=this._childrenHashes.slice()||[];delete t[this._getChildIndex(e)];delete r[this._getChildIndex(e)];return AccountsTreeNode.branchNode(this._prefix,t,r)}},{key:"hasChildren",value:function hasChildren(){return this._childrenSuffixes&&this._childrenSuffixes.some(function(e){return!!e})}},{key:"hasSingleChild",value:function hasSingleChild(){return this._childrenSuffixes&&1===this._childrenSuffixes.reduce(function(e,t){return e+!!t},0)}},{key:"getFirstChild",value:function getFirstChild(){if(!this._childrenSuffixes)return undefined;var e=this._childrenSuffixes.find(function(e){return!!e});return e?this.prefix+e:undefined}},{key:"getLastChild",value:function getLastChild(){if(!this._childrenSuffixes)return undefined;for(var e=this._childrenSuffixes.length-1;e>=0;--e)if(this._childrenSuffixes[e])return this.prefix+this._childrenSuffixes[e];return undefined}},{key:"getChildren",value:function getChildren(){var e=this;return this._childrenSuffixes?this._childrenSuffixes.filter(function(e){return!!e}).map(function(t){return e.prefix+t}):undefined}},{key:"withAccount",value:function withAccount(e){return AccountsTreeNode.terminalNode(this._prefix,e)}},{key:"hash",value:function hash(){this._hash||(this._hash=U.light(this.serialize()));return this._hash}},{key:"isChildOf",value:function isChildOf(e){return e.getChildren()&&e.getChildren().includes(this._prefix)}},{key:"isTerminal",value:function isTerminal(){return AccountsTreeNode.isTerminalType(this._type)}},{key:"isBranch",value:function isBranch(){return AccountsTreeNode.isBranchType(this._type)}},{key:"_getChildIndex",value:function _getChildIndex(e){C.that(e.substr(0,this.prefix.length)===this.prefix,"Prefix "+e+" is not a child of the current node "+this.prefix);return parseInt(e[this.prefix.length],16)}},{key:"equals",value:function equals(e){if(!(e instanceof AccountsTreeNode))return!1;if(!(0,_is2["default"])(this.prefix,e.prefix))return!1;if(this.isTerminal())return e.isTerminal()&&e._account.equals(this._account);if(!e.isBranch())return!1;if(this._childrenSuffixes.length!==e._childrenSuffixes.length)return!1;if(e._childrenSuffixes.length!==e._childrenHashes.length)return!1;for(var t=0;t<this._childrenSuffixes.length;++t){var r=this._childrenHashes[t],n=e._childrenHashes[t];if(r){if(!n||!r.equals(n))return!1}else if(n)return!1;if(this._childrenSuffixes[t]!==e._childrenSuffixes[t])return!1}return!0}},{key:"serializedSize",get:function get(){var e=this,t=void 0;if(this.isTerminal())t=this._account.serializedSize;else{t=1+this._childrenHashes.reduce(function(t,r,n){return t+(r?r.serializedSize+T.varLengthStringSize(e._childrenSuffixes[n]):0)},0)}return 1+T.varLengthStringSize(this._prefix)+t}},{key:"account",get:function get(){return this._account}},{key:"prefix",get:function get(){return this._prefix},set:function set(e){this._prefix=e;this._hash=undefined}}],[{key:"isTerminalType",value:function isTerminalType(e){return e===AccountsTreeNode.TERMINAL}},{key:"isBranchType",value:function isBranchType(e){return e===AccountsTreeNode.BRANCH}},{key:"unserialize",value:function unserialize(e){var t=e.readUint8(),r=e.readVarLengthString();if(AccountsTreeNode.isTerminalType(t)){var n=$.unserialize(e);return AccountsTreeNode.terminalNode(r,n)}if(AccountsTreeNode.isBranchType(t)){for(var a=[],i=[],s=e.readUint8(),o=0;o<s;++o){var u=e.readVarLengthString(),c=U.unserialize(e),l=parseInt(u[0],16);a[l]=u;i[l]=c}return AccountsTreeNode.branchNode(r,a,i)}throw"Invalid AccountsTreeNode type: "+t}}]);return AccountsTreeNode}();ee.BRANCH=0;ee.TERMINAL=255;r.register(ee);var te=function(){(0,_createClass3["default"])(AccountsTreeStore,null,[{key:"initPersistent",value:function initPersistent(e){e.createObjectStore("Accounts",new re)}},{key:"getPersistent",value:function getPersistent(e){return new AccountsTreeStore(e.getObjectStore("Accounts"))}},{key:"createVolatile",value:function createVolatile(){return new AccountsTreeStore(JDB.JungleDB.createVolatileObjectStore())}}]);function AccountsTreeStore(e){(0,_classCallCheck3["default"])(this,AccountsTreeStore);this._store=e}(0,_createClass3["default"])(AccountsTreeStore,[{key:"get",value:function get(e){return this._store.get(e)}},{key:"put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee130(e){var t;return _regenerator2["default"].wrap(function _callee130$(r){for(;;)switch(r.prev=r.next){case 0:t=e.prefix;r.next=3;return this._store.put(t,e);case 3:return r.abrupt("return",t);case 4:case"end":return r.stop()}},_callee130,this)}));return function put(t){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee131(e){var t;return _regenerator2["default"].wrap(function _callee131$(r){for(;;)switch(r.prev=r.next){case 0:t=e.prefix;r.next=3;return this._store.remove(t);case 3:return r.abrupt("return",t);case 4:case"end":return r.stop()}},_callee131,this)}));return function remove(t){return e.apply(this,arguments)}}()},{key:"getRootNode",value:function getRootNode(){return this.get("")}},{key:"getTerminalNodes",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee132(e,t){var r,n,a,i,s,o,u,c;return _regenerator2["default"].wrap(function _callee132$(l){for(;;)switch(l.prev=l.next){case 0:r=[];l.next=3;return this._store.keyStream(function(e){if(e.length===q.HEX_SIZE){r.push(e);if(r.length===t)return!1}return!0},!0,JDB.KeyRange.lowerBound(e,!0));case 3:n=[];a=!0;i=!1;s=undefined;l.prev=7;for(o=(0,_getIterator3["default"])(r);!(a=(u=o.next()).done);a=!0){c=u.value;n.push(this._store.get(c))}l.next=15;break;case 11:l.prev=11;l.t0=l["catch"](7);i=!0;s=l.t0;case 15:l.prev=15;l.prev=16;!a&&o["return"]&&o["return"]();case 18:l.prev=18;if(!i){l.next=21;break}throw s;case 21:return l.finish(18);case 22:return l.finish(15);case 23:return l.abrupt("return",_promise2["default"].all(n));case 24:case"end":return l.stop()}},_callee132,this,[[7,11,15,23],[16,,18,22]])}));return function getTerminalNodes(t,r){return e.apply(this,arguments)}}()},{key:"snapshot",value:function snapshot(e){var snapshot=this._store.snapshot();e&&snapshot.inherit(e._store);return new AccountsTreeStore(snapshot)}},{key:"transaction",value:function transaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];return new AccountsTreeStore(this._store.transaction(e))}},{key:"synchronousTransaction",value:function synchronousTransaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0],t=this._store.synchronousTransaction(e);return new ne(t)}},{key:"truncate",value:function truncate(){return this._store.truncate()}},{key:"commit",value:function commit(){return this._store.commit()}},{key:"abort",value:function abort(){return this._store.abort()}},{key:"tx",get:function get(){return this._store instanceof JDB.Transaction?this._store:undefined}}]);return AccountsTreeStore}();r.register(te);var re=function(){function AccountsTreeStoreCodec(){(0,_classCallCheck3["default"])(this,AccountsTreeStoreCodec)}(0,_createClass3["default"])(AccountsTreeStoreCodec,[{key:"encode",value:function encode(e){return e.stripDown()}},{key:"decode",value:function decode(e,t){return ee.copy(e)}},{key:"valueEncoding",get:function get(){return JDB.JungleDB.JSON_ENCODING}}]);return AccountsTreeStoreCodec}(),ne=function(e){(0,_inherits3["default"])(SynchronousAccountsTreeStore,e);function SynchronousAccountsTreeStore(e){(0,_classCallCheck3["default"])(this,SynchronousAccountsTreeStore);var t=(0,_possibleConstructorReturn3["default"])(this,(SynchronousAccountsTreeStore.__proto__||(0,_getPrototypeOf2["default"])(SynchronousAccountsTreeStore)).call(this,e));t._syncStore=e;return t}(0,_createClass3["default"])(SynchronousAccountsTreeStore,[{key:"preload",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee133(e){return _regenerator2["default"].wrap(function _callee133$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._syncStore.preload(e);case 2:case"end":return t.stop()}},_callee133,this)}));return function preload(t){return e.apply(this,arguments)}}()},{key:"getSync",value:function getSync(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1];return this._syncStore.getSync(e,t)}},{key:"putSync",value:function putSync(e){var t=e.prefix;this._syncStore.putSync(t,e);return t}},{key:"removeSync",value:function removeSync(e){var t=e.prefix;this._syncStore.removeSync(t);return t}},{key:"getRootNodeSync",value:function getRootNodeSync(){return this.getSync("")}}]);return SynchronousAccountsTreeStore}(te);r.register(ne);var ae=function(){function AccountsProof(e){(0,_classCallCheck3["default"])(this,AccountsProof);if(!e||!Array.isArray(e)||!I.isUint16(e.length)||e.some(function(e){return!(e instanceof ee)}))throw"Malformed nodes";this._nodes=e;this._index=null}(0,_createClass3["default"])(AccountsProof,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint16(this._nodes.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._nodes);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"verify",value:function verify(){var e=[];this._index=new y;var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._nodes);!(t=(a=i.next()).done);t=!0){var s=a.value;if(s.isBranch())for(var o=void 0;o=e.pop();){if(!o.isChildOf(s)){e.push(o);break}var u=o.hash();if(!s.getChildHash(o.prefix).equals(u)||s.getChild(o.prefix)!==o.prefix)return!1;this._index.put(u,o)}e.push(s)}}catch(c){r=!0;n=c}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return 1===e.length&&""===e[0].prefix&&e[0].isBranch()}},{key:"getAccount",value:function getAccount(e){C.that(!!this._index,"AccountsProof must be verified before retrieving accounts. Call verify() first.");var t=this._nodes[this._nodes.length-1],r=e.toHex();return this._getAccount(t,r)}},{key:"_getAccount",value:function _getAccount(e,t){var r=B.commonPrefix(e.prefix,t);if(r.length!==e.prefix.length)return null;if(r===t)return e.account;var n=e.getChildHash(t);if(n){var a=this._index.get(n);if(!a)throw new Error("Requested address not part of AccountsProof");return this._getAccount(a,t)}return null}},{key:"toString",value:function toString(){return"AccountsProof{length="+this.length+"}"}},{key:"root",value:function root(){return this._nodes[this._nodes.length-1].hash()}},{key:"serializedSize",get:function get(){var e=2,t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._nodes);!(t=(a=i.next()).done);t=!0){e+=a.value.serializedSize}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"length",get:function get(){return this._nodes.length}},{key:"nodes",get:function get(){return this._nodes}}],[{key:"unserialize",value:function unserialize(e){for(var t=e.readUint16(),r=[],n=0;n<t;n++)r.push(ee.unserialize(e));return new AccountsProof(r)}}]);return AccountsProof}();r.register(ae);var ie=function(){function AccountsTreeChunk(e,t){(0,_classCallCheck3["default"])(this,AccountsTreeChunk);if(!e||!I.isUint16(e.length)||e.some(function(e){return!(e instanceof ee&&e.isTerminal())}))throw"Malformed nodes";this._nodes=e;this._proof=t}(0,_createClass3["default"])(AccountsTreeChunk,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint16(this._nodes.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._nodes);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}this._proof.serialize(e);return e}},{key:"verify",value:function verify(){if(!this._proof.verify())return!1;for(var e=null,t=0;t<=this._nodes.length;++t){var r=t<this._nodes.length?this._nodes[t]:this.tail;if(e&&e>=r.prefix)return!1;e=r.prefix}return!0}},{key:"toString",value:function toString(){return"AccountsTreeChunk{length="+this.length+"}"}},{key:"root",value:function root(){return this._proof.root()}},{key:"serializedSize",get:function get(){var e=2,t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._nodes);!(t=(a=i.next()).done);t=!0){e+=a.value.serializedSize}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e+=this._proof.serializedSize}},{key:"terminalNodes",get:function get(){return this._nodes.concat([this.tail])}},{key:"proof",get:function get(){return this._proof}},{key:"head",get:function get(){return this._nodes[0]}},{key:"tail",get:function get(){return this._proof.nodes[0]}},{key:"length",get:function get(){return this._nodes.length+1}}],[{key:"unserialize",value:function unserialize(e){for(var t=e.readUint16(),r=[],n=0;n<t;n++)r.push(ee.unserialize(e));return new AccountsTreeChunk(r,ae.unserialize(e))}}]);return AccountsTreeChunk}();ie.SIZE_MAX=1e3;ie.EMPTY=new ie([],new ae([]));r.register(ie);var se=function(e){(0,_inherits3["default"])(AccountsTree,e);(0,_createClass3["default"])(AccountsTree,null,[{key:"getPersistent",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee134(e){var t,r;return _regenerator2["default"].wrap(function _callee134$(n){for(;;)switch(n.prev=n.next){case 0:t=te.getPersistent(e);r=new AccountsTree(t);return n.abrupt("return",r._init());case 3:case"end":return n.stop()}},_callee134,this)}));return function getPersistent(t){return e.apply(this,arguments)}}()},{key:"createVolatile",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee135(){var e,t;return _regenerator2["default"].wrap(function _callee135$(r){for(;;)switch(r.prev=r.next){case 0:e=te.createVolatile();t=new AccountsTree(e);return r.abrupt("return",t._init());case 3:case"end":return r.stop()}},_callee135,this)}));return function createVolatile(){return e.apply(this,arguments)}}()}]);function AccountsTree(e){(0,_classCallCheck3["default"])(this,AccountsTree);var t=(0,_possibleConstructorReturn3["default"])(this,(AccountsTree.__proto__||(0,_getPrototypeOf2["default"])(AccountsTree)).call(this));t._store=e;t._synchronizer=new f;return t}(0,_createClass3["default"])(AccountsTree,[{key:"_init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee136(){var e;return _regenerator2["default"].wrap(function _callee136$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._store.getRootNode();case 2:if(e=t.sent){t.next=7;break}e=ee.branchNode("",[],[]);t.next=7;return this._store.put(e);case 7:return t.abrupt("return",this);case 8:case"end":return t.stop()}},_callee136,this)}));return function _init(){return e.apply(this,arguments)}}()},{key:"put",value:function put(e,t){var r=this;return this._synchronizer.push(function(){return r._put(e,t)})}},{key:"_put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee137(e,t){var r,n;return _regenerator2["default"].wrap(function _callee137$(a){for(;;)switch(a.prev=a.next){case 0:a.t0=t.isInitial();if(!a.t0){a.next=5;break}a.next=4;return this.get(e);case 4:a.t0=!a.sent;case 5:if(!a.t0){a.next=7;break}return a.abrupt("return");case 7:a.next=9;return this._store.getRootNode();case 9:r=a.sent;C.that(!!r,"Corrupted store: Failed to fetch AccountsTree root node");n=e.toHex();a.next=14;return this._insert(r,n,t,[]);case 14:case"end":return a.stop()}},_callee137,this)}));return function _put(t,r){return e.apply(this,arguments)}}()},{key:"_insert",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee138(e,t,r,n){var a,i,s,o,u,c,l,h,f,_,d;return _regenerator2["default"].wrap(function _callee138$(p){for(;;)switch(p.prev=p.next){case 0:if((a=B.commonPrefix(e.prefix,t)).length===e.prefix.length){p.next=11;break}i=ee.terminalNode(t,r);s=i.hash();p.next=6;return this._store.put(i);case 6:o=ee.branchNode(a).withChild(e.prefix,e.hash()).withChild(i.prefix,s);u=o.hash();p.next=10;return this._store.put(o);case 10:return p.abrupt("return",this._updateKeys(o.prefix,u,n));case 11:if(a!==t){p.next=21;break}if(!r.isInitial()){p.next=16;break}p.next=15;return this._store.remove(e);case 15:return p.abrupt("return",this._prune(e.prefix,n));case 16:e=e.withAccount(r);c=e.hash();p.next=20;return this._store.put(e);case 20:return p.abrupt("return",this._updateKeys(e.prefix,c,n));case 21:if(!(l=e.getChild(t))){p.next=28;break}p.next=25;return this._store.get(l);case 25:h=p.sent;n.push(e);return p.abrupt("return",this._insert(h,t,r,n));case 28:f=ee.terminalNode(t,r);_=f.hash();p.next=32;return this._store.put(f);case 32:e=e.withChild(f.prefix,_);d=e.hash();p.next=36;return this._store.put(e);case 36:return p.abrupt("return",this._updateKeys(e.prefix,d,n));case 37:case"end":return p.stop()}},_callee138,this)}));return function _insert(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_prune",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee139(e,t){var r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee139$(u){for(;;)switch(u.prev=u.next){case 0:r=t.length-1;case 1:if(!(r>=0)){u.next=26;break}if(!(n=(n=t[r]).withoutChild(e)).hasSingleChild()||""===n.prefix){u.next=17;break}u.next=7;return this._store.remove(n);case 7:a=n.getFirstChild();u.next=10;return this._store.get(a);case 10:i=u.sent;u.next=13;return this._store.put(i);case 13:s=i.hash();return u.abrupt("return",this._updateKeys(i.prefix,s,t.slice(0,r)));case 17:if(!n.hasChildren()&&""!==n.prefix){u.next=22;break}o=n.hash();u.next=21;return this._store.put(n);case 21:return u.abrupt("return",this._updateKeys(n.prefix,o,t.slice(0,r)));case 22:e=n.prefix;case 23:--r;u.next=1;break;case 26:return u.abrupt("return",undefined);case 27:case"end":return u.stop()}},_callee139,this)}));return function _prune(t,r){return e.apply(this,arguments)}}()},{key:"_updateKeys",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee140(e,t,r){var n,a;return _regenerator2["default"].wrap(function _callee140$(i){for(;;)switch(i.prev=i.next){case 0:n=r.length-1;case 1:if(!(n>=0)){i.next=11;break}a=(a=r[n]).withChild(e,t);i.next=6;return this._store.put(a);case 6:t=a.hash();e=a.prefix;case 8:--n;i.next=1;break;case 11:return i.abrupt("return",t);case 12:case"end":return i.stop()}},_callee140,this)}));return function _updateKeys(t,r,n){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee141(e){var t;return _regenerator2["default"].wrap(function _callee141$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._store.get(e.toHex());case 2:t=r.sent;return r.abrupt("return",t!==undefined?t.account:null);case 4:case"end":return r.stop()}},_callee141,this)}));return function get(t){return e.apply(this,arguments)}}()},{key:"getAccountsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee142(e){var t,r,n,a,i,s,o,u,c;return _regenerator2["default"].wrap(function _callee142$(l){for(;;)switch(l.prev=l.next){case 0:l.next=2;return this._store.getRootNode();case 2:t=l.sent;C.that(!!t,"Corrupted store: Failed to fetch AccountsTree root node");r=[];n=!0;a=!1;i=undefined;l.prev=8;for(s=(0,_getIterator3["default"])(e);!(n=(o=s.next()).done);n=!0){u=o.value;r.push(u.toHex())}l.next=16;break;case 12:l.prev=12;l.t0=l["catch"](8);a=!0;i=l.t0;case 16:l.prev=16;l.prev=17;!n&&s["return"]&&s["return"]();case 19:l.prev=19;if(!a){l.next=22;break}throw i;case 22:return l.finish(19);case 23:return l.finish(16);case 24:r.sort();c=[];l.next=28;return this._getAccountsProof(t,r,c);case 28:return l.abrupt("return",new ae(c));case 29:case"end":return l.stop()}},_callee142,this,[[8,12,16,24],[17,,19,23]])}));return function getAccountsProof(t){return e.apply(this,arguments)}}()},{key:"_getAccountsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee143(e,t,r){var n,a,i,s,o,u,c;return _regenerator2["default"].wrap(function _callee143$(l){for(;;)switch(l.prev=l.next){case 0:n=!1;a=0;case 2:if(!(a<t.length)){l.next=36;break}i=t[a];if(B.commonPrefix(e.prefix,i).length===e.prefix.length&&e.prefix!==i){l.next=9;break}n=!0;a++;return l.abrupt("continue",34);case 9:if(!(s=e.getChild(i))){l.next=32;break}l.next=13;return this._store.get(s);case 13:o=l.sent;u=[i];c=a+1;case 16:if(!(c<t.length)){l.next=23;break}if(t[c].startsWith(o.prefix)){l.next=19;break}return l.abrupt("break",23);case 19:u.push(t[c]);case 20:++c;l.next=16;break;case 23:a=c;l.next=26;return this._getAccountsProof(o,u,r);case 26:l.t0=l.sent;if(l.t0){l.next=29;break}l.t0=n;case 29:n=l.t0;l.next=34;break;case 32:n=!0;a++;case 34:l.next=2;break;case 36:n&&r.push(e);return l.abrupt("return",n);case 38:case"end":return l.stop()}},_callee143,this)}));return function _getAccountsProof(t,r,n){return e.apply(this,arguments)}}()},{key:"getChunk",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee144(e,t){var r,n,a;return _regenerator2["default"].wrap(function _callee144$(i){for(;;)switch(i.prev=i.next){case 0:i.next=2;return this._store.getTerminalNodes(e,t);case 2:r=i.sent;n=r.pop();a=void 0;if(!n){i.next=11;break}i.next=8;return this.getAccountsProof([q.fromHex(n.prefix)]);case 8:a=i.sent;i.next=14;break;case 11:i.next=13;return this.getAccountsProof([q.fromHex("ffffffffffffffffffffffffffffffffffffffff")]);case 13:a=i.sent;case 14:return i.abrupt("return",new ie(r,a));case 15:case"end":return i.stop()}},_callee144,this)}));return function getChunk(t,r){return e.apply(this,arguments)}}()},{key:"transaction",value:function transaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];return new AccountsTree(this._store.transaction(e))._init()}},{key:"synchronousTransaction",value:function synchronousTransaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0],t=this._store.synchronousTransaction(e);return new oe(t)._init()}},{key:"partialTree",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee145(){var e,t;return _regenerator2["default"].wrap(function _callee145$(r){for(;;)switch(r.prev=r.next){case 0:e=this._store.synchronousTransaction(!1);r.next=3;return e.truncate();case 3:t=new ue(e);return r.abrupt("return",t._init());case 5:case"end":return r.stop()}},_callee145,this)}));return function partialTree(){return e.apply(this,arguments)}}()},{key:"snapshot",value:function snapshot(e){return new AccountsTree(this._store.snapshot(e?e._store:undefined))._init()}},{key:"commit",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee146(){return _regenerator2["default"].wrap(function _callee146$(e){for(;;)switch(e.prev=e.next){case 0:e.t0=C;e.next=3;return this.root();case 3:e.t1=new U(null);e.t2=!e.sent.equals(e.t1);e.t0.that.call(e.t0,e.t2);return e.abrupt("return",this._store.commit());case 7:case"end":return e.stop()}},_callee146,this)}));return function commit(){return e.apply(this,arguments)}}()},{key:"abort",value:function abort(){return this._store.abort()}},{key:"root",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee147(){var e;return _regenerator2["default"].wrap(function _callee147$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._store.getRootNode();case 2:e=t.sent;return t.abrupt("return",e&&e.hash());case 4:case"end":return t.stop()}},_callee147,this)}));return function root(){return e.apply(this,arguments)}}()},{key:"isEmpty",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee148(){var e;return _regenerator2["default"].wrap(function _callee148$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._store.getRootNode();case 2:e=t.sent;return t.abrupt("return",!e.hasChildren());case 4:case"end":return t.stop()}},_callee148,this)}));return function isEmpty(){return e.apply(this,arguments)}}()},{key:"tx",get:function get(){return this._store.tx}}]);return AccountsTree}(i);r.register(se);var oe=function(e){(0,_inherits3["default"])(SynchronousAccountsTree,e);function SynchronousAccountsTree(e){(0,_classCallCheck3["default"])(this,SynchronousAccountsTree);var t=(0,_possibleConstructorReturn3["default"])(this,(SynchronousAccountsTree.__proto__||(0,_getPrototypeOf2["default"])(SynchronousAccountsTree)).call(this,e));t._syncStore=e;return t}(0,_createClass3["default"])(SynchronousAccountsTree,[{key:"preloadAddresses",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee149(e){var t,r,n,a,i,s,o,u;return _regenerator2["default"].wrap(function _callee149$(c){for(;;)switch(c.prev=c.next){case 0:c.next=2;return this._syncStore.getRootNode();case 2:t=c.sent;C.that(!!t,"Corrupted store: Failed to fetch AccountsTree root node");r=[];n=!0;a=!1;i=undefined;c.prev=8;for(s=(0,_getIterator3["default"])(e);!(n=(o=s.next()).done);n=!0){u=o.value;r.push(u.toHex())}c.next=16;break;case 12:c.prev=12;c.t0=c["catch"](8);a=!0;i=c.t0;case 16:c.prev=16;c.prev=17;!n&&s["return"]&&s["return"]();case 19:c.prev=19;if(!a){c.next=22;break}throw i;case 22:return c.finish(19);case 23:return c.finish(16);case 24:r.sort();c.next=27;return this._preloadAddresses(t,r);case 27:case"end":return c.stop()}},_callee149,this,[[8,12,16,24],[17,,19,23]])}));return function preloadAddresses(t){return e.apply(this,arguments)}}()},{key:"_preloadAddresses",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee150(e,t){var r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee150$(u){for(;;)switch(u.prev=u.next){case 0:if(!e.hasChildren()){u.next=3;break}u.next=3;return this._syncStore.preload(e.getChildren());case 3:r=0;case 4:if(!(r<t.length)){u.next=30;break}n=t[r];if(B.commonPrefix(e.prefix,n).length===e.prefix.length&&e.prefix!==n){u.next=10;break}r++;return u.abrupt("continue",28);case 10:if(!(a=e.getChild(n))){u.next=27;break}i=this._syncStore.getSync(a);s=[n];o=r+1;case 15:if(!(o<t.length)){u.next=22;break}if(t[o].startsWith(i.prefix)){u.next=18;break}return u.abrupt("break",22);case 18:s.push(t[o]);case 19:++o;u.next=15;break;case 22:r=o;u.next=25;return this._preloadAddresses(i,s);case 25:u.next=28;break;case 27:r++;case 28:u.next=4;break;case 30:case"end":return u.stop()}},_callee150,this)}));return function _preloadAddresses(t,r){return e.apply(this,arguments)}}()},{key:"putSync",value:function putSync(e,t){this.putBatch(e,t);this.finalizeBatch()}},{key:"finalizeBatch",value:function finalizeBatch(){var e=this._syncStore.getRootNodeSync();this._updateHashes(e)}},{key:"putBatch",value:function putBatch(e,t){if(!t.isInitial()||this.getSync(e,!1)){var r=this._syncStore.getRootNodeSync();C.that(!!r,"Corrupted store: Failed to fetch AccountsTree root node");var n=e.toHex();this._insertBatch(r,n,t,[])}}},{key:"_insertBatch",value:function _insertBatch(e,t,r,n){var a=B.commonPrefix(e.prefix,t);if(a.length!==e.prefix.length){var i=ee.terminalNode(t,r);this._syncStore.putSync(i);var s=ee.branchNode(a).withChild(e.prefix,new U(null)).withChild(i.prefix,new U(null));this._syncStore.putSync(s);return this._updateKeysBatch(s.prefix,n)}if(a===t){if(r.isInitial()){this._syncStore.removeSync(e);return this._pruneBatch(e.prefix,n)}e=e.withAccount(r);this._syncStore.putSync(e);return this._updateKeysBatch(e.prefix,n)}var o=e.getChild(t);if(o){var u=this._syncStore.getSync(o);n.push(e);return this._insertBatch(u,t,r,n)}var c=ee.terminalNode(t,r);this._syncStore.putSync(c);e=e.withChild(c.prefix,new U(null));this._syncStore.putSync(e);return this._updateKeysBatch(e.prefix,n)}},{key:"_pruneBatch",value:function _pruneBatch(e,t){for(var r=t.length-1;r>=0;--r){var n=t[r];if((n=n.withoutChild(e)).hasSingleChild()&&""!==n.prefix){this._syncStore.removeSync(n);var a=n.getFirstChild(),i=this._syncStore.getSync(a);this._syncStore.putSync(i);return this._updateKeysBatch(i.prefix,t.slice(0,r))}if(n.hasChildren()||""===n.prefix){this._syncStore.putSync(n);return this._updateKeysBatch(n.prefix,t.slice(0,r))}e=n.prefix}return undefined}},{key:"_updateKeysBatch",value:function _updateKeysBatch(e,t){for(var r=t.length-1;r>=0;--r){var n=t[r];n=n.withChild(e,new U(null));this._syncStore.putSync(n);e=n.prefix}}},{key:"_updateHashes",value:function _updateHashes(e){var t=this;if(e.isTerminal())return e.hash();var r=new U(null),n=e.getChildren().map(function(n){var a=e.getChildHash(n);if(!a.equals(r))return a;var i=t._syncStore.getSync(n);return t._updateHashes(i)}),a=e;e.getChildren().forEach(function(e,t){a=a.withChild(e,n[t])});this._syncStore.putSync(a);return a.hash()}},{key:"getSync",value:function getSync(e){var t=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1],r=this._syncStore.getSync(e.toHex(),t);return r!==undefined?r.account:null}},{key:"rootSync",value:function rootSync(){var e=this._syncStore.getRootNodeSync();return e&&e.hash()}}]);return SynchronousAccountsTree}(se);r.register(oe);var ue=function(e){(0,_inherits3["default"])(PartialAccountsTree,e);function PartialAccountsTree(e){(0,_classCallCheck3["default"])(this,PartialAccountsTree);var t=(0,_possibleConstructorReturn3["default"])(this,(PartialAccountsTree.__proto__||(0,_getPrototypeOf2["default"])(PartialAccountsTree)).call(this,e));t._complete=!1;t._lastPrefix="";return t}(0,_createClass3["default"])(PartialAccountsTree,[{key:"pushChunk",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee151(e){var t;return _regenerator2["default"].wrap(function _callee151$(r){for(;;)switch(r.prev=r.next){case 0:if(e.verify()){r.next=2;break}return r.abrupt("return",PartialAccountsTree.Status.ERR_INCORRECT_PROOF);case 2:(t=this.synchronousTransaction())._putLight(e.terminalNodes);if(t._mergeProof(e.proof,e.tail.prefix)){r.next=8;break}r.next=7;return t.abort();case 7:return r.abrupt("return",PartialAccountsTree.Status.ERR_UNMERGEABLE);case 8:this._complete=t.complete;r.next=11;return t.commit();case 11:this._lastPrefix=e.tail.prefix;return r.abrupt("return",this._complete?PartialAccountsTree.Status.OK_COMPLETE:PartialAccountsTree.Status.OK_UNFINISHED);case 13:case"end":return r.stop()}},_callee151,this)}));return function pushChunk(t){return e.apply(this,arguments)}}()},{key:"_mergeProof",value:function _mergeProof(e,t){for(var r=this._store.getRootNodeSync(),n=r.getChildren(),a=!0,i=e.length-1;i>0;--i){var s=e.nodes[i];if(B.commonPrefix(r.prefix,s.prefix)!==r.prefix)return!1;var o=s.getChildren();if(n.length>o.length)return!1;var u=r.getLastChild(),c=!1,l=0,h=!0,f=!1,_=undefined;try{for(var d,p=(0,_getIterator3["default"])(o);!(h=(d=p.next()).done);h=!0){var g=d.value;if(!(g<=t.substr(0,g.length)))break;var y=n.shift();if(B.commonPrefix(u,g)!==g){if(y!==g)return!1;var v=r.getChildHash(y),k=s.getChildHash(y);if(!v||!k||!v.equals(k))return!1;++l}else g!==u&&(c=!0)}}catch(m){f=!0;_=m}finally{try{!h&&p["return"]&&p["return"]()}finally{if(f)throw _}}if(0!==n.length)return!1;a=a&&l===o.length-1;if(c)n=[u];else{if(r.isTerminal())return!1;n=(r=this._store.getSync(r.getLastChild())).getChildren();if(r.isTerminal())break}}if(!r.equals(e.nodes[0]))return!1;this._complete=a;return!0}},{key:"_putLight",value:function _putLight(e){C.that(e.every(function(e){return e.isTerminal()}),"Can only build tree from terminal nodes");var t=this._store.getRootNodeSync();C.that(!!t,"Corrupted store: Failed to fetch AccountsTree root node");var r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(e);!(r=(i=s.next()).done);r=!0){var o=i.value;this._insertBatch(t,o.prefix,o.account,[]);t=this._store.getRootNodeSync();C.that(!!t,"Corrupted store: Failed to fetch AccountsTree root node")}}catch(u){n=!0;a=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}this._updateHashes(t)}},{key:"synchronousTransaction",value:function synchronousTransaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0],t=new PartialAccountsTree(this._store.synchronousTransaction(e));t._complete=this._complete;t._lastPrefix=this._lastPrefix;return t}},{key:"transaction",value:function transaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];if(!this.complete)throw new Error("Can only construct AccountsTree from complete PartialAccountsTree");return new se(this._store.synchronousTransaction(e))}},{key:"commit",value:function commit(){return this._store.commit()}},{key:"abort",value:function abort(){return this._store.abort()}},{key:"complete",get:function get(){return this._complete}},{key:"missingPrefix",get:function get(){return this._lastPrefix}}]);return PartialAccountsTree}(oe);ue.Status={ERR_HASH_MISMATCH:-3,ERR_INCORRECT_PROOF:-2,ERR_UNMERGEABLE:-1,OK_COMPLETE:0,OK_UNFINISHED:1};r.register(ue);var ce=function(e){(0,_inherits3["default"])(Accounts,e);(0,_createClass3["default"])(Accounts,null,[{key:"getPersistent",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee152(e){var t;return _regenerator2["default"].wrap(function _callee152$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return se.getPersistent(e);case 2:t=r.sent;return r.abrupt("return",new Accounts(t));case 4:case"end":return r.stop()}},_callee152,this)}));return function getPersistent(t){return e.apply(this,arguments)}}()},{key:"createVolatile",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee153(){var e;return _regenerator2["default"].wrap(function _callee153$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return se.createVolatile();case 2:e=t.sent;return t.abrupt("return",new Accounts(e));case 4:case"end":return t.stop()}},_callee153,this)}));return function createVolatile(){return e.apply(this,arguments)}}()}]);function Accounts(e){(0,_classCallCheck3["default"])(this,Accounts);var t=(0,_possibleConstructorReturn3["default"])(this,(Accounts.__proto__||(0,_getPrototypeOf2["default"])(Accounts)).call(this));t._tree=e;t.bubble(t._tree,"*");return t}(0,_createClass3["default"])(Accounts,[{key:"initialize",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee154(e,t){var r,n,a,i,s,o,u;return _regenerator2["default"].wrap(function _callee154$(c){for(;;)switch(c.prev=c.next){case 0:c.t0=C;c.next=3;return this._tree.isEmpty();case 3:c.t1=c.sent;c.t0.that.call(c.t0,c.t1);c.next=7;return this._tree.synchronousTransaction();case 7:r=c.sent;c.prev=8;n=w.fromBase64(t);a=n.readUint16();for(i=0;i<a;i++){s=q.unserialize(n);o=$.unserialize(n);r.putSync(s,o)}c.next=14;return this._commitBlockBody(r,e.body,e.height,new me);case 14:r.finalizeBatch();c.next=22;break;case 17:c.prev=17;c.t2=c["catch"](8);c.next=21;return r.abort();case 21:throw c.t2;case 22:u=r.rootSync();if(e.accountsHash.equals(u)){c.next=27;break}c.next=26;return r.abort();case 26:throw new Error("Genesis AccountsHash mismatch");case 27:return c.abrupt("return",r.commit());case 28:case"end":return c.stop()}},_callee154,this,[[8,17]])}));return function initialize(t,r){return e.apply(this,arguments)}}()},{key:"getAccountsProof",value:function getAccountsProof(e){return this._tree.getAccountsProof(e)}},{key:"getAccountsTreeChunk",value:function getAccountsTreeChunk(e){return this._tree.getChunk(e,ie.SIZE_MAX)}},{key:"commitBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee155(e,t){var r,n;return _regenerator2["default"].wrap(function _callee155$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return this._tree.synchronousTransaction();case 2:r=a.sent;a.next=5;return r.preloadAddresses(e.body.getAddresses());case 5:a.prev=5;this._commitBlockBody(r,e.body,e.height,t);a.next=14;break;case 9:a.prev=9;a.t0=a["catch"](5);a.next=13;return r.abort();case 13:throw a.t0;case 14:r.finalizeBatch();n=r.rootSync();if(e.accountsHash.equals(n)){a.next=20;break}a.next=19;return r.abort();case 19:throw new Error("AccountsHash mismatch");case 20:return a.abrupt("return",r.commit());case 21:case"end":return a.stop()}},_callee155,this,[[5,9]])}));return function commitBlock(t,r){return e.apply(this,arguments)}}()},{key:"commitBlockBody",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee156(e,t,r){var n;return _regenerator2["default"].wrap(function _callee156$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return this._tree.synchronousTransaction();case 2:n=a.sent;a.next=5;return n.preloadAddresses(e.getAddresses());case 5:a.prev=5;this._commitBlockBody(n,e,t,r);a.next=14;break;case 9:a.prev=9;a.t0=a["catch"](5);a.next=13;return n.abort();case 13:throw a.t0;case 14:n.finalizeBatch();return a.abrupt("return",n.commit());case 16:case"end":return a.stop()}},_callee156,this,[[5,9]])}));return function commitBlockBody(t,r,n){return e.apply(this,arguments)}}()},{key:"gatherToBePrunedAccounts",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee157(e,t,r){var n,a,i,s,o,u,c,l,h,f,_,d,p,g,y,v;return _regenerator2["default"].wrap(function _callee157$(k){for(;;)switch(k.prev=k.next){case 0:k.next=2;return this._tree.synchronousTransaction();case 2:n=k.sent;a=[];i=!0;s=!1;o=undefined;k.prev=7;for(u=(0,_getIterator3["default"])(e);!(i=(c=u.next()).done);i=!0){l=c.value;a.push(l.sender,l.recipient)}k.next=15;break;case 11:k.prev=11;k.t0=k["catch"](7);s=!0;o=k.t0;case 15:k.prev=15;k.prev=16;!i&&u["return"]&&u["return"]();case 18:k.prev=18;if(!s){k.next=21;break}throw o;case 21:return k.finish(18);case 22:return k.finish(15);case 23:k.next=25;return n.preloadAddresses(a);case 25:k.prev=25;this._processSenderAccounts(n,e,t,r);this._processRecipientAccounts(n,e,t);this._processContracts(n,e,t);h=[];f=!0;_=!1;d=undefined;k.prev=33;for(p=(0,_getIterator3["default"])(e);!(f=(g=p.next()).done);f=!0){y=g.value;(v=this._getSync(y.sender,undefined,n)).isToBePruned()&&h.push(new X(y.sender,v))}k.next=41;break;case 37:k.prev=37;k.t1=k["catch"](33);_=!0;d=k.t1;case 41:k.prev=41;k.prev=42;!f&&p["return"]&&p["return"]();case 44:k.prev=44;if(!_){k.next=47;break}throw d;case 47:return k.finish(44);case 48:return k.finish(41);case 49:return k.abrupt("return",h.sort(function(e,t){return e.compare(t)}));case 50:k.prev=50;k.next=53;return n.abort();case 53:return k.finish(50);case 54:case"end":return k.stop()}},_callee157,this,[[7,11,15,23],[16,,18,22],[25,,50,54],[33,37,41,49],[42,,44,48]])}));return function gatherToBePrunedAccounts(t,r,n){return e.apply(this,arguments)}}()},{key:"revertBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee158(e,t){var r;return _regenerator2["default"].wrap(function _callee158$(n){for(;;)switch(n.prev=n.next){case 0:if(e){n.next=2;break}throw new Error("block undefined");case 2:n.next=4;return this._tree.root();case 4:r=n.sent;if(e.accountsHash.equals(r)){n.next=7;break}throw new Error("AccountsHash mismatch");case 7:return n.abrupt("return",this.revertBlockBody(e.body,e.height,t));case 8:case"end":return n.stop()}},_callee158,this)}));return function revertBlock(t,r){return e.apply(this,arguments)}}()},{key:"revertBlockBody",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee159(e,t,r){var n;return _regenerator2["default"].wrap(function _callee159$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return this._tree.synchronousTransaction();case 2:n=a.sent;a.next=5;return n.preloadAddresses(e.getAddresses());case 5:a.prev=5;this._revertBlockBody(n,e,t,r);a.next=14;break;case 9:a.prev=9;a.t0=a["catch"](5);a.next=13;return n.abort();case 13:throw a.t0;case 14:n.finalizeBatch();return a.abrupt("return",n.commit());case 16:case"end":return a.stop()}},_callee159,this,[[5,9]])}));return function revertBlockBody(t,r,n){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee160(e,t){var r,n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:this._tree;return _regenerator2["default"].wrap(function _callee160$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return n.get(e);case 2:if(r=a.sent){a.next=9;break}if("undefined"!=typeof t){a.next=6;break}return a.abrupt("return",$.INITIAL);case 6:throw new Error("Account type was given but account not present");case 9:if("undefined"==typeof t||r.type===t){a.next=11;break}throw new Error("Account type does match actual account");case 11:return a.abrupt("return",r);case 12:case"end":return a.stop()}},_callee160,this)}));return function get(t,r){return e.apply(this,arguments)}}()},{key:"_getSync",value:function _getSync(e,t,r){var n=r.getSync(e,!1);if(!n){if("undefined"==typeof t)return $.INITIAL;throw new Error("Account type was given but account not present")}if("undefined"!=typeof t&&n.type!==t)throw new Error("Account type does match actual account");return n}},{key:"transaction",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee161(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];return _regenerator2["default"].wrap(function _callee161$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=Accounts;t.next=3;return this._tree.transaction(e);case 3:t.t1=t.sent;return t.abrupt("return",new t.t0(t.t1));case 5:case"end":return t.stop()}},_callee161,this)}));return function transaction(){return e.apply(this,arguments)}}()},{key:"snapshot",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee162(e){return _regenerator2["default"].wrap(function _callee162$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=Accounts;t.next=3;return this._tree.snapshot(e?e._tree:undefined);case 3:t.t1=t.sent;return t.abrupt("return",new t.t0(t.t1));case 5:case"end":return t.stop()}},_callee162,this)}));return function snapshot(t){return e.apply(this,arguments)}}()},{key:"partialAccountsTree",value:function partialAccountsTree(){return this._tree.partialTree()}},{key:"commit",value:function commit(){return this._tree.commit()}},{key:"abort",value:function abort(){return this._tree.abort()}},{key:"_processSenderAccounts",value:function _processSenderAccounts(e,t,r,n){var a=arguments.length>4&&arguments[4]!==undefined&&arguments[4],i=!0,s=!1,o=undefined;try{for(var u,c=(0,_getIterator3["default"])(t);!(i=(u=c.next()).done);i=!0){var l=u.value,h=this._getSync(l.sender,a?undefined:l.senderType,e);e.putBatch(l.sender,h.withOutgoingTransaction(l,r,n,a))}}catch(f){s=!0;o=f}finally{try{!i&&c["return"]&&c["return"]()}finally{if(s)throw o}}}},{key:"_processRecipientAccounts",value:function _processRecipientAccounts(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined&&arguments[3],a=!0,i=!1,s=undefined;try{for(var o,u=(0,_getIterator3["default"])(t);!(a=(o=u.next()).done);a=!0){var c=o.value,l=this._getSync(c.recipient,undefined,e);e.putBatch(c.recipient,l.withIncomingTransaction(c,r,n))}}catch(h){i=!0;s=h}finally{try{!a&&u["return"]&&u["return"]()}finally{if(i)throw s}}}},{key:"_processContracts",value:function _processContracts(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined&&arguments[3];n&&(t=t.slice().reverse());var a=!0,i=!1,s=undefined;try{for(var o,u=(0,_getIterator3["default"])(t);!(a=(o=u.next()).done);a=!0){var c=o.value,l=this._getSync(c.recipient,n?c.recipientType:undefined,e);e.putBatch(c.recipient,l.withContractCommand(c,r,n))}}catch(h){i=!0;s=h}finally{try{!a&&u["return"]&&u["return"]()}finally{if(i)throw s}}}},{key:"_commitBlockBody",value:function _commitBlockBody(e,t,r,n){var a=this;this._processSenderAccounts(e,t.transactions,r,n);this._processRecipientAccounts(e,t.transactions,r);this._processContracts(e,t.transactions,r);var i=t.prunedAccounts.slice(),s=!0,o=!1,u=undefined;try{for(var c,l=function _loop5(){var t=c.value,r=a._getSync(t.sender,undefined,e);if(r.isToBePruned()){var n=i.findIndex(function(e){return e.address.equals(t.sender)});if(-1===n||!r.equals(i[n].account))throw new Error("Account was not pruned correctly");e.putBatch(t.sender,$.INITIAL);i.splice(n,1)}},h=(0,_getIterator3["default"])(t.transactions);!(s=(c=h.next()).done);s=!0)l()}catch(f){o=!0;u=f}finally{try{!s&&h["return"]&&h["return"]()}finally{if(o)throw u}}if(i.length>0)throw new Error("Account was invalidly pruned");this._rewardMiner(e,t,r,!1)}},{key:"_revertBlockBody",value:function _revertBlockBody(e,t,r,n){this._rewardMiner(e,t,r,!0);var a=!0,i=!1,s=undefined;try{for(var o,u=(0,_getIterator3["default"])(t.prunedAccounts);!(a=(o=u.next()).done);a=!0){var c=o.value;e.putBatch(c.address,c.account)}}catch(l){i=!0;s=l}finally{try{!a&&u["return"]&&u["return"]()}finally{if(i)throw s}}this._processContracts(e,t.transactions,r,!0);this._processRecipientAccounts(e,t.transactions,r,!0);this._processSenderAccounts(e,t.transactions,r,n,!0)}},{key:"_rewardMiner",value:function _rewardMiner(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined&&arguments[3],a=t.transactions.reduce(function(e,t){return e+t.fee},0),i=new ve(q.NULL,$.Type.BASIC,t.minerAddr,$.Type.BASIC,a+z.blockRewardAt(r),0,0,pe.Flag.NONE,new Uint8Array(0)),s=this._getSync(t.minerAddr,undefined,e);e.putBatch(t.minerAddr,s.withIncomingTransaction(i,r,n))}},{key:"hash",value:function hash(){return this._tree.root()}},{key:"tx",get:function get(){return this._tree.tx}}]);return Accounts}(i);r.register(ce);var le=function(){(0,_createClass3["default"])(BlockHeader,null,[{key:"copy",value:function copy(e){return e?new BlockHeader(U.copy(e._prevHash),U.copy(e._interlinkHash),U.copy(e._bodyHash),U.copy(e._accountsHash),e._nBits,e._height,e._timestamp,e._nonce,e._version):e}}]);function BlockHeader(e,t,r,n,a,i,s,o){var u=arguments.length>8&&arguments[8]!==undefined?arguments[8]:BlockHeader.CURRENT_VERSION;(0,_classCallCheck3["default"])(this,BlockHeader);if(!I.isUint16(u))throw"Malformed version";if(!U.isHash(e))throw"Malformed prevHash";if(!U.isHash(t))throw"Malformed interlinkHash";if(!U.isHash(r))throw"Malformed bodyHash";if(!U.isHash(n))throw"Malformed accountsHash";if(!I.isUint32(a)||!_e.isValidCompact(a))throw"Malformed nBits";if(!I.isUint32(i))throw"Invalid height";if(!I.isUint32(s))throw"Malformed timestamp";if(!I.isUint32(o))throw"Malformed nonce";this._version=u;this._prevHash=e;this._interlinkHash=t;this._bodyHash=r;this._accountsHash=n;this._nBits=a;this._height=i;this._timestamp=s;this._nonce=o}(0,_createClass3["default"])(BlockHeader,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint16(this._version);this._prevHash.serialize(e);this._interlinkHash.serialize(e);this._bodyHash.serialize(e);this._accountsHash.serialize(e);e.writeUint32(this._nBits);e.writeUint32(this._height);e.writeUint32(this._timestamp);e.writeUint32(this._nonce);return e}},{key:"verifyProofOfWork",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee163(e){var t;return _regenerator2["default"].wrap(function _callee163$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.pow(e);case 2:t=r.sent;return r.abrupt("return",_e.isProofOfWork(t,this.target));case 4:case"end":return r.stop()}},_callee163,this)}));return function verifyProofOfWork(t){return e.apply(this,arguments)}}()},{key:"isImmediateSuccessorOf",value:function isImmediateSuccessorOf(e){if(this.height!==e.height+1)return!1;if(this.timestamp<e.timestamp)return!1;var t=e.hash();return!!this.prevHash.equals(t)}},{key:"hash",value:function hash(e){this._hash=this._hash||U.light(this.serialize(e));return this._hash}},{key:"hashAsync",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee164(e){return _regenerator2["default"].wrap(function _callee164$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=this._hash;if(t.t0){t.next=5;break}t.next=4;return U.lightAsync(this.serialize(e));case 4:t.t0=t.sent;case 5:this._hash=t.t0;return t.abrupt("return",this._hash);case 7:case"end":return t.stop()}},_callee164,this)}));return function hashAsync(t){return e.apply(this,arguments)}}()},{key:"pow",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee165(e){return _regenerator2["default"].wrap(function _callee165$(t){for(;;)switch(t.prev=t.next){case 0:t.t0=this._pow;if(t.t0){t.next=5;break}t.next=4;return U.hard(this.serialize(e));case 4:t.t0=t.sent;case 5:this._pow=t.t0;return t.abrupt("return",this._pow);case 7:case"end":return t.stop()}},_callee165,this)}));return function pow(t){return e.apply(this,arguments)}}()},{key:"equals",value:function equals(e){return e instanceof BlockHeader&&this._prevHash.equals(e.prevHash)&&this._interlinkHash.equals(e.interlinkHash)&&this._bodyHash.equals(e.bodyHash)&&this._accountsHash.equals(e.accountsHash)&&this._nBits===e.nBits&&this._height===e.height&&this._timestamp===e.timestamp&&this._nonce===e.nonce}},{key:"toString",value:function toString(){return"BlockHeader{prevHash="+this._prevHash+", interlinkHash="+this._interlinkHash+", bodyHash="+this._bodyHash+", accountsHash="+this._accountsHash+", nBits="+this._nBits.toString(16)+", height="+this._height+", timestamp="+this._timestamp+", nonce="+this._nonce+"}"}},{key:"serializedSize",get:function get(){return 2+this._prevHash.serializedSize+this._interlinkHash.serializedSize+this._bodyHash.serializedSize+this._accountsHash.serializedSize+4+4+4+4}},{key:"version",get:function get(){return this._version}},{key:"prevHash",get:function get(){return this._prevHash}},{key:"interlinkHash",get:function get(){return this._interlinkHash}},{key:"bodyHash",get:function get(){return this._bodyHash}},{key:"accountsHash",get:function get(){return this._accountsHash}},{key:"nBits",get:function get(){return this._nBits}},{key:"target",get:function get(){return _e.compactToTarget(this._nBits)}},{key:"difficulty",get:function get(){return _e.compactToDifficulty(this._nBits)}},{key:"height",get:function get(){return this._height}},{key:"timestamp",get:function get(){return this._timestamp}},{key:"nonce",get:function get(){return this._nonce},set:function set(e){this._nonce=e;this._hash=null;this._pow=null}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint16();if(!BlockHeader.SUPPORTED_VERSIONS.includes(t))throw new Error("Unsupported block version "+t);return new BlockHeader(U.unserialize(e),U.unserialize(e),U.unserialize(e),U.unserialize(e),e.readUint32(),e.readUint32(),e.readUint32(),e.readUint32(),t)}}]);return BlockHeader}();le.Version={V1:1};le.CURRENT_VERSION=le.Version.V1;le.SUPPORTED_VERSIONS=[le.Version.V1];le.SERIALIZED_SIZE=146;r.register(le);var he=function(){(0,_createClass3["default"])(BlockInterlink,null,[{key:"copy",value:function copy(e){if(!e)return e;var t=e._hashes.map(function(e){return U.copy(e)}),r=new Uint8Array(e._repeatBits),n=e._compressed.map(function(e){return U.copy(e)});return new BlockInterlink(t,undefined,r,n)}},{key:"_compress",value:function _compress(e,t){for(var r=e.length,n=Math.ceil(r/8),a=new Uint8Array(n),i=t,s=[],o=0;o<r;o++){var u=e[o];if(u.equals(i))a[Math.floor(o/8)]|=128>>>o%8;else{s.push(u);i=u}}return{repeatBits:a,compressed:s}}}]);function BlockInterlink(e,t,r,n){(0,_classCallCheck3["default"])(this,BlockInterlink);if(!Array.isArray(e)||!I.isUint8(e.length)||e.some(function(e){return!(e instanceof U)}))throw new Error("Malformed hashes");if((r||n)&&(!r||!n))throw new Error("Malformed repeatBits/compressed");if(!t&&!r)throw new Error("Either prevHash or repeatBits/compressed required");if(!r){var a=BlockInterlink._compress(e,t);r=a.repeatBits;n=a.compressed}this._hashes=e;this._repeatBits=r;this._compressed=n}(0,_createClass3["default"])(BlockInterlink,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint8(this._hashes.length);e.write(this._repeatBits);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._compressed);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"equals",value:function equals(e){return e instanceof BlockInterlink&&this._hashes.length===e._hashes.length&&this._hashes.every(function(t,r){return t.equals(e.hashes[r])})}},{key:"hash",value:function hash(){this._hash||(this._hash=P.computeRoot([this._repeatBits,Se.GENESIS.HASH].concat((0,_toConsumableArray3["default"])(this._compressed))));return this._hash}},{key:"serializedSize",get:function get(){return 1+this._repeatBits.length+this._compressed.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"hashes",get:function get(){return this._hashes}},{key:"length",get:function get(){return this._hashes.length}}],[{key:"unserialize",value:function unserialize(e,t){for(var r=e.readUint8(),n=Math.ceil(r/8),a=e.read(n),i=t,s=[],o=[],u=0;u<r;u++){if(!(0!=(a[Math.floor(u/8)]&128>>>u%8))){i=U.unserialize(e);o.push(i)}s.push(i)}return new BlockInterlink(s,t,a,o)}}]);return BlockInterlink}();r.register(he);var fe=function(){(0,_createClass3["default"])(BlockBody,null,[{key:"getMetadataSize",value:function getMetadataSize(e){return q.SERIALIZED_SIZE+1+e.byteLength+2}}]);function BlockBody(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:new Uint8Array(0),n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];(0,_classCallCheck3["default"])(this,BlockBody);if(!(e instanceof q))throw"Malformed minerAddr";if(!Array.isArray(t)||t.some(function(e){return!(e instanceof pe)}))throw"Malformed transactions";if(!(r instanceof Uint8Array&&I.isUint8(r.byteLength)))throw"Malformed extraData";this._minerAddr=e;this._extraData=r;this._transactions=t;this._prunedAccounts=n;this._hash=null}(0,_createClass3["default"])(BlockBody,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this._minerAddr.serialize(e);e.writeUint8(this._extraData.byteLength);e.write(this._extraData);e.writeUint16(this._transactions.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._transactions);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(h){r=!0;n=h}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}e.writeUint16(this._prunedAccounts.length);var s=!0,o=!1,u=undefined;try{for(var c,l=(0,_getIterator3["default"])(this._prunedAccounts);!(s=(c=l.next()).done);s=!0){c.value.serialize(e)}}catch(h){o=!0;u=h}finally{try{!s&&l["return"]&&l["return"]()}finally{if(o)throw u}}return e}},{key:"verify",value:function verify(){var e=null,t=!0,r=!1,n=undefined;try{for(var i,s=(0,_getIterator3["default"])(this._transactions);!(t=(i=s.next()).done);t=!0){var o=i.value;if(e&&e.compareBlockOrder(o)>=0){a.w(BlockBody,"Invalid block - transactions not ordered.");return!1}e=o;if(!o.verify()){a.w(BlockBody,"Invalid block - invalid transaction");return!1}}}catch(p){r=!0;n=p}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}var u=null,c=!0,l=!1,h=undefined;try{for(var f,_=(0,_getIterator3["default"])(this._prunedAccounts);!(c=(f=_.next()).done);c=!0){var d=f.value;if(u&&u.compare(d)>=0){a.w(BlockBody,"Invalid block - pruned accounts not ordered.");return!1}u=d;if(!d.account.isToBePruned()){a.w(BlockBody,"Invalid block - invalid pruned account");return!1}}}catch(p){l=!0;h=p}finally{try{!c&&_["return"]&&_["return"]()}finally{if(l)throw h}}return!0}},{key:"getMerkleLeafs",value:function getMerkleLeafs(){return[this._minerAddr,this._extraData].concat((0,_toConsumableArray3["default"])(this._transactions),(0,_toConsumableArray3["default"])(this.prunedAccounts))}},{key:"hash",value:function hash(){this._hash||(this._hash=P.computeRoot(this.getMerkleLeafs()));return this._hash}},{key:"equals",value:function equals(e){return e instanceof BlockBody&&this._minerAddr.equals(e.minerAddr)&&w.equals(this._extraData,e.extraData)&&this._transactions.length===e.transactions.length&&this._transactions.every(function(t,r){return t.equals(e.transactions[r])})}},{key:"getAddresses",value:function getAddresses(){var e=[this._minerAddr],t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._transactions);!(t=(a=i.next()).done);t=!0){var s=a.value;e.push(s.sender,s.recipient)}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"serializedSize",get:function get(){var e=this._minerAddr.serializedSize+1+this._extraData.byteLength+2+2,t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._transactions);!(t=(a=i.next()).done);t=!0){e+=a.value.serializedSize}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e+=this._prunedAccounts.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"extraData",get:function get(){return this._extraData}},{key:"minerAddr",get:function get(){return this._minerAddr}},{key:"transactions",get:function get(){return this._transactions}},{key:"transactionCount",get:function get(){return this._transactions.length}},{key:"prunedAccounts",get:function get(){return this._prunedAccounts}}],[{key:"unserialize",value:function unserialize(e){for(var t=q.unserialize(e),r=e.readUint8(),n=e.read(r),a=e.readUint16(),i=new Array(a),s=0;s<a;s++)i[s]=pe.unserialize(e);for(var o=e.readUint16(),u=[],c=0;c<o;c++)u.push(X.unserialize(e));return new BlockBody(t,i,n,u)}}]);return BlockBody}();r.register(fe);var _e=function(){function BlockUtils(){(0,_classCallCheck3["default"])(this,BlockUtils)}(0,_createClass3["default"])(BlockUtils,null,[{key:"compactToTarget",value:function compactToTarget(e){return(16777215&e)*Math.pow(2,8*((e>>24)-3))}},{key:"targetToCompact",value:function targetToCompact(e){if(!(0,_isFinite2["default"])(e)||(0,_isNan2["default"])(e))throw"Invalid Target";var t=Math.max(Math.ceil((0,_log2["default"])(e)/8),1);e/Math.pow(2,8*(t-1))>=128&&t++;return(t<<24)+(e/Math.pow(2,8*(t-3))&16777215)}},{key:"getTargetHeight",value:function getTargetHeight(e){return Math.ceil((0,_log2["default"])(e))}},{key:"getTargetDepth",value:function getTargetDepth(e){return BlockUtils.getTargetHeight(z.BLOCK_TARGET_MAX)-BlockUtils.getTargetHeight(e)}},{key:"compactToDifficulty",value:function compactToDifficulty(e){return z.BLOCK_TARGET_MAX/BlockUtils.compactToTarget(e)}},{key:"difficultyToCompact",value:function difficultyToCompact(e){return BlockUtils.targetToCompact(BlockUtils.difficultyToTarget(e))}},{key:"difficultyToTarget",value:function difficultyToTarget(e){return z.BLOCK_TARGET_MAX/e}},{key:"targetToDifficulty",value:function targetToDifficulty(e){return z.BLOCK_TARGET_MAX/e}},{key:"hashToTarget",value:function hashToTarget(e){return parseInt(e.toHex(),16)}},{key:"realDifficulty",value:function realDifficulty(e){return BlockUtils.targetToDifficulty(BlockUtils.hashToTarget(e))}},{key:"isProofOfWork",value:function isProofOfWork(e,t){return parseInt(e.toHex(),16)<=t}},{key:"isValidCompact",value:function isValidCompact(e){return BlockUtils.isValidTarget(BlockUtils.compactToTarget(e))}},{key:"isValidTarget",value:function isValidTarget(e){return e>=1&&e<=z.BLOCK_TARGET_MAX}},{key:"getNextTarget",value:function getNextTarget(e,t,r){C.that(e.height-t.height===z.DIFFICULTY_BLOCK_WINDOW||e.height<=z.DIFFICULTY_BLOCK_WINDOW&&1===t.height,"Tail and head block must be "+z.DIFFICULTY_BLOCK_WINDOW+" blocks apart");var n=e.timestamp-t.timestamp;if(e.height<=z.DIFFICULTY_BLOCK_WINDOW){n+=(z.DIFFICULTY_BLOCK_WINDOW-e.height+1)*z.BLOCK_TIME;r+=z.DIFFICULTY_BLOCK_WINDOW-e.height+1}var a=n/(z.DIFFICULTY_BLOCK_WINDOW*z.BLOCK_TIME);a=Math.max(a,1/z.DIFFICULTY_MAX_ADJUSTMENT_FACTOR);a=Math.min(a,z.DIFFICULTY_MAX_ADJUSTMENT_FACTOR);var i=r/z.DIFFICULTY_BLOCK_WINDOW,s=BlockUtils.difficultyToTarget(i)*a;s=Math.min(s,z.BLOCK_TARGET_MAX);s=Math.max(s,1);var o=BlockUtils.targetToCompact(s);return BlockUtils.compactToTarget(o)}}]);return BlockUtils}();r.register(_e);var de=function(){(0,_createClass3["default"])(Subscription,null,[{key:"fromAddresses",value:function fromAddresses(e){return new Subscription(Subscription.Type.ADDRESSES,e)}},{key:"fromMinFeePerByte",value:function fromMinFeePerByte(e){return new Subscription(Subscription.Type.MIN_FEE,e)}}]);function Subscription(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;(0,_classCallCheck3["default"])(this,Subscription);if(!I.isUint8(e))throw new Error("Invalid type");if(e===Subscription.Type.ADDRESSES&&(!Array.isArray(t)||!I.isUint16(t.length)||t.some(function(e){return!(e instanceof q)})))throw new Error("Invalid addresses");if(e===Subscription.Type.MIN_FEE&&!I.isUint64(t))throw new Error("Invalid minFeePerByte");this._type=e;this._addresses=new v;this._minFeePerByte=0;switch(e){case Subscription.Type.ADDRESSES:this._addresses.addAll(t);break;case Subscription.Type.MIN_FEE:this._minFeePerByte=t}}(0,_createClass3["default"])(Subscription,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint8(this._type);switch(this._type){case Subscription.Type.ADDRESSES:e.writeUint16(this._addresses.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._addresses);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}break;case Subscription.Type.MIN_FEE:e.writeUint64(this._minFeePerByte)}return e}},{key:"matchesBlock",value:function matchesBlock(e){switch(this._type){case Subscription.Type.NONE:return!1;case Subscription.Type.ANY:case Subscription.Type.ADDRESSES:case Subscription.Type.MIN_FEE:return!0;default:throw new Error("Unknown type")}}},{key:"matchesTransaction",value:function matchesTransaction(e){switch(this._type){case Subscription.Type.NONE:return!1;case Subscription.Type.ANY:return!0;case Subscription.Type.ADDRESSES:return this._addresses.contains(e.recipient)||this._addresses.contains(e.sender);case Subscription.Type.MIN_FEE:return e.fee/e.serializedSize>=this._minFeePerByte;default:throw new Error("Unknown type")}}},{key:"toString",value:function toString(){return"Subscription{type="+this._type+", addresses=["+this._addresses.values()+"], minFeePerByte="+this._minFeePerByte+"}"}},{key:"serializedSize",get:function get(){var e=0;switch(this._type){case Subscription.Type.ADDRESSES:e=2;var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._addresses);!(t=(a=i.next()).done);t=!0){e+=a.value.serializedSize}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}break;case Subscription.Type.MIN_FEE:e=8}return 1+e}},{key:"type",get:function get(){return this._type}},{key:"addresses",get:function get(){return this._addresses.values()}},{key:"minFeePerByte",get:function get(){return this._minFeePerByte}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint8(),r=null;switch(t){case Subscription.Type.ADDRESSES:r=[];for(var n=e.readUint16(),a=0;a<n;++a)r.push(q.unserialize(e));break;case Subscription.Type.MIN_FEE:r=e.readUint64()}return new Subscription(t,r)}}]);return Subscription}();de.Type={NONE:0,ANY:1,ADDRESSES:2,MIN_FEE:3};de.NONE=new de(de.Type.NONE);de.BLOCKS_ONLY=new de(de.Type.ADDRESSES,[]);de.ANY=new de(de.Type.ANY);r.register(de);var pe=function(){function Transaction(e,t,r,n,a,i,s,o,u,c,l){(0,_classCallCheck3["default"])(this,Transaction);if(!(t instanceof q))throw new Error("Malformed sender");if(!I.isUint8(r))throw new Error("Malformed sender type");if(!(n instanceof q))throw new Error("Malformed recipient");if(!I.isUint8(a))throw new Error("Malformed recipient type");if(!I.isUint64(i)||0===i)throw new Error("Malformed value");if(!I.isUint64(s))throw new Error("Malformed fee");if(!I.isUint32(o))throw new Error("Malformed validityStartHeight");if(!I.isUint8(u)&&(u&~Transaction.Flag.ALL)>0)throw new Error("Malformed flags");if(!(c instanceof Uint8Array&&I.isUint16(c.byteLength)))throw new Error("Malformed data");if(l&&(!(l instanceof Uint8Array)||!I.isUint16(l.byteLength)))throw new Error("Malformed proof");this._format=e;this._sender=t;this._senderType=r;this._recipient=n;this._recipientType=a;this._value=i;this._fee=s;this._validityStartHeight=o;this._flags=u;this._data=c;this._proof=l;this._recipient===q.CONTRACT_CREATION&&(this._recipient=this.getContractCreationAddress())}(0,_createClass3["default"])(Transaction,[{key:"serializeContent",value:function serializeContent(e){(e=e||new T(this.serializedContentSize)).writeUint16(this._data.byteLength);e.write(this._data);this._sender.serialize(e);e.writeUint8(this._senderType);this._recipient.serialize(e);e.writeUint8(this._recipientType);e.writeUint64(this._value);e.writeUint64(this._fee);e.writeUint32(this._validityStartHeight);e.writeUint8(this._flags);return e}},{key:"verify",value:function verify(){this._valid===undefined&&(this._valid=this._verify());return this._valid}},{key:"_verify",value:function _verify(){if(this._recipient.equals(this._sender)){a.w(Transaction,"Sender and recipient must not match",this);return!1}if(!$.TYPE_MAP.has(this._senderType)||!$.TYPE_MAP.has(this._recipientType)){a.w(Transaction,"Invalid account type",this);return!1}if(!$.TYPE_MAP.get(this._senderType).verifyOutgoingTransaction(this)){a.w(Transaction,"Invalid for sender",this);return!1}if(!$.TYPE_MAP.get(this._recipientType).verifyIncomingTransaction(this)){a.w(Transaction,"Invalid for recipient",this);return!1}return!0}},{key:"serialize",value:function serialize(e){throw new Error("Method needs to be overwritten by subclasses")}},{key:"hash",value:function hash(){this._hash=this._hash||U.light(this.serializeContent());return this._hash}},{key:"hashAsync",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee166(){return _regenerator2["default"].wrap(function _callee166$(e){for(;;)switch(e.prev=e.next){case 0:e.t0=this._hash;if(e.t0){e.next=5;break}e.next=4;return U.lightAsync(this.serializeContent());case 4:e.t0=e.sent;case 5:this._hash=e.t0;return e.abrupt("return",this._hash);case 7:case"end":return e.stop()}},_callee166,this)}));return function hashAsync(){return e.apply(this,arguments)}}()},{key:"compare",value:function compare(e){return this.fee/this.serializedSize>e.fee/e.serializedSize?-1:this.fee/this.serializedSize<e.fee/e.serializedSize?1:this.serializedSize>e.serializedSize?-1:this.serializedSize<e.serializedSize?1:this.fee>e.fee?-1:this.fee<e.fee?1:this.value>e.value?-1:this.value<e.value?1:this.compareBlockOrder(e)}},{key:"compareBlockOrder",value:function compareBlockOrder(e){var t=this._recipient.compare(e._recipient);if(0!==t)return t;if(this._validityStartHeight<e._validityStartHeight)return-1;if(this._validityStartHeight>e._validityStartHeight)return 1;if(this._fee>e._fee)return-1;if(this._fee<e._fee)return 1;if(this._value>e._value)return-1;if(this._value<e._value)return 1;var r=this._sender.compare(e._sender);return 0!==r?r:this._recipientType<e._recipientType?-1:this._recipientType>e._recipientType?1:this._senderType<e._senderType?-1:this._senderType>e._senderType?1:this._flags<e._flags?-1:this._flags>e._flags?1:w.compare(this._data,e._data)}},{key:"equals",value:function equals(e){return e instanceof Transaction&&this._sender.equals(e._sender)&&this._senderType===e._senderType&&this._recipient.equals(e._recipient)&&this._recipientType===e._recipientType&&this._value===e._value&&this._fee===e._fee&&this._validityStartHeight===e._validityStartHeight&&this._flags===e._flags&&w.equals(this._data,e._data)}},{key:"toString",value:function toString(){return"Transaction{sender="+this._sender.toBase64()+", recipient="+this._recipient.toBase64()+", value="+this._value+", fee="+this._fee+", validityStartHeight="+this._validityStartHeight+"}"}},{key:"getContractCreationAddress",value:function getContractCreationAddress(){var e=Transaction.unserialize(this.serialize());e._recipient=q.NULL;e._hash=null;return q.fromHash(e.hash())}},{key:"hasFlag",value:function hasFlag(e){return(this._flags&e)>0}},{key:"serializedContentSize",get:function get(){return 2+this._data.byteLength+this._sender.serializedSize+1+this._recipient.serializedSize+1+8+8+4+1}},{key:"serializedSize",get:function get(){throw new Error("Getter needs to be overwritten by subclasses")}},{key:"sender",get:function get(){return this._sender}},{key:"senderType",get:function get(){return this._senderType}},{key:"recipient",get:function get(){return this._recipient}},{key:"recipientType",get:function get(){return this._recipientType}},{key:"value",get:function get(){return this._value}},{key:"fee",get:function get(){return this._fee}},{key:"feePerByte",get:function get(){return this._fee/this.serializedSize}},{key:"validityStartHeight",get:function get(){return this._validityStartHeight}},{key:"flags",get:function get(){return this._flags}},{key:"data",get:function get(){return this._data}},{key:"proof",get:function get(){return this._proof},set:function set(e){this._proof=e}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint8();e.readPos--;if(!Transaction.FORMAT_MAP.has(t))throw new Error("Invalid transaction type");return Transaction.FORMAT_MAP.get(t).unserialize(e)}}]);return Transaction}();pe.Format={BASIC:0,EXTENDED:1};pe.Flag={NONE:0,CONTRACT_CREATION:1,ALL:1};pe.FORMAT_MAP=new _map2["default"];r.register(pe);var ge=function(){(0,_createClass3["default"])(SignatureProof,null,[{key:"verifyTransaction",value:function verifyTransaction(e){try{var t=new T(e.proof),r=SignatureProof.unserialize(t);if(t.readPos!==t.byteLength){a.w(SignatureProof,"Invalid SignatureProof - overlong");return!1}return r.verify(e.sender,e.serializeContent())}catch(n){a.w(SignatureProof,"Failed to verify transaction: "+(n.message||n),n);return!1}}},{key:"singleSig",value:function singleSig(e,t){return new SignatureProof(e,new N([]),t)}},{key:"multiSig",value:function multiSig(e,t,r){return new SignatureProof(e,N.compute(t,e),r)}}]);function SignatureProof(e,t,r){(0,_classCallCheck3["default"])(this,SignatureProof);if(!(e instanceof H))throw new Error("Malformed publickKey");if(!(t instanceof N))throw new Error("Malformed merklePath");if(r&&!(r instanceof W))throw new Error("Malformed signature");this._publicKey=e;this._merklePath=t;this._signature=r}(0,_createClass3["default"])(SignatureProof,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this._publicKey.serialize(e);this._merklePath.serialize(e);this._signature&&this._signature.serialize(e);return e}},{key:"equals",value:function equals(e){return e instanceof SignatureProof&&this._publicKey.equals(e._publicKey)&&this._merklePath.equals(e._merklePath)&&(this._signature?this._signature.equals(e._signature):this._signature===e._signature)}},{key:"verify",value:function verify(e,t){if(null!==e&&!this.isSignedBy(e)){a.w(SignatureProof,"Invalid SignatureProof - signer does not match sender address");return!1}if(!this._signature){a.w(SignatureProof,"Invalid SignatureProof - signature is missing");return!1}if(!this._signature.verify(this._publicKey,t)){a.w(SignatureProof,"Invalid SignatureProof - signature is invalid");return!1}return!0}},{key:"isSignedBy",value:function isSignedBy(e){var t=this._merklePath.computeRoot(this._publicKey);return q.fromHash(t).equals(e)}},{key:"serializedSize",get:function get(){return this._publicKey.serializedSize+this._merklePath.serializedSize+(this._signature?this._signature.serializedSize:0)}},{key:"publicKey",get:function get(){return this._publicKey}},{key:"merklePath",get:function get(){return this._merklePath}},{key:"signature",get:function get(){return this._signature},set:function set(e){this._signature=e}}],[{key:"unserialize",value:function unserialize(e){return new SignatureProof(H.unserialize(e),N.unserialize(e),W.unserialize(e))}}]);return SignatureProof}();r.register(ge);var ye=function(e){(0,_inherits3["default"])(BasicTransaction,e);function BasicTransaction(e,t,r,n,a,i){(0,_classCallCheck3["default"])(this,BasicTransaction);if(!(e instanceof H))throw new Error("Malformed senderPubKey");if(i!==undefined&&!(i instanceof W))throw new Error("Malformed signature");var s=ge.singleSig(e,i),o=(0,_possibleConstructorReturn3["default"])(this,(BasicTransaction.__proto__||(0,_getPrototypeOf2["default"])(BasicTransaction)).call(this,pe.Format.BASIC,e.toAddress(),$.Type.BASIC,t,$.Type.BASIC,r,n,a,pe.Flag.NONE,new Uint8Array(0),s.serialize()));o._signatureProof=s;return o}(0,_createClass3["default"])(BasicTransaction,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint8(pe.Format.BASIC);this.senderPubKey.serialize(e);this._recipient.serialize(e);e.writeUint64(this._value);e.writeUint64(this._fee);e.writeUint32(this._validityStartHeight);this.signature.serialize(e);return e}},{key:"serializedSize",get:function get(){return 1+this.senderPubKey.serializedSize+this._recipient.serializedSize+8+8+4+this.signature.serializedSize}},{key:"senderPubKey",get:function get(){return this._signatureProof.publicKey}},{key:"signature",get:function get(){return this._signatureProof.signature},set:function set(e){this._signatureProof.signature=e;this._proof=this._signatureProof.serialize()}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint8();C.that(t===pe.Format.BASIC);return new BasicTransaction(H.unserialize(e),q.unserialize(e),e.readUint64(),e.readUint64(),e.readUint32(),W.unserialize(e))}}]);return BasicTransaction}(pe);pe.FORMAT_MAP.set(pe.Format.BASIC,ye);r.register(ye);var ve=function(e){(0,_inherits3["default"])(ExtendedTransaction,e);function ExtendedTransaction(e,t,r,n,a,i,s,o,u){var c=arguments.length>9&&arguments[9]!==undefined?arguments[9]:new Uint8Array(0);(0,_classCallCheck3["default"])(this,ExtendedTransaction);return(0,_possibleConstructorReturn3["default"])(this,(ExtendedTransaction.__proto__||(0,_getPrototypeOf2["default"])(ExtendedTransaction)).call(this,pe.Format.EXTENDED,e,t,r,n,a,i,s,o,u,c))}(0,_createClass3["default"])(ExtendedTransaction,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint8(pe.Format.EXTENDED);this.serializeContent(e);e.writeUint16(this._proof.byteLength);e.write(this._proof);return e}},{key:"serializedSize",get:function get(){return 1+this.serializedContentSize+2+this._proof.byteLength}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint8();C.that(t===pe.Format.EXTENDED);var r=e.readUint16(),n=e.read(r),a=q.unserialize(e),i=e.readUint8(),s=q.unserialize(e),o=e.readUint8(),u=e.readUint64(),c=e.readUint64(),l=e.readUint32(),h=e.readUint8(),f=e.readUint16();return new ExtendedTransaction(a,i,s,o,u,c,l,h,n,e.read(f))}}]);return ExtendedTransaction}(pe);pe.FORMAT_MAP.set(pe.Format.EXTENDED,ve);r.register(ve);var ke=function(){function TransactionsProof(e,t){(0,_classCallCheck3["default"])(this,TransactionsProof);if(!e||!I.isUint16(e.length)||e.some(function(e){return!(e instanceof pe)}))throw new Error("Malformed transactions");if(!(t instanceof R))throw new Error("Malformed merkle proof");this._transactions=e;this._proof=t}(0,_createClass3["default"])(TransactionsProof,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint16(this._transactions.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._transactions);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}this._proof.serialize(e);return e}},{key:"toString",value:function toString(){return"TransactionsProof{length="+this.length+"}"}},{key:"root",value:function root(){return this._proof.computeRoot(this._transactions)}},{key:"serializedSize",get:function get(){return 2+this._transactions.reduce(function(e,t){return e+t.serializedSize},0)+this._proof.serializedSize}},{key:"length",get:function get(){return this._transactions.length}},{key:"transactions",get:function get(){return this._transactions}},{key:"proof",get:function get(){return this._proof}}],[{key:"unserialize",value:function unserialize(e){for(var t=e.readUint16(),r=[],n=0;n<t;++n)r.push(pe.unserialize(e));return new TransactionsProof(r,R.unserialize(e))}}]);return TransactionsProof}();r.register(ke);var me=function(){function TransactionCache(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[],t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];(0,_classCallCheck3["default"])(this,TransactionCache);this._transactions=new v(function(e){return e.hash().toBase64()});this._transactions.addAll(e);this._blockOrder=t}(0,_createClass3["default"])(TransactionCache,[{key:"containsTransaction",value:function containsTransaction(e){return this._transactions.contains(e)}},{key:"pushBlock",value:function pushBlock(e){this._blockOrder.push(e);this._transactions.addAll(e.transactions);this._blockOrder.length>z.TRANSACTION_VALIDITY_WINDOW&&this.shiftBlock()}},{key:"shiftBlock",value:function shiftBlock(){var e=this._blockOrder.shift();e&&this._transactions.removeAll(e.transactions)}},{key:"revertBlock",value:function revertBlock(e){if(this._transactions.isEmpty())return this.missingBlocks;var t=this._blockOrder.pop();C.that(t.equals(e),"Invalid block to revert");e&&this._transactions.removeAll(e.transactions);return this.missingBlocks}},{key:"prependBlocks",value:function prependBlocks(e){var t,r=this;if(e.length+this._blockOrder.length>z.TRANSACTION_VALIDITY_WINDOW)throw new Error("Exceeding transaction cache size");(t=this._blockOrder).unshift.apply(t,(0,_toConsumableArray3["default"])(e));e.forEach(function(e){return r._transactions.addAll(e.transactions)})}},{key:"clone",value:function clone(){return new TransactionCache(this._transactions,this._blockOrder.slice())}},{key:"missingBlocks",get:function get(){return z.TRANSACTION_VALIDITY_WINDOW-this._blockOrder.length}},{key:"transactions",get:function get(){return this._transactions}}]);return TransactionCache}();r.register(me);var be=function(){function TransactionStoreEntry(e,t,r,n,a,i){(0,_classCallCheck3["default"])(this,TransactionStoreEntry);this._transactionHash=e;this._sender=t;this._recipient=r;this._blockHeight=n;this._blockHash=a;this._index=i;this.senderKey=t.toBase64();this.recipientKey=r.toBase64()}(0,_createClass3["default"])(TransactionStoreEntry,[{key:"toJSON",value:function toJSON(){return{senderKey:this.senderKey,recipientKey:this.recipientKey,blockHeight:this.blockHeight,blockHash:this.blockHash.toBase64(),index:this.index}}},{key:"transactionHash",get:function get(){return this._transactionHash}},{key:"sender",get:function get(){return this._sender}},{key:"recipient",get:function get(){return this._recipient}},{key:"blockHeight",get:function get(){return this._blockHeight}},{key:"blockHash",get:function get(){return this._blockHash}},{key:"index",get:function get(){return this._index}},{key:"key",get:function get(){return this.transactionHash.toBase64()}}],[{key:"fromBlock",value:function fromBlock(e){for(var t=e.hash(),r=[],n=0;n<e.transactions.length;++n){var a=e.transactions[n];r.push(new TransactionStoreEntry(a.hash(),a.sender,a.recipient,e.height,t,n))}return r}},{key:"fromJSON",value:function fromJSON(e,t){return new TransactionStoreEntry(U.fromBase64(e),q.fromBase64(t.senderKey),q.fromBase64(t.recipientKey),t.blockHeight,U.fromBase64(t.blockHash),t.index)}}]);return TransactionStoreEntry}();r.register(be);var Ce=function(){(0,_createClass3["default"])(TransactionStore,null,[{key:"initPersistent",value:function initPersistent(e){var t=e.createObjectStore("Transactions",new we);t.createIndex("sender","senderKey",!0);t.createIndex("recipient","recipientKey",!0)}},{key:"getPersistent",value:function getPersistent(e){return new TransactionStore(e.getObjectStore("Transactions"))}},{key:"createVolatile",value:function createVolatile(){var e=JDB.JungleDB.createVolatileObjectStore();e.createIndex("sender","senderKey",!0);e.createIndex("recipient","recipientKey",!0);return new TransactionStore(e)}}]);function TransactionStore(e){(0,_classCallCheck3["default"])(this,TransactionStore);this._store=e}(0,_createClass3["default"])(TransactionStore,[{key:"get",value:function get(e){return this._store.get(e.toBase64())}},{key:"getBySender",value:function getBySender(e){return this._store.index("sender").values(JDB.KeyRange.only(e.toBase64()))}},{key:"getByRecipient",value:function getByRecipient(e){return this._store.index("recipient").values(JDB.KeyRange.only(e.toBase64()))}},{key:"put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee167(e){var t,r,n,a,i,s,o,u,c;return _regenerator2["default"].wrap(function _callee167$(l){for(;;)switch(l.prev=l.next){case 0:l.next=2;return be.fromBlock(e);case 2:t=l.sent;r=this._store.transaction();n=[];a=!0;i=!1;s=undefined;l.prev=8;for(o=(0,_getIterator3["default"])(t);!(a=(u=o.next()).done);a=!0){c=u.value;n.push(r.put(c.key,c))}l.next=16;break;case 12:l.prev=12;l.t0=l["catch"](8);i=!0;s=l.t0;case 16:l.prev=16;l.prev=17;!a&&o["return"]&&o["return"]();case 19:l.prev=19;if(!i){l.next=22;break}throw s;case 22:return l.finish(19);case 23:return l.finish(16);case 24:l.next=26;return _promise2["default"].all(n);case 26:return l.abrupt("return",r.commit());case 27:case"end":return l.stop()}},_callee167,this,[[8,12,16,24],[17,,19,23]])}));return function put(t){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee168(e){var t,r,n,a,i,s,o,u;return _regenerator2["default"].wrap(function _callee168$(c){for(;;)switch(c.prev=c.next){case 0:t=this._store.transaction();r=[];n=!0;a=!1;i=undefined;c.prev=5;for(s=(0,_getIterator3["default"])(e.transactions);!(n=(o=s.next()).done);n=!0){u=o.value;r.push(t.remove(u.hash().toBase64()))}c.next=13;break;case 9:c.prev=9;c.t0=c["catch"](5);a=!0;i=c.t0;case 13:c.prev=13;c.prev=14;!n&&s["return"]&&s["return"]();case 16:c.prev=16;if(!a){c.next=19;break}throw i;case 19:return c.finish(16);case 20:return c.finish(13);case 21:c.next=23;return _promise2["default"].all(r);case 23:return c.abrupt("return",t.commit());case 24:case"end":return c.stop()}},_callee168,this,[[5,9,13,21],[14,,16,20]])}));return function remove(t){return e.apply(this,arguments)}}()},{key:"snapshot",value:function snapshot(e){var snapshot=this._store.snapshot();e&&snapshot.inherit(e._store);return new TransactionStore(snapshot)}},{key:"transaction",value:function transaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];return new TransactionStore(this._store.transaction(e))}},{key:"truncate",value:function truncate(){return this._store.truncate()}},{key:"commit",value:function commit(){return this._store.commit()}},{key:"abort",value:function abort(){return this._store.abort()}},{key:"tx",get:function get(){return this._store instanceof JDB.Transaction?this._store:undefined}}]);return TransactionStore}();r.register(Ce);var we=function(){function TransactionStoreCodec(){(0,_classCallCheck3["default"])(this,TransactionStoreCodec)}(0,_createClass3["default"])(TransactionStoreCodec,[{key:"encode",value:function encode(e){return e.toJSON()}},{key:"decode",value:function decode(e,t){return be.fromJSON(t,e)}},{key:"valueEncoding",get:function get(){return JDB.JungleDB.JSON_ENCODING}}]);return TransactionStoreCodec}(),Ae=function(){function TransactionReceipt(e,t){(0,_classCallCheck3["default"])(this,TransactionReceipt);this._transactionHash=e;this._blockHash=t}(0,_createClass3["default"])(TransactionReceipt,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this._transactionHash.serialize(e);this._blockHash.serialize(e);return e}},{key:"serializedSize",get:function get(){return this._transactionHash.serializedSize+this._blockHash.serializedSize}},{key:"transactionHash",get:function get(){return this._transactionHash}},{key:"blockHash",get:function get(){return this._blockHash}}],[{key:"unserialize",value:function unserialize(e){return new TransactionReceipt(U.unserialize(e),U.unserialize(e))}}]);return TransactionReceipt}();r.register(Ae);var Se=function(){(0,_createClass3["default"])(Block,null,[{key:"copy",value:function copy(e){return e?new Block(le.copy(e._header),he.copy(e._interlink),fe.copy(e._body)):e}}]);function Block(e,t,r){(0,_classCallCheck3["default"])(this,Block);if(!(e instanceof le))throw"Malformed header";if(!(t instanceof he))throw"Malformed interlink";if(r&&!(r instanceof fe))throw"Malformed body";this._header=e;this._interlink=t;this._body=r}(0,_createClass3["default"])(Block,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this._header.serialize(e);this._interlink.serialize(e);if(this._body){e.writeUint8(1);this._body.serialize(e)}else e.writeUint8(0);return e}},{key:"verify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee169(e){var t,r,n,a,i,s;return _regenerator2["default"].wrap(function _callee169$(o){for(;;)switch(o.prev=o.next){case 0:if(this._valid!==undefined){o.next=19;break}if(!(this.isLight()||this.body.transactions.length<150)&&mr.areWorkersAsync){o.next=7;break}o.next=4;return this._verify(e.now());case 4:this._valid=o.sent;o.next=19;break;case 7:t=this.body.transactions.map(function(e){return e._valid});o.next=10;return x.blockVerify(this.serialize(),t,e.now());case 10:r=o.sent;n=r.valid;a=r.pow;i=r.interlinkHash;s=r.bodyHash;this._valid=n;this.header._pow=U.unserialize(new T(a));this.interlink._hash=U.unserialize(new T(i));this.body._hash=U.unserialize(new T(s));case 19:return o.abrupt("return",this._valid);case 20:case"end":return o.stop()}},_callee169,this)}));return function verify(t){return e.apply(this,arguments)}}()},{key:"_verify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee170(e){return _regenerator2["default"].wrap(function _callee170$(t){for(;;)switch(t.prev=t.next){case 0:if(!(1e3*this._header.timestamp>e+1e3*Block.TIMESTAMP_DRIFT_MAX)){t.next=3;break}a.w(Block,"Invalid block - timestamp too far in the future");return t.abrupt("return",!1);case 3:t.next=5;return this._header.verifyProofOfWork();case 5:if(t.sent){t.next=8;break}a.w(Block,"Invalid block - PoW verification failed");return t.abrupt("return",!1);case 8:if(!(this.serializedSize>z.BLOCK_SIZE_MAX)){t.next=11;break}a.w(Block,"Invalid block - max block size exceeded");return t.abrupt("return",!1);case 11:if(this._verifyInterlink()){t.next=13;break}return t.abrupt("return",!1);case 13:if(!this.isFull()||this._verifyBody()){t.next=15;break}return t.abrupt("return",!1);case 15:return t.abrupt("return",!0);case 16:case"end":return t.stop()}},_callee170,this)}));return function _verify(t){return e.apply(this,arguments)}}()},{key:"_verifyInterlink",value:function _verifyInterlink(){if(1===this.height&&this._header.interlinkHash.equals(new U(null)))return!0;var e=this._interlink.hash();if(!this._header.interlinkHash.equals(e)){a.w(Block,"Invalid block - interlink hash mismatch");return!1}return!0}},{key:"_verifyBody",value:function _verifyBody(){if(!this._body.verify())return!1;var e=this._body.hash();if(!this._header.bodyHash.equals(e)){a.w(Block,"Invalid block - body hash mismatch");return!1}return!0}},{key:"isImmediateSuccessorOf",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee171(e){var t;return _regenerator2["default"].wrap(function _callee171$(r){for(;;)switch(r.prev=r.next){case 0:if(this._header.isImmediateSuccessorOf(e.header)){r.next=2;break}return r.abrupt("return",!1);case 2:r.next=4;return e.getNextInterlink(this.target,this.version);case 4:t=r.sent;if(this._interlink.equals(t)){r.next=7;break}return r.abrupt("return",!1);case 7:return r.abrupt("return",!0);case 8:case"end":return r.stop()}},_callee171,this)}));return function isImmediateSuccessorOf(t){return e.apply(this,arguments)}}()},{key:"isInterlinkSuccessorOf",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee172(e){var t,r,n,i,s,o,u,c,l,h,f,_,d,p,g;return _regenerator2["default"].wrap(function _callee172$(y){for(;;)switch(y.prev=y.next){case 0:if(!(this._header.height<=e.header.height)){y.next=3;break}a.v(Block,"No interlink successor - height");return y.abrupt("return",!1);case 3:if(!(this._header.timestamp<e.header.timestamp)){y.next=6;break}a.v(Block,"No interlink successor - timestamp");return y.abrupt("return",!1);case 6:t=e.hash();if(Block.GENESIS.HASH.equals(t)){y.next=26;break}y.next=10;return e.pow();case 10:r=y.sent;n=_e.getTargetHeight(this.target);i=!1;s=0;case 14:if(!(s<this._interlink.length)){y.next=23;break}if(!t.equals(this._interlink.hashes[s])){y.next=20;break}i=!0;if(_e.isProofOfWork(r,Math.pow(2,n-s))){y.next=20;break}a.v(Block,"No interlink successor - invalid position in interlink");return y.abrupt("return",!1);case 20:s++;y.next=14;break;case 23:if(i){y.next=26;break}a.v(Block,"No interlink successor - not in interlink");return y.abrupt("return",!1);case 26:if(!this._header.prevHash.equals(t)){y.next=39;break}if(this._header.height===e.header.height+1){y.next=30;break}a.v(Block,"No interlink successor - immediate height");return y.abrupt("return",!1);case 30:y.next=32;return e.getNextInterlink(this.target,this.version);case 32:o=y.sent;u=o.hash();if(this._header.interlinkHash.equals(u)){y.next=37;break}a.v(Block,"No interlink successor - immediate interlink");return y.abrupt("return",!1);case 37:y.next=71;break;case 39:if(this._header.height!==e.height.height+1){y.next=44;break}a.v(Block,"No interlink successor - immediate height (2)");return y.abrupt("return",!1);case 44:(c=new v).addAll(this._interlink.hashes);c.removeAll(e.interlink.hashes);if(!(c.length>this._header.height-e.header.height)){y.next=50;break}a.v(Block,"No interlink successor - too many new blocks");return y.abrupt("return",!1);case 50:l=_e.getTargetDepth(this.target);h=_e.getTargetDepth(e.target);f=l-h;if(!(this._interlink.length<e.interlink.length-f)){y.next=56;break}a.v(Block,"No interlink successor - interlink too short");return y.abrupt("return",!1);case 56:_=!1;d=this._interlink.hashes;p=e.interlink.hashes;g=1;case 60:if(!(g<p.length&&g-f<d.length)){y.next=71;break}if(!p[g].equals(d[g-f])){y.next=65;break}_=!0;y.next=68;break;case 65:if(!_){y.next=68;break}a.v(Block,"No interlink successor - invalid common suffix");return y.abrupt("return",!1);case 68:g++;y.next=60;break;case 71:return y.abrupt("return",!0);case 72:case"end":return y.stop()}},_callee172,this)}));return function isInterlinkSuccessorOf(t){return e.apply(this,arguments)}}()},{key:"isSuccessorOf",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee173(e){return _regenerator2["default"].wrap(function _callee173$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this.isImmediateSuccessorOf(e);case 2:t.t0=t.sent;if(t.t0){t.next=7;break}t.next=6;return this.isInterlinkSuccessorOf(e);case 6:t.t0=t.sent;case 7:return t.abrupt("return",t.t0);case 8:case"end":return t.stop()}},_callee173,this)}));return function isSuccessorOf(t){return e.apply(this,arguments)}}()},{key:"getNextInterlink",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee174(e){var t,r,n,a,i,s,o,u,c;arguments.length>1&&arguments[1]!==undefined?arguments[1]:le.CURRENT_VERSION;return _regenerator2["default"].wrap(function _callee174$(l){for(;;)switch(l.prev=l.next){case 0:l.next=2;return this.pow();case 2:t=l.sent;r=_e.getTargetDepth(_e.hashToTarget(t));n=_e.getTargetDepth(e);a=r-n;i=[];s=this.hash();for(o=0;o<=a;o++)i.push(s);u=_e.getTargetDepth(this.target);for(c=a+(n-u)+1;c<this.interlink.length;c++)i.push(this.interlink.hashes[c]);return l.abrupt("return",new he(i,s));case 13:case"end":return l.stop()}},_callee174,this)}));return function getNextInterlink(t){return e.apply(this,arguments)}}()},{key:"equals",value:function equals(e){return e instanceof Block&&this._header.equals(e._header)&&this._interlink.equals(e._interlink)&&(this._body?this._body.equals(e._body):!e._body)}},{key:"isLight",value:function isLight(){return!this._body}},{key:"isFull",value:function isFull(){return!!this._body}},{key:"toLight",value:function toLight(){return this.isLight()?this:new Block(this._header,this._interlink)}},{key:"toFull",value:function toFull(e){return this.isFull()?this:new Block(this._header,this._interlink,e)}},{key:"hash",value:function hash(e){return this._header.hash(e)}},{key:"hashAsync",value:function hashAsync(e){return this._header.hashAsync(e)}},{key:"pow",value:function pow(e){return this._header.pow(e)}},{key:"serializedSize",get:function get(){return this._header.serializedSize+this._interlink.serializedSize+1+(this._body?this._body.serializedSize:0)}},{key:"header",get:function get(){return this._header}},{key:"interlink",get:function get(){return this._interlink}},{key:"body",get:function get(){if(this.isLight())throw"Cannot access body of light block";return this._body}},{key:"version",get:function get(){return this._header.version}},{key:"prevHash",get:function get(){return this._header.prevHash}},{key:"bodyHash",get:function get(){return this._header.bodyHash}},{key:"accountsHash",get:function get(){return this._header.accountsHash}},{key:"nBits",get:function get(){return this._header.nBits}},{key:"target",get:function get(){return this._header.target}},{key:"difficulty",get:function get(){return this._header.difficulty}},{key:"height",get:function get(){return this._header.height}},{key:"timestamp",get:function get(){return this._header.timestamp}},{key:"nonce",get:function get(){return this._header.nonce}},{key:"minerAddr",get:function get(){return this._body.minerAddr}},{key:"transactions",get:function get(){return this._body.transactions}},{key:"transactionCount",get:function get(){return this._body.transactionCount}}],[{key:"unserialize",value:function unserialize(e){var t=le.unserialize(e),r=he.unserialize(e,t.prevHash),n=undefined;e.readUint8()&&(n=fe.unserialize(e));return new Block(t,r,n)}}]);return Block}();Se.TIMESTAMP_DRIFT_MAX=600;r.register(Se);var Te=function(e){(0,_inherits3["default"])(IBlockchain,e);function IBlockchain(){(0,_classCallCheck3["default"])(this,IBlockchain);return(0,_possibleConstructorReturn3["default"])(this,(IBlockchain.__proto__||(0,_getPrototypeOf2["default"])(IBlockchain)).apply(this,arguments))}(0,_createClass3["default"])(IBlockchain,[{key:"head",get:function get(){}},{key:"headHash",get:function get(){}},{key:"height",get:function get(){}}]);return IBlockchain}(i);r.register(Te);var xe=function(e){(0,_inherits3["default"])(BaseChain,e);function BaseChain(e){(0,_classCallCheck3["default"])(this,BaseChain);var t=(0,_possibleConstructorReturn3["default"])(this,(BaseChain.__proto__||(0,_getPrototypeOf2["default"])(BaseChain)).call(this));t._store=e;return t}(0,_createClass3["default"])(BaseChain,[{key:"getBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee175(e){var t,r=arguments.length>1&&arguments[1]!==undefined&&arguments[1];return _regenerator2["default"].wrap(function _callee175$(n){for(;;)switch(n.prev=n.next){case 0:n.next=2;return this._store.getChainData(e);case 2:t=n.sent;return n.abrupt("return",t&&(t.onMainChain||r)?t.head:null);case 4:case"end":return n.stop()}},_callee175,this)}));return function getBlock(t){return e.apply(this,arguments)}}()},{key:"getBlockAt",value:function getBlockAt(e){return this._store.getBlockAt(e)||null}},{key:"getNextTarget",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee176(e){var t,r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee176$(u){for(;;)switch(u.prev=u.next){case 0:t=void 0;if(!e){u.next=9;break}r=e.hash();u.next=5;return this._store.getChainData(r);case 5:t=u.sent;C.that(!!t);u.next=11;break;case 9:e=this.head;t=this._mainChain;case 11:n=Math.max(e.height-z.DIFFICULTY_BLOCK_WINDOW,1);a=void 0;if(!t.onMainChain){u.next=19;break}u.next=16;return this._store.getChainDataAt(n);case 16:a=u.sent;u.next=37;break;case 19:i=t;s=0;case 21:if(!(s<z.DIFFICULTY_BLOCK_WINDOW)||i.onMainChain){u.next=30;break}u.next=24;return this._store.getChainData(i.head.prevHash);case 24:if(i=u.sent){u.next=27;break}return u.abrupt("return",-1);case 27:s++;u.next=21;break;case 30:if(!(i.onMainChain&&i.head.height>n)){u.next=36;break}u.next=33;return this._store.getChainDataAt(n);case 33:a=u.sent;u.next=37;break;case 36:a=i;case 37:if(a&&!(a.totalDifficulty<1)){u.next=39;break}return u.abrupt("return",-1);case 39:o=t.totalDifficulty-a.totalDifficulty;return u.abrupt("return",_e.getNextTarget(t.head.header,a.head.header,o));case 41:case"end":return u.stop()}},_callee176,this)}));return function getNextTarget(t){return e.apply(this,arguments)}}()},{key:"_getChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee177(){var e,t,r;return _regenerator2["default"].wrap(function _callee177$(n){for(;;)switch(n.prev=n.next){case 0:e=this._store.snapshot();t=new Ee(e,this.head);n.next=4;return t._prove(z.M,z.K,z.DELTA);case 4:r=n.sent;e.abort()["catch"](a.w.tag(BaseChain));return n.abrupt("return",r);case 7:case"end":return n.stop()}},_callee177,this)}));return function _getChainProof(){return e.apply(this,arguments)}}()},{key:"_prove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee178(e,t,r){var n,i,s,o,u,c,l;return _regenerator2["default"].wrap(function _callee178$(h){for(;;)switch(h.prev=h.next){case 0:C.that(e>=1,"m must be >= 1");C.that(r>0,"delta must be > 0");n=new Ie([]);i=1;h.next=6;return this.getBlockAt(Math.max(this.height-t,1));case 6:s=h.sent;o=Math.max(_e.getTargetDepth(s.target)+s.interlink.length-1,0);u=o;case 9:if(!(u>=0)){h.next=18;break}h.next=12;return this._getSuperChain(u,s,i);case 12:c=h.sent;n=Ie.merge(n,c);if(BaseChain._isGoodSuperChain(c,u,e,r)){C.that(c.length>=e,"Good superchain expected to be at least "+e+" long");a.v(BaseChain,"Found good superchain at depth "+u+" with length "+c.length+" (#"+i+" - #"+s.height+")");i=c.blocks[c.length-e].height}case 15:u--;h.next=9;break;case 18:h.next=20;return this._getHeaderChain(this.height-s.height);case 20:l=h.sent;return h.abrupt("return",new Ne(n,l));case 22:case"end":return h.stop()}},_callee178,this)}));return function _prove(t,r,n){return e.apply(this,arguments)}}()},{key:"_getSuperChain",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee179(e){var t,r,n,i,s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.head,o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1;return _regenerator2["default"].wrap(function _callee179$(u){for(;;)switch(u.prev=u.next){case 0:C.that(o>=1,"tailHeight must be >= 1");t=[];u.next=4;return s.pow();case 4:r=u.sent;_e.getTargetDepth(_e.hashToTarget(r))>=e&&t.push(s.toLight());n=Math.max(e-_e.getTargetDepth(s.target),-1);case 8:if(!(n<s.interlink.hashes.length&&s.height>o)){u.next=20;break}i=n<0?s.prevHash:s.interlink.hashes[n];u.next=12;return this.getBlock(i);case 12:if(s=u.sent){u.next=16;break}a.w(BaseChain,"Failed to find block "+i+" while constructing SuperChain at depth "+e+" - returning truncated chain");return u.abrupt("break",20);case 16:t.push(s.toLight());n=Math.max(e-_e.getTargetDepth(s.target),-1);u.next=8;break;case 20:(0===t.length||t[t.length-1].height>1)&&1===o&&t.push(Se.GENESIS.toLight());return u.abrupt("return",new Ie(t.reverse()));case 22:case"end":return u.stop()}},_callee179,this)}));return function _getSuperChain(t){return e.apply(this,arguments)}}()},{key:"_getHeaderChain",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee180(e){var t,r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.head;return _regenerator2["default"].wrap(function _callee180$(n){for(;;)switch(n.prev=n.next){case 0:t=[];case 1:if(!(r&&t.length<e)){n.next=8;break}t.push(r.header);n.next=5;return this.getBlock(r.prevHash);case 5:r=n.sent;n.next=1;break;case 8:return n.abrupt("return",new Pe(t.reverse()));case 9:case"end":return n.stop()}},_callee180,this)}));return function _getHeaderChain(t){return e.apply(this,arguments)}}()},{key:"_extendChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee181(e,t){var r,n,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m,b=!(arguments.length>2&&arguments[2]!==undefined)||arguments[2];return _regenerator2["default"].wrap(function _callee181$(C){for(;;)switch(C.prev=C.next){case 0:(r=e.suffix.headers.slice()).push(t);n=e.prefix.blocks.slice();if(!(r.length<=z.K)){C.next=5;break}return C.abrupt("return",new Ne(new Ie(n),new Pe(r)));case 5:i=r.shift();C.next=8;return e.prefix.head.getNextInterlink(i.target,i.version);case 8:s=C.sent;o=new Se(i,s);n.push(o);C.next=13;return e.getSuperChains();case 13:u=C.sent.slice();C.t0=_e;C.next=17;return o.pow();case 17:C.t1=C.sent;c=C.t0.hashToTarget.call(C.t0,C.t1);l=_e.getTargetDepth(c);for(h=l;h>=0;h--)u[h]?u[h]=new Ie([].concat((0,_toConsumableArray3["default"])(u[h].blocks),[o])):u[h]=new Ie([o]);if(!(l-_e.getTargetDepth(o.target)<=0)){C.next=23;break}return C.abrupt("return",new Ne(new Ie(n),new Pe(r),u));case 23:f=new _set3["default"];_=l;case 25:if(!(_>=0)){C.next=59;break}if(!((d=u[_]).length<z.M)){C.next=29;break}return C.abrupt("continue",56);case 29:if(!BaseChain._isGoodSuperChain(d,_,z.M,z.DELTA)){C.next=53;break}p=d.blocks[d.length-z.M];g=_-1;case 32:if(!(g>=0)){C.next=51;break}y=0;v=u[g].blocks[y];case 35:if(!(v.height<=p.height)){C.next=47;break}C.t2=_e;C.next=39;return v.pow();case 39:C.t3=C.sent;k=C.t2.hashToTarget.call(C.t2,C.t3);_e.getTargetDepth(k)===g&&v.height>1&&f.add(v.height);y++;v=u[g].blocks[y];C.next=35;break;case 47:y>0&&(u[g]=new Ie(u[g].blocks.slice(y)));case 48:g--;C.next=32;break;case 51:C.next=56;break;case 53:a.w(BaseChain,"Chain quality badness detected at depth "+_);if(!b){C.next=56;break}return C.abrupt("return",null);case 56:_--;C.next=25;break;case 59:m=new Ie(n.filter(function(e){return!f.has(e.height)}));return C.abrupt("return",new Ne(m,new Pe(r),u));case 61:case"end":return C.stop()}},_callee181,this)}));return function _extendChainProof(t,r){return e.apply(this,arguments)}}()}],[{key:"_isGoodSuperChain",value:function _isGoodSuperChain(e,t,r,n){return BaseChain._hasSuperQuality(e,t,r,n)}},{key:"_hasSuperQuality",value:function _hasSuperQuality(e,t,r,n){C.that(r>=1,"m must be >= 1");if(e.length<r)return!1;for(var a=r;a<=e.length;a++){var i=e.head.height-e.blocks[e.length-a].height+1;if(!BaseChain._isLocallyGood(a,i,t,n))return!1}return!0}},{key:"_isLocallyGood",value:function _isLocallyGood(e,t,r,n){return e>(1-n)*Math.pow(2,-r)*t}},{key:"isBetterProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee182(e,t,r){var n,a,i;return _regenerator2["default"].wrap(function _callee182$(s){for(;;)switch(s.prev=s.next){case 0:n=Ie.lowestCommonAncestor(e.prefix,t.prefix);s.next=3;return We._getProofScore(e.prefix,n,r);case 3:a=s.sent;s.next=6;return We._getProofScore(t.prefix,n,r);case 6:i=s.sent;return s.abrupt("return",a===i?e.suffix.totalDifficulty()>=t.suffix.totalDifficulty():a>i);case 8:case"end":return s.stop()}},_callee182,this)}));return function isBetterProof(t,r,n){return e.apply(this,arguments)}}()},{key:"_getProofScore",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee183(e,t,r){var n,a,i,s,o,u,c,l,h,f,_,d,p,g,y;return _regenerator2["default"].wrap(function _callee183$(v){for(;;)switch(v.prev=v.next){case 0:n=[];a=!0;i=!1;s=undefined;v.prev=4;o=(0,_getIterator3["default"])(e.blocks);case 6:if(a=(u=o.next()).done){v.next=20;break}if(!((c=u.value).height<t.height)){v.next=10;break}return v.abrupt("continue",17);case 10:v.t0=_e;v.next=13;return c.pow();case 13:v.t1=v.sent;l=v.t0.hashToTarget.call(v.t0,v.t1);h=_e.getTargetDepth(l);n[h]=n[h]?n[h]+1:1;case 17:a=!0;v.next=6;break;case 20:v.next=26;break;case 22:v.prev=22;v.t2=v["catch"](4);i=!0;s=v.t2;case 26:v.prev=26;v.prev=27;!a&&o["return"]&&o["return"]();case 29:v.prev=29;if(!i){v.next=32;break}throw s;case 32:return v.finish(29);case 33:return v.finish(26);case 34:f=0;_=void 0;for(_=n.length-1;f<r&&_>=0;_--)f+=n[_]?n[_]:0;d=Math.pow(2,_+1)*f;p=f;for(g=_;g>=0;g--){p+=n[g]?n[g]:0;y=Math.pow(2,g)*p;d=Math.max(d,y)}return v.abrupt("return",d);case 41:case"end":return v.stop()}},_callee183,this,[[4,22,26,34],[27,,29,33]])}));return function _getProofScore(t,r,n){return e.apply(this,arguments)}}()}]);return BaseChain}(Te);r.register(xe);var Ee=function(e){(0,_inherits3["default"])(BaseChainSnapshot,e);function BaseChainSnapshot(e,t){(0,_classCallCheck3["default"])(this,BaseChainSnapshot);var r=(0,_possibleConstructorReturn3["default"])(this,(BaseChainSnapshot.__proto__||(0,_getPrototypeOf2["default"])(BaseChainSnapshot)).call(this,e));r._head=t;return r}(0,_createClass3["default"])(BaseChainSnapshot,[{key:"head",get:function get(){return this._head}},{key:"height",get:function get(){return this._head.height}}]);return BaseChainSnapshot}(xe);r.register(Ee);var Ie=function(){(0,_createClass3["default"])(BlockChain,null,[{key:"merge",value:function merge(e,t){for(var r=[],n=0,a=0;n<e.length&&a<t.length;){var i=e.blocks[n],s=t.blocks[a];if(i.height===s.height){C.that(i.equals(s),"Encountered different blocks at same height during chain merge");r.push(i);n++;a++}else if(i.height<s.height){r.push(i);n++}else{r.push(s);a++}}for(;n<e.length;n++)r.push(e.blocks[n]);for(;a<t.length;a++)r.push(t.blocks[a]);return new BlockChain(r)}},{key:"lowestCommonAncestor",value:function lowestCommonAncestor(e,t){for(var r=e.length-1,n=t.length-1;r>=0&&n>=0;){var a=e.blocks[r],i=t.blocks[n];if(a.equals(i))return a;a.height>i.height?r--:n--}return undefined}}]);function BlockChain(e){(0,_classCallCheck3["default"])(this,BlockChain);if(!e||!I.isUint16(e.length)||e.some(function(e){return!(e instanceof Se&&e.isLight())}))throw new Error("Malformed blocks");this._blocks=e}(0,_createClass3["default"])(BlockChain,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint16(this._blocks.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._blocks);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"verify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee184(){var e;return _regenerator2["default"].wrap(function _callee184$(t){for(;;)switch(t.prev=t.next){case 0:e=this._blocks.length-1;case 1:if(!(e>=1)){t.next=9;break}t.next=4;return this._blocks[e].isSuccessorOf(this._blocks[e-1]);case 4:if(t.sent){t.next=6;break}return t.abrupt("return",!1);case 6:e--;t.next=1;break;case 9:return t.abrupt("return",!0);case 10:case"end":return t.stop()}},_callee184,this)}));return function verify(){return e.apply(this,arguments)}}()},{key:"denseSuffix",value:function denseSuffix(){for(var denseSuffix=[this.head],e=this.head,t=this.length-2;t>=0;t--){var r=this.blocks[t];if(!r.hash().equals(e.prevHash))break;denseSuffix.push(r);e=r}denseSuffix.reverse();return denseSuffix}},{key:"isAnchored",value:function isAnchored(){return Se.GENESIS.HASH.equals(this.tail.hash())}},{key:"toString",value:function toString(){return"BlockChain{length="+this.length+"}"}},{key:"totalDifficulty",value:function totalDifficulty(){return this._blocks.reduce(function(e,t){return e+_e.targetToDifficulty(t.target)},0)}},{key:"serializedSize",get:function get(){return 2+this._blocks.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"length",get:function get(){return this._blocks.length}},{key:"blocks",get:function get(){return this._blocks}},{key:"head",get:function get(){return this._blocks[this.length-1]}},{key:"tail",get:function get(){return this._blocks[0]}}],[{key:"unserialize",value:function unserialize(e){for(var t=e.readUint16(),r=[],n=0;n<t;n++)r.push(Se.unserialize(e));return new BlockChain(r)}}]);return BlockChain}();r.register(Ie);var Pe=function(){function HeaderChain(e){(0,_classCallCheck3["default"])(this,HeaderChain);if(!e||!Array.isArray(e)||!I.isUint16(e.length)||e.some(function(e){return!(e instanceof le)}))throw new Error("Malformed headers");this._headers=e}(0,_createClass3["default"])(HeaderChain,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint16(this._headers.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._headers);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"verify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee185(){var e;return _regenerator2["default"].wrap(function _callee185$(t){for(;;)switch(t.prev=t.next){case 0:e=this._headers.length-1;case 1:if(!(e>=1)){t.next=7;break}if(this._headers[e].isImmediateSuccessorOf(this._headers[e-1])){t.next=4;break}return t.abrupt("return",!1);case 4:e--;t.next=1;break;case 7:return t.abrupt("return",!0);case 8:case"end":return t.stop()}},_callee185,this)}));return function verify(){return e.apply(this,arguments)}}()},{key:"toString",value:function toString(){return"HeaderChain{length="+this.length+"}"}},{key:"totalDifficulty",value:function totalDifficulty(){return this._headers.reduce(function(e,t){return e+_e.targetToDifficulty(t.target)},0)}},{key:"serializedSize",get:function get(){return 2+this._headers.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"length",get:function get(){return this._headers.length}},{key:"headers",get:function get(){return this._headers}},{key:"head",get:function get(){return this._headers[this.length-1]}},{key:"tail",get:function get(){return this._headers[0]}}],[{key:"unserialize",value:function unserialize(e){for(var t=e.readUint16(),r=[],n=0;n<t;n++)r.push(le.unserialize(e));return new HeaderChain(r)}}]);return HeaderChain}();r.register(Pe);var Ne=function(){function ChainProof(e,t,r){(0,_classCallCheck3["default"])(this,ChainProof);if(!(e instanceof Ie&&e.length))throw new Error("Malformed prefix");if(!(t instanceof Pe))throw new Error("Malformed suffix");this._prefix=e;this._suffix=t;this._chains=r}(0,_createClass3["default"])(ChainProof,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);this._prefix.serialize(e);this._suffix.serialize(e);return e}},{key:"verify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee186(){return _regenerator2["default"].wrap(function _callee186$(e){for(;;)switch(e.prev=e.next){case 0:if(this._prefix.isAnchored()){e.next=2;break}return e.abrupt("return",!1);case 2:e.next=4;return this._prefix.verify();case 4:e.t0=!e.sent;if(e.t0){e.next=9;break}e.next=8;return this._suffix.verify();case 8:e.t0=!e.sent;case 9:if(!e.t0){e.next=11;break}return e.abrupt("return",!1);case 11:if(!(this._suffix.length>0)||this._suffix.tail.isImmediateSuccessorOf(this._prefix.head.header)){e.next=13;break}return e.abrupt("return",!1);case 13:if(this._verifyDifficulty()){e.next=15;break}return e.abrupt("return",!1);case 15:return e.abrupt("return",!0);case 16:case"end":return e.stop()}},_callee186,this)}));return function verify(){return e.apply(this,arguments)}}()},{key:"_verifyDifficulty",value:function _verifyDifficulty(){for(var e=this.prefix.denseSuffix().map(function(e){return e.header}).concat(this.suffix.headers),t=0,r=[],n=0;n<e.length;n++){t+=e[n].difficulty;r[n]=t}for(var i=e.length-2,s=i-z.DIFFICULTY_BLOCK_WINDOW;s>=0&&i>=0;){var o=e[i],u=e[s],c=r[i]-r[s],l=_e.getNextTarget(o,u,c),h=_e.targetToCompact(l),f=e[i+1];if(f.nBits!==h){a.w(ChainProof,"Block target mismatch: expected="+h+", got="+f.nBits);return!1}--i;0===s&&1===u.height||--s}return!0}},{key:"getSuperChains",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee187(){var e,t,r,n,a;return _regenerator2["default"].wrap(function _callee187$(i){for(;;)switch(i.prev=i.next){case 0:if(this._chains){i.next=16;break}this._chains=[];e=0;case 3:if(!(e<this._prefix.length)){i.next=16;break}t=this._prefix.blocks[e];i.t0=_e;i.next=8;return t.pow();case 8:i.t1=i.sent;r=i.t0.hashToTarget.call(i.t0,i.t1);n=_e.getTargetDepth(r);this._chains[n]?this._chains[n].blocks.push(t):this._chains[n]||(this._chains[n]=new Ie([t]));for(a=n-1;a>=0;a--)this._chains[a]?this._chains[a].blocks.push(t):this._chains[a]=new Ie([]);case 13:e++;i.next=3;break;case 16:return i.abrupt("return",this._chains);case 17:case"end":return i.stop()}},_callee187,this)}));return function getSuperChains(){return e.apply(this,arguments)}}()},{key:"toString",value:function toString(){return"ChainProof{prefix="+this._prefix.length+", suffix="+this._suffix.length+", height="+this.head.height+"}"}},{key:"serializedSize",get:function get(){return this._prefix.serializedSize+this._suffix.serializedSize}},{key:"prefix",get:function get(){return this._prefix}},{key:"suffix",get:function get(){return this._suffix}},{key:"head",get:function get(){return this._suffix.length>0?this._suffix.head:this._prefix.head.header}}],[{key:"unserialize",value:function unserialize(e){return new ChainProof(Ie.unserialize(e),Pe.unserialize(e))}}]);return ChainProof}();r.register(Ne);var Oe=function(){(0,_createClass3["default"])(ChainData,null,[{key:"copy",value:function copy(e){if(!e)return e;var t=Se.unserialize(new T(e._head));t.header._pow=U.unserialize(new T(e._pow));return new ChainData(t,e._totalDifficulty,e._totalWork,e._onMainChain)}}]);function ChainData(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined&&arguments[3];(0,_classCallCheck3["default"])(this,ChainData);this._head=e;this._totalDifficulty=t;this._totalWork=r;this._onMainChain=n;this._height=e.height}(0,_createClass3["default"])(ChainData,[{key:"stripDown",value:function stripDown(){C.that(this._head.header._pow instanceof U,"Expected cashed PoW hash");return{_head:this._head.serialize(),_totalDifficulty:this._totalDifficulty,_totalWork:this._totalWork,_onMainChain:this._onMainChain,_height:this._height,_pow:this._head.header._pow.serialize()}}},{key:"head",get:function get(){return this._head}},{key:"totalDifficulty",get:function get(){return this._totalDifficulty}},{key:"totalWork",get:function get(){return this._totalWork}},{key:"onMainChain",get:function get(){return this._onMainChain},set:function set(e){this._onMainChain=e}}]);return ChainData}();r.register(Oe);var Re=function(){(0,_createClass3["default"])(ChainDataStore,null,[{key:"initPersistent",value:function initPersistent(e){var t=e.createObjectStore("ChainData",new Me);ChainDataStore._createIndexes(t)}},{key:"getPersistent",value:function getPersistent(e){return new ChainDataStore(e.getObjectStore("ChainData"))}},{key:"createVolatile",value:function createVolatile(){var e=JDB.JungleDB.createVolatileObjectStore();ChainDataStore._createIndexes(e);return new ChainDataStore(e)}},{key:"_createIndexes",value:function _createIndexes(e){e.createIndex("height",["_height"])}}]);function ChainDataStore(e){(0,_classCallCheck3["default"])(this,ChainDataStore);this._store=e}(0,_createClass3["default"])(ChainDataStore,[{key:"getChainData",value:function getChainData(e){return this._store.get(e.toBase64())}},{key:"putChainData",value:function putChainData(e,t){return this._store.put(e.toBase64(),t)}},{key:"getBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee188(e){var t;return _regenerator2["default"].wrap(function _callee188$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.getChainData(e);case 2:t=r.sent;return r.abrupt("return",t?t.head:undefined);case 4:case"end":return r.stop()}},_callee188,this)}));return function getBlock(t){return e.apply(this,arguments)}}()},{key:"getChainDataAt",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee189(e){var t,r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee189$(u){for(;;)switch(u.prev=u.next){case 0:u.next=2;return this._store.values(JDB.Query.eq("height",e));case 2:if((t=u.sent)&&t.length){u.next=5;break}return u.abrupt("return",undefined);case 5:r=!0;n=!1;a=undefined;u.prev=8;i=(0,_getIterator3["default"])(t);case 10:if(r=(s=i.next()).done){u.next=17;break}if(!(o=s.value).onMainChain){u.next=14;break}return u.abrupt("return",o);case 14:r=!0;u.next=10;break;case 17:u.next=23;break;case 19:u.prev=19;u.t0=u["catch"](8);n=!0;a=u.t0;case 23:u.prev=23;u.prev=24;!r&&i["return"]&&i["return"]();case 26:u.prev=26;if(!n){u.next=29;break}throw a;case 29:return u.finish(26);case 30:return u.finish(23);case 31:return u.abrupt("return",undefined);case 32:case"end":return u.stop()}},_callee189,this,[[8,19,23,31],[24,,26,30]])}));return function getChainDataAt(t){return e.apply(this,arguments)}}()},{key:"getBlockAt",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee190(e){var t;return _regenerator2["default"].wrap(function _callee190$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.getChainDataAt(e);case 2:t=r.sent;return r.abrupt("return",t?t.head:undefined);case 4:case"end":return r.stop()}},_callee190,this)}));return function getBlockAt(t){return e.apply(this,arguments)}}()},{key:"getNearestBlockAt",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee191(e){var t,r,n,a,i,s,o,u,c=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1];return _regenerator2["default"].wrap(function _callee191$(l){for(;;)switch(l.prev=l.next){case 0:t=this._store.index("height");if(!c){l.next=7;break}l.next=4;return t.maxValues(JDB.KeyRange.upperBound(e));case 4:l.t0=l.sent;l.next=10;break;case 7:l.next=9;return t.minValues(JDB.KeyRange.lowerBound(e));case 9:l.t0=l.sent;case 10:if((r=l.t0)&&r.length){l.next=13;break}return l.abrupt("return",undefined);case 13:n=!0;a=!1;i=undefined;l.prev=16;s=(0,_getIterator3["default"])(r);case 18:if(n=(o=s.next()).done){l.next=25;break}if(!(u=o.value).onMainChain){l.next=22;break}return l.abrupt("return",u.head);case 22:n=!0;l.next=18;break;case 25:l.next=31;break;case 27:l.prev=27;l.t1=l["catch"](16);a=!0;i=l.t1;case 31:l.prev=31;l.prev=32;!n&&s["return"]&&s["return"]();case 34:l.prev=34;if(!a){l.next=37;break}throw i;case 37:return l.finish(34);case 38:return l.finish(31);case 39:throw new Error("Failed to find main chain block at height "+e);case 40:case"end":return l.stop()}},_callee191,this,[[16,27,31,39],[32,,34,38]])}));return function getNearestBlockAt(t){return e.apply(this,arguments)}}()},{key:"getBlocks",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee192(e){var t,r,n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:500,a=!(arguments.length>2&&arguments[2]!==undefined)||arguments[2];return _regenerator2["default"].wrap(function _callee192$(i){for(;;)switch(i.prev=i.next){case 0:if(!(n<=0)){i.next=2;break}return i.abrupt("return",[]);case 2:a||(e-=n);i.next=5;return this._store.values(JDB.Query.within("height",e,e+n-1));case 5:t=(t=i.sent).filter(function(e){return e.onMainChain}).map(function(e){return e.head});r=a?function(e,t){return e.height-t.height}:function(e,t){return t.height-e.height};t.sort(r);return i.abrupt("return",t);case 10:case"end":return i.stop()}},_callee192,this)}));return function getBlocks(t){return e.apply(this,arguments)}}()},{key:"getHead",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee193(){var e;return _regenerator2["default"].wrap(function _callee193$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._store.get("main");case 2:e=t.sent;return t.abrupt("return",e?U.fromBase64(e):undefined);case 4:case"end":return t.stop()}},_callee193,this)}));return function getHead(){return e.apply(this,arguments)}}()},{key:"setHead",value:function setHead(e){return this._store.put("main",e.toBase64())}},{key:"transaction",value:function transaction(){var e=!(arguments.length>0&&arguments[0]!==undefined)||arguments[0];return new ChainDataStore(this._store.transaction(e))}},{key:"commit",value:function commit(){return this._store.commit()}},{key:"abort",value:function abort(){return this._store.abort()}},{key:"snapshot",value:function snapshot(){var snapshot=this._store.snapshot();return new ChainDataStore(snapshot)}},{key:"truncate",value:function truncate(){return this._store.truncate()}},{key:"tx",get:function get(){return this._store instanceof JDB.Transaction?this._store:undefined}}]);return ChainDataStore}();r.register(Re);var Me=function(){function ChainDataStoreCodec(){(0,_classCallCheck3["default"])(this,ChainDataStoreCodec)}(0,_createClass3["default"])(ChainDataStoreCodec,[{key:"encode",value:function encode(e){return"string"==typeof e?e:e.stripDown()}},{key:"decode",value:function decode(e,t){return"string"==typeof e?e:Oe.copy(e)}},{key:"valueEncoding",get:function get(){return JDB.JungleDB.JSON_ENCODING}}]);return ChainDataStoreCodec}(),Be=function(){function MempoolTransactionSet(e){(0,_classCallCheck3["default"])(this,MempoolTransactionSet);this._transactions=new b(e)}(0,_createClass3["default"])(MempoolTransactionSet,[{key:"add",value:function add(e){this._transactions.add(e);return this}},{key:"remove",value:function remove(e){this._transactions.remove(e);return this}},{key:"copyAndAdd",value:function copyAndAdd(e){var t=this._transactions.copy();t.add(e);return new MempoolTransactionSet(t.values())}},{key:"numBelowFeePerByte",value:function numBelowFeePerByte(e){return this._transactions.values().filter(function(t){return t.fee/t.serializedSize<e}).length}},{key:"toString",value:function toString(){return"MempoolTransactionSet{length="+this.length+"}"}},{key:"transactions",get:function get(){return this._transactions.values()}},{key:"sender",get:function get(){return this._transactions.length>0?this._transactions.values()[0].sender:null}},{key:"senderType",get:function get(){return this._transactions.length>0?this._transactions.values()[0].senderType:undefined}},{key:"length",get:function get(){return this._transactions.length}}]);return MempoolTransactionSet}();r.register(Be);var ze=function(e){(0,_inherits3["default"])(Mempool,e);function Mempool(e,t){(0,_classCallCheck3["default"])(this,Mempool);var r=(0,_possibleConstructorReturn3["default"])(this,(Mempool.__proto__||(0,_getPrototypeOf2["default"])(Mempool)).call(this));r._blockchain=e;r._accounts=t;r._transactionsByHash=new y;r._transactionSetByAddress=new y;r._synchronizer=new f;e.on("head-changed",function(){return r._evictTransactions()});return r}(0,_createClass3["default"])(Mempool,[{key:"pushTransaction",value:function pushTransaction(e){var t=this;return this._synchronizer.push(function(){return t._pushTransaction(e)})}},{key:"_pushTransaction",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee194(e){var t,r,n,i,s,o,u,c,l,h,f;return _regenerator2["default"].wrap(function _callee194$(_){for(;;)switch(_.prev=_.next){case 0:t=e.hash();if(!this._transactionsByHash.contains(t)){_.next=4;break}a.v(Mempool,function(){return"Ignoring known transaction "+t.toBase64()});return _.abrupt("return",Mempool.ReturnCode.KNOWN);case 4:r=this._transactionSetByAddress.get(e.sender)||new Be;if(!(e.fee/e.serializedSize<Mempool.TRANSACTION_RELAY_FEE_MIN&&r.numBelowFeePerByte(Mempool.TRANSACTION_RELAY_FEE_MIN)>=Mempool.FREE_TRANSACTIONS_PER_SENDER_MAX)){_.next=7;break}return _.abrupt("return",Mempool.ReturnCode.FEE_TOO_LOW);case 7:if(e.verify()){_.next=9;break}return _.abrupt("return",Mempool.ReturnCode.INVALID);case 9:void 0;_.prev=10;_.next=13;return this._accounts.get(e.recipient);case 13:_.sent.withIncomingTransaction(e,this._blockchain.height+1);_.next=21;break;case 17:_.prev=17;_.t0=_["catch"](10);a.w(Mempool,"Rejected transaction - "+_.t0.message,e);return _.abrupt("return",Mempool.ReturnCode.INVALID);case 21:n=void 0;_.prev=22;_.next=25;return this._accounts.get(e.sender,e.senderType);case 25:n=_.sent;_.next=32;break;case 28:_.prev=28;_.t1=_["catch"](22);a.w(Mempool,"Rejected transaction - "+_.t1.message,e);return _.abrupt("return",Mempool.ReturnCode.INVALID);case 32:i=[];s=n;o=!0;u=!1;c=undefined;_.prev=37;l=(0,_getIterator3["default"])(r.copyAndAdd(e).transactions);case 39:if(o=(h=l.next()).done){_.next=57;break}f=h.value;_.prev=41;s=s.withOutgoingTransaction(f,this._blockchain.height+1,this._blockchain.transactionCache);i.push(f);_.next=54;break;case 46:_.prev=46;_.t2=_["catch"](41);if(!f.equals(e)){_.next=53;break}a.w(Mempool,"Rejected transaction - "+_.t2.message,e);return _.abrupt("return",Mempool.ReturnCode.INVALID);case 53:this._transactionsByHash.remove(f.hash());case 54:o=!0;_.next=39;break;case 57:_.next=63;break;case 59:_.prev=59;_.t3=_["catch"](37);u=!0;c=_.t3;case 63:_.prev=63;_.prev=64;!o&&l["return"]&&l["return"]();case 66:_.prev=66;if(!u){_.next=69;break}throw c;case 69:return _.finish(66);case 70:return _.finish(63);case 71:this._transactionsByHash.put(t,e);this._transactionSetByAddress.put(e.sender,new Be(i));this.fire("transaction-added",e);return _.abrupt("return",Mempool.ReturnCode.ACCEPTED);case 75:case"end":return _.stop()}},_callee194,this,[[10,17],[22,28],[37,59,63,71],[41,46],[64,,66,70]])}));return function _pushTransaction(t){return e.apply(this,arguments)}}()},{key:"getTransaction",value:function getTransaction(e){return this._transactionsByHash.get(e)}},{key:"getTransactions",value:function getTransactions(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:Infinity,t=[],r=0,n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(this._transactionsByHash.values().sort(function(e,t){return e.compare(t)}));!(n=(s=o.next()).done);n=!0){var u=s.value,c=u.serializedSize;if(!(r+c>=e)){t.push(u);r+=c}}}catch(l){a=!0;i=l}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}return t}},{key:"getTransactionsForBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee195(e){var t,r,n,a;return _regenerator2["default"].wrap(function _callee195$(i){for(;;)switch(i.prev=i.next){case 0:t=this.getTransactions(e);i.next=3;return this._accounts.gatherToBePrunedAccounts(t,this._blockchain.height+1,this._blockchain.transactionCache);case 3:r=i.sent;n=r.reduce(function(e,t){return e+t.serializedSize},0);a=n+t.reduce(function(e,t){return e+t.serializedSize},0);for(;a>e;)a-=t.pop().serializedSize;t.sort(function(e,t){return e.compareBlockOrder(t)});return i.abrupt("return",t);case 9:case"end":return i.stop()}},_callee195,this)}));return function getTransactionsForBlock(t){return e.apply(this,arguments)}}()},{key:"getPendingTransactions",value:function getPendingTransactions(e){var t=this._transactionSetByAddress.get(e);return t?t.transactions:[]}},{key:"_evictTransactions",value:function _evictTransactions(){var e=this;return this._synchronizer.push(function(){return e.__evictTransactions()})}},{key:"__evictTransactions",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee196(){var e,t,r,n,a,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m,b,C;return _regenerator2["default"].wrap(function _callee196$(w){for(;;)switch(w.prev=w.next){case 0:e=!0;t=!1;r=undefined;w.prev=3;n=(0,_getIterator3["default"])(this._transactionSetByAddress.keys());case 5:if(e=(a=n.next()).done){w.next=79;break}i=a.value;s=this._transactionSetByAddress.get(i);w.prev=8;w.next=11;return this._accounts.get(s.sender,s.senderType);case 11:o=w.sent;u=[];c=o;l=!0;h=!1;f=undefined;w.prev=17;_=(0,_getIterator3["default"])(s.transactions);case 19:if(l=(d=_.next()).done){w.next=37;break}p=d.value;w.prev=21;g=c.withOutgoingTransaction(p,this._blockchain.height+1,this._blockchain.transactionCache);w.next=25;return this._accounts.get(p.recipient);case 25:w.sent.withIncomingTransaction(p,this._blockchain.height+1);u.push(p);c=g;w.next=34;break;case 31:w.prev=31;w.t0=w["catch"](21);this._transactionsByHash.remove(p.hash());case 34:l=!0;w.next=19;break;case 37:w.next=43;break;case 39:w.prev=39;w.t1=w["catch"](17);h=!0;f=w.t1;case 43:w.prev=43;w.prev=44;!l&&_["return"]&&_["return"]();case 46:w.prev=46;if(!h){w.next=49;break}throw f;case 49:return w.finish(46);case 50:return w.finish(43);case 51:0===u.length?this._transactionSetByAddress.remove(i):this._transactionSetByAddress.put(i,new Be(u));w.next=76;break;case 54:w.prev=54;w.t2=w["catch"](8);y=!0;v=!1;k=undefined;w.prev=59;for(m=(0,_getIterator3["default"])(s.transactions);!(y=(b=m.next()).done);y=!0){C=b.value;this._transactionsByHash.remove(C.hash())}w.next=67;break;case 63:w.prev=63;w.t3=w["catch"](59);v=!0;k=w.t3;case 67:w.prev=67;w.prev=68;!y&&m["return"]&&m["return"]();case 70:w.prev=70;if(!v){w.next=73;break}throw k;case 73:return w.finish(70);case 74:return w.finish(67);case 75:this._transactionSetByAddress.remove(i);case 76:e=!0;w.next=5;break;case 79:w.next=85;break;case 81:w.prev=81;w.t4=w["catch"](3);t=!0;r=w.t4;case 85:w.prev=85;w.prev=86;!e&&n["return"]&&n["return"]();case 88:w.prev=88;if(!t){w.next=91;break}throw r;case 91:return w.finish(88);case 92:return w.finish(85);case 93:this.fire("transactions-ready");case 94:case"end":return w.stop()}},_callee196,this,[[3,81,85,93],[8,54],[17,39,43,51],[21,31],[44,,46,50],[59,63,67,75],[68,,70,74],[86,,88,92]])}));return function __evictTransactions(){return e.apply(this,arguments)}}()}]);return Mempool}(i);ze.TRANSACTION_RELAY_FEE_MIN=1;ze.FREE_TRANSACTIONS_PER_SENDER_MAX=10;ze.ReturnCode={FEE_TOO_LOW:-2,INVALID:-1,ACCEPTED:1,KNOWN:2};r.register(ze);var Le=function(e){(0,_inherits3["default"])(BaseConsensusAgent,e);function BaseConsensusAgent(e){(0,_classCallCheck3["default"])(this,BaseConsensusAgent);var t=(0,_possibleConstructorReturn3["default"])(this,(BaseConsensusAgent.__proto__||(0,_getPrototypeOf2["default"])(BaseConsensusAgent)).call(this));t._peer=e;t._synced=!1;t._knownObjects=new v;t._knownObjects.add(new at(at.Type.BLOCK,e.headHash));t._objectsToRequest=new v;t._objectsInFlight=new v;t._objectsThatFlew=new v;t._objectsProcessing=new v;t._remoteSubscription=de.NONE;t._timers=new _;t._waitingInvVectors=new m;t._timers.setInterval("invVectors",function(){return t._sendWaitingInvVectors()},BaseConsensusAgent.TRANSACTION_RELAY_INTERVAL);t._waitingFreeInvVectors=new m;t._timers.setInterval("freeInvVectors",function(){return t._sendFreeWaitingInvVectors()},BaseConsensusAgent.FREE_TRANSACTION_RELAY_INTERVAL);e.channel.on("inv",function(e){return t._onInv(e)});e.channel.on("block",function(e){return t._onBlock(e)});e.channel.on("header",function(e){return t._onHeader(e)});e.channel.on("tx",function(e){return t._onTx(e)});e.channel.on("not-found",function(e){return t._onNotFound(e)});e.channel.on("subscribe",function(e){return t._onSubscribe(e)});e.channel.on("get-data",function(e){return t._onGetData(e)});e.channel.on("get-header",function(e){return t._onGetHeader(e)});e.channel.on("close",function(){return t._onClose()});return t}(0,_createClass3["default"])(BaseConsensusAgent,[{key:"relayBlock",value:function relayBlock(e){if(!this._synced)return!1;if(!this._remoteSubscription.matchesBlock(e))return!1;var t=at.fromBlock(e);if(this._knownObjects.contains(t))return!1;this._peer.channel.inv([t].concat((0,_toConsumableArray3["default"])(this._waitingInvVectors.dequeueMulti(it.VECTORS_MAX_COUNT-1))));this._knownObjects.add(t);return!0}},{key:"_sendWaitingInvVectors",value:function _sendWaitingInvVectors(){var e=this._waitingInvVectors.dequeueMulti(it.VECTORS_MAX_COUNT);if(e.length>0){this._peer.channel.inv(e);a.v(BaseConsensusAgent,"[INV] Sent "+e.length+" vectors to "+this._peer.peerAddress)}}},{key:"_sendFreeWaitingInvVectors",value:function _sendFreeWaitingInvVectors(){for(var e=[],t=0;e.length<=it.VECTORS_MAX_COUNT&&this._waitingFreeInvVectors.length>0&&t<BaseConsensusAgent.FREE_TRANSACTION_SIZE_PER_INTERVAL;){var r=this._waitingFreeInvVectors.dequeue(),n=r.serializedSize,i=r.vector;e.push(i);t+=n}if(e.length>0){this._peer.channel.inv(e);a.v(BaseConsensusAgent,"[INV] Sent "+e.length+" vectors to "+this._peer.peerAddress)}}},{key:"relayTransaction",value:function relayTransaction(e){if(!this._remoteSubscription.matchesTransaction(e))return!1;var t=at.fromTransaction(e);if(this._knownObjects.contains(t))return!1;var r=e.serializedSize;e.fee/r<BaseConsensusAgent.TRANSACTION_RELAY_FEE_MIN?this._waitingFreeInvVectors.enqueue({serializedSize:r,vector:t}):this._waitingInvVectors.enqueue(t);this._knownObjects.add(t);return!0}},{key:"knowsBlock",value:function knowsBlock(e){var t=new at(at.Type.BLOCK,e);return this._knownObjects.contains(t)}},{key:"_onSubscribe",value:function _onSubscribe(e){a.d(BaseConsensusAgent,"[SUBSCRIBE] "+this._peer.peerAddress+" "+e.subscription);this._remoteSubscription=e.subscription}},{key:"_onInv",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee197(e){var t,r,n,i,s,o,u,c,l,h,f,_,d,p,g,y=this;return _regenerator2["default"].wrap(function _callee197$(v){for(;;)switch(v.prev=v.next){case 0:t=!0;r=!1;n=undefined;v.prev=3;for(i=(0,_getIterator3["default"])(e.vectors);!(t=(s=i.next()).done);t=!0){o=s.value;this._knownObjects.add(o);this._waitingInvVectors.remove(o)}v.next=11;break;case 7:v.prev=7;v.t0=v["catch"](3);r=!0;n=v.t0;case 11:v.prev=11;v.prev=12;!t&&i["return"]&&i["return"]();case 14:v.prev=14;if(!r){v.next=17;break}throw n;case 17:return v.finish(14);case 18:return v.finish(11);case 19:u=[];c=!0;l=!1;h=undefined;v.prev=23;f=(0,_getIterator3["default"])(e.vectors);case 25:if(c=(_=f.next()).done){v.next=48;break}d=_.value;if(!this._objectsInFlight.contains(d)&&!this._objectsProcessing.contains(d)){v.next=29;break}return v.abrupt("continue",45);case 29:if(this._shouldRequestData(d)){v.next=31;break}return v.abrupt("continue",45);case 31:v.t1=d.type;v.next=v.t1===at.Type.BLOCK?34:v.t1===at.Type.TRANSACTION?39:44;break;case 34:v.next=36;return this._getBlock(d.hash,!0);case 36:if(p=v.sent)this._onKnownBlockAnnounced(d.hash,p);else{u.push(d);this._onNewBlockAnnounced(d.hash)}return v.abrupt("break",45);case 39:v.next=41;return this._getTransaction(d.hash);case 41:if(g=v.sent)this._onKnownTransactionAnnounced(d.hash,g);else{u.push(d);this._onNewTransactionAnnounced(d.hash)}return v.abrupt("break",45);case 44:throw"Invalid inventory type: "+d.type;case 45:c=!0;v.next=25;break;case 48:v.next=54;break;case 50:v.prev=50;v.t2=v["catch"](23);l=!0;h=v.t2;case 54:v.prev=54;v.prev=55;!c&&f["return"]&&f["return"]();case 57:v.prev=57;if(!l){v.next=60;break}throw h;case 60:return v.finish(57);case 61:return v.finish(54);case 62:a.v(BaseConsensusAgent,"[INV] "+e.vectors.length+" vectors ("+u.length+" new) received from "+this._peer.peerAddress);if(u.length>0){this._objectsToRequest.addAll(u);this._timers.clearTimeout("inv");this._objectsToRequest.length>=BaseConsensusAgent.REQUEST_THRESHOLD?this._requestData():this._timers.setTimeout("inv",function(){return y._requestData()},BaseConsensusAgent.REQUEST_THROTTLE)}else this._onNoUnknownObjects();case 64:case"end":return v.stop()}},_callee197,this,[[3,7,11,19],[12,,14,18],[23,50,54,62],[55,,57,61]])}));return function _onInv(t){return e.apply(this,arguments)}}()},{key:"_shouldRequestData",value:function _shouldRequestData(e){return!0}},{key:"_getBlock",value:function _getBlock(e){arguments.length>1&&arguments[1]!==undefined&&arguments[1];throw new Error("not implemented")}},{key:"_getTransaction",value:function _getTransaction(e){throw new Error("not implemented")}},{key:"_onNewBlockAnnounced",value:function _onNewBlockAnnounced(e){}},{key:"_onKnownBlockAnnounced",value:function _onKnownBlockAnnounced(e,t){}},{key:"_onNewTransactionAnnounced",value:function _onNewTransactionAnnounced(e){}},{key:"_onKnownTransactionAnnounced",value:function _onKnownTransactionAnnounced(e,t){}},{key:"_requestData",value:function _requestData(){var e=this;if(this._objectsInFlight.isEmpty()&&!this._objectsToRequest.isEmpty()){var t=it.VECTORS_MAX_COUNT,r=(0,_from2["default"])(new k(this._objectsToRequest.valueIterator(),t));this._objectsInFlight.addAll(r);this._objectsToRequest.removeAll(r);this._doRequestData(r);this._timers.setTimeout("getData",function(){return e._noMoreData()},BaseConsensusAgent.REQUEST_TIMEOUT)}}},{key:"_doRequestData",value:function _doRequestData(e){this._peer.channel.getData(e)}},{key:"_onBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee198(e){var t,r,n,i,s,o,u=this;return _regenerator2["default"].wrap(function _callee198$(c){for(;;)switch(c.prev=c.next){case 0:t=e.block.hash();r=new at(at.Type.BLOCK,t);if(this._objectsInFlight.contains(r)||this._objectsThatFlew.contains(r)){c.next=5;break}a.w(BaseConsensusAgent,"Unsolicited block "+t+" received from "+this._peer.peerAddress+", discarding");return c.abrupt("return");case 5:n=e.block.isFull()?e.block.body.transactions:[];i=n.map(function(e){return u._getTransaction(e.hash())});s=0;case 8:if(!(s<n.length)){c.next=16;break}c.next=11;return i[s];case 11:(o=c.sent)&&(n[s]=o);case 13:s++;c.next=8;break;case 16:this._onObjectReceived(r);this._objectsProcessing.add(r);c.next=20;return this._processBlock(t,e.block);case 20:this._onObjectProcessed(r);case 21:case"end":return c.stop()}},_callee198,this)}));return function _onBlock(t){return e.apply(this,arguments)}}()},{key:"_processBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee199(e,t){return _regenerator2["default"].wrap(function _callee199$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee199,this)}));return function _processBlock(t,r){return e.apply(this,arguments)}}()},{key:"_onHeader",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee200(e){var t,r;return _regenerator2["default"].wrap(function _callee200$(n){for(;;)switch(n.prev=n.next){case 0:t=e.header.hash();r=new at(at.Type.BLOCK,t);if(this._objectsInFlight.contains(r)||this._objectsThatFlew.contains(r)){n.next=5;break}a.w(BaseConsensusAgent,"Unsolicited header "+t+" received from "+this._peer.peerAddress+", discarding");return n.abrupt("return");case 5:this._onObjectReceived(r);this._objectsProcessing.add(r);n.next=9;return this._processHeader(t,e.header);case 9:this._onObjectProcessed(r);case 10:case"end":return n.stop()}},_callee200,this)}));return function _onHeader(t){return e.apply(this,arguments)}}()},{key:"_processHeader",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee201(e,t){return _regenerator2["default"].wrap(function _callee201$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee201,this)}));return function _processHeader(t,r){return e.apply(this,arguments)}}()},{key:"_onTx",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee202(e){var t,r;return _regenerator2["default"].wrap(function _callee202$(n){for(;;)switch(n.prev=n.next){case 0:t=e.transaction.hash();r=new at(at.Type.TRANSACTION,t);if(this._objectsInFlight.contains(r)||this._objectsThatFlew.contains(r)){n.next=5;break}a.w(BaseConsensusAgent,"Unsolicited transaction "+t+" received from "+this._peer.peerAddress+", discarding");return n.abrupt("return");case 5:this._onObjectReceived(r);this._objectsProcessing.add(r);n.next=9;return this._processTransaction(t,e.transaction);case 9:this._onObjectProcessed(r);case 10:case"end":return n.stop()}},_callee202,this)}));return function _onTx(t){return e.apply(this,arguments)}}()},{key:"_processTransaction",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee203(e,t){return _regenerator2["default"].wrap(function _callee203$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee203,this)}));return function _processTransaction(t,r){return e.apply(this,arguments)}}()},{key:"_onNotFound",value:function _onNotFound(e){a.d(BaseConsensusAgent,"[NOTFOUND] "+e.vectors.length+" unknown objects received from "+this._peer.peerAddress);var t=!0,r=!1,n=undefined;try{for(var i,s=(0,_getIterator3["default"])(e.vectors);!(t=(i=s.next()).done);t=!0){var o=i.value;this._objectsInFlight.contains(o)&&this._onObjectReceived(o)}}catch(u){r=!0;n=u}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}}},{key:"_onObjectReceived",value:function _onObjectReceived(e){var t=this;if(!this._objectsInFlight.isEmpty()){this._objectsInFlight.remove(e);this._objectsInFlight.isEmpty()?this._noMoreData():this._timers.resetTimeout("getData",function(){return t._noMoreData()},BaseConsensusAgent.REQUEST_TIMEOUT)}}},{key:"_noMoreData",value:function _noMoreData(){this._timers.clearTimeout("getData");this._objectsThatFlew.addAll(this._objectsInFlight.values());this._objectsInFlight.clear();this._objectsToRequest.isEmpty()?this._onAllObjectsReceived():this._requestData()}},{key:"_onNoUnknownObjects",value:function _onNoUnknownObjects(){}},{key:"_onAllObjectsReceived",value:function _onAllObjectsReceived(){}},{key:"_onObjectProcessed",value:function _onObjectProcessed(e){this._objectsProcessing.remove(e);this._objectsProcessing.isEmpty()&&this._onAllObjectsProcessed()}},{key:"_onAllObjectsProcessed",value:function _onAllObjectsProcessed(){}},{key:"_onGetData",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee204(e){var t,r,n,a,i,s,o,u,c,l,h,f,_,d,p;return _regenerator2["default"].wrap(function _callee204$(g){for(;;)switch(g.prev=g.next){case 0:t=!0;r=!1;n=undefined;g.prev=3;for(a=(0,_getIterator3["default"])(e.vectors);!(t=(i=a.next()).done);t=!0){s=i.value;this._knownObjects.add(s)}g.next=11;break;case 7:g.prev=7;g.t0=g["catch"](3);r=!0;n=g.t0;case 11:g.prev=11;g.prev=12;!t&&a["return"]&&a["return"]();case 14:g.prev=14;if(!r){g.next=17;break}throw n;case 17:return g.finish(14);case 18:return g.finish(11);case 19:o=[];u=!0;c=!1;l=undefined;g.prev=23;h=(0,_getIterator3["default"])(e.vectors);case 25:if(u=(f=h.next()).done){g.next=44;break}_=f.value;g.t1=_.type;g.next=g.t1===at.Type.BLOCK?30:g.t1===at.Type.TRANSACTION?35:40;break;case 30:g.next=32;return this._getBlock(_.hash);case 32:(d=g.sent)&&d.isFull()?this._peer.channel.block(d):o.push(_);return g.abrupt("break",41);case 35:g.next=37;return this._getTransaction(_.hash);case 37:(p=g.sent)?this._peer.channel.tx(p):o.push(_);return g.abrupt("break",41);case 40:throw"Invalid inventory type: "+_.type;case 41:u=!0;g.next=25;break;case 44:g.next=50;break;case 46:g.prev=46;g.t2=g["catch"](23);c=!0;l=g.t2;case 50:g.prev=50;g.prev=51;!u&&h["return"]&&h["return"]();case 53:g.prev=53;if(!c){g.next=56;break}throw l;case 56:return g.finish(53);case 57:return g.finish(50);case 58:o.length&&this._peer.channel.notFound(o);case 59:case"end":return g.stop()}},_callee204,this,[[3,7,11,19],[12,,14,18],[23,46,50,58],[51,,53,57]])}));return function _onGetData(t){return e.apply(this,arguments)}}()},{key:"_onGetHeader",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee205(e){var t,r,n,a,i,s,o,u,c,l,h,f,_,d;return _regenerator2["default"].wrap(function _callee205$(p){for(;;)switch(p.prev=p.next){case 0:t=!0;r=!1;n=undefined;p.prev=3;for(a=(0,_getIterator3["default"])(e.vectors);!(t=(i=a.next()).done);t=!0){s=i.value;this._knownObjects.add(s)}p.next=11;break;case 7:p.prev=7;p.t0=p["catch"](3);r=!0;n=p.t0;case 11:p.prev=11;p.prev=12;!t&&a["return"]&&a["return"]();case 14:p.prev=14;if(!r){p.next=17;break}throw n;case 17:return p.finish(14);case 18:return p.finish(11);case 19:o=[];u=!0;c=!1;l=undefined;p.prev=23;h=(0,_getIterator3["default"])(e.vectors);case 25:if(u=(f=h.next()).done){p.next=39;break}_=f.value;p.t1=_.type;p.next=p.t1===at.Type.BLOCK?30:(p.t1,at.Type.TRANSACTION,35);break;case 30:p.next=32;return this._getBlock(_.hash);case 32:(d=p.sent)?this._peer.channel.header(d.header):o.push(_);return p.abrupt("break",36);case 35:throw"Invalid inventory type: "+_.type;case 36:u=!0;p.next=25;break;case 39:p.next=45;break;case 41:p.prev=41;p.t2=p["catch"](23);c=!0;l=p.t2;case 45:p.prev=45;p.prev=46;!u&&h["return"]&&h["return"]();case 48:p.prev=48;if(!c){p.next=51;break}throw l;case 51:return p.finish(48);case 52:return p.finish(45);case 53:o.length&&this._peer.channel.notFound(o);case 54:case"end":return p.stop()}},_callee205,this,[[3,7,11,19],[12,,14,18],[23,41,45,53],[46,,48,52]])}));return function _onGetHeader(t){return e.apply(this,arguments)}}()},{key:"_onClose",value:function _onClose(){this._timers.clearAll();this.fire("close",this)}},{key:"peer",get:function get(){return this._peer}},{key:"synced",get:function get(){return this._synced}}]);return BaseConsensusAgent}(i);Le.REQUEST_THRESHOLD=50;Le.REQUEST_THROTTLE=500;Le.REQUEST_TIMEOUT=1e4;Le.TRANSACTION_RELAY_INTERVAL=5e3;Le.FREE_TRANSACTION_RELAY_INTERVAL=6e3;Le.FREE_TRANSACTION_SIZE_PER_INTERVAL=15e3;Le.TRANSACTION_RELAY_FEE_MIN=1;r.register(Le);var Ue=function(e){(0,_inherits3["default"])(FullChain,e);(0,_createClass3["default"])(FullChain,null,[{key:"getPersistent",value:function getPersistent(e,t,r,n){return new FullChain(Re.getPersistent(e),t,r,n)._init()}},{key:"createVolatile",value:function createVolatile(e,t,r){return new FullChain(Re.createVolatile(),e,t,r)._init()}}]);function FullChain(e,t,r,n){(0,_classCallCheck3["default"])(this,FullChain);var a=(0,_possibleConstructorReturn3["default"])(this,(FullChain.__proto__||(0,_getPrototypeOf2["default"])(FullChain)).call(this,e));a._accounts=t;a._time=r;a._snapshots=new y;a._snapshotOrder=[];a._mainChain=null;a._proof=null;a._transactionCache=new me;a._transactionStore=n;a._synchronizer=new f;a._blockKnownCount=a._blockInvalidCount=a._blockOrphanCount=a._blockExtendedCount=a._blockRebranchedCount=a._blockForkedCount=0;return a}(0,_createClass3["default"])(FullChain,[{key:"_init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee206(){var e,t;return _regenerator2["default"].wrap(function _callee206$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._store.getHead();case 2:this._headHash=r.sent;if(!this._headHash){r.next=21;break}r.next=6;return this._store.getChainData(this._headHash);case 6:this._mainChain=r.sent;C.that(!!this._mainChain,"Failed to load main chain from storage");r.t0=C;r.t1=this._mainChain.head.accountsHash;r.next=12;return this._accounts.hash();case 12:r.t2=r.sent;r.t3=r.t1.equals.call(r.t1,r.t2);r.t0.that.call(r.t0,r.t3,"Corrupted store: Inconsistent chain/accounts state");r.next=17;return this.getBlocks(this.head.height,this._transactionCache.missingBlocks-1,!1);case 17:e=r.sent;this._transactionCache.prependBlocks([].concat((0,_toConsumableArray3["default"])(e.reverse()),[this._mainChain.head]));r.next=40;break;case 21:r.t4=Oe;r.t5=Se.GENESIS;r.t6=Se.GENESIS.difficulty;r.t7=_e;r.next=27;return Se.GENESIS.pow();case 27:r.t8=r.sent;r.t9=r.t7.realDifficulty.call(r.t7,r.t8);this._mainChain=new r.t4(r.t5,r.t6,r.t9,!0);this._headHash=Se.GENESIS.HASH;t=this._store.transaction();r.next=34;return t.putChainData(Se.GENESIS.HASH,this._mainChain);case 34:r.next=36;return t.setHead(Se.GENESIS.HASH);case 36:r.next=38;return t.commit();case 38:r.next=40;return this._accounts.initialize(Se.GENESIS,ce.GENESIS);case 40:return r.abrupt("return",this);case 41:case"end":return r.stop()}},_callee206,this)}));return function _init(){return e.apply(this,arguments)}}()},{key:"pushBlock",value:function pushBlock(e){var t=this;return this._synchronizer.push(function(){return t._pushBlock(e)})}},{key:"_pushBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee207(e){var t,r,n,i,s,o,u;return _regenerator2["default"].wrap(function _callee207$(c){for(;;)switch(c.prev=c.next){case 0:t=e.hash();c.next=3;return this._store.getBlock(t);case 3:if(!c.sent){c.next=8;break}a.v(FullChain,"Ignoring known block "+t);this._blockKnownCount++;return c.abrupt("return",FullChain.OK_KNOWN);case 8:if(e.isFull()){c.next=12;break}a.w(FullChain,"Rejecting block - body missing");this._blockInvalidCount++;return c.abrupt("return",FullChain.ERR_INVALID);case 12:c.next=14;return e.verify(this._time);case 14:if(c.sent){c.next=17;break}this._blockInvalidCount++;return c.abrupt("return",FullChain.ERR_INVALID);case 17:c.next=19;return this._store.getChainData(e.prevHash);case 19:if(r=c.sent){c.next=24;break}a.w(FullChain,"Rejecting block - unknown predecessor");this._blockOrphanCount++;return c.abrupt("return",FullChain.ERR_ORPHAN);case 24:n=r.head;c.next=27;return e.isImmediateSuccessorOf(n);case 27:if(c.sent){c.next=31;break}a.w(FullChain,"Rejecting block - not a valid immediate successor");this._blockInvalidCount++;return c.abrupt("return",FullChain.ERR_INVALID);case 31:c.next=33;return this.getNextTarget(n);case 33:i=c.sent;C.that(_e.isValidTarget(i),"Failed to compute next target in FullChain");if(e.nBits===_e.targetToCompact(i)){c.next=39;break}a.w(FullChain,"Rejecting block - difficulty mismatch");this._blockInvalidCount++;return c.abrupt("return",FullChain.ERR_INVALID);case 39:s=r.totalDifficulty+e.difficulty;c.t0=r.totalWork;c.t1=_e;c.next=44;return e.pow();case 44:c.t2=c.sent;c.t3=c.t1.realDifficulty.call(c.t1,c.t2);o=c.t0+c.t3;u=new Oe(e,s,o);if(!e.prevHash.equals(this.headHash)){c.next=56;break}c.next=51;return this._extend(t,u);case 51:if(c.sent){c.next=54;break}this._blockInvalidCount++;return c.abrupt("return",FullChain.ERR_INVALID);case 54:this._blockExtendedCount++;return c.abrupt("return",FullChain.OK_EXTENDED);case 56:if(!(s>this.totalDifficulty)){c.next=64;break}c.next=59;return this._rebranch(t,u);case 59:if(c.sent){c.next=62;break}this._blockInvalidCount++;return c.abrupt("return",FullChain.ERR_INVALID);case 62:this._blockRebranchedCount++;return c.abrupt("return",FullChain.OK_REBRANCHED);case 64:a.v(FullChain,"Creating/extending fork with block "+t+", height="+e.height+", totalDifficulty="+u.totalDifficulty+", totalWork="+u.totalWork);c.next=67;return this._store.putChainData(t,u);case 67:this._blockForkedCount++;return c.abrupt("return",FullChain.OK_FORKED);case 69:case"end":return c.stop()}},_callee207,this)}));return function _pushBlock(t){return e.apply(this,arguments)}}()},{key:"_verifyInterlink",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee208(e){var t,r;return _regenerator2["default"].wrap(function _callee208$(n){for(;;)switch(n.prev=n.next){case 0:t=0;case 1:if(!(t<e.interlink.length)){n.next=15;break}n.next=4;return this._store.getBlock(e.interlink.hashes[t]);case 4:r=n.sent;n.t0=!r;if(n.t0){n.next=10;break}n.next=9;return e.isInterlinkSuccessorOf(r);case 9:n.t0=!n.sent;case 10:if(!n.t0){n.next=12;break}return n.abrupt("return",!1);case 12:t++;n.next=1;break;case 15:return n.abrupt("return",!0);case 16:case"end":return n.stop()}},_callee208,this)}));return function _verifyInterlink(t){return e.apply(this,arguments)}}()},{key:"_extend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee209(e,t){var r,n,i;return _regenerator2["default"].wrap(function _callee209$(s){for(;;)switch(s.prev=s.next){case 0:s.next=2;return this._accounts.transaction();case 2:r=s.sent;s.prev=3;s.next=6;return r.commitBlock(t.head,this._transactionCache);case 6:s.next=13;break;case 8:s.prev=8;s.t0=s["catch"](3);a.w(FullChain,"Rejecting block - failed to commit to AccountsTree: "+(s.t0.message||s.t0));r.abort()["catch"](a.w.tag(FullChain));return s.abrupt("return",!1);case 13:t.onMainChain=!0;s.next=16;return this._store.transaction();case 16:n=s.sent;s.next=19;return n.putChainData(e,t);case 19:s.next=21;return n.setHead(e);case 21:if(!this._transactionStore){s.next=29;break}i=this._transactionStore.transaction();s.next=25;return i.put(t.head);case 25:s.next=27;return JDB.JungleDB.commitCombined(n.tx,r.tx,i.tx);case 27:s.next=31;break;case 29:s.next=31;return JDB.JungleDB.commitCombined(n.tx,r.tx);case 31:s.next=33;return this._saveSnapshot(e);case 33:this._transactionCache.pushBlock(t.head);if(!this._proof){s.next=38;break}s.next=37;return this._extendChainProof(this._proof,t.head.header);case 37:this._proof=s.sent;case 38:this._mainChain=t;this._headHash=e;this.fire("head-changed",this.head,!1);return s.abrupt("return",!0);case 42:case"end":return s.stop()}},_callee209,this,[[3,8]])}));return function _extend(t,r){return e.apply(this,arguments)}}()},{key:"_rebranch",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee210(e,t){var r,n,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m,b,w,A,S,T;return _regenerator2["default"].wrap(function _callee210$(x){for(;;)switch(x.prev=x.next){case 0:a.v(FullChain,"Rebranching to fork "+e+", height="+t.head.height+", totalDifficulty="+t.totalDifficulty+", totalWork="+t.totalWork);r=!0;n=!1;i=undefined;x.prev=4;for(s=(0,_getIterator3["default"])(this._snapshotOrder);!(r=(o=s.next()).done);r=!0){u=o.value;this._snapshots.get(u).abort()}x.next=12;break;case 8:x.prev=8;x.t0=x["catch"](4);n=!0;i=x.t0;case 12:x.prev=12;x.prev=13;!r&&s["return"]&&s["return"]();case 15:x.prev=15;if(!n){x.next=18;break}throw i;case 18:return x.finish(15);case 19:return x.finish(12);case 20:this._snapshots.clear();this._snapshotOrder=[];c=[];l=[];h=t;f=e;case 26:if(h.onMainChain){x.next=36;break}c.push(h);l.push(f);f=h.head.prevHash;x.next=32;return this._store.getChainData(f);case 32:h=x.sent;C.that(!!h,"Corrupted store: Failed to find fork predecessor while rebranching");x.next=26;break;case 36:a.v(FullChain,function(){return"Found common ancestor "+f.toBase64()+" "+c.length+" blocks up"});x.next=39;return this._accounts.transaction(!1);case 39:_=x.sent;d=this._transactionCache.clone();p=this._transactionStore?this._transactionStore.transaction():null;g=this._headHash;y=this._mainChain.head;case 44:if(g.equals(f)){x.next=74;break}x.prev=45;x.next=48;return _.revertBlock(y,d);case 48:d.revertBlock(y);if(!this._transactionStore){x.next=52;break}x.next=52;return p.remove(y);case 52:x.next=60;break;case 54:x.prev=54;x.t1=x["catch"](45);a.e(FullChain,"Failed to revert main chain while rebranching",x.t1);_.abort()["catch"](a.w.tag(FullChain));this._transactionStore&&p.abort()["catch"](a.w.tag(FullChain));return x.abrupt("return",!1);case 60:g=y.prevHash;x.next=63;return this._store.getBlock(g);case 63:y=x.sent;C.that(!!y,"Corrupted store: Failed to find main chain predecessor while rebranching");x.t2=C;x.t3=y.accountsHash;x.next=69;return _.hash();case 69:x.t4=x.sent;x.t5=x.t3.equals.call(x.t3,x.t4);x.t2.that.call(x.t2,x.t5,"Failed to revert main chain - inconsistent state");x.next=44;break;case 74:v=d.missingBlocks;x.next=77;return this.getBlocks(y.height,v,!1);case 77:k=x.sent;d.prependBlocks(k.reverse());m=c.length-1;case 80:if(!(m>=0)){x.next=99;break}x.prev=81;x.next=84;return _.commitBlock(c[m].head,d);case 84:d.pushBlock(c[m].head);if(!this._transactionStore){x.next=88;break}x.next=88;return p.put(c[m].head);case 88:x.next=96;break;case 90:x.prev=90;x.t6=x["catch"](81);a.e(FullChain,"Failed to apply fork block while rebranching",x.t6);_.abort()["catch"](a.w.tag(FullChain));this._transactionStore&&p.abort()["catch"](a.w.tag(FullChain));return x.abrupt("return",!1);case 96:m--;x.next=80;break;case 99:b=this._store.transaction(!1);g=this._headHash;w=this._mainChain;case 102:if(g.equals(f)){x.next=113;break}w.onMainChain=!1;x.next=106;return b.putChainData(g,w);case 106:g=w.head.prevHash;x.next=109;return b.getChainData(g);case 109:w=x.sent;C.that(!!w,"Corrupted store: Failed to find main chain predecessor while rebranching");x.next=102;break;case 113:A=c.length-1;case 114:if(!(A>=0)){x.next=122;break}(S=c[A]).onMainChain=!0;x.next=119;return b.putChainData(l[A],S);case 119:A--;x.next=114;break;case 122:x.next=124;return b.setHead(e);case 124:if(!this._transactionStore){x.next=129;break}x.next=127;return JDB.JungleDB.commitCombined(b.tx,_.tx,p.tx);case 127:x.next=131;break;case 129:x.next=131;return JDB.JungleDB.commitCombined(b.tx,_.tx);case 131:this._transactionCache=d;this._proof=null;for(T=c.length-1;T>=0;T--){this._mainChain=c[T];this._headHash=l[T];this.fire("head-changed",this.head,T>0)}return x.abrupt("return",!0);case 135:case"end":return x.stop()}},_callee210,this,[[4,8,12,20],[13,,15,19],[45,54],[81,90]])}));return function _rebranch(t,r){return e.apply(this,arguments)}}()},{key:"getBlocks",value:function getBlocks(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:500,r=!(arguments.length>2&&arguments[2]!==undefined)||arguments[2];return this._store.getBlocks(e,t,r)}},{key:"getChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee211(){return _regenerator2["default"].wrap(function _callee211$(e){for(;;)switch(e.prev=e.next){case 0:if(this._proof){e.next=4;break}e.next=3;return this._getChainProof();case 3:this._proof=e.sent;case 4:return e.abrupt("return",this._proof);case 5:case"end":return e.stop()}},_callee211,this)}));return function getChainProof(){return e.apply(this,arguments)}}()},{key:"getAccountsTreeChunk",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee212(e,t){var r;return _regenerator2["default"].wrap(function _callee212$(n){for(;;)switch(n.prev=n.next){case 0:n.next=2;return this._getSnapshot(e);case 2:r=n.sent;n.t0=r;if(!n.t0){n.next=8;break}n.next=7;return r.getAccountsTreeChunk(t);case 7:n.t0=n.sent;case 8:return n.abrupt("return",n.t0);case 9:case"end":return n.stop()}},_callee212,this)}));return function getAccountsTreeChunk(t,r){return e.apply(this,arguments)}}()},{key:"getAccountsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee213(e,t){var r;return _regenerator2["default"].wrap(function _callee213$(n){for(;;)switch(n.prev=n.next){case 0:n.next=2;return this._getSnapshot(e);case 2:r=n.sent;n.t0=r;if(!n.t0){n.next=8;break}n.next=7;return r.getAccountsProof(t);case 7:n.t0=n.sent;case 8:return n.abrupt("return",n.t0);case 9:case"end":return n.stop()}},_callee213,this)}));return function getAccountsProof(t,r){return e.apply(this,arguments)}}()},{key:"getTransactionsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee214(e,t){var r,n,a,i,s,o,u,c,l,h;return _regenerator2["default"].wrap(function _callee214$(f){for(;;)switch(f.prev=f.next){case 0:f.next=2;return this.getBlock(e);case 2:if((r=f.sent)&&r.isFull()){f.next=5;break}return f.abrupt("return",null);case 5:n=[];(a=new v).addAll(t);i=!0;s=!1;o=undefined;f.prev=11;for(u=(0,_getIterator3["default"])(r.transactions);!(i=(c=u.next()).done);i=!0){l=c.value;(a.contains(l.sender)||a.contains(l.recipient))&&n.push(l)}f.next=19;break;case 15:f.prev=15;f.t0=f["catch"](11);s=!0;o=f.t0;case 19:f.prev=19;f.prev=20;!i&&u["return"]&&u["return"]();case 22:f.prev=22;if(!s){f.next=25;break}throw o;case 25:return f.finish(22);case 26:return f.finish(19);case 27:h=R.compute(r.body.getMerkleLeafs(),n);return f.abrupt("return",new ke(n,h));case 29:case"end":return f.stop()}},_callee214,this,[[11,15,19,27],[20,,22,26]])}));return function getTransactionsProof(t,r){return e.apply(this,arguments)}}()},{key:"getTransactionReceiptsByAddress",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee215(e){var t,r,n;return _regenerator2["default"].wrap(function _callee215$(a){for(;;)switch(a.prev=a.next){case 0:if(this._transactionStore){a.next=2;break}throw new Error("Invalid request");case 2:t=[];a.next=5;return this._transactionStore.getBySender(e);case 5:r=a.sent;a.next=8;return this._transactionStore.getByRecipient(e);case 8:n=a.sent;r.forEach(function(e){t.push(new Ae(e.transactionHash,e.blockHash))});n.forEach(function(e){t.push(new Ae(e.transactionHash,e.blockHash))});return a.abrupt("return",t);case 12:case"end":return a.stop()}},_callee215,this)}));return function getTransactionReceiptsByAddress(t){return e.apply(this,arguments)}}()},{key:"getTransactionInfoByHash",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee216(e){var t;return _regenerator2["default"].wrap(function _callee216$(r){for(;;)switch(r.prev=r.next){case 0:if(this._transactionStore){r.next=2;break}throw new Error("Invalid request");case 2:r.next=4;return this._transactionStore.get(e);case 4:if(t=r.sent){r.next=7;break}return r.abrupt("return",null);case 7:return r.abrupt("return",t);case 8:case"end":return r.stop()}},_callee216,this)}));return function getTransactionInfoByHash(t){return e.apply(this,arguments)}}()},{key:"_getSnapshot",value:function _getSnapshot(e){var t=this;return this._synchronizer.push((0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee217(){var r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee217$(u){for(;;)switch(u.prev=u.next){case 0:u.next=2;return t.getBlock(e);case 2:if((r=u.sent)&&!(t._mainChain.head.height-r.height>z.NUM_SNAPSHOTS_MAX)){u.next=5;break}return u.abrupt("return",null);case 5:n=null;if(t._snapshots.contains(e)){u.next=32;break}u.next=9;return t._accounts.transaction();case 9:a=u.sent;i=t._transactionCache.clone();s=t._headHash;case 12:if(r.prevHash.equals(s)){u.next=28;break}u.next=15;return t.getBlock(s);case 15:o=u.sent;if(t._snapshots.contains(s)){u.next=22;break}u.next=19;return t._accounts.snapshot(a);case 19:n=u.sent;t._snapshots.put(s,n);t._snapshotOrder.unshift(s);case 22:u.next=24;return a.revertBlock(o,i);case 24:i.revertBlock(o);s=o.prevHash;u.next=12;break;case 28:u.next=30;return a.abort();case 30:u.next=33;break;case 32:n=t._snapshots.get(e);case 33:u.t0=C;u.t1=r.accountsHash;u.next=37;return n.hash();case 37:u.t2=u.sent;u.t3=u.t1.equals.call(u.t1,u.t2);u.t0.that.call(u.t0,u.t3,"AccountsHash mismatch for snapshot of block ${blockHash}");return u.abrupt("return",n);case 41:case"end":return u.stop()}},_callee217,t)})))}},{key:"_saveSnapshot",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee218(e){var t,r,n;return _regenerator2["default"].wrap(function _callee218$(i){for(;;)switch(i.prev=i.next){case 0:if(!(this._snapshotOrder.length>0)){i.next=15;break}t=this._snapshotOrder.shift();if(!(r=this._snapshots.get(t))){i.next=8;break}i.next=6;return r.abort();case 6:i.next=9;break;case 8:a.e(FullChain,function(){return"Snapshot with hash "+t.toBase64()+" not found."});case 9:this._snapshots.remove(t);i.next=12;return this._accounts.snapshot();case 12:n=i.sent;this._snapshots.put(e,n);this._snapshotOrder.push(e);case 15:case"end":return i.stop()}},_callee218,this)}));return function _saveSnapshot(t){return e.apply(this,arguments)}}()},{key:"accountsHash",value:function accountsHash(){return this._accounts.hash()}},{key:"head",get:function get(){return this._mainChain.head}},{key:"headHash",get:function get(){return this._headHash}},{key:"height",get:function get(){return this._mainChain.head.height}},{key:"totalDifficulty",get:function get(){return this._mainChain.totalDifficulty}},{key:"totalWork",get:function get(){return this._mainChain.totalWork}},{key:"accounts",get:function get(){return this._accounts}},{key:"transactionCache",get:function get(){return this._transactionCache}},{key:"blockForkedCount",get:function get(){return this._blockForkedCount}},{key:"blockRebranchedCount",get:function get(){return this._blockRebranchedCount}},{key:"blockExtendedCount",get:function get(){return this._blockExtendedCount}},{key:"blockOrphanCount",get:function get(){return this._blockOrphanCount}},{key:"blockInvalidCount",get:function get(){return this._blockInvalidCount}},{key:"blockKnownCount",get:function get(){return this._blockKnownCount}}]);return FullChain}(xe);Ue.ERR_ORPHAN=-2;Ue.ERR_INVALID=-1;Ue.OK_KNOWN=0;Ue.OK_EXTENDED=1;Ue.OK_REBRANCHED=2;Ue.OK_FORKED=3;r.register(Ue);var De=function(e){(0,_inherits3["default"])(FullConsensusAgent,e);function FullConsensusAgent(e,t,r){(0,_classCallCheck3["default"])(this,FullConsensusAgent);var n=(0,_possibleConstructorReturn3["default"])(this,(FullConsensusAgent.__proto__||(0,_getPrototypeOf2["default"])(FullConsensusAgent)).call(this,r));n._blockchain=e;n._mempool=t;n._syncing=!1;n._numBlocksExtending=-1;n._numBlocksForking=-1;n._forkHead=null;n._failedSyncs=0;n._syncTarget=r.headHash;r.channel.on("get-blocks",function(e){return n._onGetBlocks(e)});r.channel.on("get-chain-proof",function(e){return n._onGetChainProof(e)});r.channel.on("get-accounts-proof",function(e){return n._onGetAccountsProof(e)});r.channel.on("get-accounts-tree-chunk",function(e){return n._onGetAccountsTreeChunk(e)});r.channel.on("get-transactions-proof",function(e){return n._onGetTransactionsProof(e)});r.channel.on("get-transaction-receipts",function(e){return n._onGetTransactions(e)});r.channel.on("mempool",function(e){return n._onMempool(e)});return n}(0,_createClass3["default"])(FullConsensusAgent,[{key:"syncBlockchain",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee219(){return _regenerator2["default"].wrap(function _callee219$(e){for(;;)switch(e.prev=e.next){case 0:this._syncing=!0;if(h.isFullNode(this._peer.peerAddress.services)){e.next=4;break}this._syncFinished();return e.abrupt("return");case 4:if(this._objectsInFlight.isEmpty()){e.next=7;break}a.v(FullConsensusAgent,"Waiting for "+this._objectsInFlight.length+" objects to arrive ...");return e.abrupt("return");case 7:if(this._objectsProcessing.isEmpty()){e.next=10;break}a.v(FullConsensusAgent,"Waiting for "+this._objectsProcessing.length+" objects to be processed ...");return e.abrupt("return");case 10:e.next=12;return this._blockchain.getBlock(this._syncTarget,!0);case 12:if(!e.sent){e.next=16;break}this._syncFinished();return e.abrupt("return");case 16:if(!(0===this._numBlocksExtending&&++this._failedSyncs>=FullConsensusAgent.SYNC_ATTEMPTS_MAX)){e.next=19;break}this._peer.channel.close($t.BLOCKCHAIN_SYNC_FAILED,"blockchain sync failed");return e.abrupt("return");case 19:this._requestBlocks()["catch"](a.w.tag(FullConsensusAgent));case 20:case"end":return e.stop()}},_callee219,this)}));return function syncBlockchain(){return e.apply(this,arguments)}}()},{key:"_syncFinished",value:function _syncFinished(){var e=this;this._peer.channel.subscribe(de.ANY);var t=FullConsensusAgent.MEMPOOL_DELAY_MIN+Math.random()*(FullConsensusAgent.MEMPOOL_DELAY_MAX-FullConsensusAgent.MEMPOOL_DELAY_MIN);setTimeout(function(){return e._peer.channel.mempool()},t);this._syncing=!1;this._synced=!0;this._numBlocksExtending=0;this._numBlocksForking=0;this._forkHead=null;this._failedSyncs=0;this.fire("sync")}},{key:"_requestBlocks",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee220(e){var t,r,n,i,s,o,u=this;return _regenerator2["default"].wrap(function _callee220$(c){for(;;)switch(c.prev=c.next){case 0:if(!this._peer.channel.isExpectingMessage(Je.Type.INV)){c.next=3;break}a.e(FullConsensusAgent,"Duplicate _requestBlocks()");return c.abrupt("return");case 3:this._peer.channel.expectMessage(Je.Type.INV,function(){u._peer.channel.close($t.GET_BLOCKS_TIMEOUT,"getBlocks timeout")},Le.REQUEST_TIMEOUT);t=this._forkHead&&0===this._numBlocksExtending&&this._numBlocksForking>0;r=[];if(!t){c.next=10;break}r.push(this._forkHead.hash());c.next=35;break;case 10:r.push(this._blockchain.headHash);n=this._blockchain.head;i=Math.min(10,this._blockchain.height)-1;case 13:if(!(i>0)){c.next=23;break}if(n){c.next=16;break}return c.abrupt("break",23);case 16:r.push(n.prevHash);c.next=19;return this._blockchain.getBlock(n.prevHash);case 19:n=c.sent;case 20:i--;c.next=13;break;case 23:s=2;o=this._blockchain.height-10-s;case 25:if(!(o>0)){c.next=34;break}c.next=28;return this._blockchain.getBlockAt(o);case 28:(n=c.sent)&&r.push(n.hash());s*=2;case 31:o-=s;c.next=25;break;case 34:0!==r.length&&r[r.length-1].equals(Se.GENESIS.HASH)||r.push(Se.GENESIS.HASH);case 35:this._numBlocksExtending=0;this._numBlocksForking=0;this._peer.channel.getBlocks(r,e);case 38:case"end":return c.stop()}},_callee220,this)}));return function _requestBlocks(t){return e.apply(this,arguments)}}()},{key:"_onInv",value:function _onInv(e){return(0,_get3["default"])(FullConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(FullConsensusAgent.prototype),"_onInv",this).call(this,e)}},{key:"_shouldRequestData",value:function _shouldRequestData(e){return!(h.isNanoNode(this._peer.peerAddress.services)&&e.type===at.Type.BLOCK)}},{key:"_getBlock",value:function _getBlock(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];return this._blockchain.getBlock(e,t)}},{key:"_getTransaction",value:function _getTransaction(e){return _promise2["default"].resolve(this._mempool.getTransaction(e))}},{key:"_onKnownBlockAnnounced",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee221(e,t){return _regenerator2["default"].wrap(function _callee221$(e){for(;;)switch(e.prev=e.next){case 0:if(this._syncing){e.next=2;break}return e.abrupt("return");case 2:this._numBlocksForking++;this._forkHead=t;case 4:case"end":return e.stop()}},_callee221,this)}));return function _onKnownBlockAnnounced(t,r){return e.apply(this,arguments)}}()},{key:"_onNoUnknownObjects",value:function _onNoUnknownObjects(){this._syncing&&this.syncBlockchain()["catch"](a.w.tag(FullConsensusAgent))}},{key:"_onAllObjectsReceived",value:function _onAllObjectsReceived(){this._syncing&&this.syncBlockchain()["catch"](a.w.tag(FullConsensusAgent))}},{key:"_onHeader",value:function _onHeader(e){a.w(FullConsensusAgent,"Unsolicited header message received from "+this._peer.peerAddress+", discarding")}},{key:"_processBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee222(e,t){var r;return _regenerator2["default"].wrap(function _callee222$(n){for(;;)switch(n.prev=n.next){case 0:n.next=2;return this._blockchain.pushBlock(t);case 2:r=n.sent;n.t0=r;n.next=n.t0===Ue.ERR_INVALID?6:n.t0===Ue.OK_EXTENDED?8:n.t0===Ue.OK_REBRANCHED?8:n.t0===Ue.OK_FORKED?10:n.t0===Ue.ERR_ORPHAN?12:n.t0===Ue.OK_KNOWN?14:16;break;case 6:this._peer.channel.close($t.RECEIVED_INVALID_BLOCK,"received invalid block");return n.abrupt("break",16);case 8:this._syncing&&this._numBlocksExtending++;return n.abrupt("break",16);case 10:if(this._syncing){this._numBlocksForking++;this._forkHead=t}return n.abrupt("break",16);case 12:this._onOrphanBlock(e,t);return n.abrupt("break",16);case 14:a.v(FullConsensusAgent,"Received known block "+e+" (height="+t.height+", prevHash="+t.prevHash+") from "+this._peer.peerAddress);return n.abrupt("break",16);case 16:case"end":return n.stop()}},_callee222,this)}));return function _processBlock(t,r){return e.apply(this,arguments)}}()},{key:"_onOrphanBlock",value:function _onOrphanBlock(e,t){var r=this;if(this._synced){a.d(FullConsensusAgent,"Received orphan block "+e+" (height="+t.height+", prevHash="+t.prevHash+") from "+this._peer.peerAddress);this._timers.timeoutExists("outOfSync")||this._peer.channel.subscribe(de.NONE);this._syncTarget=e;this._timers.resetTimeout("outOfSync",function(){return r._outOfSync()},FullConsensusAgent.RESYNC_THROTTLE)}else a.w(FullConsensusAgent,"Received orphan block "+e+" (height="+t.height+", prevHash="+t.prevHash+") while syncing")}},{key:"_outOfSync",value:function _outOfSync(){this._timers.clearTimeout("outOfSync");this._synced=!1;this.fire("out-of-sync")}},{key:"_processTransaction",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee223(e,t){var r;return _regenerator2["default"].wrap(function _callee223$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return this._mempool.pushTransaction(t);case 2:r=e.sent;e.t0=r;e.next=e.t0===ze.ReturnCode.ACCEPTED?6:e.t0===ze.ReturnCode.KNOWN?7:e.t0===ze.ReturnCode.FEE_TOO_LOW?8:e.t0===ze.ReturnCode.INVALID?10:12;break;case 6:return e.abrupt("return",!0);case 7:return e.abrupt("return",!1);case 8:this.peer.channel.reject(Je.Type.TX,_t.Code.REJECT_INSUFFICIENT_FEE,"Sender has too many free transactions",t.hash().serialize());return e.abrupt("return",!1);case 10:this.peer.channel.reject(Je.Type.TX,_t.Code.REJECT_INVALID,"Invalid transaction",t.hash().serialize());return e.abrupt("return",!1);case 12:return e.abrupt("return",!1);case 13:case"end":return e.stop()}},_callee223,this)}));return function _processTransaction(t,r){return e.apply(this,arguments)}}()},{key:"_onAllObjectsProcessed",value:function _onAllObjectsProcessed(){this._syncing&&this.syncBlockchain()["catch"](a.w.tag(FullConsensusAgent))}},{key:"_onGetBlocks",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee224(e){var t,r,n,i,s,o,u,c,l,h,f,_,d,p,g,y;return _regenerator2["default"].wrap(function _callee224$(v){for(;;)switch(v.prev=v.next){case 0:a.v(FullConsensusAgent,"[GETBLOCKS] "+e.locators.length+" block locators maxInvSize "+e.maxInvSize+" received from "+this._peer.peerAddress);t=Se.GENESIS;r=!0;n=!1;i=undefined;v.prev=5;s=(0,_getIterator3["default"])(e.locators);case 7:if(r=(o=s.next()).done){v.next=18;break}u=o.value;v.next=11;return this._blockchain.getBlock(u);case 11:if(!(c=v.sent)){v.next=15;break}t=c;return v.abrupt("break",18);case 15:r=!0;v.next=7;break;case 18:v.next=24;break;case 20:v.prev=20;v.t0=v["catch"](5);n=!0;i=v.t0;case 24:v.prev=24;v.prev=25;!r&&s["return"]&&s["return"]();case 27:v.prev=27;if(!n){v.next=30;break}throw i;case 30:return v.finish(27);case 31:return v.finish(24);case 32:v.next=34;return this._blockchain.getBlocks(t.height+1,Math.min(e.maxInvSize,FullConsensusAgent.GETBLOCKS_VECTORS_MAX),e.direction===rt.Direction.FORWARD);case 34:l=v.sent;h=[];f=!0;_=!1;d=undefined;v.prev=39;for(p=(0,_getIterator3["default"])(l);!(f=(g=p.next()).done);f=!0){y=g.value;h.push(at.fromBlock(y))}v.next=47;break;case 43:v.prev=43;v.t1=v["catch"](39);_=!0;d=v.t1;case 47:v.prev=47;v.prev=48;!f&&p["return"]&&p["return"]();case 50:v.prev=50;if(!_){v.next=53;break}throw d;case 53:return v.finish(50);case 54:return v.finish(47);case 55:this._peer.channel.inv(h);case 56:case"end":return v.stop()}},_callee224,this,[[5,20,24,32],[25,,27,31],[39,43,47,55],[48,,50,54]])}));return function _onGetBlocks(t){return e.apply(this,arguments)}}()},{key:"_onGetChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee225(e){var t;return _regenerator2["default"].wrap(function _callee225$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return this._blockchain.getChainProof();case 2:t=e.sent;this._peer.channel.chainProof(t);case 4:case"end":return e.stop()}},_callee225,this)}));return function _onGetChainProof(t){return e.apply(this,arguments)}}()},{key:"_onGetAccountsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee226(e){var t;return _regenerator2["default"].wrap(function _callee226$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._blockchain.getAccountsProof(e.blockHash,e.addresses);case 2:t=r.sent;this._peer.channel.accountsProof(e.blockHash,t);case 4:case"end":return r.stop()}},_callee226,this)}));return function _onGetAccountsProof(t){return e.apply(this,arguments)}}()},{key:"_onGetTransactionsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee227(e){var t;return _regenerator2["default"].wrap(function _callee227$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._blockchain.getTransactionsProof(e.blockHash,e.addresses);case 2:t=r.sent;this._peer.channel.transactionsProof(e.blockHash,t);case 4:case"end":return r.stop()}},_callee227,this)}));return function _onGetTransactionsProof(t){return e.apply(this,arguments)}}()},{key:"_onGetAccountsTreeChunk",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee228(e){var t;return _regenerator2["default"].wrap(function _callee228$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this._blockchain.getAccountsTreeChunk(e.blockHash,e.startPrefix);case 2:t=r.sent;this._peer.channel.accountsTreeChunk(e.blockHash,t);case 4:case"end":return r.stop()}},_callee228,this)}));return function _onGetAccountsTreeChunk(t){return e.apply(this,arguments)}}()},{key:"_onGetTransactions",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee229(e){var t,r,n;return _regenerator2["default"].wrap(function _callee229$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return this._blockchain.getTransactionReceiptsByAddress(e.address);case 2:t=a.sent;r=0;for(;r<Et.RECEIPTS_MAX_COUNT;){n=t.slice(r,r+Et.RECEIPTS_MAX_COUNT);this._peer.channel.transactionReceipts(n);r+=Et.RECEIPTS_MAX_COUNT}case 5:case"end":return a.stop()}},_callee229,this)}));return function _onGetTransactions(t){return e.apply(this,arguments)}}()},{key:"_onMempool",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee230(e){var t,r,n,a,i,s,o,u,c;return _regenerator2["default"].wrap(function _callee230$(e){for(;;)switch(e.prev=e.next){case 0:t=this._mempool.getTransactions();r=new k(t,FullConsensusAgent.MEMPOOL_ENTRIES_MAX);n=[];a=!0;i=!1;s=undefined;e.prev=6;o=(0,_getIterator3["default"])(r);case 8:if(a=(u=o.next()).done){e.next=19;break}c=u.value;n.push(at.fromTransaction(c));if(!(n.length>=it.VECTORS_MAX_COUNT)){e.next=16;break}this._peer.channel.inv(n);n=[];e.next=16;return new _promise2["default"](function(e){return setTimeout(e,FullConsensusAgent.MEMPOOL_THROTTLE)});case 16:a=!0;e.next=8;break;case 19:e.next=25;break;case 21:e.prev=21;e.t0=e["catch"](6);i=!0;s=e.t0;case 25:e.prev=25;e.prev=26;!a&&o["return"]&&o["return"]();case 28:e.prev=28;if(!i){e.next=31;break}throw s;case 31:return e.finish(28);case 32:return e.finish(25);case 33:n.length>0&&this._peer.channel.inv(n);case 34:case"end":return e.stop()}},_callee230,this,[[6,21,25,33],[26,,28,32]])}));return function _onMempool(t){return e.apply(this,arguments)}}()}]);return FullConsensusAgent}(Le);De.SYNC_ATTEMPTS_MAX=25;De.GETBLOCKS_VECTORS_MAX=500;De.RESYNC_THROTTLE=3e3;De.MEMPOOL_DELAY_MIN=2e3;De.MEMPOOL_DELAY_MAX=2e4;De.MEMPOOL_THROTTLE=1e3;De.MEMPOOL_ENTRIES_MAX=1e4;r.register(De);var He=function(e){(0,_inherits3["default"])(FullConsensus,e);function FullConsensus(e,t,r){(0,_classCallCheck3["default"])(this,FullConsensus);var n=(0,_possibleConstructorReturn3["default"])(this,(FullConsensus.__proto__||(0,_getPrototypeOf2["default"])(FullConsensus)).call(this));n._blockchain=e;n._mempool=t;n._network=r;n._agents=new y;n._timers=new _;n._established=!1;n._syncPeer=null;r.on("peer-joined",function(e){return n._onPeerJoined(e)});r.on("peer-left",function(e){return n._onPeerLeft(e)});e.on("head-changed",function(e){if(n._established){var t=!0,r=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(n._agents.values());!(t=(i=s.next()).done);t=!0){i.value.relayBlock(e)}}catch(o){r=!0;a=o}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw a}}}});t.on("transaction-added",function(e){if(n._established){var t=!0,r=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(n._agents.values());!(t=(i=s.next()).done);t=!0){i.value.relayTransaction(e)}}catch(o){r=!0;a=o}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw a}}}});return n}(0,_createClass3["default"])(FullConsensus,[{key:"_onPeerJoined",value:function _onPeerJoined(e){var t=this,r=new De(this._blockchain,this._mempool,e);this._agents.put(e.id,r);r.on("close",function(){return t._onPeerLeft(r.peer)});r.on("sync",function(){return t._onPeerSynced(r.peer)});r.on("out-of-sync",function(){return t._onPeerOutOfSync(r.peer)});this._timers.resetTimeout("sync",this._syncBlockchain.bind(this),FullConsensus.SYNC_THROTTLE)}},{key:"_onPeerLeft",value:function _onPeerLeft(e){if(e.equals(this._syncPeer)){a.w(FullConsensus,"Peer "+e.peerAddress+" left during sync");this._syncPeer=null}this._agents.remove(e.id);this._syncBlockchain()}},{key:"_syncBlockchain",value:function _syncBlockchain(){if(!this._syncPeer){var e=g.randomElement(this._agents.values().filter(function(e){return!e.synced}));if(e){this._syncPeer=e.peer;this._established||this.fire("syncing");a.v(FullConsensus,"Syncing blockchain with peer "+e.peer.peerAddress);e.syncBlockchain()["catch"](a.w.tag(De))}else if(this._agents.length>0){if(!this._established){a.i(FullConsensus,"Synced with all connected peers ("+this._agents.length+"), consensus established.");a.d(FullConsensus,"Blockchain: height="+this._blockchain.height+", headHash="+this._blockchain.headHash);this._established=!0;this.fire("established")}}else{this._established=!1;this.fire("lost")}}}},{key:"_onPeerSynced",value:function _onPeerSynced(e){if(e.equals(this._syncPeer)){a.v(FullConsensus,"Finished sync with peer "+e.peerAddress);this._syncPeer=null}this._syncBlockchain()}},{key:"_onPeerOutOfSync",value:function _onPeerOutOfSync(e){a.w(FullConsensus,"Peer "+e.peerAddress+" out of sync, resyncing");this._syncBlockchain()}},{key:"established",get:function get(){return this._established}},{key:"blockchain",get:function get(){return this._blockchain}},{key:"mempool",get:function get(){return this._mempool}},{key:"network",get:function get(){return this._network}}]);return FullConsensus}(i);He.SYNC_THROTTLE=1500;r.register(He);var Ge=function(e){(0,_inherits3["default"])(LightChain,e);(0,_createClass3["default"])(LightChain,null,[{key:"getPersistent",value:function getPersistent(e,t,r){return new LightChain(Re.getPersistent(e),t,r)._init()}},{key:"createVolatile",value:function createVolatile(e,t){return new LightChain(Re.createVolatile(),e,t)._init()}}]);function LightChain(e,t,r){(0,_classCallCheck3["default"])(this,LightChain);return(0,_possibleConstructorReturn3["default"])(this,(LightChain.__proto__||(0,_getPrototypeOf2["default"])(LightChain)).call(this,e,t,r))}(0,_createClass3["default"])(LightChain,[{key:"_init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee231(){return _regenerator2["default"].wrap(function _callee231$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return Ue.prototype._init.call(this);case 2:if(this._proof){e.next=6;break}e.next=5;return this._getChainProof();case 5:this._proof=e.sent;case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}},_callee231,this)}));return function _init(){return e.apply(this,arguments)}}()},{key:"partialChain",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee233(){var e,t,r=this;return _regenerator2["default"].wrap(function _callee233$(n){for(;;)switch(n.prev=n.next){case 0:n.next=2;return this.getChainProof();case 2:e=n.sent;(t=new je(this._store,this._accounts,this._time,e)).on("committed",function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee232(e,t,n){return _regenerator2["default"].wrap(function _callee232$(a){for(;;)switch(a.prev=a.next){case 0:r._proof=e;r._headHash=t;r._mainChain=n;r.fire("head-changed",r.head);case 4:case"end":return a.stop()}},_callee232,r)}));return function(t,r,n){return e.apply(this,arguments)}}());n.next=7;return t._init();case 7:return n.abrupt("return",t);case 8:case"end":return n.stop()}},_callee233,this)}));return function partialChain(){return e.apply(this,arguments)}}()}]);return LightChain}(Ue);r.register(Ge);var Ke=function(e){(0,_inherits3["default"])(LightConsensusAgent,e);function LightConsensusAgent(e,t,r){(0,_classCallCheck3["default"])(this,LightConsensusAgent);var n=(0,_possibleConstructorReturn3["default"])(this,(LightConsensusAgent.__proto__||(0,_getPrototypeOf2["default"])(LightConsensusAgent)).call(this,e,t,r));n._blockchain=e;n._partialChain=null;n._syncing=!1;n._catchup=!1;n._onMainChain=!1;n._orphanedBlocks=[];n._busy=!1;n._accountsRequest=null;n._requestedChainProof=!1;r.channel.on("chain-proof",function(e){return n._onChainProof(e)});r.channel.on("accounts-tree-chunk",function(e){return n._onAccountsTreeChunk(e)});return n}(0,_createClass3["default"])(LightConsensusAgent,[{key:"syncBlockchain",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee234(){var e,t;return _regenerator2["default"].wrap(function _callee234$(r){for(;;)switch(r.prev=r.next){case 0:if(!h.isNanoNode(this._peer.peerAddress.services)){r.next=3;break}this._syncFinished();return r.abrupt("return");case 3:if(this._objectsInFlight.isEmpty()){r.next=6;break}a.v(LightConsensusAgent,"Waiting for "+this._objectsInFlight.length+" objects to arrive ...");return r.abrupt("return");case 6:if(this._objectsProcessing.isEmpty()){r.next=9;break}a.v(LightConsensusAgent,"Waiting for "+this._objectsProcessing.length+" objects to be processed ...");return r.abrupt("return");case 9:if(!(this._failedSyncs>=LightConsensusAgent.SYNC_ATTEMPTS_MAX)){r.next=16;break}this._peer.channel.close($t.BLOCKCHAIN_SYNC_FAILED,"blockchain sync failed");if(!this._partialChain){r.next=15;break}r.next=14;return this._partialChain.abort();case 14:this._partialChain=null;case 15:return r.abrupt("return");case 16:r.next=18;return this._blockchain.getBlock(this._syncTarget);case 18:if(!(e=r.sent)||this._syncing){r.next=22;break}this._syncFinished();return r.abrupt("return");case 22:if(e||this._syncing){r.next=38;break}this._syncing=!0;this._onMainChain=!1;t=void 0;r.prev=26;r.next=29;return this.getHeader(this._syncTarget);case 29:t=r.sent;r.next=36;break;case 32:r.prev=32;r.t0=r["catch"](26);this._peer.channel.close($t.DID_NOT_GET_REQUESTED_HEADER,"Did not get requested header");return r.abrupt("return");case 36:this._catchup=t.height-this._blockchain.height<=z.NUM_BLOCKS_VERIFICATION;a.d(LightConsensusAgent,"Start syncing, catchup mode: "+this._catchup);case 38:if(!this._syncing||this._busy){r.next=69;break}if(!this._catchup){r.next=44;break}r.next=42;return De.prototype.syncBlockchain.call(this);case 42:r.next=69;break;case 44:if(this._partialChain){r.next=47;break}r.next=47;return this._initChainProofSync();case 47:r.t1=this._partialChain.state;r.next=r.t1===je.State.PROVE_CHAIN?50:r.t1===je.State.PROVE_ACCOUNTS_TREE?53:r.t1===je.State.PROVE_BLOCKS?56:r.t1===je.State.COMPLETE?59:r.t1===je.State.ABORTED?67:69;break;case 50:this._requestChainProof();this.fire("sync-chain-proof",this._peer.peerAddress);return r.abrupt("break",69);case 53:this._requestAccountsTree();this.fire("sync-accounts-tree",this._peer.peerAddress);return r.abrupt("break",69);case 56:this._requestProofBlocks();this.fire("verify-accounts-tree",this._peer.peerAddress);return r.abrupt("break",69);case 59:this.fire("sync-finalize",this._peer.peerAddress);this._busy=!0;r.next=63;return this._partialChain.commit();case 63:r.next=65;return this._applyOrphanedBlocks();case 65:this._syncFinished();return r.abrupt("break",69);case 67:this._peer.channel.close($t.ABORTED_SYNC,"aborted sync");return r.abrupt("break",69);case 69:case"end":return r.stop()}},_callee234,this,[[26,32]])}));return function syncBlockchain(){return e.apply(this,arguments)}}()},{key:"_initChainProofSync",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee235(){return _regenerator2["default"].wrap(function _callee235$(e){for(;;)switch(e.prev=e.next){case 0:this._peer.channel.subscribe(de.ANY);this._syncing=!0;this._synced=!1;this._catchup=!1;this._onMainChain=!0;if(!this._partialChain){e.next=8;break}e.next=8;return this._partialChain.abort();case 8:e.next=10;return this._blockchain.partialChain();case 10:this._partialChain=e.sent;case 11:case"end":return e.stop()}},_callee235,this)}));return function _initChainProofSync(){return e.apply(this,arguments)}}()},{key:"_syncFinished",value:function _syncFinished(){this._partialChain&&(this._partialChain=null);this._busy=!1;(0,_get3["default"])(LightConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(LightConsensusAgent.prototype),"_syncFinished",this).call(this)}},{key:"_applyOrphanedBlocks",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee236(){var e,t,r,n,a,i;return _regenerator2["default"].wrap(function _callee236$(s){for(;;)switch(s.prev=s.next){case 0:e=!0;t=!1;r=undefined;s.prev=3;n=(0,_getIterator3["default"])(this._orphanedBlocks);case 5:if(e=(a=n.next()).done){s.next=16;break}i=a.value;s.next=9;return this._blockchain.pushBlock(i);case 9:if(s.sent!==Ge.ERR_INVALID){s.next=13;break}this._peer.channel.close($t.RECEIVED_INVALID_BLOCK,"received invalid block");return s.abrupt("break",16);case 13:e=!0;s.next=5;break;case 16:s.next=22;break;case 18:s.prev=18;s.t0=s["catch"](3);t=!0;r=s.t0;case 22:s.prev=22;s.prev=23;!e&&n["return"]&&n["return"]();case 25:s.prev=25;if(!t){s.next=28;break}throw r;case 28:return s.finish(25);case 29:return s.finish(22);case 30:this._orphanedBlocks=[];case 31:case"end":return s.stop()}},_callee236,this,[[3,18,22,30],[23,,25,29]])}));return function _applyOrphanedBlocks(){return e.apply(this,arguments)}}()},{key:"_requestChainProof",value:function _requestChainProof(){var e=this;C.that(this._partialChain&&this._partialChain.state===je.State.PROVE_CHAIN);C.that(!this._requestedChainProof);this._busy=!0;this._peer.channel.getChainProof();this._requestedChainProof=!0;this._peer.channel.expectMessage(Je.Type.CHAIN_PROOF,function(){e._peer.channel.close($t.GET_CHAIN_PROOF_TIMEOUT,"getChainProof timeout")},LightConsensusAgent.CHAINPROOF_REQUEST_TIMEOUT,LightConsensusAgent.CHAINPROOF_CHUNK_TIMEOUT)}},{key:"_onChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee237(e){return _regenerator2["default"].wrap(function _callee237$(t){for(;;)switch(t.prev=t.next){case 0:C.that(this._partialChain&&this._partialChain.state===je.State.PROVE_CHAIN);a.d(LightConsensusAgent,"[CHAIN-PROOF] Received from "+this._peer.peerAddress+": "+e.proof);if(this._requestedChainProof){t.next=5;break}a.w(LightConsensusAgent,"Unsolicited chain proof received from "+this._peer.peerAddress);return t.abrupt("return");case 5:this._requestedChainProof=!1;this._syncing&&this.fire("verify-chain-proof",this._peer.peerAddress);t.next=9;return this._partialChain.pushProof(e.proof);case 9:if(t.sent){t.next=13;break}a.w(LightConsensusAgent,"Invalid chain proof received from "+this._peer.peerAddress+" - verification failed");this._peer.channel.close($t.INVALID_CHAIN_PROOF,"invalid chain proof");return t.abrupt("return");case 13:this._busy=!1;this.syncBlockchain()["catch"](a.w.tag(LightConsensusAgent));case 15:case"end":return t.stop()}},_callee237,this)}));return function _onChainProof(t){return e.apply(this,arguments)}}()},{key:"_requestAccountsTree",value:function _requestAccountsTree(){var e=this;C.that(this._partialChain&&this._partialChain.state===je.State.PROVE_ACCOUNTS_TREE);C.that(!this._accountsRequest);this._busy=!0;var t=this._partialChain.getMissingAccountsPrefix(),r=this._partialChain.headHash;a.d(LightConsensusAgent,"Requesting AccountsTreeChunk starting at "+t+" from "+this._peer.peerAddress);this._accountsRequest={startPrefix:t,blockHash:r};this._peer.channel.getAccountsTreeChunk(r,t);this._peer.channel.expectMessage(Je.Type.ACCOUNTS_TREE_CHUNK,function(){e._peer.channel.close($t.GET_ACCOUNTS_TREE_CHUNK_TIMEOUT,"getAccountsTreeChunk timeout")},LightConsensusAgent.ACCOUNTS_TREE_CHUNK_REQUEST_TIMEOUT)}},{key:"_onAccountsTreeChunk",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee238(e){var t,r,n,i,s;return _regenerator2["default"].wrap(function _callee238$(o){for(;;)switch(o.prev=o.next){case 0:a.d(LightConsensusAgent,"[ACCOUNTS-TREE-CHUNK] Received from "+this._peer.peerAddress+": blockHash="+e.blockHash+", proof="+e.chunk);if(this._accountsRequest){o.next=4;break}a.w(LightConsensusAgent,"Unsolicited accounts tree chunk received from "+this._peer.peerAddress);return o.abrupt("return");case 4:C.that(this._partialChain&&this._partialChain.state===je.State.PROVE_ACCOUNTS_TREE);t=this._accountsRequest.startPrefix;r=this._accountsRequest.blockHash;this._accountsRequest=null;if(e.hasChunk()){o.next=15;break}o.next=11;return this._partialChain.abort();case 11:this._partialChain=null;this._busy=!1;this._failedSyncs++;return o.abrupt("return");case 15:if(r.equals(e.blockHash)&&!(e.chunk.head.prefix<=t)){o.next=19;break}a.w(LightConsensusAgent,"Received AccountsTreeChunk for block != head or wrong start prefix from "+this._peer.peerAddress);this._peer.channel.close($t.INVALID_ACCOUNTS_TREE_CHUNK,"Invalid AccountsTreeChunk");return o.abrupt("return");case 19:if((n=e.chunk).verify()){o.next=24;break}a.w(LightConsensusAgent,"Invalid AccountsTreeChunk received from "+this._peer.peerAddress);this._peer.channel.close($t.INVALID_ACCOUNTS_TREE_CHUNK,"Invalid AccountsTreeChunk");return o.abrupt("return");case 24:i=n.root();o.next=27;return this._partialChain.getBlock(r);case 27:if(o.sent.accountsHash.equals(i)){o.next=32;break}a.w(LightConsensusAgent,"Invalid AccountsTreeChunk (root hash) received from "+this._peer.peerAddress);this._peer.channel.close($t.ACCOUNTS_TREE_CHUNCK_ROOT_HASH_MISMATCH,"AccountsTreeChunk root hash mismatch");return o.abrupt("return");case 32:o.next=34;return this._partialChain.pushAccountsTreeChunk(n);case 34:if((s=o.sent)<0){a.e("AccountsTree sync failed with error code "+s+" from "+this._peer.peerAddress);this._peer.channel.close($t.ACCOUNTS_TREE_CHUNCK_ROOT_HASH_MISMATCH,"AccountsTreeChunk root hash mismatch")}this._busy=!1;this.syncBlockchain()["catch"](a.w.tag(LightConsensusAgent));case 38:case"end":return o.stop()}},_callee238,this)}));return function _onAccountsTreeChunk(t){return e.apply(this,arguments)}}()},{key:"_requestProofBlocks",value:function _requestProofBlocks(){var e=this;C.that(this._partialChain&&this._partialChain.state===je.State.PROVE_BLOCKS);this._lastChainHeight===this._partialChain.proofHeadHeight&&this._failedSyncs++;this._lastChainHeight=this._partialChain.proofHeadHeight;if(this._peer.channel.isExpectingMessage(Je.Type.INV))a.e(LightConsensusAgent,"Duplicate _requestProofBlocks()");else{this._peer.channel.expectMessage(Je.Type.INV,function(){e._peer.channel.close($t.GET_BLOCKS_TIMEOUT,"getBlocks timeout")},Le.REQUEST_TIMEOUT);this._peer.channel.getBlocks(this._partialChain.getBlockLocators(),this._partialChain.numBlocksNeeded(),!1)}}},{key:"_requestBlocks",value:function _requestBlocks(){return this._syncing&&!this._onMainChain?(0,_get3["default"])(LightConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(LightConsensusAgent.prototype),"_requestBlocks",this).call(this,1):(0,_get3["default"])(LightConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(LightConsensusAgent.prototype),"_requestBlocks",this).call(this)}},{key:"_processBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee239(e,t){var r;return _regenerator2["default"].wrap(function _callee239$(n){for(;;)switch(n.prev=n.next){case 0:if(!(t.height<this._chain.height-z.NUM_BLOCKS_VERIFICATION)||this._partialChain&&this._partialChain.state===je.State.PROVE_BLOCKS){n.next=8;break}this._onMainChain=!1;n.next=4;return this._initChainProofSync();case 4:this.syncBlockchain()["catch"](a.w.tag(LightConsensusAgent));return n.abrupt("return");case 8:this._onMainChain=!0;case 9:n.next=11;return this._chain.pushBlock(t);case 11:r=n.sent;n.t0=r;n.next=n.t0===Ue.ERR_INVALID?15:n.t0===Ue.OK_EXTENDED?17:n.t0===Ue.OK_REBRANCHED?17:n.t0===Ue.OK_FORKED?19:n.t0===Ge.ERR_ORPHAN?21:23;break;case 15:this._peer.channel.close($t.RECEIVED_INVALID_BLOCK,"received invalid block");return n.abrupt("break",23);case 17:this._syncing&&this._numBlocksExtending++;return n.abrupt("break",23);case 19:if(this._syncing){this._numBlocksForking++;this._forkHead=t}return n.abrupt("break",23);case 21:this._onOrphanBlock(e,t);return n.abrupt("break",23);case 23:case"end":return n.stop()}},_callee239,this)}));return function _processBlock(t,r){return e.apply(this,arguments)}}()},{key:"_onKnownBlockAnnounced",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee240(e,t){return _regenerator2["default"].wrap(function _callee240$(r){for(;;)switch(r.prev=r.next){case 0:if(!this._syncing||!this._catchup){r.next=11;break}if(!(t.height<this._chain.height-z.NUM_BLOCKS_VERIFICATION)||this._partialChain&&this._partialChain.state===je.State.PROVE_BLOCKS){r.next=9;break}this._onMainChain=!1;r.next=5;return this._initChainProofSync();case 5:this.syncBlockchain()["catch"](function(e){return a.e(LightConsensusAgent,e)});return r.abrupt("return");case 9:this._onMainChain=!0;case 10:De.prototype._onKnownBlockAnnounced.call(this,e,t);case 11:case"end":return r.stop()}},_callee240,this)}));return function _onKnownBlockAnnounced(t,r){return e.apply(this,arguments)}}()},{key:"_onOrphanBlock",value:function _onOrphanBlock(e,t){this._syncing&&!this._catchup?this._orphanedBlocks.push(t):(0,_get3["default"])(LightConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(LightConsensusAgent.prototype),"_onOrphanBlock",this).call(this,e,t)}},{key:"getHeader",value:function getHeader(e){var t=this;C.that(!this._headerRequest);return new _promise2["default"](function(r,n){var a=new at(at.Type.BLOCK,e);t._headerRequest={hash:e,resolve:r,reject:n};t._peer.channel.getHeader([a]);t._peer.channel.expectMessage(Je.Type.HEADER,function(){t._headerRequest=null;t._peer.channel.close($t.GET_HEADER_TIMEOUT,"getHeader timeout");n(new Error("timeout"))},Le.REQUEST_TIMEOUT)})}},{key:"_onHeader",value:function _onHeader(e){var t=e.header,r=t.hash();if(this._headerRequest){var n=this._headerRequest.hash,i=this._headerRequest.resolve,s=this._headerRequest.reject;if(n.equals(r))i(t);else{a.w(LightConsensusAgent,"Received wrong header from "+this._peer.peerAddress);this._peer.channel.close($t.RECEIVED_WRONG_HEADER,"Received wrong header");s(new Error("Received wrong header"))}}else a.w(Ve,"Unsolicited header "+r+" received from "+this._peer.peerAddress+", discarding")}},{key:"_onClose",value:function _onClose(){this._partialChain&&this._partialChain.abort()["catch"](a.w.tag(LightConsensusAgent));(0,_get3["default"])(LightConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(LightConsensusAgent.prototype),"_onClose",this).call(this)}},{key:"_chain",get:function get(){return this._syncing&&!this._catchup&&this._partialChain?this._partialChain:this._blockchain}}]);return LightConsensusAgent}(De);Ke.CHAINPROOF_REQUEST_TIMEOUT=45e3;Ke.CHAINPROOF_CHUNK_TIMEOUT=1e4;Ke.ACCOUNTS_TREE_CHUNK_REQUEST_TIMEOUT=8e3;Ke.SYNC_ATTEMPTS_MAX=5;Ke.GETBLOCKS_VECTORS_MAX=500;r.register(Ke);var Fe=function(e){(0,_inherits3["default"])(LightConsensus,e);function LightConsensus(e,t,r){(0,_classCallCheck3["default"])(this,LightConsensus);var n=(0,_possibleConstructorReturn3["default"])(this,(LightConsensus.__proto__||(0,_getPrototypeOf2["default"])(LightConsensus)).call(this));n._blockchain=e;n._mempool=t;n._network=r;n._agents=new y;n._timers=new _;n._established=!1;n._syncPeer=null;n._synchronizer=new f;r.on("peer-joined",function(e){return n._onPeerJoined(e)});r.on("peer-left",function(e){return n._onPeerLeft(e)});e.on("head-changed",function(e){if(n._established){var t=!0,r=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(n._agents.values());!(t=(i=s.next()).done);t=!0){i.value.relayBlock(e)}}catch(o){r=!0;a=o}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw a}}}});t.on("transaction-added",function(e){if(n._established){var t=!0,r=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(n._agents.values());!(t=(i=s.next()).done);t=!0){i.value.relayTransaction(e)}}catch(o){r=!0;a=o}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw a}}}});return n}(0,_createClass3["default"])(LightConsensus,[{key:"_onPeerJoined",value:function _onPeerJoined(e){var t=this,r=new Ke(this._blockchain,this._mempool,e);this._agents.put(e.id,r);r.on("close",function(){return t._onPeerLeft(r.peer)});r.on("sync",function(){return t._onPeerSynced(r.peer)});r.on("out-of-sync",function(){return t._onPeerOutOfSync(r.peer)});this.bubble(r,"sync-chain-proof","verify-chain-proof","sync-accounts-tree","verify-accounts-tree","sync-finalize");this._timers.resetTimeout("sync",this._syncBlockchain.bind(this),LightConsensus.SYNC_THROTTLE)}},{key:"_onPeerLeft",value:function _onPeerLeft(e){if(e.equals(this._syncPeer)){a.w(LightConsensus,"Peer "+e.peerAddress+" left during sync");this._syncPeer=null;this.fire("sync-failed",e.peerAddress)}this._agents.remove(e.id);this._syncBlockchain()}},{key:"_syncBlockchain",value:function _syncBlockchain(){var e=this;return this._synchronizer.push(function(){if(!e._syncPeer){var t=e._agents.values().filter(function(e){return!e.synced}),r=g.randomElement(t);if(r){e._syncPeer=r.peer;e._established||e.fire("syncing",r.peer.peerAddress,t.length-1);a.v(LightConsensus,"Syncing blockchain with peer "+r.peer.peerAddress);r.syncBlockchain()["catch"](a.w.tag(Ke))}else if(e._agents.length>0){if(!e._established){a.i(LightConsensus,"Synced with all connected peers ("+e._agents.length+"), consensus established.");a.d(LightConsensus,"Blockchain: height="+e._blockchain.height+", headHash="+e._blockchain.headHash);e._established=!0;e.fire("established")}}else{e._established=!1;e.fire("lost")}}})}},{key:"_onPeerSynced",value:function _onPeerSynced(e){if(e.equals(this._syncPeer)){a.v(LightConsensus,"Finished sync with peer "+e.peerAddress);this._syncPeer=null;this.fire("sync-finished",e.peerAddress)}this._syncBlockchain()}},{key:"_onPeerOutOfSync",value:function _onPeerOutOfSync(e){a.w(LightConsensus,"Peer "+e.peerAddress+" out of sync, resyncing");this._syncBlockchain()}},{key:"established",get:function get(){return this._established}},{key:"blockchain",get:function get(){return this._blockchain}},{key:"mempool",get:function get(){return this._mempool}},{key:"network",get:function get(){return this._network}}]);return LightConsensus}(i);Fe.SYNC_THROTTLE=1e3;r.register(Fe);var je=function(e){(0,_inherits3["default"])(PartialLightChain,e);function PartialLightChain(e,t,r,n){(0,_classCallCheck3["default"])(this,PartialLightChain);var a=e.transaction(!1),i=(0,_possibleConstructorReturn3["default"])(this,(PartialLightChain.__proto__||(0,_getPrototypeOf2["default"])(PartialLightChain)).call(this,a,t,r));i._proof=n;i._state=PartialLightChain.State.PROVE_CHAIN;i._partialTree=null;i._accountsTx=null;i._proofHead=null;return i}(0,_createClass3["default"])(PartialLightChain,[{key:"pushProof",value:function pushProof(e){var t=this;return this._synchronizer.push(function(){return t._pushProof(e)})}},{key:"_pushProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee241(e){var t,r,n,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m,b,C,w,A,S,T,E;return _regenerator2["default"].wrap(function _callee241$(I){for(;;)switch(I.prev=I.next){case 0:t=[];r=0;case 2:if(!(r<e.prefix.length)){I.next=12;break}n=e.prefix.blocks[r];i=n.hash();I.next=7;return this._store.getBlock(i);case 7:I.sent||n.header._pow||t.push(n.header);case 9:++r;I.next=2;break;case 12:s=0;case 13:if(!(s<e.suffix.length)){I.next=23;break}o=e.suffix.headers[s];u=o.hash();I.next=18;return this._store.getBlock(u);case 18:I.sent||o._pow||t.push(o);case 20:++s;I.next=13;break;case 23:I.next=25;return x.manyPow(t);case 25:c=0;case 26:if(!(c<e.prefix.length)){I.next=44;break}l=e.prefix.blocks[c];h=l.hash();I.next=31;return this._store.getBlock(h);case 31:if(!(f=I.sent)){I.next=36;break}e.prefix.blocks[c]=f.toLight();I.next=41;break;case 36:I.next=38;return l.verify(this._time);case 38:if(I.sent){I.next=41;break}a.w(PartialLightChain,"Rejecting proof - prefix contains invalid block");return I.abrupt("return",!1);case 41:c++;I.next=26;break;case 44:_=0;case 45:if(!(_<e.suffix.length)){I.next=63;break}d=e.suffix.headers[_];p=d.hash();I.next=50;return this._store.getBlock(p);case 50:if(!(g=I.sent)){I.next=55;break}e.suffix.headers[_]=g.header;I.next=60;break;case 55:I.next=57;return d.verifyProofOfWork();case 57:if(I.sent){I.next=60;break}a.w(PartialLightChain,"Rejecting proof - suffix contains invalid header");return I.abrupt("return",!1);case 60:_++;I.next=45;break;case 63:I.next=65;return e.verify();case 65:if(I.sent){I.next=68;break}a.w(PartialLightChain,"Rejecting proof - verification failed");return I.abrupt("return",!1);case 68:if(e.suffix.length===z.K||e.suffix.length===e.head.height-1){I.next=71;break}a.w(PartialLightChain,"Rejecting proof - invalid suffix length");return I.abrupt("return",!1);case 71:if(!(e.prefix.denseSuffix().length<z.M&&e.prefix.length>0&&e.prefix.head.height>=z.M)){I.next=75;break}a.w(We,"Rejecting proof - dense suffix too short");return I.abrupt("return",!1);case 75:y=[];v=e.prefix.head;k=!0;m=!1;b=undefined;I.prev=80;C=(0,_getIterator3["default"])(e.suffix.headers);case 82:if(k=(w=C.next()).done){I.next=96;break}A=w.value;I.next=86;return v.getNextInterlink(A.target,A.version);case 86:S=I.sent;T=S.hash();if(A.interlinkHash.equals(T)){I.next=91;break}a.w(PartialLightChain,"Rejecting proof - invalid interlink hash in proof suffix");return I.abrupt("return",!1);case 91:v=new Se(A,S);y.push(v);case 93:k=!0;I.next=82;break;case 96:I.next=102;break;case 98:I.prev=98;I.t0=I["catch"](80);m=!0;b=I.t0;case 102:I.prev=102;I.prev=103;!k&&C["return"]&&C["return"]();case 105:I.prev=105;if(!m){I.next=108;break}throw b;case 108:return I.finish(105);case 109:return I.finish(102);case 110:I.next=112;return this.getChainProof();case 112:E=I.sent;I.next=115;return xe.isBetterProof(e,E,z.M);case 115:if(!I.sent){I.next=120;break}I.next=118;return this._acceptProof(e,y);case 118:I.next=122;break;case 120:I.next=122;return this.abort();case 122:return I.abrupt("return",!0);case 123:case"end":return I.stop()}},_callee241,this,[[80,98,102,110],[103,,105,109]])}));return function _pushProof(t){return e.apply(this,arguments)}}()},{key:"_acceptProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee242(e,t){var r,n,a,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m;return _regenerator2["default"].wrap(function _callee242$(b){for(;;)switch(b.prev=b.next){case 0:r=e.prefix.head;n=r.hash();b.next=4;return this._store.getChainData(n);case 4:if((a=b.sent)&&!(a.totalDifficulty<=0)){b.next=42;break}b.next=8;return this._store.truncate();case 8:i=e.prefix.denseSuffix();s=0;case 10:if(!(s<e.prefix.length-i.length)){b.next=19;break}o=e.prefix.blocks[s];u=o.hash();c=new Oe(o,-1,-1,!0);b.next=16;return this._store.putChainData(u,c);case 16:s++;b.next=10;break;case 19:l=i[0];this._headHash=l.hash();b.t0=Oe;b.t1=l;b.t2=l.difficulty;b.t3=_e;b.next=27;return l.pow();case 27:b.t4=b.sent;b.t5=b.t3.realDifficulty.call(b.t3,b.t4);this._mainChain=new b.t0(b.t1,b.t2,b.t5,!0);b.next=32;return this._store.putChainData(this._headHash,this._mainChain);case 32:h=1;case 33:if(!(h<i.length)){b.next=42;break}f=i[h];b.next=37;return this._pushLightBlock(f);case 37:_=b.sent;C.that(_>=0);case 39:h++;b.next=33;break;case 42:d=!0;p=!1;g=undefined;b.prev=45;y=(0,_getIterator3["default"])(t);case 47:if(d=(v=y.next()).done){b.next=56;break}k=v.value;b.next=51;return this._pushLightBlock(k);case 51:m=b.sent;C.that(m>=0);case 53:d=!0;b.next=47;break;case 56:b.next=62;break;case 58:b.prev=58;b.t6=b["catch"](45);p=!0;g=b.t6;case 62:b.prev=62;b.prev=63;!d&&y["return"]&&y["return"]();case 65:b.prev=65;if(!p){b.next=68;break}throw g;case 68:return b.finish(65);case 69:return b.finish(62);case 70:this._state=PartialLightChain.State.PROVE_ACCOUNTS_TREE;b.next=73;return this._accounts.partialAccountsTree();case 73:this._partialTree=b.sent;this._proofHead=this._mainChain;b.next=77;return this._store.setHead(this.headHash);case 77:this._proof=e;case 78:case"end":return b.stop()}},_callee242,this,[[45,58,62,70],[63,,65,69]])}));return function _acceptProof(t,r){return e.apply(this,arguments)}}()},{key:"_pushLightBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee243(e){var t,r;return _regenerator2["default"].wrap(function _callee243$(n){for(;;)switch(n.prev=n.next){case 0:t=e.hash();n.next=3;return this._store.getBlock(t);case 3:if(!n.sent){n.next=6;break}return n.abrupt("return",We.OK_KNOWN);case 6:n.next=8;return this._store.getChainData(e.prevHash);case 8:if((r=n.sent)&&!(r.totalDifficulty<=0)){n.next=11;break}return n.abrupt("return",We.ERR_ORPHAN);case 11:return n.abrupt("return",this._pushBlockInternal(e,t,r));case 12:case"end":return n.stop()}},_callee243,this)}));return function _pushLightBlock(t){return e.apply(this,arguments)}}()},{key:"_pushBlockInternal",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee244(e,t,r){var n,i,s,o;return _regenerator2["default"].wrap(function _callee244$(u){for(;;)switch(u.prev=u.next){case 0:n=r.totalDifficulty+e.difficulty;u.t0=r.totalWork;u.t1=_e;u.next=5;return e.pow();case 5:u.t2=u.sent;u.t3=u.t1.realDifficulty.call(u.t1,u.t2);i=u.t0+u.t3;s=new Oe(e,n,i);if(!e.prevHash.equals(this.headHash)){u.next=23;break}s.onMainChain=!0;u.next=13;return this._store.putChainData(t,s);case 13:this._mainChain=s;this._headHash=t;if(!this._proof){u.next=21;break}o=this._proof.head.hash();if(!e.prevHash.equals(o)){u.next=21;break}u.next=20;return this._extendChainProof(this._proof,e.header);case 20:this._proof=u.sent;case 21:this.fire("head-changed",this.head,!1);return u.abrupt("return",We.OK_EXTENDED);case 23:if(!(n>this._mainChain.totalDifficulty)){u.next=27;break}u.next=26;return this._rebranch(t,s);case 26:return u.abrupt("return",We.OK_REBRANCHED);case 27:a.v(We,"Creating/extending fork with block "+t+", height="+e.height+", totalDifficulty="+s.totalDifficulty+", totalWork="+s.totalWork);u.next=30;return this._store.putChainData(t,s);case 30:return u.abrupt("return",We.OK_FORKED);case 31:case"end":return u.stop()}},_callee244,this)}));return function _pushBlockInternal(t,r,n){return e.apply(this,arguments)}}()},{key:"_pushBlock",value:function _pushBlock(e){if(this._state===PartialLightChain.State.PROVE_BLOCKS){var t=e.hash();if(this._proofHead.head.prevHash.equals(t))return this._pushBlockBackwards(e);if(this._proofHead.head.hash().equals(t))return this._pushHeadBlock(e)}return Ue.ERR_ORPHAN}},{key:"_pushHeadBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee245(e){var t,r,n,i,s,o,u;return _regenerator2["default"].wrap(function _callee245$(c){for(;;)switch(c.prev=c.next){case 0:t=e.hash();if(e.isFull()){c.next=4;break}a.w(PartialLightChain,"Rejecting block - body missing");return c.abrupt("return",Ue.ERR_INVALID);case 4:c.next=6;return e.verify(this._time);case 6:if(c.sent){c.next=8;break}return c.abrupt("return",Ue.ERR_INVALID);case 8:c.next=10;return this._verifyInterlink(e);case 10:if(c.sent){c.next=13;break}a.w(PartialLightChain,"Rejecting block - interlink verification failed");return c.abrupt("return",Ue.ERR_INVALID);case 13:c.next=15;return this._store.getChainData(e.prevHash);case 15:if(r=c.sent){c.next=19;break}a.w(PartialLightChain,"Rejecting block - unknown predecessor");return c.abrupt("return",Ue.ERR_ORPHAN);case 19:n=r.head;c.next=22;return e.isImmediateSuccessorOf(n);case 22:if(c.sent){c.next=25;break}a.w(PartialLightChain,"Rejecting block - not a valid immediate successor");return c.abrupt("return",Ue.ERR_INVALID);case 25:c.next=27;return this.getNextTarget(n);case 27:i=c.sent;if(!_e.isValidTarget(i)){c.next=34;break}if(e.nBits===_e.targetToCompact(i)){c.next=32;break}a.w(PartialLightChain,"Rejecting block - difficulty mismatch");return c.abrupt("return",Ue.ERR_INVALID);case 32:c.next=35;break;case 34:a.w(PartialLightChain,"Skipping difficulty verification - not enough blocks available");case 35:s=r.totalDifficulty+e.difficulty;c.t0=r.totalWork;c.t1=_e;c.next=40;return e.pow();case 40:c.t2=c.sent;c.t3=c.t1.realDifficulty.call(c.t1,c.t2);o=c.t0+c.t3;u=new Oe(e,s,o);c.next=46;return this._prepend(t,u);case 46:if(c.sent){c.next=48;break}return c.abrupt("return",Ue.ERR_INVALID);case 48:this._mainChain=u;this._proofHead=u;this._headHash=t;if(this.needsMoreBlocks()){c.next=54;break}c.next=54;return this._complete();case 54:return c.abrupt("return",Ue.OK_EXTENDED);case 55:case"end":return c.stop()}},_callee245,this)}));return function _pushHeadBlock(t){return e.apply(this,arguments)}}()},{key:"_pushBlockBackwards",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee246(e){var t,r,n,i,s;return _regenerator2["default"].wrap(function _callee246$(o){for(;;)switch(o.prev=o.next){case 0:t=e.hash();if(e.isFull()){o.next=4;break}a.w(PartialLightChain,"Rejecting block - body missing");return o.abrupt("return",Ue.ERR_INVALID);case 4:o.next=6;return e.verify(this._time);case 6:if(o.sent){o.next=8;break}return o.abrupt("return",Ue.ERR_INVALID);case 8:o.next=10;return this._verifyInterlink(e);case 10:if(o.sent){o.next=13;break}a.w(PartialLightChain,"Rejecting block - interlink verification failed");return o.abrupt("return",Ue.ERR_INVALID);case 13:o.next=15;return this._proofHead.head.isImmediateSuccessorOf(e);case 15:if(o.sent){o.next=18;break}a.w(PartialLightChain,"Rejecting block - not a valid immediate predecessor");return o.abrupt("return",Ue.ERR_INVALID);case 18:o.next=20;return this.getNextTarget(e);case 20:r=o.sent;if(!_e.isValidTarget(r)){o.next=27;break}if(this._proofHead.head.nBits===_e.targetToCompact(r)){o.next=25;break}a.w(PartialLightChain,"Rejecting block - difficulty mismatch");return o.abrupt("return",Ue.ERR_INVALID);case 25:o.next=28;break;case 27:a.w(We,"Skipping difficulty verification - not enough blocks available");case 28:n=this._proofHead.totalDifficulty-this._proofHead.head.difficulty;o.t0=this._proofHead.totalWork;o.t1=_e;o.next=33;return this._proofHead.head.pow();case 33:o.t2=o.sent;o.t3=o.t1.realDifficulty.call(o.t1,o.t2);i=o.t0-o.t3;s=new Oe(e,n,i);o.next=39;return this._prepend(t,s);case 39:if(o.sent){o.next=41;break}return o.abrupt("return",Ue.ERR_INVALID);case 41:return o.abrupt("return",Ue.OK_EXTENDED);case 42:case"end":return o.stop()}},_callee246,this)}));return function _pushBlockBackwards(t){return e.apply(this,arguments)}}()},{key:"_prepend",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee247(e,t){var r;return _regenerator2["default"].wrap(function _callee247$(n){for(;;)switch(n.prev=n.next){case 0:n.prev=0;r=new me;n.next=4;return this._accountsTx.revertBlock(t.head,r);case 4:n.next=10;break;case 6:n.prev=6;n.t0=n["catch"](0);a.w(PartialLightChain,"Rejecting block - failed to commit to AccountsTree: "+(n.t0.message||n.t0));return n.abrupt("return",!1);case 10:t.onMainChain=!0;n.next=13;return this._store.putChainData(e,t);case 13:this._proofHead=t;if(this.needsMoreBlocks()){n.next=17;break}n.next=17;return this._complete();case 17:return n.abrupt("return",!0);case 18:case"end":return n.stop()}},_callee247,this,[[0,6]])}));return function _prepend(t,r){return e.apply(this,arguments)}}()},{key:"pushAccountsTreeChunk",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee248(e){var t;return _regenerator2["default"].wrap(function _callee248$(r){for(;;)switch(r.prev=r.next){case 0:if(this._state===PartialLightChain.State.PROVE_ACCOUNTS_TREE){r.next=2;break}return r.abrupt("return",ue.Status.ERR_INCORRECT_PROOF);case 2:r.next=4;return this._partialTree.pushChunk(e);case 4:if((t=r.sent)===ue.Status.OK_COMPLETE){this._state=PartialLightChain.State.PROVE_BLOCKS;this._accountsTx=new ce(this._partialTree.transaction(!1))}return r.abrupt("return",t);case 7:case"end":return r.stop()}},_callee248,this)}));return function pushAccountsTreeChunk(t){return e.apply(this,arguments)}}()},{key:"_complete",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee249(){var e;return _regenerator2["default"].wrap(function _callee249$(t){for(;;)switch(t.prev=t.next){case 0:this._state=PartialLightChain.State.COMPLETE;if(!this._accountsTx){t.next=5;break}t.next=4;return this._accountsTx.abort();case 4:this._accountsTx=null;case 5:t.next=7;return this.getChainProof();case 7:e=t.sent;this.fire("complete",e,this._headHash,this._mainChain);case 9:case"end":return t.stop()}},_callee249,this)}));return function _complete(){return e.apply(this,arguments)}}()},{key:"commit",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee250(){var e,t;return _regenerator2["default"].wrap(function _callee250$(r){for(;;)switch(r.prev=r.next){case 0:if(!this._accountsTx){r.next=3;break}r.next=3;return this._accountsTx.abort();case 3:r.next=5;return JDB.JungleDB.commitCombined(this._store.tx,this._partialTree.tx);case 5:e=r.sent;this._partialTree=null;r.next=9;return this.getChainProof();case 9:t=r.sent;this.fire("committed",t,this._headHash,this._mainChain);return r.abrupt("return",e);case 12:case"end":return r.stop()}},_callee250,this)}));return function commit(){return e.apply(this,arguments)}}()},{key:"abort",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee251(){return _regenerator2["default"].wrap(function _callee251$(e){for(;;)switch(e.prev=e.next){case 0:this._state=PartialLightChain.State.ABORTED;if(!this._accountsTx){e.next=4;break}e.next=4;return this._accountsTx.abort();case 4:if(!this._partialTree){e.next=7;break}e.next=7;return this._partialTree.abort();case 7:e.next=9;return this._store.abort();case 9:this.fire("aborted");case 10:case"end":return e.stop()}},_callee251,this)}));return function abort(){return e.apply(this,arguments)}}()},{key:"getMissingAccountsPrefix",value:function getMissingAccountsPrefix(){return this._partialTree?this._partialTree.missingPrefix:""}},{key:"getBlockLocators",value:function getBlockLocators(){return this._proofHead?[this._proofHead.head.hash()]:[this.headHash]}},{key:"numBlocksNeeded",value:function numBlocksNeeded(){if(!this._proofHead)return z.NUM_BLOCKS_VERIFICATION;var e=z.NUM_BLOCKS_VERIFICATION-(this.height-this._proofHead.head.height+1);this._proofHead.head.isFull()||e++;return e}},{key:"needsMoreBlocks",value:function needsMoreBlocks(){return this.numBlocksNeeded()>0}},{key:"state",get:function get(){return this._state}},{key:"proofHeadHeight",get:function get(){return this._proofHead.head.height}}]);return PartialLightChain}(Ge);je.State={ABORTED:-1,PROVE_CHAIN:0,PROVE_ACCOUNTS_TREE:1,PROVE_BLOCKS:2,COMPLETE:3};r.register(je);var We=function(e){(0,_inherits3["default"])(NanoChain,e);function NanoChain(e){var t;(0,_classCallCheck3["default"])(this,NanoChain);var r=(0,_possibleConstructorReturn3["default"])(this,(NanoChain.__proto__||(0,_getPrototypeOf2["default"])(NanoChain)).call(this,Re.createVolatile()));r._time=e;r._proof=new Ne(new Ie([Se.GENESIS.toLight()]),new Pe([]));r._headHash=Se.GENESIS.HASH;r._synchronizer=new f;return t=r._init(),(0,_possibleConstructorReturn3["default"])(r,t)}(0,_createClass3["default"])(NanoChain,[{key:"_init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee252(){return _regenerator2["default"].wrap(function _callee252$(e){for(;;)switch(e.prev=e.next){case 0:e.t0=Oe;e.t1=Se.GENESIS;e.t2=Se.GENESIS.difficulty;e.t3=_e;e.next=6;return Se.GENESIS.pow();case 6:e.t4=e.sent;e.t5=e.t3.realDifficulty.call(e.t3,e.t4);this._mainChain=new e.t0(e.t1,e.t2,e.t5,!0);e.next=11;return this._store.putChainData(Se.GENESIS.HASH,this._mainChain);case 11:return e.abrupt("return",this);case 12:case"end":return e.stop()}},_callee252,this)}));return function _init(){return e.apply(this,arguments)}}()},{key:"pushProof",value:function pushProof(e){var t=this;return this._synchronizer.push(function(){return t._pushProof(e)})}},{key:"_pushProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee253(e){var t,r,n,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m,b,C,w,A,S,T,E;return _regenerator2["default"].wrap(function _callee253$(I){for(;;)switch(I.prev=I.next){case 0:t=[];r=0;case 2:if(!(r<e.prefix.length)){I.next=12;break}n=e.prefix.blocks[r];i=n.hash();I.next=7;return this._store.getBlock(i);case 7:I.sent||n.header._pow||t.push(n.header);case 9:++r;I.next=2;break;case 12:s=0;case 13:if(!(s<e.suffix.length)){I.next=23;break}o=e.suffix.headers[s];u=o.hash();I.next=18;return this._store.getBlock(u);case 18:I.sent||o._pow||t.push(o);case 20:++s;I.next=13;break;case 23:I.next=25;return x.manyPow(t);case 25:c=0;case 26:if(!(c<e.prefix.length)){I.next=44;break}l=e.prefix.blocks[c];h=l.hash();I.next=31;return this._store.getBlock(h);case 31:if(!(f=I.sent)){I.next=36;break}e.prefix.blocks[c]=f.toLight();I.next=41;break;case 36:I.next=38;return l.verify(this._time);case 38:if(I.sent){I.next=41;break}a.w(NanoChain,"Rejecting proof - prefix contains invalid block");return I.abrupt("return",!1);case 41:c++;I.next=26;break;case 44:_=0;case 45:if(!(_<e.suffix.length)){I.next=63;break}d=e.suffix.headers[_];p=d.hash();I.next=50;return this._store.getBlock(p);case 50:if(!(g=I.sent)){I.next=55;break}e.suffix.headers[_]=g.header;I.next=60;break;case 55:I.next=57;return d.verifyProofOfWork();case 57:if(I.sent){I.next=60;break}a.w(NanoChain,"Rejecting proof - suffix contains invalid header");return I.abrupt("return",!1);case 60:_++;I.next=45;break;case 63:I.next=65;return e.verify();case 65:if(I.sent){I.next=68;break}a.w(NanoChain,"Rejecting proof - verification failed");return I.abrupt("return",!1);case 68:if(e.suffix.length===z.K||e.suffix.length===e.head.height-1){I.next=71;break}a.w(NanoChain,"Rejecting proof - invalid suffix length");return I.abrupt("return",!1);case 71:if(!(e.prefix.denseSuffix().length<z.M&&e.prefix.length>0&&e.prefix.head.height>=z.M)){I.next=75;break}a.w(NanoChain,"Rejecting proof - dense suffix too short");return I.abrupt("return",!1);case 75:y=[];v=e.prefix.head;k=!0;m=!1;b=undefined;I.prev=80;C=(0,_getIterator3["default"])(e.suffix.headers);case 82:if(k=(w=C.next()).done){I.next=96;break}A=w.value;I.next=86;return v.getNextInterlink(A.target,A.version);case 86:S=I.sent;T=S.hash();if(A.interlinkHash.equals(T)){I.next=91;break}a.w(NanoChain,"Rejecting proof - invalid interlink hash in proof suffix");return I.abrupt("return",!1);case 91:v=new Se(A,S);y.push(v);case 93:k=!0;I.next=82;break;case 96:I.next=102;break;case 98:I.prev=98;I.t0=I["catch"](80);m=!0;b=I.t0;case 102:I.prev=102;I.prev=103;!k&&C["return"]&&C["return"]();case 105:I.prev=105;if(!m){I.next=108;break}throw b;case 108:return I.finish(105);case 109:return I.finish(102);case 110:I.next=112;return this.getChainProof();case 112:E=I.sent;I.next=115;return xe.isBetterProof(e,E,z.M);case 115:if(!I.sent){I.next=118;break}I.next=118;return this._acceptProof(e,y);case 118:return I.abrupt("return",!0);case 119:case"end":return I.stop()}},_callee253,this,[[80,98,102,110],[103,,105,109]])}));return function _pushProof(t){return e.apply(this,arguments)}}()},{key:"_acceptProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee254(e,t){var r,n,a,i,s,o,u,c,l,h,f,_,d,p,g,y,v,k,m;return _regenerator2["default"].wrap(function _callee254$(b){for(;;)switch(b.prev=b.next){case 0:this._proof=e;r=e.prefix.head;n=r.hash();b.next=5;return this._store.getChainData(n);case 5:if((a=b.sent)&&!(a.totalDifficulty<=0)){b.next=43;break}b.next=9;return this._store.truncate();case 9:i=e.prefix.denseSuffix();s=0;case 11:if(!(s<e.prefix.length-i.length)){b.next=20;break}o=e.prefix.blocks[s];u=o.hash();c=new Oe(o,-1,-1,!0);b.next=17;return this._store.putChainData(u,c);case 17:s++;b.next=11;break;case 20:l=i[0];this._headHash=l.hash();b.t0=Oe;b.t1=l;b.t2=l.difficulty;b.t3=_e;b.next=28;return l.pow();case 28:b.t4=b.sent;b.t5=b.t3.realDifficulty.call(b.t3,b.t4);this._mainChain=new b.t0(b.t1,b.t2,b.t5,!0);b.next=33;return this._store.putChainData(this._headHash,this._mainChain);case 33:h=1;case 34:if(!(h<i.length)){b.next=43;break}f=i[h];b.next=38;return this._pushBlock(f);case 38:_=b.sent;C.that(_>=0);case 40:h++;b.next=34;break;case 43:d=!0;p=!1;g=undefined;b.prev=46;y=(0,_getIterator3["default"])(t);case 48:if(d=(v=y.next()).done){b.next=57;break}k=v.value;b.next=52;return this._pushBlock(k);case 52:m=b.sent;C.that(m>=0);case 54:d=!0;b.next=48;break;case 57:b.next=63;break;case 59:b.prev=59;b.t6=b["catch"](46);p=!0;g=b.t6;case 63:b.prev=63;b.prev=64;!d&&y["return"]&&y["return"]();case 66:b.prev=66;if(!p){b.next=69;break}throw g;case 69:return b.finish(66);case 70:return b.finish(63);case 71:case"end":return b.stop()}},_callee254,this,[[46,59,63,71],[64,,66,70]])}));return function _acceptProof(t,r){return e.apply(this,arguments)}}()},{key:"_pushBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee255(e){var t,r;return _regenerator2["default"].wrap(function _callee255$(n){for(;;)switch(n.prev=n.next){case 0:n.next=2;return e.hash();case 2:t=n.sent;n.next=5;return this._store.getBlock(t);case 5:if(!n.sent){n.next=8;break}return n.abrupt("return",NanoChain.OK_KNOWN);case 8:n.next=10;return this._store.getChainData(e.prevHash);case 10:if((r=n.sent)&&!(r.totalDifficulty<=0)){n.next=13;break}return n.abrupt("return",NanoChain.ERR_ORPHAN);case 13:return n.abrupt("return",this._pushBlockInternal(e,t,r));case 14:case"end":return n.stop()}},_callee255,this)}));return function _pushBlock(t){return e.apply(this,arguments)}}()},{key:"pushHeader",value:function pushHeader(e){var t=this;return this._synchronizer.push(function(){return t._pushHeader(e)})}},{key:"_pushHeader",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee256(e){var t,r,n,i,s,o;return _regenerator2["default"].wrap(function _callee256$(u){for(;;)switch(u.prev=u.next){case 0:t=e.hash();u.next=3;return this._store.getBlock(t);case 3:if(!u.sent){u.next=6;break}return u.abrupt("return",NanoChain.OK_KNOWN);case 6:u.next=8;return e.verifyProofOfWork();case 8:if(u.sent){u.next=11;break}a.w(NanoChain,"Rejecting header - PoW verification failed");return u.abrupt("return",NanoChain.ERR_INVALID);case 11:u.next=13;return this._store.getChainData(e.prevHash);case 13:if((r=u.sent)&&!(r.totalDifficulty<=0)){u.next=17;break}a.w(NanoChain,"Rejecting header - unknown predecessor");return u.abrupt("return",NanoChain.ERR_ORPHAN);case 17:n=r.head;if(e.isImmediateSuccessorOf(n.header)){u.next=21;break}a.w(NanoChain,"Rejecting header - not a valid successor");return u.abrupt("return",NanoChain.ERR_INVALID);case 21:u.next=23;return this.getNextTarget(n);case 23:i=u.sent;if(!_e.isValidTarget(i)){u.next=30;break}if(e.nBits===_e.targetToCompact(i)){u.next=28;break}a.w(NanoChain,"Rejecting header - difficulty mismatch");return u.abrupt("return",NanoChain.ERR_INVALID);case 28:u.next=31;break;case 30:a.w(NanoChain,"Skipping difficulty verification - not enough blocks available");case 31:u.next=33;return n.getNextInterlink(e.target,e.version);case 33:s=u.sent;if(s.hash().equals(e.interlinkHash)){u.next=38;break}a.w(NanoChain,"Rejecting header - interlink verification failed");return u.abrupt("return",NanoChain.ERR_INVALID);case 38:o=new Se(e,s);return u.abrupt("return",this._pushBlockInternal(o,t,r));case 40:case"end":return u.stop()}},_callee256,this)}));return function _pushHeader(t){return e.apply(this,arguments)}}()},{key:"_pushBlockInternal",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee257(e,t,r){var n,i,s,o;return _regenerator2["default"].wrap(function _callee257$(u){for(;;)switch(u.prev=u.next){case 0:n=r.totalDifficulty+e.difficulty;u.t0=r.totalWork;u.t1=_e;u.next=5;return e.pow();case 5:u.t2=u.sent;u.t3=u.t1.realDifficulty.call(u.t1,u.t2);i=u.t0+u.t3;s=new Oe(e,n,i);if(!e.prevHash.equals(this.headHash)){u.next=23;break}s.onMainChain=!0;u.next=13;return this._store.putChainData(t,s);case 13:this._mainChain=s;this._headHash=t;if(!this._proof){u.next=21;break}o=this._proof.head.hash();if(!e.prevHash.equals(o)){u.next=21;break}u.next=20;return this._extendChainProof(this._proof,e.header);case 20:this._proof=u.sent;case 21:this.fire("head-changed",this.head,!1);return u.abrupt("return",NanoChain.OK_EXTENDED);case 23:if(!(n>this._mainChain.totalDifficulty)){u.next=27;break}u.next=26;return this._rebranch(t,s);case 26:return u.abrupt("return",NanoChain.OK_REBRANCHED);case 27:a.v(NanoChain,"Creating/extending fork with block "+t+", height="+e.height+", totalDifficulty="+s.totalDifficulty+", totalWork="+s.totalWork);u.next=30;return this._store.putChainData(t,s);case 30:return u.abrupt("return",NanoChain.OK_FORKED);case 31:case"end":return u.stop()}},_callee257,this)}));return function _pushBlockInternal(t,r,n){return e.apply(this,arguments)}}()},{key:"_rebranch",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee258(e,t){var r,n,i,s,o,u,c,l;return _regenerator2["default"].wrap(function _callee258$(h){for(;;)switch(h.prev=h.next){case 0:a.v(NanoChain,"Rebranching to fork "+e+", height="+t.head.height+", totalDifficulty="+t.totalDifficulty+", totalWork="+t.totalWork);r=[];n=[];i=t;s=e;case 5:if(i.onMainChain){h.next=15;break}r.push(i);n.push(s);s=i.head.prevHash;h.next=11;return this._store.getChainData(s);case 11:i=h.sent;C.that(!!i,"Failed to find fork predecessor while rebranching");h.next=5;break;case 15:a.v(NanoChain,function(){return"Found common ancestor "+s.toBase64()+" "+r.length+" blocks up"});o=this._headHash;u=this._mainChain;case 18:if(o.equals(s)){h.next=29;break}u.onMainChain=!1;h.next=22;return this._store.putChainData(o,u);case 22:o=u.head.prevHash;h.next=25;return this._store.getChainData(o);case 25:u=h.sent;C.that(!!u,"Failed to find main chain predecessor while rebranching");h.next=18;break;case 29:this._proof=null;c=r.length-1;case 31:if(!(c>=0)){h.next=42;break}(l=r[c]).onMainChain=!0;h.next=36;return this._store.putChainData(n[c],l);case 36:this._mainChain=r[c];this._headHash=n[c];this.fire("head-changed",this.head,c>0);case 39:c--;h.next=31;break;case 42:case"end":return h.stop()}},_callee258,this)}));return function _rebranch(t,r){return e.apply(this,arguments)}}()},{key:"getChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee259(){return _regenerator2["default"].wrap(function _callee259$(e){for(;;)switch(e.prev=e.next){case 0:if(this._proof){e.next=4;break}e.next=3;return this._getChainProof();case 3:this._proof=e.sent;case 4:return e.abrupt("return",this._proof);case 5:case"end":return e.stop()}},_callee259,this)}));return function getChainProof(){return e.apply(this,arguments)}}()},{key:"head",get:function get(){return this._mainChain.head}},{key:"headHash",get:function get(){return this._headHash}},{key:"height",get:function get(){return this._mainChain.head.height}}]);return NanoChain}(xe);We.ERR_ORPHAN=-2;We.ERR_INVALID=-1;We.OK_KNOWN=0;We.OK_EXTENDED=1;We.OK_REBRANCHED=2;We.OK_FORKED=3;r.register(We);var Ve=function(e){(0,_inherits3["default"])(NanoConsensusAgent,e);function NanoConsensusAgent(e,t,r,n){(0,_classCallCheck3["default"])(this,NanoConsensusAgent);var a=(0,_possibleConstructorReturn3["default"])(this,(NanoConsensusAgent.__proto__||(0,_getPrototypeOf2["default"])(NanoConsensusAgent)).call(this,n));a._blockchain=e;a._mempool=t;a._time=r;a._syncing=!1;a._orphanedBlocks=[];a._synchronizer=new f;a._accountsRequest=null;a._transactionsRequest=null;a._blockRequest=null;a._requestedChainProof=!1;a._requestedTransactionReceipts=!1;n.channel.on("chain-proof",function(e){return a._onChainProof(e)});n.channel.on("accounts-proof",function(e){return a._onAccountsProof(e)});n.channel.on("transactions-proof",function(e){return a._onTransactionsProof(e)});n.channel.on("transaction-receipts",function(e){return a._onTransactionReceipts(e)});n.channel.on("get-chain-proof",function(e){return a._onGetChainProof(e)});a._localSubscription=de.BLOCKS_ONLY;a._peer.channel.subscribe(a._localSubscription);return a}(0,_createClass3["default"])(NanoConsensusAgent,[{key:"subscribeAccounts",value:function subscribeAccounts(e){var t=this;this._localSubscription=de.fromAddresses(e);this._peer.channel.subscribe(de.BLOCKS_ONLY);this._timers.resetTimeout("subscription-change",function(){t._peer.channel.subscribe(t._localSubscription)},NanoConsensusAgent.SUBSCRIPTION_CHANGE_THROTTLE)}},{key:"syncBlockchain",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee260(){return _regenerator2["default"].wrap(function _callee260$(e){for(;;)switch(e.prev=e.next){case 0:this._syncing=!0;e.next=3;return this._blockchain.getBlock(this._peer.headHash);case 3:if(e.sent)this._syncFinished();else{this._requestChainProof();this.fire("sync-chain-proof",this._peer.peerAddress)}case 5:case"end":return e.stop()}},_callee260,this)}));return function syncBlockchain(){return e.apply(this,arguments)}}()},{key:"_syncFinished",value:function _syncFinished(){this._syncing=!1;this._synced=!0;this.fire("sync")}},{key:"_requestChainProof",value:function _requestChainProof(){var e=this;if(!this._requestedChainProof){this._peer.channel.getChainProof();this._requestedChainProof=!0;this._peer.channel.expectMessage(Je.Type.CHAIN_PROOF,function(){e._peer.channel.close($t.GET_CHAIN_PROOF_TIMEOUT,"getChainProof timeout")},NanoConsensusAgent.CHAINPROOF_REQUEST_TIMEOUT,NanoConsensusAgent.CHAINPROOF_CHUNK_TIMEOUT)}}},{key:"_onChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee261(e){return _regenerator2["default"].wrap(function _callee261$(t){for(;;)switch(t.prev=t.next){case 0:a.d(NanoConsensusAgent,"[CHAIN-PROOF] Received from "+this._peer.peerAddress+": "+e.proof);if(this._requestedChainProof){t.next=4;break}a.w(NanoConsensusAgent,"Unsolicited chain proof received from "+this._peer.peerAddress);return t.abrupt("return");case 4:this._requestedChainProof=!1;this._syncing&&this.fire("verify-chain-proof",this._peer.peerAddress);t.next=8;return this._blockchain.pushProof(e.proof);case 8:if(t.sent){t.next=12;break}a.w(NanoConsensusAgent,"Invalid chain proof received from "+this._peer.peerAddress+" - verification failed");this._peer.channel.close($t.INVALID_CHAIN_PROOF,"invalid chain proof");return t.abrupt("return");case 12:t.next=14;return this._applyOrphanedBlocks();case 14:this._syncing&&this._syncFinished();case 15:case"end":return t.stop()}},_callee261,this)}));return function _onChainProof(t){return e.apply(this,arguments)}}()},{key:"_applyOrphanedBlocks",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee262(){var e,t,r,n,a,i;return _regenerator2["default"].wrap(function _callee262$(s){for(;;)switch(s.prev=s.next){case 0:e=!0;t=!1;r=undefined;s.prev=3;n=(0,_getIterator3["default"])(this._orphanedBlocks);case 5:if(e=(a=n.next()).done){s.next=16;break}i=a.value;s.next=9;return this._blockchain.pushHeader(i);case 9:if(s.sent!==We.ERR_INVALID){s.next=13;break}this._peer.channel.close($t.RECEIVED_INVALID_BLOCK,"received invalid block");return s.abrupt("break",16);case 13:e=!0;s.next=5;break;case 16:s.next=22;break;case 18:s.prev=18;s.t0=s["catch"](3);t=!0;r=s.t0;case 22:s.prev=22;s.prev=23;!e&&n["return"]&&n["return"]();case 25:s.prev=25;if(!t){s.next=28;break}throw r;case 28:return s.finish(25);case 29:return s.finish(22);case 30:this._orphanedBlocks=[];case 31:case"end":return s.stop()}},_callee262,this,[[3,18,22,30],[23,,25,29]])}));return function _applyOrphanedBlocks(){return e.apply(this,arguments)}}()},{key:"_doRequestData",value:function _doRequestData(e){var t=[],r=[],n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(e);!(n=(s=o.next()).done);n=!0){var u=s.value;u.type===at.Type.BLOCK?t.push(u):r.push(u)}}catch(c){a=!0;i=c}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}this._peer.channel.getHeader(t);this._peer.channel.getData(r)}},{key:"_getBlock",value:function _getBlock(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];return this._blockchain.getBlock(e,t)}},{key:"_getTransaction",value:function _getTransaction(e){return _promise2["default"].resolve(this._mempool.getTransaction(e))}},{key:"_processHeader",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee263(e,t){var r;return _regenerator2["default"].wrap(function _callee263$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return this._blockchain.pushHeader(t);case 2:if((r=e.sent)===We.ERR_INVALID)this._peer.channel.close($t.RECEIVED_INVALID_HEADER,"received invalid header");else if(r===We.ERR_ORPHAN){this._orphanedBlocks.push(t);this._synced&&this._requestChainProof()}case 4:case"end":return e.stop()}},_callee263,this)}));return function _processHeader(t,r){return e.apply(this,arguments)}}()},{key:"_processTransaction",value:function _processTransaction(e,t){this._localSubscription.matchesTransaction(t)||this._peer.channel.close($t.RECEIVED_TRANSACTION_NOT_MATCHING_OUR_SUBSCRIPTION,"received transaction not matching our subscription");return this._mempool.pushTransaction(t)}},{key:"_onGetChainProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee264(e){var t;return _regenerator2["default"].wrap(function _callee264$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return this._blockchain.getChainProof();case 2:(t=e.sent)&&this._peer.channel.chainProof(t);case 4:case"end":return e.stop()}},_callee264,this)}));return function _onGetChainProof(t){return e.apply(this,arguments)}}()},{key:"getAccounts",value:function getAccounts(e,t){var r=this;return this._synchronizer.push(function(){return r._getAccounts(e,t)})}},{key:"_getAccounts",value:function _getAccounts(e,t){var r=this;C.that(null===this._accountsRequest);a.d(NanoConsensusAgent,"Requesting AccountsProof for "+t+" from "+this._peer.peerAddress);return new _promise2["default"](function(n,a){r._accountsRequest={addresses:t,blockHash:e,resolve:n,reject:a};r._peer.channel.getAccountsProof(e,t);r._peer.channel.expectMessage(Je.Type.ACCOUNTS_PROOF,function(){r._peer.channel.close($t.GET_ACCOUNTS_PROOF_TIMEOUT,"getAccountsProof timeout");a(new Error("timeout"))},NanoConsensusAgent.ACCOUNTSPROOF_REQUEST_TIMEOUT)})}},{key:"_onAccountsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee265(e){var t,r,n,i,s,o,u,c,l,h,f,_,d,p;return _regenerator2["default"].wrap(function _callee265$(g){for(;;)switch(g.prev=g.next){case 0:a.d(NanoConsensusAgent,"[ACCOUNTS-PROOF] Received from "+this._peer.peerAddress+": blockHash="+e.blockHash+", proof="+e.proof+" ("+e.serializedSize+" bytes)");if(this._accountsRequest){g.next=4;break}a.w(NanoConsensusAgent,"Unsolicited accounts proof received from "+this._peer.peerAddress);return g.abrupt("return");case 4:t=this._accountsRequest.addresses;r=this._accountsRequest.blockHash;n=this._accountsRequest.resolve;i=this._accountsRequest.reject;this._accountsRequest=null;if(e.hasProof()){g.next=12;break}i(new Error("Accounts request was rejected"));return g.abrupt("return");case 12:if(r.equals(e.blockHash)){g.next=16;break}a.w(NanoConsensusAgent,"Received AccountsProof for invalid reference block from "+this._peer.peerAddress);i(new Error("Invalid reference block"));return g.abrupt("return");case 16:if((s=e.proof).verify()){g.next=22;break}a.w(NanoConsensusAgent,"Invalid AccountsProof received from "+this._peer.peerAddress);this._peer.channel.close($t.INVALID_ACCOUNTS_PROOF,"Invalid AccountsProof");i(new Error("Invalid AccountsProof"));return g.abrupt("return");case 22:o=s.root();g.next=25;return this._blockchain.getBlock(r);case 25:if(g.sent.accountsHash.equals(o)){g.next=31;break}a.w(NanoConsensusAgent,"Invalid AccountsProof (root hash) received from "+this._peer.peerAddress);this._peer.channel.close($t.ACCOUNTS_PROOF_ROOT_HASH_MISMATCH,"AccountsProof root hash mismatch");i(new Error("AccountsProof root hash mismatch"));return g.abrupt("return");case 31:u=[];c=!0;l=!1;h=undefined;g.prev=35;f=(0,_getIterator3["default"])(t);case 37:if(c=(_=f.next()).done){g.next=53;break}d=_.value;g.prev=39;p=s.getAccount(d);u.push(p);g.next=50;break;case 44:g.prev=44;g.t0=g["catch"](39);a.w(NanoConsensusAgent,"Incomplete AccountsProof received from "+this._peer.peerAddress);this._peer.channel.close($t.INCOMPLETE_ACCOUNTS_PROOF,"Incomplete AccountsProof");i(new Error("Incomplete AccountsProof"));return g.abrupt("return");case 50:c=!0;g.next=37;break;case 53:g.next=59;break;case 55:g.prev=55;g.t1=g["catch"](35);l=!0;h=g.t1;case 59:g.prev=59;g.prev=60;!c&&f["return"]&&f["return"]();case 62:g.prev=62;if(!l){g.next=65;break}throw h;case 65:return g.finish(62);case 66:return g.finish(59);case 67:n(u);case 68:case"end":return g.stop()}},_callee265,this,[[35,55,59,67],[39,44],[60,,62,66]])}));return function _onAccountsProof(t){return e.apply(this,arguments)}}()},{key:"getTransactionsProof",value:function getTransactionsProof(e,t){var r=this;return this._synchronizer.push(function(){return r._getTransactionsProof(e,t)})}},{key:"_getTransactionsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee266(e,t){var r,n=this;return _regenerator2["default"].wrap(function _callee266$(i){for(;;)switch(i.prev=i.next){case 0:C.that(null===this._transactionsRequest);a.d(NanoConsensusAgent,"Requesting TransactionsProof for "+t+" from "+this._peer.peerAddress);i.next=4;return this._blockchain.getBlock(e);case 4:if(r=i.sent){i.next=8;break}a.d(NanoConsensusAgent,"Requested block with hash "+e+" not found");return i.abrupt("return",[]);case 8:return i.abrupt("return",new _promise2["default"](function(a,i){n._transactionsRequest={addresses:t,blockHash:e,header:r.header,resolve:a,reject:i};n._peer.channel.getTransactionsProof(e,t);n._peer.channel.expectMessage(Je.Type.TRANSACTIONS_PROOF,function(){n._peer.channel.close($t.GET_TRANSACTIONS_PROOF_TIMEOUT,"getTransactionsProof timeout");i(new Error("timeout"))},NanoConsensusAgent.TRANSACTIONSPROOF_REQUEST_TIMEOUT)}));case 9:case"end":return i.stop()}},_callee266,this)}));return function _getTransactionsProof(t,r){return e.apply(this,arguments)}}()},{key:"_onTransactionsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee267(e){var t,r,n,i,s;return _regenerator2["default"].wrap(function _callee267$(o){for(;;)switch(o.prev=o.next){case 0:a.d(NanoConsensusAgent,"[TRANSACTIONS-PROOF] Received from "+this._peer.peerAddress+": blockHash="+e.blockHash+", transactions="+e.transactions+", proof="+e.proof+" ("+e.serializedSize+" bytes)");if(this._transactionsRequest){o.next=4;break}a.w(NanoConsensusAgent,"Unsolicited transactions proof received from "+this._peer.peerAddress);return o.abrupt("return");case 4:t=this._transactionsRequest.blockHash;r=this._transactionsRequest.header;n=this._transactionsRequest.resolve;i=this._transactionsRequest.reject;this._transactionsRequest=null;if(e.hasProof()){o.next=13;break}a.w(NanoConsensusAgent,"TransactionsProof request was rejected by "+this._peer.peerAddress);i(new Error("TransactionsProof request was rejected"));return o.abrupt("return");case 13:if(t.equals(e.blockHash)){o.next=17;break}a.w(NanoConsensusAgent,"Received TransactionsProof for invalid reference block from "+this._peer.peerAddress);i(new Error("Invalid reference block"));return o.abrupt("return");case 17:s=e.proof;if(r.bodyHash.equals(s.root())){o.next=23;break}a.w(NanoConsensusAgent,"Invalid TransactionsProof received from "+this._peer.peerAddress);this._peer.channel.close($t.INVALID_TRANSACTION_PROOF,"Invalid TransactionsProof");i(new Error("Invalid TransactionsProof"));return o.abrupt("return");case 23:n(s.transactions);case 24:case"end":return o.stop()}},_callee267,this)}));return function _onTransactionsProof(t){return e.apply(this,arguments)}}()},{key:"getTransactionReceipts",value:function getTransactionReceipts(e){var t=this;this._peer.channel.getTransactionReceipts(e);this._requestedTransactionReceipts=!0;this._peer.channel.expectMessage(Je.Type.TRANSACTION_RECEIPTS,function(){t._peer.channel.close($t.GET_TRANSACTION_RECEIPTS_TIMEOUT,"getTransactionReceipts timeout")},NanoConsensusAgent.TRANSACTIONS_REQUEST_TIMEOUT)}},{key:"_onTransactionReceipts",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee268(e){return _regenerator2["default"].wrap(function _callee268$(t){for(;;)switch(t.prev=t.next){case 0:a.d(NanoConsensusAgent,"[TRANSACTION-RECEIPTS] Received from "+this._peer.peerAddress+": "+e.transactionReceipts.length);if(this._requestedTransactionReceipts){t.next=4;break}a.w(NanoConsensusAgent,"Unsolicited transaction receipts received from "+this._peer.peerAddress);return t.abrupt("return");case 4:this._requestedTransactionReceipts=!1;this.fire("transaction-receipts",e.transactionReceipts);case 6:case"end":return t.stop()}},_callee268,this)}));return function _onTransactionReceipts(t){return e.apply(this,arguments)}}()},{key:"getFullBlock",value:function getFullBlock(e){var t=this;return this._synchronizer.push(function(){return t._getFullBlock(e)})}},{key:"_getFullBlock",value:function _getFullBlock(e){var t=this;C.that(null===this._blockRequest);a.d(NanoConsensusAgent,"Requesting full block "+e+" from "+this._peer.peerAddress);return new _promise2["default"](function(r,n){t._blockRequest={hash:e,resolve:r,reject:n};var a=new at(at.Type.BLOCK,e);t._peer.channel.getData([a]);t._peer.channel.expectMessage([Je.Type.BLOCK,Je.Type.NOT_FOUND],function(){n(new Error("timeout"))},Le.REQUEST_TIMEOUT)})}},{key:"_onBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee269(e){var t,r,n;return _regenerator2["default"].wrap(function _callee269$(i){for(;;)switch(i.prev=i.next){case 0:if(this._blockRequest){i.next=3;break}a.w(NanoConsensusAgent,"Unsolicited block message received from "+this._peer.peerAddress+", discarding");return i.abrupt("return");case 3:t=this._blockRequest.hash;r=this._blockRequest.resolve;n=this._blockRequest.reject;this._blockRequest=null;if(e.block.hash().equals(t)){i.next=12;break}a.w(NanoConsensusAgent,"Unexpected block received from "+this._peer.peerAddress+", discarding");n(new Error("Unexpected block"));return i.abrupt("return");case 12:i.next=14;return e.block.verify(this._time);case 14:if(i.sent){i.next=19;break}a.w(NanoConsensusAgent,"Invalid block received from "+this._peer.peerAddress);this._peer.channel.close($t.INVALID_BLOCK,"Invalid block");n(new Error("Invalid block"));return i.abrupt("return");case 19:r(e.block);case 20:case"end":return i.stop()}},_callee269,this)}));return function _onBlock(t){return e.apply(this,arguments)}}()},{key:"_onNotFound",value:function _onNotFound(e){if(this._blockRequest&&1===e.vectors.length&&e.vectors[0].hash.equals(this._blockRequest.hash)){var t=this._blockRequest.reject;this._blockRequest=null;t(new Error("Block not found"))}(0,_get3["default"])(NanoConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(NanoConsensusAgent.prototype),"_onNotFound",this).call(this,e)}},{key:"_onClose",value:function _onClose(){this._synchronizer.clear();(0,_get3["default"])(NanoConsensusAgent.prototype.__proto__||(0,_getPrototypeOf2["default"])(NanoConsensusAgent.prototype),"_onClose",this).call(this)}}]);return NanoConsensusAgent}(Le);Ve.CHAINPROOF_REQUEST_TIMEOUT=45e3;Ve.CHAINPROOF_CHUNK_TIMEOUT=1e4;Ve.ACCOUNTSPROOF_REQUEST_TIMEOUT=5e3;Ve.TRANSACTIONSPROOF_REQUEST_TIMEOUT=1e4;Ve.TRANSACTIONS_REQUEST_TIMEOUT=15e3;Ve.SUBSCRIPTION_CHANGE_THROTTLE=2e3;r.register(Ve);var qe=function(e){(0,_inherits3["default"])(NanoConsensus,e);function NanoConsensus(e,t,r){(0,_classCallCheck3["default"])(this,NanoConsensus);var n=(0,_possibleConstructorReturn3["default"])(this,(NanoConsensus.__proto__||(0,_getPrototypeOf2["default"])(NanoConsensus)).call(this));n._blockchain=e;n._mempool=t;n._network=r;n._agents=new y;n._timers=new _;n._established=!1;n._syncPeer=null;n._addresses=[];r.on("peer-joined",function(e){return n._onPeerJoined(e)});r.on("peer-left",function(e){return n._onPeerLeft(e)});e.on("head-changed",function(e){return n._onHeadChanged(e)});return n}(0,_createClass3["default"])(NanoConsensus,[{key:"_onPeerJoined",value:function _onPeerJoined(e){var t=this,r=new Ve(this._blockchain,this._mempool,this._network.time,e);this._agents.put(e.id,r);r.on("close",function(){return t._onPeerLeft(r.peer)});r.on("sync",function(){return t._onPeerSynced(r.peer)});this.bubble(r,"sync-chain-proof","verify-chain-proof");r.subscribeAccounts(this._addresses);this._timers.resetTimeout("sync",this._syncBlockchain.bind(this),NanoConsensus.SYNC_THROTTLE)}},{key:"_onPeerLeft",value:function _onPeerLeft(e){if(e.equals(this._syncPeer)){a.w(NanoConsensus,"Peer "+e.peerAddress+" left during sync");this._syncPeer=null;this.fire("sync-failed",e.peerAddress)}this._agents.remove(e.id);this._syncBlockchain()}},{key:"_syncBlockchain",value:function _syncBlockchain(){if(!this._syncPeer){var e=this._agents.values().filter(function(e){return!e.synced}),t=g.randomElement(e);if(t){this._syncPeer=t.peer;this._established||this.fire("syncing",t.peer.peerAddress,e.length-1);a.v(NanoConsensus,"Syncing blockchain with peer "+t.peer.peerAddress);t.syncBlockchain()["catch"](a.w.tag(Ve))}else if(this._agents.length>0){if(!this._established){a.i(NanoConsensus,"Synced with all connected peers ("+this._agents.length+"), consensus established.");a.d(NanoConsensus,"Blockchain: height="+this._blockchain.height+", headHash="+this._blockchain.headHash);this._established=!0;this.fire("established")}}else{this._established=!1;this.fire("lost")}}}},{key:"_onPeerSynced",value:function _onPeerSynced(e){if(e.equals(this._syncPeer)){a.v(NanoConsensus,"Finished sync with peer "+e.peerAddress);this._syncPeer=null;this.fire("sync-finished",e.peerAddress)}this._syncBlockchain()}},{key:"_onHeadChanged",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee270(e){var t,r,n,a,i,s;return _regenerator2["default"].wrap(function _callee270$(o){for(;;)switch(o.prev=o.next){case 0:if(this._established){o.next=2;break}return o.abrupt("return");case 2:t=!0;r=!1;n=undefined;o.prev=5;for(a=(0,_getIterator3["default"])(this._agents.values());!(t=(i=a.next()).done);t=!0)i.value.relayBlock(e);o.next=13;break;case 9:o.prev=9;o.t0=o["catch"](5);r=!0;n=o.t0;case 13:o.prev=13;o.prev=14;!t&&a["return"]&&a["return"]();case 16:o.prev=16;if(!r){o.next=19;break}throw n;case 19:return o.finish(16);case 20:return o.finish(13);case 21:o.next=23;return this.getTransactionsProof(this._addresses,e.hash());case 23:s=o.sent;this._mempool.changeHead(e,s);case 25:case"end":return o.stop()}},_callee270,this,[[5,9,13,21],[14,,16,20]])}));return function _onHeadChanged(t){return e.apply(this,arguments)}}()},{key:"getAccount",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee271(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return _regenerator2["default"].wrap(function _callee271$(r){for(;;)switch(r.prev=r.next){case 0:r.next=2;return this.getAccounts([e],t);case 2:return r.abrupt("return",r.sent[0]);case 3:case"end":return r.stop()}},_callee271,this)}));return function getAccount(t){return e.apply(this,arguments)}}()},{key:"getAccounts",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee272(e){var t,r,n,i,s,o,u,c=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return _regenerator2["default"].wrap(function _callee272$(l){for(;;)switch(l.prev=l.next){case 0:c=c||this._blockchain.headHash;t=this._agents.values().filter(function(e){return e.synced&&e.knowsBlock(c)&&!h.isNanoNode(e.peer.peerAddress.services)});r=!0;n=!1;i=undefined;l.prev=5;s=(0,_getIterator3["default"])(t);case 7:if(r=(o=s.next()).done){l.next=21;break}u=o.value;l.prev=9;l.next=12;return u.getAccounts(c,e);case 12:return l.abrupt("return",l.sent);case 15:l.prev=15;l.t0=l["catch"](9);a.w(NanoConsensus,"Failed to retrieve accounts "+e+" from "+u.peer.peerAddress+": "+l.t0);case 18:r=!0;l.next=7;break;case 21:l.next=27;break;case 23:l.prev=23;l.t1=l["catch"](5);n=!0;i=l.t1;case 27:l.prev=27;l.prev=28;!r&&s["return"]&&s["return"]();case 30:l.prev=30;if(!n){l.next=33;break}throw i;case 33:return l.finish(30);case 34:return l.finish(27);case 35:throw new Error("Failed to retrieve accounts "+e);case 36:case"end":return l.stop()}},_callee272,this,[[5,23,27,35],[9,15],[28,,30,34]])}));return function getAccounts(t){return e.apply(this,arguments)}}()},{key:"subscribeAccounts",value:function subscribeAccounts(e){this._addresses=e;var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._agents.values());!(t=(a=i.next()).done);t=!0){a.value.subscribeAccounts(this._addresses)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"getTransactionsProof",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee273(e){var t,r,n,i,s,o,u,c=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return _regenerator2["default"].wrap(function _callee273$(l){for(;;)switch(l.prev=l.next){case 0:c=c||this._blockchain.headHash;t=this._agents.values().filter(function(e){return e.synced&&e.knowsBlock(c)&&!h.isNanoNode(e.peer.peerAddress.services)});r=!0;n=!1;i=undefined;l.prev=5;s=(0,_getIterator3["default"])(t);case 7:if(r=(o=s.next()).done){l.next=21;break}u=o.value;l.prev=9;l.next=12;return u.getTransactionsProof(c,e);case 12:return l.abrupt("return",l.sent);case 15:l.prev=15;l.t0=l["catch"](9);a.w(NanoConsensus,"Failed to retrieve transactions for "+e+" from "+u.peer.peerAddress+": "+l.t0);case 18:r=!0;l.next=7;break;case 21:l.next=27;break;case 23:l.prev=23;l.t1=l["catch"](5);n=!0;i=l.t1;case 27:l.prev=27;l.prev=28;!r&&s["return"]&&s["return"]();case 30:l.prev=30;if(!n){l.next=33;break}throw i;case 33:return l.finish(30);case 34:return l.finish(27);case 35:throw new Error("Failed to retrieve transactions for "+e);case 36:case"end":return l.stop()}},_callee273,this,[[5,23,27,35],[9,15],[28,,30,34]])}));return function getTransactionsProof(t){return e.apply(this,arguments)}}()},{key:"relayTransaction",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee274(e){var t,r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee274$(u){for(;;)switch(u.prev=u.next){case 0:if(this._agents.values().some(function(e){return!h.isNanoNode(e.peer.peerAddress.services)})){u.next=2;break}throw new Error("Failed to relay transaction - only nano nodes connected");case 2:u.next=4;return this._mempool.pushTransaction(e);case 4:if(u.sent){u.next=6;break}throw new Error("Failed to relay transaction - mempool rejected transaction");case 6:t=!1;r=!0;n=!1;a=undefined;u.prev=10;for(i=(0,_getIterator3["default"])(this._agents.values());!(r=(s=i.next()).done);r=!0){o=s.value;t=o.relayTransaction(e)||t}u.next=18;break;case 14:u.prev=14;u.t0=u["catch"](10);n=!0;a=u.t0;case 18:u.prev=18;u.prev=19;!r&&i["return"]&&i["return"]();case 21:u.prev=21;if(!n){u.next=24;break}throw a;case 24:return u.finish(21);case 25:return u.finish(18);case 26:if(t){u.next=28;break}throw new Error("Failed to relay transaction - no agent relayed transaction");case 28:case"end":return u.stop()}},_callee274,this,[[10,14,18,26],[19,,21,25]])}));return function relayTransaction(t){return e.apply(this,arguments)}}()},{key:"getFullBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee275(e){var t,r,n,i,s,o,u;return _regenerator2["default"].wrap(function _callee275$(c){for(;;)switch(c.prev=c.next){case 0:t=this._agents.values().filter(function(e){return e.synced&&!h.isNanoNode(e.peer.peerAddress.services)});r=!0;n=!1;i=undefined;c.prev=4;s=(0,_getIterator3["default"])(t);case 6:if(r=(o=s.next()).done){c.next=20;break}u=o.value;c.prev=8;c.next=11;return u.getFullBlock(e);case 11:return c.abrupt("return",c.sent);case 14:c.prev=14;c.t0=c["catch"](8);a.w(NanoConsensus,"Failed to retrieve full block "+e+" from "+u.peer.peerAddress+": "+c.t0);case 17:r=!0;c.next=6;break;case 20:c.next=26;break;case 22:c.prev=22;c.t1=c["catch"](4);n=!0;i=c.t1;case 26:c.prev=26;c.prev=27;!r&&s["return"]&&s["return"]();case 29:c.prev=29;if(!n){c.next=32;break}throw i;case 32:return c.finish(29);case 33:return c.finish(26);case 34:throw new Error("Failed to retrieve block "+e);case 35:case"end":return c.stop()}},_callee275,this,[[4,22,26,34],[8,14],[27,,29,33]])}));return function getFullBlock(t){return e.apply(this,arguments)}}()},{key:"established",get:function get(){return this._established}},{key:"blockchain",get:function get(){return this._blockchain}},{key:"mempool",get:function get(){return this._mempool}},{key:"network",get:function get(){return this._network}}]);return NanoConsensus}(i);qe.SYNC_THROTTLE=1e3;r.register(qe);var $e=function(e){(0,_inherits3["default"])(NanoMempool,e);function NanoMempool(e){(0,_classCallCheck3["default"])(this,NanoMempool);var t=(0,_possibleConstructorReturn3["default"])(this,(NanoMempool.__proto__||(0,_getPrototypeOf2["default"])(NanoMempool)).call(this));t._blockchain=e;t._transactionsByHash=new y;t._transactionSetByAddress=new y;return t}(0,_createClass3["default"])(NanoMempool,[{key:"pushTransaction",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee276(e){var t,r;return _regenerator2["default"].wrap(function _callee276$(n){for(;;)switch(n.prev=n.next){case 0:t=e.hash();if(!this._transactionsByHash.contains(t)){n.next=4;break}a.v(ze,function(){return"Ignoring known transaction "+t.toBase64()});return n.abrupt("return",!1);case 4:if(!(this._blockchain.height>=e.validityStartHeight+z.TRANSACTION_VALIDITY_WINDOW)){n.next=7;break}a.v(ze,function(){return"Ignoring expired transaction "+t.toBase64()});return n.abrupt("return",!1);case 7:if(e.verify()){n.next=9;break}return n.abrupt("return",!1);case 9:this._transactionsByHash.put(t,e);(r=this._transactionSetByAddress.get(e.sender)||new Be).add(e);this._transactionSetByAddress.put(e.sender,r);this.fire("transaction-added",e);return n.abrupt("return",!0);case 15:case"end":return n.stop()}},_callee276,this)}));return function pushTransaction(t){return e.apply(this,arguments)}}()},{key:"getTransaction",value:function getTransaction(e){return this._transactionsByHash.get(e)}},{key:"getTransactions",value:function getTransactions(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:5e3;return this._transactionsByHash.values().sort(function(e,t){return e.compare(t)}).slice(0,e)}},{key:"getPendingTransactions",value:function getPendingTransactions(e){var t=this._transactionSetByAddress.get(e);return t?t.transactions:[]}},{key:"changeHead",value:function changeHead(e,t){this._evictTransactions(e.height,t)}},{key:"_evictTransactions",value:function _evictTransactions(e,t){var r=!0,n=!1,a=undefined;try{for(var i,s=(0,_getIterator3["default"])(this._transactionsByHash.values());!(r=(i=s.next()).done);r=!0){var o=i.value,u=o.hash();if(e>=o.validityStartHeight+z.TRANSACTION_VALIDITY_WINDOW){this._transactionsByHash.remove(u);var c=this._transactionSetByAddress.get(o.sender);c.remove(o);0===c.length&&this._transactionSetByAddress.remove(o.sender);this.fire("transaction-expired",o)}}}catch(v){n=!0;a=v}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}var l=!0,h=!1,f=undefined;try{for(var _,d=(0,_getIterator3["default"])(t);!(l=(_=d.next()).done);l=!0){var p=_.value,g=p.hash();if(this._transactionsByHash.contains(g)){this._transactionsByHash.remove(g);var y=this._transactionSetByAddress.get(p.sender);y.remove(p);0===y.length&&this._transactionSetByAddress.remove(p.sender);this.fire("transaction-mined",p)}}}catch(v){h=!0;f=v}finally{try{!l&&d["return"]&&d["return"]()}finally{if(h)throw f}}}}]);return NanoMempool}(i);r.register($e);var Xe=function(e){(0,_inherits3["default"])(ConsensusDB,e);(0,_createClass3["default"])(ConsensusDB,null,[{key:"getFull",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee277(){return _regenerator2["default"].wrap(function _callee277$(e){for(;;)switch(e.prev=e.next){case 0:if(ConsensusDB._instance){e.next=4;break}e.next=3;return new ConsensusDB("full-consensus");case 3:ConsensusDB._instance=e.sent;case 4:return e.abrupt("return",ConsensusDB._instance);case 5:case"end":return e.stop()}},_callee277,this)}));return function getFull(){return e.apply(this,arguments)}}()},{key:"getLight",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee278(){return _regenerator2["default"].wrap(function _callee278$(e){for(;;)switch(e.prev=e.next){case 0:if(ConsensusDB._instance){e.next=4;break}e.next=3;return new ConsensusDB("light-consensus");case 3:ConsensusDB._instance=e.sent;case 4:return e.abrupt("return",ConsensusDB._instance);case 5:case"end":return e.stop()}},_callee278,this)}));return function getLight(){return e.apply(this,arguments)}}()}]);function ConsensusDB(e){var t;(0,_classCallCheck3["default"])(this,ConsensusDB);var r=(0,_possibleConstructorReturn3["default"])(this,(ConsensusDB.__proto__||(0,_getPrototypeOf2["default"])(ConsensusDB)).call(this,e,ConsensusDB.VERSION));return t=r._init(),(0,_possibleConstructorReturn3["default"])(r,t)}(0,_createClass3["default"])(ConsensusDB,[{key:"_init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee279(){return _regenerator2["default"].wrap(function _callee279$(e){for(;;)switch(e.prev=e.next){case 0:te.initPersistent(this);Re.initPersistent(this);Ce.initPersistent(this);e.next=5;return this.connect();case 5:return e.abrupt("return",this);case 6:case"end":return e.stop()}},_callee279,this)}));return function _init(){return e.apply(this,arguments)}}()}]);return ConsensusDB}(JDB.JungleDB);Xe._instance=null;Xe.VERSION=3;r.register(Xe);var Ye=function(){function Consensus(){(0,_classCallCheck3["default"])(this,Consensus)}(0,_createClass3["default"])(Consensus,null,[{key:"full",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee280(){var e,t,r,n,a,i,s,o=arguments.length>0&&arguments[0]!==undefined?arguments[0]:sr.getDefault();return _regenerator2["default"].wrap(function _callee280$(u){for(;;)switch(u.prev=u.next){case 0:u.next=2;return x.prepareSyncCryptoWorker();case 2:o.services=new h(h.FULL,h.FULL);u.next=5;return o.initPersistent();case 5:e=new p;u.next=8;return Xe.getFull();case 8:t=u.sent;u.next=11;return ce.getPersistent(t);case 11:r=u.sent;u.next=14;return Ce.getPersistent(t);case 14:n=u.sent;u.next=17;return Ue.getPersistent(t,r,e,n);case 17:a=u.sent;i=new ze(a,r);s=new lr(a,o,e);return u.abrupt("return",new He(a,i,s));case 21:case"end":return u.stop()}},_callee280,this)}));return function full(){return e.apply(this,arguments)}}()},{key:"light",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee281(){var e,t,r,n,a,i,s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:sr.getDefault();return _regenerator2["default"].wrap(function _callee281$(o){for(;;)switch(o.prev=o.next){case 0:o.next=2;return x.prepareSyncCryptoWorker();case 2:s.services=new h(h.LIGHT,h.LIGHT|h.FULL);o.next=5;return s.initPersistent();case 5:e=new p;o.next=8;return Xe.getLight();case 8:t=o.sent;o.next=11;return ce.getPersistent(t);case 11:r=o.sent;o.next=14;return Ge.getPersistent(t,r,e);case 14:n=o.sent;a=new ze(n,r);i=new lr(n,s,e);return o.abrupt("return",new Fe(n,a,i));case 18:case"end":return o.stop()}},_callee281,this)}));return function light(){return e.apply(this,arguments)}}()},{key:"nano",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee282(){var e,t,r,n,a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:sr.getDefault();return _regenerator2["default"].wrap(function _callee282$(i){for(;;)switch(i.prev=i.next){case 0:i.next=2;return x.prepareSyncCryptoWorker();case 2:a.services=new h(h.NANO,h.NANO|h.LIGHT|h.FULL);i.next=5;return a.initPersistent();case 5:e=new p;i.next=8;return new We(e);case 8:t=i.sent;r=new $e(t);n=new lr(t,a,e);return i.abrupt("return",new qe(t,r,n));case 12:case"end":return i.stop()}},_callee282,this)}));return function nano(){return e.apply(this,arguments)}}()},{key:"volatileFull",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee283(){var e,t,r,n,a,i,s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:sr.getDefault();return _regenerator2["default"].wrap(function _callee283$(o){for(;;)switch(o.prev=o.next){case 0:o.next=2;return x.prepareSyncCryptoWorker();case 2:s.services=new h(h.FULL,h.FULL);o.next=5;return s.initVolatile();case 5:e=new p;o.next=8;return ce.createVolatile();case 8:t=o.sent;o.next=11;return Ce.createVolatile();case 11:r=o.sent;o.next=14;return Ue.createVolatile(t,e,r);case 14:n=o.sent;a=new ze(n,t);i=new lr(n,s,e);return o.abrupt("return",new He(n,a,i));case 18:case"end":return o.stop()}},_callee283,this)}));return function volatileFull(){return e.apply(this,arguments)}}()},{key:"volatileLight",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee284(){var e,t,r,n,a,i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:sr.getDefault();return _regenerator2["default"].wrap(function _callee284$(s){for(;;)switch(s.prev=s.next){case 0:s.next=2;return x.prepareSyncCryptoWorker();case 2:i.services=new h(h.LIGHT,h.LIGHT|h.FULL);s.next=5;return i.initVolatile();case 5:e=new p;s.next=8;return ce.createVolatile();case 8:t=s.sent;s.next=11;return Ge.createVolatile(t,e);case 11:r=s.sent;n=new ze(r,t);a=new lr(r,i,e);return s.abrupt("return",new Fe(r,n,a));case 15:case"end":return s.stop()}},_callee284,this)}));return function volatileLight(){return e.apply(this,arguments)}}()},{key:"volatileNano",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee285(){var e,t,r,n,a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:sr.getDefault();return _regenerator2["default"].wrap(function _callee285$(i){for(;;)switch(i.prev=i.next){case 0:i.next=2;return x.prepareSyncCryptoWorker();case 2:a.services=new h(h.NANO,h.NANO|h.LIGHT|h.FULL);i.next=5;return a.initVolatile();case 5:e=new p;i.next=8;return new We(e);case 8:t=i.sent;r=new $e(t);n=new lr(t,a,e);return i.abrupt("return",new qe(t,r,n));case 12:case"end":return i.stop()}},_callee285,this)}));return function volatileNano(){return e.apply(this,arguments)}}()}]);return Consensus}();r.register(Ye);Se.GENESIS=new Se(new le(new U(null),new U(null),U.fromBase64("giOIYTBojKQPmBLq5msCgObOL3KnQ9CKrIGb5HWz7E8="),U.fromBase64("xexmOOk+2oLBIhwkCD+caw2FsifB0U6tXlles8Tycts="),_e.difficultyToCompact(1),1,0,104295,le.Version.V1),new he([],new U(null)),new fe(q.fromBase64("AAAAAAAAAAAAAAAAAAAAAAAAAAA="),[]));Se.GENESIS.HASH=U.fromBase64("ykmTb222PK189z6x6dpT3Ul607cGjzFzECR4WXO+m+Y=");ce.GENESIS="AAIP7R94Gl77Xrk4xvszHLBXdCzC9AAAAHKYqT3gAAh2jadJcsL852C50iDDRIdlFjsNAAAAcpipPeAA";var Ze=function Protocol(){(0,_classCallCheck3["default"])(this,Protocol)};Ze.DUMB=0;Ze.WS=1;Ze.RTC=2;r.register(Ze);var Je=function(){function Message(e){(0,_classCallCheck3["default"])(this,Message);if(!I.isUint64(e))throw new Error("Malformed type");this._type=e}(0,_createClass3["default"])(Message,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);C.that(0===e.writePos,"Message.serialize() requires buf.writePos == 0");e.writeUint32(Message.MAGIC);e.writeVarUint(this._type);e.writeUint32(this.serializedSize);e.writeUint32(0);return e}},{key:"_setChecksum",value:function _setChecksum(e){var t=E.compute(e);Message._writeChecksum(this._type,e,t)}},{key:"serializedSize",get:function get(){return 4+T.varUintSize(this._type)+4+4}},{key:"type",get:function get(){return this._type}}],[{key:"peekType",value:function peekType(e){var t=e.readPos;e.readPos=4;var r=e.readVarUint();e.readPos=t;return r}},{key:"peekLength",value:function peekLength(e){var t=e.readPos;e.readPos=4;e.readVarUint();var r=e.readUint32();e.readPos=t;return r}},{key:"unserialize",value:function unserialize(e){C.that(0===e.readPos,"Message.unserialize() requires buf.readPos == 0");var t=e.readUint32(),r=e.readVarUint();e.readUint32();var n=e.readUint32();if(t!==Message.MAGIC)throw"Malformed magic";Message._writeChecksum(r,e,0);if(n!==E.compute(e))throw new Error("Invalid checksum");return new Message(r)}},{key:"_writeChecksum",value:function _writeChecksum(e,t,r){var n=t.writePos;t.writePos=4+T.varUintSize(e)+4;t.writeUint32(r);t.writePos=n}}]);return Message}();Je.MAGIC=1107566658;Je.Type={VERSION:0,INV:1,GET_DATA:2,GET_HEADER:3,NOT_FOUND:4,GET_BLOCKS:5,BLOCK:6,HEADER:7,TX:8,MEMPOOL:9,REJECT:10,SUBSCRIBE:11,ADDR:20,GET_ADDR:21,PING:22,PONG:23,SIGNAL:30,GET_CHAIN_PROOF:40,CHAIN_PROOF:41,GET_ACCOUNTS_PROOF:42,ACCOUNTS_PROOF:43,GET_ACCOUNTS_TREE_CHUNK:44,ACCOUNTS_TREE_CHUNK:45,GET_TRANSACTIONS_PROOF:47,TRANSACTIONS_PROOF:48,GET_TRANSACTION_RECEIPTS:49,TRANSACTION_RECEIPTS:50,VERACK:90};r.register(Je);var Qe=function(e){(0,_inherits3["default"])(AddrMessage,e);function AddrMessage(e){(0,_classCallCheck3["default"])(this,AddrMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(AddrMessage.__proto__||(0,_getPrototypeOf2["default"])(AddrMessage)).call(this,Je.Type.ADDR));if(!e||!I.isUint16(e.length)||e.some(function(e){return!(e instanceof Ht)}))throw"Malformed addresses";t._addresses=e;return t}(0,_createClass3["default"])(AddrMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(AddrMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AddrMessage.prototype),"serialize",this).call(this,e);e.writeUint16(this._addresses.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._addresses);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}(0,_get3["default"])(AddrMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AddrMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){var e=(0,_get3["default"])(AddrMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AddrMessage.prototype),"serializedSize",this)+2,t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._addresses);!(t=(a=i.next()).done);t=!0){e+=a.value.serializedSize}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"addresses",get:function get(){return this._addresses}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=e.readUint16(),r=[],n=0;n<t;++n)r.push(Ht.unserialize(e));return new AddrMessage(r)}}]);return AddrMessage}(Je);r.register(Qe);var et=function(e){(0,_inherits3["default"])(BlockMessage,e);function BlockMessage(e){(0,_classCallCheck3["default"])(this,BlockMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(BlockMessage.__proto__||(0,_getPrototypeOf2["default"])(BlockMessage)).call(this,Je.Type.BLOCK));t._block=e;return t}(0,_createClass3["default"])(BlockMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(BlockMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(BlockMessage.prototype),"serialize",this).call(this,e);this._block.serialize(e);(0,_get3["default"])(BlockMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(BlockMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(BlockMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(BlockMessage.prototype),"serializedSize",this)+this._block.serializedSize}},{key:"block",get:function get(){return this._block}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new BlockMessage(Se.unserialize(e))}}]);return BlockMessage}(Je);r.register(et);var tt=function(e){(0,_inherits3["default"])(GetAddrMessage,e);function GetAddrMessage(e,t){(0,_classCallCheck3["default"])(this,GetAddrMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(GetAddrMessage.__proto__||(0,_getPrototypeOf2["default"])(GetAddrMessage)).call(this,Je.Type.GET_ADDR));if(!I.isUint8(e))throw"Malformed protocolMask";if(!I.isUint32(t))throw"Malformed serviceMask";r._protocolMask=e;r._serviceMask=t;return r}(0,_createClass3["default"])(GetAddrMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(GetAddrMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAddrMessage.prototype),"serialize",this).call(this,e);e.writeUint8(this._protocolMask);e.writeUint32(this._serviceMask);(0,_get3["default"])(GetAddrMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAddrMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(GetAddrMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAddrMessage.prototype),"serializedSize",this)+1+4}},{key:"protocolMask",get:function get(){return this._protocolMask}},{key:"serviceMask",get:function get(){return this._serviceMask}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new GetAddrMessage(e.readUint8(),e.readUint32())}}]);return GetAddrMessage}(Je);r.register(tt);var rt=function(e){(0,_inherits3["default"])(GetBlocksMessage,e);function GetBlocksMessage(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:it.VECTORS_MAX_COUNT,r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:GetBlocksMessage.Direction.FORWARD;(0,_classCallCheck3["default"])(this,GetBlocksMessage);var n=(0,_possibleConstructorReturn3["default"])(this,(GetBlocksMessage.__proto__||(0,_getPrototypeOf2["default"])(GetBlocksMessage)).call(this,Je.Type.GET_BLOCKS));if(!e||!I.isUint16(e.length)||e.some(function(e){return!U.isHash(e)}))throw"Malformed locators";if(!I.isUint16(t))throw"Malformed maxInvSize";if(!I.isUint8(r))throw"Malformed direction";n._locators=e;n._maxInvSize=t;n._direction=r;return n}(0,_createClass3["default"])(GetBlocksMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(GetBlocksMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetBlocksMessage.prototype),"serialize",this).call(this,e);e.writeUint16(this._locators.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._locators);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}e.writeUint16(this._maxInvSize);e.writeUint8(this._direction);(0,_get3["default"])(GetBlocksMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetBlocksMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){var e=(0,_get3["default"])(GetBlocksMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetBlocksMessage.prototype),"serializedSize",this)+2+1+2,t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._locators);!(t=(a=i.next()).done);t=!0){e+=a.value.serializedSize}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"locators",get:function get(){return this._locators}},{key:"direction",get:function get(){return this._direction}},{key:"maxInvSize",get:function get(){return this._maxInvSize}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=e.readUint16(),r=[],n=0;n<t;n++)r.push(U.unserialize(e));return new GetBlocksMessage(r,e.readUint16(),e.readUint8())}}]);return GetBlocksMessage}(Je);rt.Direction={FORWARD:1,BACKWARD:2};r.register(rt);var nt=function(e){(0,_inherits3["default"])(HeaderMessage,e);function HeaderMessage(e){(0,_classCallCheck3["default"])(this,HeaderMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(HeaderMessage.__proto__||(0,_getPrototypeOf2["default"])(HeaderMessage)).call(this,Je.Type.HEADER));t._header=e;return t}(0,_createClass3["default"])(HeaderMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(HeaderMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(HeaderMessage.prototype),"serialize",this).call(this,e);this._header.serialize(e);(0,_get3["default"])(HeaderMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(HeaderMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(HeaderMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(HeaderMessage.prototype),"serializedSize",this)+this._header.serializedSize}},{key:"header",get:function get(){return this._header}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new HeaderMessage(le.unserialize(e))}}]);return HeaderMessage}(Je);r.register(nt);var at=function(){(0,_createClass3["default"])(InvVector,null,[{key:"fromBlock",value:function fromBlock(e){var t=e.hash();return new InvVector(InvVector.Type.BLOCK,t)}},{key:"fromHeader",value:function fromHeader(e){var t=e.hash();return new InvVector(InvVector.Type.BLOCK,t)}},{key:"fromTransaction",value:function fromTransaction(e){var t=e.hash();return new InvVector(InvVector.Type.TRANSACTION,t)}}]);function InvVector(e,t){(0,_classCallCheck3["default"])(this,InvVector);if(!U.isHash(t))throw"Malformed hash";this._type=e;this._hash=t}(0,_createClass3["default"])(InvVector,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeUint32(this._type);this._hash.serialize(e);return e}},{key:"equals",value:function equals(e){return e instanceof InvVector&&this._type===e.type&&this._hash.equals(e.hash)}},{key:"hashCode",value:function hashCode(){return this._type+"|"+this._hash}},{key:"toString",value:function toString(){return"InvVector{type="+this._type+", hash="+this._hash+"}"}},{key:"serializedSize",get:function get(){return 4+this._hash.serializedSize}},{key:"type",get:function get(){return this._type}},{key:"hash",get:function get(){return this._hash}}],[{key:"unserialize",value:function unserialize(e){return new InvVector(InvVector.Type.unserialize(e),U.unserialize(e))}}]);return InvVector}();at.Type={ERROR:0,TRANSACTION:1,BLOCK:2,unserialize:function unserialize(e){return e.readUint32()}};r.register(at);var it=function(e){(0,_inherits3["default"])(BaseInventoryMessage,e);function BaseInventoryMessage(e,t){(0,_classCallCheck3["default"])(this,BaseInventoryMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(BaseInventoryMessage.__proto__||(0,_getPrototypeOf2["default"])(BaseInventoryMessage)).call(this,e));if(!t||!I.isUint16(t.length)||t.some(function(e){return!(e instanceof at)})||t.length>BaseInventoryMessage.VECTORS_MAX_COUNT)throw"Malformed vectors";r._vectors=t;return r}(0,_createClass3["default"])(BaseInventoryMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(BaseInventoryMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(BaseInventoryMessage.prototype),"serialize",this).call(this,e);e.writeUint16(this._vectors.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._vectors);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}(0,_get3["default"])(BaseInventoryMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(BaseInventoryMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){var e=(0,_get3["default"])(BaseInventoryMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(BaseInventoryMessage.prototype),"serializedSize",this)+2,t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._vectors);!(t=(a=i.next()).done);t=!0){e+=a.value.serializedSize}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"vectors",get:function get(){return this._vectors}}]);return BaseInventoryMessage}(Je);it.VECTORS_MAX_COUNT=1e3;r.register(it);var st=function(e){(0,_inherits3["default"])(InvMessage,e);function InvMessage(e){(0,_classCallCheck3["default"])(this,InvMessage);return(0,_possibleConstructorReturn3["default"])(this,(InvMessage.__proto__||(0,_getPrototypeOf2["default"])(InvMessage)).call(this,Je.Type.INV,e))}(0,_createClass3["default"])(InvMessage,null,[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=e.readUint16(),r=[],n=0;n<t;++n)r.push(at.unserialize(e));return new InvMessage(r)}}]);return InvMessage}(it);r.register(st);var ot=function(e){(0,_inherits3["default"])(GetDataMessage,e);function GetDataMessage(e){(0,_classCallCheck3["default"])(this,GetDataMessage);return(0,_possibleConstructorReturn3["default"])(this,(GetDataMessage.__proto__||(0,_getPrototypeOf2["default"])(GetDataMessage)).call(this,Je.Type.GET_DATA,e))}(0,_createClass3["default"])(GetDataMessage,null,[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=e.readUint16(),r=[],n=0;n<t;++n)r.push(at.unserialize(e));return new GetDataMessage(r)}}]);return GetDataMessage}(it);r.register(ot);var ut=function(e){(0,_inherits3["default"])(GetHeaderMessage,e);function GetHeaderMessage(e){(0,_classCallCheck3["default"])(this,GetHeaderMessage);return(0,_possibleConstructorReturn3["default"])(this,(GetHeaderMessage.__proto__||(0,_getPrototypeOf2["default"])(GetHeaderMessage)).call(this,Je.Type.GET_HEADER,e))}(0,_createClass3["default"])(GetHeaderMessage,null,[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=e.readUint16(),r=[],n=0;n<t;++n)r.push(at.unserialize(e));return new GetHeaderMessage(r)}}]);return GetHeaderMessage}(it);r.register(ut);var ct=function(e){(0,_inherits3["default"])(NotFoundMessage,e);function NotFoundMessage(e){(0,_classCallCheck3["default"])(this,NotFoundMessage);return(0,_possibleConstructorReturn3["default"])(this,(NotFoundMessage.__proto__||(0,_getPrototypeOf2["default"])(NotFoundMessage)).call(this,Je.Type.NOT_FOUND,e))}(0,_createClass3["default"])(NotFoundMessage,null,[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=e.readUint16(),r=[],n=0;n<t;++n)r.push(at.unserialize(e));return new NotFoundMessage(r)}}]);return NotFoundMessage}(it);r.register(ct);var lt=function(e){(0,_inherits3["default"])(MempoolMessage,e);function MempoolMessage(){(0,_classCallCheck3["default"])(this,MempoolMessage);return(0,_possibleConstructorReturn3["default"])(this,(MempoolMessage.__proto__||(0,_getPrototypeOf2["default"])(MempoolMessage)).call(this,Je.Type.MEMPOOL))}(0,_createClass3["default"])(MempoolMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(MempoolMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(MempoolMessage.prototype),"serialize",this).call(this,e);(0,_get3["default"])(MempoolMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(MempoolMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(MempoolMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(MempoolMessage.prototype),"serializedSize",this)}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new MempoolMessage}}]);return MempoolMessage}(Je);r.register(lt);var ht=function(e){(0,_inherits3["default"])(PingMessage,e);function PingMessage(e){(0,_classCallCheck3["default"])(this,PingMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(PingMessage.__proto__||(0,_getPrototypeOf2["default"])(PingMessage)).call(this,Je.Type.PING));if(!I.isUint32(e))throw"Malformed nonce";t._nonce=e;return t}(0,_createClass3["default"])(PingMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(PingMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(PingMessage.prototype),"serialize",this).call(this,e);e.writeUint32(this._nonce);(0,_get3["default"])(PingMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(PingMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(PingMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(PingMessage.prototype),"serializedSize",this)+4}},{key:"nonce",get:function get(){return this._nonce}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new PingMessage(e.readUint32())}}]);return PingMessage}(Je);r.register(ht);var ft=function(e){(0,_inherits3["default"])(PongMessage,e);function PongMessage(e){(0,_classCallCheck3["default"])(this,PongMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(PongMessage.__proto__||(0,_getPrototypeOf2["default"])(PongMessage)).call(this,Je.Type.PONG));if(!I.isUint32(e))throw"Malformed nonce";t._nonce=e;return t}(0,_createClass3["default"])(PongMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(PongMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(PongMessage.prototype),"serialize",this).call(this,e);e.writeUint32(this._nonce);(0,_get3["default"])(PongMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(PongMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(PongMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(PongMessage.prototype),"serializedSize",this)+4}},{key:"nonce",get:function get(){return this._nonce}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new PongMessage(e.readUint32())}}]);return PongMessage}(Je);r.register(ft);var _t=function(e){(0,_inherits3["default"])(RejectMessage,e);function RejectMessage(e,t,r){var n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:new Uint8Array(0);(0,_classCallCheck3["default"])(this,RejectMessage);var a=(0,_possibleConstructorReturn3["default"])(this,(RejectMessage.__proto__||(0,_getPrototypeOf2["default"])(RejectMessage)).call(this,Je.Type.REJECT));if(!I.isUint64(e))throw new Error("Malformed type");if(!I.isUint8(t))throw new Error("Malformed code");if(B.isMultibyte(r)||r.length>255)throw new Error("Malformed reason");if(!(n instanceof Uint8Array&&I.isUint16(n.byteLength)))throw new Error("Malformed extraData");a._messageType=e;a._code=t;a._reason=r;a._extraData=n;return a}(0,_createClass3["default"])(RejectMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(RejectMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(RejectMessage.prototype),"serialize",this).call(this,e);e.writeVarUint(this._messageType);e.writeUint8(this._code);e.writeVarLengthString(this._reason);e.writeUint16(this._extraData.byteLength);e.write(this._extraData);(0,_get3["default"])(RejectMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(RejectMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(RejectMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(RejectMessage.prototype),"serializedSize",this)+T.varUintSize(this._messageType)+1+T.varLengthStringSize(this._reason)+2+this._extraData.byteLength}},{key:"messageType",get:function get(){return this._messageType}},{key:"code",get:function get(){return this._code}},{key:"reason",get:function get(){return this._reason}},{key:"extraData",get:function get(){return this._extraData}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);var t=e.readVarUint(),r=e.readUint8(),n=e.readVarLengthString(),a=e.readUint16();return new RejectMessage(t,r,n,e.read(a))}}]);return RejectMessage}(Je);_t.Code={REJECT_MALFORMED:1,REJECT_INVALID:16,REJECT_OBSOLETE:17,REJECT_DOUBLE:18,REJECT_DUST:65,REJECT_INSUFFICIENT_FEE:66};r.register(_t);var dt=function(e){(0,_inherits3["default"])(SignalMessage,e);function SignalMessage(e,t,r,n){var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0,i=arguments.length>5&&arguments[5]!==undefined?arguments[5]:new Uint8Array(0),s=arguments[6],o=arguments[7];(0,_classCallCheck3["default"])(this,SignalMessage);var u=(0,_possibleConstructorReturn3["default"])(this,(SignalMessage.__proto__||(0,_getPrototypeOf2["default"])(SignalMessage)).call(this,Je.Type.SIGNAL));if(!(e instanceof Dt))throw"Malformed senderId";if(!(t instanceof Dt))throw"Malformed recipientId";if(!I.isUint32(r))throw"Malformed nonce";if(!I.isUint8(n))throw"Malformed ttl";if(!I.isUint8(a))throw"Malformed flags";if(!(i instanceof Uint8Array&&I.isUint16(i.byteLength)))throw"Malformed payload";var c=i.byteLength>0;if(c&&!(o instanceof W))throw"Malformed signature";if(c&&!(s instanceof H))throw"Malformed public key";u._senderId=e;u._recipientId=t;u._nonce=r;u._ttl=n;u._flags=a;u._payload=i;u._senderPubKey=c?s:undefined;u._signature=c?o:undefined;return u}(0,_createClass3["default"])(SignalMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(SignalMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(SignalMessage.prototype),"serialize",this).call(this,e);this._senderId.serialize(e);this._recipientId.serialize(e);e.writeUint32(this._nonce);e.writeUint8(this._ttl);e.writeUint8(this._flags);e.writeUint16(this._payload.byteLength);e.write(this._payload);if(this._payload.byteLength>0){this._senderPubKey.serialize(e);this._signature.serialize(e)}(0,_get3["default"])(SignalMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(SignalMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"verifySignature",value:function verifySignature(){return!!this._signature&&(this._signature.verify(this._senderPubKey,this._payload)&&this._senderId.equals(this._senderPubKey.toPeerId()))}},{key:"hasPayload",value:function hasPayload(){return this._payload.byteLength>0}},{key:"isUnroutable",value:function isUnroutable(){return 0!=(this._flags&SignalMessage.Flag.UNROUTABLE)}},{key:"isTtlExceeded",value:function isTtlExceeded(){return 0!=(this._flags&SignalMessage.Flag.TTL_EXCEEDED)}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(SignalMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(SignalMessage.prototype),"serializedSize",this)+this._senderId.serializedSize+this._recipientId.serializedSize+4+1+1+2+this._payload.byteLength+(this._payload.byteLength>0?this._senderPubKey.serializedSize:0)+(this._payload.byteLength>0?this._signature.serializedSize:0)}},{key:"senderId",get:function get(){return this._senderId}},{key:"recipientId",get:function get(){return this._recipientId}},{key:"nonce",get:function get(){return this._nonce}},{key:"ttl",get:function get(){return this._ttl}},{key:"flags",get:function get(){return this._flags}},{key:"payload",get:function get(){return this._payload}},{key:"signature",get:function get(){return this._signature}},{key:"senderPubKey",get:function get(){return this._senderPubKey}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);var t=Dt.unserialize(e),r=Dt.unserialize(e),n=e.readUint32(),a=e.readUint8(),i=e.readUint8(),s=e.readUint16();return new SignalMessage(t,r,n,a,i,e.read(s),s>0?H.unserialize(e):undefined,s>0?W.unserialize(e):undefined)}}]);return SignalMessage}(Je);dt.Flag={UNROUTABLE:1,TTL_EXCEEDED:2};r.register(dt);var pt=function(e){(0,_inherits3["default"])(SubscribeMessage,e);function SubscribeMessage(e){(0,_classCallCheck3["default"])(this,SubscribeMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(SubscribeMessage.__proto__||(0,_getPrototypeOf2["default"])(SubscribeMessage)).call(this,Je.Type.SUBSCRIBE));t._subscription=e;return t}(0,_createClass3["default"])(SubscribeMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(SubscribeMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(SubscribeMessage.prototype),"serialize",this).call(this,e);this._subscription.serialize(e);(0,_get3["default"])(SubscribeMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(SubscribeMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(SubscribeMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(SubscribeMessage.prototype),"serializedSize",this)+this._subscription.serializedSize}},{key:"subscription",get:function get(){return this._subscription}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new SubscribeMessage(de.unserialize(e))}}]);return SubscribeMessage}(Je);r.register(pt);var gt=function(e){(0,_inherits3["default"])(TxMessage,e);function TxMessage(e,t){(0,_classCallCheck3["default"])(this,TxMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(TxMessage.__proto__||(0,_getPrototypeOf2["default"])(TxMessage)).call(this,Je.Type.TX));r._transaction=e;r._accountsProof=t;return r}(0,_createClass3["default"])(TxMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(TxMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TxMessage.prototype),"serialize",this).call(this,e);this._transaction.serialize(e);e.writeUint8(this._accountsProof?1:0);this._accountsProof&&this._accountsProof.serialize(e);(0,_get3["default"])(TxMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TxMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){var e=(0,_get3["default"])(TxMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TxMessage.prototype),"serializedSize",this)+this._transaction.serializedSize+1;this._accountsProof&&(e+=this._accountsProof.serializedSize);return e}},{key:"transaction",get:function get(){return this._transaction}},{key:"hasAccountsProof",get:function get(){return!!this._accountsProof}},{key:"accountsProof",get:function get(){return this._accountsProof}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);var t=pe.unserialize(e);if(1===e.readUint8()){return new TxMessage(t,ae.unserialize(e))}return new TxMessage(t)}}]);return TxMessage}(Je);r.register(gt);var yt=function(e){(0,_inherits3["default"])(VersionMessage,e);function VersionMessage(e,t,r,n,a){(0,_classCallCheck3["default"])(this,VersionMessage);var i=(0,_possibleConstructorReturn3["default"])(this,(VersionMessage.__proto__||(0,_getPrototypeOf2["default"])(VersionMessage)).call(this,Je.Type.VERSION));if(!I.isUint32(e))throw new Error("Malformed version");if(!(t instanceof Ht))throw new Error("Malformed peerAddress");if(!U.isHash(r))throw new Error("Malformed genesisHash");if(!U.isHash(n))throw new Error("Malformed headHash");if(!(a instanceof Uint8Array)||32!==a.byteLength)throw new Error("Malformed challenge nonce");i._version=e;i._peerAddress=t;i._genesisHash=r;i._headHash=n;i._challengeNonce=a;return i}(0,_createClass3["default"])(VersionMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(VersionMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(VersionMessage.prototype),"serialize",this).call(this,e);e.writeUint32(this._version);this._peerAddress.serialize(e);this._genesisHash.serialize(e);this._headHash.serialize(e);e.write(this._challengeNonce);(0,_get3["default"])(VersionMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(VersionMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(VersionMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(VersionMessage.prototype),"serializedSize",this)+4+this._peerAddress.serializedSize+this._genesisHash.serializedSize+this._headHash.serializedSize+VersionMessage.CHALLENGE_SIZE}},{key:"version",get:function get(){return this._version}},{key:"peerAddress",get:function get(){return this._peerAddress}},{key:"genesisHash",get:function get(){return this._genesisHash}},{key:"headHash",get:function get(){return this._headHash}},{key:"challengeNonce",get:function get(){return this._challengeNonce}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new VersionMessage(e.readUint32(),Ht.unserialize(e),U.unserialize(e),U.unserialize(e),e.read(VersionMessage.CHALLENGE_SIZE))}}]);return VersionMessage}(Je);yt.CHALLENGE_SIZE=32;r.register(yt);var vt=function(e){(0,_inherits3["default"])(VerAckMessage,e);function VerAckMessage(e,t){(0,_classCallCheck3["default"])(this,VerAckMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(VerAckMessage.__proto__||(0,_getPrototypeOf2["default"])(VerAckMessage)).call(this,Je.Type.VERACK));r._publicKey=e;r._signature=t;return r}(0,_createClass3["default"])(VerAckMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(VerAckMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(VerAckMessage.prototype),"serialize",this).call(this,e);this.publicKey.serialize(e);this.signature.serialize(e);(0,_get3["default"])(VerAckMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(VerAckMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(VerAckMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(VerAckMessage.prototype),"serializedSize",this)+this._publicKey.serializedSize+this._signature.serializedSize}},{key:"publicKey",get:function get(){return this._publicKey}},{key:"signature",get:function get(){return this._signature}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new VerAckMessage(H.unserialize(e),W.unserialize(e))}}]);return VerAckMessage}(Je);r.register(vt);var kt=function(e){(0,_inherits3["default"])(AccountsProofMessage,e);function AccountsProofMessage(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;(0,_classCallCheck3["default"])(this,AccountsProofMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(AccountsProofMessage.__proto__||(0,_getPrototypeOf2["default"])(AccountsProofMessage)).call(this,Je.Type.ACCOUNTS_PROOF));if(!(e instanceof U))throw new Error("Malformed blockHash");if(t&&!(t instanceof ae))throw new Error("Malformed proof");r._blockHash=e;r._accountsProof=t;return r}(0,_createClass3["default"])(AccountsProofMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(AccountsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AccountsProofMessage.prototype),"serialize",this).call(this,e);this._blockHash.serialize(e);e.writeUint8(this.hasProof()?1:0);this.hasProof()&&this._accountsProof.serialize(e);(0,_get3["default"])(AccountsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AccountsProofMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"hasProof",value:function hasProof(){return!!this._accountsProof}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(AccountsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AccountsProofMessage.prototype),"serializedSize",this)+1+this._blockHash.serializedSize+(this.hasProof()?this._accountsProof.serializedSize:0)}},{key:"blockHash",get:function get(){return this._blockHash}},{key:"proof",get:function get(){return this._accountsProof}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);var t=U.unserialize(e),r=null;0!==e.readUint8()&&(r=ae.unserialize(e));return new AccountsProofMessage(t,r)}}]);return AccountsProofMessage}(Je);r.register(kt);var mt=function(e){(0,_inherits3["default"])(GetAccountsProofMessage,e);function GetAccountsProofMessage(e,t){(0,_classCallCheck3["default"])(this,GetAccountsProofMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(GetAccountsProofMessage.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsProofMessage)).call(this,Je.Type.GET_ACCOUNTS_PROOF));if(!(e&&e instanceof U))throw new Error("Malformed block hash");if(!t||!I.isUint16(t.length)||t.length<1||t.some(function(e){return!(e instanceof q)}))throw new Error("Malformed addresses");r._blockHash=e;r._addresses=t;return r}(0,_createClass3["default"])(GetAccountsProofMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(GetAccountsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsProofMessage.prototype),"serialize",this).call(this,e);this._blockHash.serialize(e);e.writeUint16(this._addresses.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._addresses);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}(0,_get3["default"])(GetAccountsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsProofMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(GetAccountsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsProofMessage.prototype),"serializedSize",this)+this._blockHash.serializedSize+2+this._addresses.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"addresses",get:function get(){return this._addresses}},{key:"blockHash",get:function get(){return this._blockHash}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=U.unserialize(e),r=e.readUint16(),n=[],a=0;a<r;a++)n.push(q.unserialize(e));return new GetAccountsProofMessage(t,n)}}]);return GetAccountsProofMessage}(Je);r.register(mt);var bt=function(e){(0,_inherits3["default"])(ChainProofMessage,e);function ChainProofMessage(e){(0,_classCallCheck3["default"])(this,ChainProofMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(ChainProofMessage.__proto__||(0,_getPrototypeOf2["default"])(ChainProofMessage)).call(this,Je.Type.CHAIN_PROOF));if(!(e instanceof Ne))throw"Malformed chainProof";t._proof=e;return t}(0,_createClass3["default"])(ChainProofMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(ChainProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(ChainProofMessage.prototype),"serialize",this).call(this,e);this._proof.serialize(e);(0,_get3["default"])(ChainProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(ChainProofMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(ChainProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(ChainProofMessage.prototype),"serializedSize",this)+this._proof.serializedSize}},{key:"proof",get:function get(){return this._proof}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new ChainProofMessage(Ne.unserialize(e))}}]);return ChainProofMessage}(Je);r.register(bt);var Ct=function(e){(0,_inherits3["default"])(GetChainProofMessage,e);function GetChainProofMessage(){(0,_classCallCheck3["default"])(this,GetChainProofMessage);return(0,_possibleConstructorReturn3["default"])(this,(GetChainProofMessage.__proto__||(0,_getPrototypeOf2["default"])(GetChainProofMessage)).call(this,Je.Type.GET_CHAIN_PROOF))}(0,_createClass3["default"])(GetChainProofMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(GetChainProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetChainProofMessage.prototype),"serialize",this).call(this,e);(0,_get3["default"])(GetChainProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetChainProofMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(GetChainProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetChainProofMessage.prototype),"serializedSize",this)}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new GetChainProofMessage}}]);return GetChainProofMessage}(Je);r.register(Ct);var wt=function(e){(0,_inherits3["default"])(AccountsTreeChunkMessage,e);function AccountsTreeChunkMessage(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;(0,_classCallCheck3["default"])(this,AccountsTreeChunkMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(AccountsTreeChunkMessage.__proto__||(0,_getPrototypeOf2["default"])(AccountsTreeChunkMessage)).call(this,Je.Type.ACCOUNTS_TREE_CHUNK));if(!(e instanceof U))throw"Malformed blockHash";if(t&&!(t instanceof ie))throw"Malformed chunk";r._blockHash=e;r._accountsTreeChunk=t;return r}(0,_createClass3["default"])(AccountsTreeChunkMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(AccountsTreeChunkMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AccountsTreeChunkMessage.prototype),"serialize",this).call(this,e);this._blockHash.serialize(e);e.writeUint8(this.hasChunk()?1:0);this.hasChunk()&&this._accountsTreeChunk.serialize(e);(0,_get3["default"])(AccountsTreeChunkMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AccountsTreeChunkMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"hasChunk",value:function hasChunk(){return!!this._accountsTreeChunk}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(AccountsTreeChunkMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(AccountsTreeChunkMessage.prototype),"serializedSize",this)+1+this._blockHash.serializedSize+(this.hasChunk()?this._accountsTreeChunk.serializedSize:0)}},{key:"blockHash",get:function get(){return this._blockHash}},{key:"chunk",get:function get(){return this._accountsTreeChunk}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);var t=U.unserialize(e),r=null;0!==e.readUint8()&&(r=ie.unserialize(e));return new AccountsTreeChunkMessage(t,r)}}]);return AccountsTreeChunkMessage}(Je);r.register(wt);var At=function(e){(0,_inherits3["default"])(GetAccountsTreeChunkMessage,e);function GetAccountsTreeChunkMessage(e,t){(0,_classCallCheck3["default"])(this,GetAccountsTreeChunkMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(GetAccountsTreeChunkMessage.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsTreeChunkMessage)).call(this,Je.Type.GET_ACCOUNTS_TREE_CHUNK));if(!(e&&e instanceof U))throw"Malformed block hash";if(B.isMultibyte(t)||!I.isUint8(t.length))throw"Malformed start prefix";r._blockHash=e;r._startPrefix=t;return r}(0,_createClass3["default"])(GetAccountsTreeChunkMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(GetAccountsTreeChunkMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsTreeChunkMessage.prototype),"serialize",this).call(this,e);this._blockHash.serialize(e);e.writeVarLengthString(this._startPrefix);(0,_get3["default"])(GetAccountsTreeChunkMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsTreeChunkMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(GetAccountsTreeChunkMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetAccountsTreeChunkMessage.prototype),"serializedSize",this)+this._blockHash.serializedSize+T.varLengthStringSize(this._startPrefix)}},{key:"blockHash",get:function get(){return this._blockHash}},{key:"startPrefix",get:function get(){return this._startPrefix}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new GetAccountsTreeChunkMessage(U.unserialize(e),e.readVarLengthString())}}]);return GetAccountsTreeChunkMessage}(Je);r.register(At);var St=function(e){(0,_inherits3["default"])(TransactionsProofMessage,e);function TransactionsProofMessage(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;(0,_classCallCheck3["default"])(this,TransactionsProofMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(TransactionsProofMessage.__proto__||(0,_getPrototypeOf2["default"])(TransactionsProofMessage)).call(this,Je.Type.TRANSACTIONS_PROOF));if(!(e instanceof U))throw new Error("Malformed blockHash");if(t&&!(t instanceof ke))throw new Error("Malformed proof");r._blockHash=e;r._proof=t;return r}(0,_createClass3["default"])(TransactionsProofMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(TransactionsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TransactionsProofMessage.prototype),"serialize",this).call(this,e);this._blockHash.serialize(e);e.writeUint8(this.hasProof()?1:0);this.hasProof()&&this._proof.serialize(e);(0,_get3["default"])(TransactionsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TransactionsProofMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"hasProof",value:function hasProof(){return!!this._proof}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(TransactionsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TransactionsProofMessage.prototype),"serializedSize",this)+1+this._blockHash.serializedSize+(this.hasProof()?this._proof.serializedSize:0)}},{key:"blockHash",get:function get(){return this._blockHash}},{key:"proof",get:function get(){return this._proof}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);var t=U.unserialize(e),r=null;0!==e.readUint8()&&(r=ke.unserialize(e));return new TransactionsProofMessage(t,r)}}]);return TransactionsProofMessage}(Je);r.register(St);var Tt=function(e){(0,_inherits3["default"])(GetTransactionsProofMessage,e);function GetTransactionsProofMessage(e,t){(0,_classCallCheck3["default"])(this,GetTransactionsProofMessage);var r=(0,_possibleConstructorReturn3["default"])(this,(GetTransactionsProofMessage.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionsProofMessage)).call(this,Je.Type.GET_TRANSACTIONS_PROOF));if(!(e&&e instanceof U))throw new Error("Malformed block hash");if(!t||!I.isUint16(t.length)||t.some(function(e){return!(e instanceof q)}))throw new Error("Malformed addresses");r._blockHash=e;r._addresses=t;return r}(0,_createClass3["default"])(GetTransactionsProofMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(GetTransactionsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionsProofMessage.prototype),"serialize",this).call(this,e);this._blockHash.serialize(e);e.writeUint16(this._addresses.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._addresses);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}(0,_get3["default"])(GetTransactionsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionsProofMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(GetTransactionsProofMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionsProofMessage.prototype),"serializedSize",this)+this._blockHash.serializedSize+2+this._addresses.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"addresses",get:function get(){return this._addresses}},{key:"blockHash",get:function get(){return this._blockHash}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=U.unserialize(e),r=e.readUint16(),n=[],a=0;a<r;a++)n.push(q.unserialize(e));return new GetTransactionsProofMessage(t,n)}}]);return GetTransactionsProofMessage}(Je);r.register(Tt);var xt=function(e){(0,_inherits3["default"])(GetTransactionReceiptsMessage,e);function GetTransactionReceiptsMessage(e){(0,_classCallCheck3["default"])(this,GetTransactionReceiptsMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(GetTransactionReceiptsMessage.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionReceiptsMessage)).call(this,Je.Type.GET_TRANSACTION_RECEIPTS));if(!(e instanceof q))throw new Error("Malformed address");t._address=e;return t}(0,_createClass3["default"])(GetTransactionReceiptsMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(GetTransactionReceiptsMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionReceiptsMessage.prototype),"serialize",this).call(this,e);this._address.serialize(e);(0,_get3["default"])(GetTransactionReceiptsMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionReceiptsMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(GetTransactionReceiptsMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(GetTransactionReceiptsMessage.prototype),"serializedSize",this)+this._address.serializedSize}},{key:"address",get:function get(){return this._address}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);return new GetTransactionReceiptsMessage(q.unserialize(e))}}]);return GetTransactionReceiptsMessage}(Je);r.register(xt);var Et=function(e){(0,_inherits3["default"])(TransactionReceiptsMessage,e);function TransactionReceiptsMessage(e){(0,_classCallCheck3["default"])(this,TransactionReceiptsMessage);var t=(0,_possibleConstructorReturn3["default"])(this,(TransactionReceiptsMessage.__proto__||(0,_getPrototypeOf2["default"])(TransactionReceiptsMessage)).call(this,Je.Type.TRANSACTION_RECEIPTS));if(!e||!I.isUint16(e.length)||e.some(function(e){return!(e instanceof Ae)})||e.length>TransactionReceiptsMessage.RECEIPTS_MAX_COUNT)throw new Error("Malformed transactionReceipts");t._transactionReceipts=e;return t}(0,_createClass3["default"])(TransactionReceiptsMessage,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(TransactionReceiptsMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TransactionReceiptsMessage.prototype),"serialize",this).call(this,e);e.writeUint16(this._transactionReceipts.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._transactionReceipts);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}(0,_get3["default"])(TransactionReceiptsMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TransactionReceiptsMessage.prototype),"_setChecksum",this).call(this,e);return e}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(TransactionReceiptsMessage.prototype.__proto__||(0,_getPrototypeOf2["default"])(TransactionReceiptsMessage.prototype),"serializedSize",this)+2+this._transactionReceipts.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"transactionReceipts",get:function get(){return this._transactionReceipts}}],[{key:"unserialize",value:function unserialize(e){Je.unserialize(e);for(var t=e.readUint16(),r=[],n=0;n<t;++n)r.push(Ae.unserialize(e));return new TransactionReceiptsMessage(r)}}]);return TransactionReceiptsMessage}(Je);r.register(Et);Et.RECEIPTS_MAX_COUNT=500;var It=function(){function MessageFactory(){(0,_classCallCheck3["default"])(this,MessageFactory)}(0,_createClass3["default"])(MessageFactory,null,[{key:"peekType",value:function peekType(e){return Je.peekType(e)}},{key:"parse",value:function parse(e){var t=Je.peekType(e),r=MessageFactory.CLASSES[t];if(!r||!r.unserialize)throw new Error("Invalid message type: "+t);return r.unserialize(e)}}]);return MessageFactory}();It.CLASSES={};It.CLASSES[Je.Type.VERSION]=yt;It.CLASSES[Je.Type.INV]=st;It.CLASSES[Je.Type.GET_DATA]=ot;It.CLASSES[Je.Type.GET_HEADER]=ut;It.CLASSES[Je.Type.NOT_FOUND]=ct;It.CLASSES[Je.Type.BLOCK]=et;It.CLASSES[Je.Type.HEADER]=nt;It.CLASSES[Je.Type.TX]=gt;It.CLASSES[Je.Type.GET_BLOCKS]=rt;It.CLASSES[Je.Type.MEMPOOL]=lt;It.CLASSES[Je.Type.REJECT]=_t;It.CLASSES[Je.Type.SUBSCRIBE]=pt;It.CLASSES[Je.Type.ADDR]=Qe;It.CLASSES[Je.Type.GET_ADDR]=tt;It.CLASSES[Je.Type.PING]=ht;It.CLASSES[Je.Type.PONG]=ft;It.CLASSES[Je.Type.SIGNAL]=dt;It.CLASSES[Je.Type.GET_CHAIN_PROOF]=Ct;It.CLASSES[Je.Type.CHAIN_PROOF]=bt;It.CLASSES[Je.Type.GET_ACCOUNTS_PROOF]=mt;It.CLASSES[Je.Type.ACCOUNTS_PROOF]=kt;It.CLASSES[Je.Type.GET_ACCOUNTS_TREE_CHUNK]=At;It.CLASSES[Je.Type.ACCOUNTS_TREE_CHUNK]=wt;It.CLASSES[Je.Type.GET_TRANSACTIONS_PROOF]=Tt;It.CLASSES[Je.Type.TRANSACTIONS_PROOF]=St;It.CLASSES[Je.Type.GET_TRANSACTION_RECEIPTS]=xt;It.CLASSES[Je.Type.TRANSACTION_RECEIPTS]=Et;It.CLASSES[Je.Type.VERACK]=vt;r.register(It);var Pt=function(e){(0,_inherits3["default"])(WebRtcConnector,e);function WebRtcConnector(e){(0,_classCallCheck3["default"])(this,WebRtcConnector);var t=(0,_possibleConstructorReturn3["default"])(this,(WebRtcConnector.__proto__||(0,_getPrototypeOf2["default"])(WebRtcConnector)).call(this));t._networkConfig=e;t._connectors=new y;t._timers=new _;return t}(0,_createClass3["default"])(WebRtcConnector,[{key:"connect",value:function connect(e,t){var r=this;if(e.protocol!==Ze.RTC)throw"Malformed peerAddress";var n=e.peerId;if(this._connectors.contains(n))return!1;var a=new Ot(this._networkConfig,e,t);a.on("connection",function(e){return r._onConnection(e,n)});this._connectors.put(n,a);this._timers.setTimeout("connect_"+n,function(){r._connectors.remove(n);r._timers.clearTimeout("connect_"+n);r.fire("error",e,"timeout")},WebRtcConnector.CONNECT_TIMEOUT);return!0}},{key:"isValidSignal",value:function isValidSignal(e){return this._connectors.contains(e.senderId)&&this._connectors.get(e.senderId).nonce===e.nonce}},{key:"onSignal",value:function onSignal(e,t){var r=this;if(t.isUnroutable()||t.isTtlExceeded()){if(this.isValidSignal(t)&&this._connectors.get(t.senderId)instanceof Ot){var n=this._connectors.get(t.senderId).peerAddress;this._connectors.remove(t.senderId);this._timers.clearTimeout("connect_"+t.senderId);var i=t.isUnroutable()?"unroutable":"ttl exceeded";this.fire("error",n,i)}}else{var s=void 0;try{s=JSON.parse(w.toAscii(t.payload))}catch(u){a.e(WebRtcConnector,"Failed to parse signal payload from "+t.senderId);return}if(s)if("offer"===s.type){var o=this._connectors.get(t.senderId);if(o){if(t.recipientId.compare(t.senderId)>0){a.d(WebRtcConnector,"Simultaneous connection, discarding offer from "+t.senderId+" (<"+t.recipientId+")");return}if(o instanceof Rt){a.w(WebRtcConnector,"Duplicate offer received from "+t.senderId);o.onSignal(s);return}a.d(WebRtcConnector,"Simultaneous connection, accepting offer from "+t.senderId+" (>"+t.recipientId+")");this._timers.clearTimeout("connect_"+t.senderId);this.fire("error",o.peerAddress,"simultaneous inbound connection")}(o=new Rt(this._networkConfig,e,t.senderId,s)).on("connection",function(e){return r._onConnection(e,t.senderId)});this._connectors.put(t.senderId,o);this._timers.setTimeout("connect_"+t.senderId,function(){r._timers.clearTimeout("connect_"+t.senderId);r._connectors.remove(t.senderId)},WebRtcConnector.CONNECT_TIMEOUT)}else this._connectors.contains(t.senderId)&&this._connectors.get(t.senderId).onSignal(s);else a.d(WebRtcConnector,"Discarding signal from "+t.senderId+" - empty payload")}}},{key:"_onConnection",value:function _onConnection(e,t){var r=this;this._timers.clearTimeout("connect_"+t);e.on("close",function(){return r._onClose(t)});this.fire("connection",e)}},{key:"_onClose",value:function _onClose(e){this._connectors.remove(e);this._timers.clearTimeout("connect_"+e)}}]);return WebRtcConnector}(i);Pt.CONNECT_TIMEOUT=5e3;r.register(Pt);var Nt=function(e){(0,_inherits3["default"])(PeerConnector,e);function PeerConnector(e,t,r,n){(0,_classCallCheck3["default"])(this,PeerConnector);var a=(0,_possibleConstructorReturn3["default"])(this,(PeerConnector.__proto__||(0,_getPrototypeOf2["default"])(PeerConnector)).call(this));a._networkConfig=e;a._signalChannel=t;a._peerId=r;a._peerAddress=n;a._nonce=I.randomUint32();a._rtcConnection=c.newPeerConnection(a._networkConfig.rtcConfig);a._rtcConnection.onicecandidate=function(e){return a._onIceCandidate(e)};a._lastIceCandidate=null;a._iceCandidateQueue=[];return a}(0,_createClass3["default"])(PeerConnector,[{key:"onSignal",value:function onSignal(e){var t=this;e.sdp?this._rtcConnection.setRemoteDescription(c.newSessionDescription(e)).then(function(){"offer"===e.type&&t._rtcConnection.createAnswer().then(function(e){return t._onDescription(e)})["catch"](a.e.tag(PeerConnector));t._handleCandidateQueue()["catch"](a.w.tag(PeerConnector))})["catch"](a.e.tag(PeerConnector)):e.candidate&&this._addIceCandidate(e)["catch"](a.w.tag(PeerConnector))}},{key:"_addIceCandidate",value:function _addIceCandidate(e){this._lastIceCandidate=c.newIceCandidate(e);if(!this._rtcConnection.remoteDescription||!this._rtcConnection.remoteDescription.type){this._iceCandidateQueue.push(e);return _promise2["default"].resolve()}return this._rtcConnection.addIceCandidate(this._lastIceCandidate)["catch"](a.e.tag(PeerConnector))}},{key:"_handleCandidateQueue",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee286(){var e,t,r,n,a,i;return _regenerator2["default"].wrap(function _callee286$(s){for(;;)switch(s.prev=s.next){case 0:e=!0;t=!1;r=undefined;s.prev=3;n=(0,_getIterator3["default"])(this._iceCandidateQueue);case 5:if(e=(a=n.next()).done){s.next=12;break}i=a.value;s.next=9;return this._addIceCandidate(i);case 9:e=!0;s.next=5;break;case 12:s.next=18;break;case 14:s.prev=14;s.t0=s["catch"](3);t=!0;r=s.t0;case 18:s.prev=18;s.prev=19;!e&&n["return"]&&n["return"]();case 21:s.prev=21;if(!t){s.next=24;break}throw r;case 24:return s.finish(21);case 25:return s.finish(18);case 26:this._iceCandidateQueue=[];case 27:case"end":return s.stop()}},_callee286,this,[[3,14,18,26],[19,,21,25]])}));return function _handleCandidateQueue(){return e.apply(this,arguments)}}()},{key:"_signal",value:function _signal(e){var t=w.fromAscii((0,_stringify2["default"])(e)),r=this._networkConfig.keyPair,n=this._networkConfig.peerId;this._signalChannel.signal(n,this._peerId,this._nonce,lr.SIGNAL_TTL_INITIAL,0,t,r.publicKey,W.create(r.privateKey,r.publicKey,t))}},{key:"_onIceCandidate",value:function _onIceCandidate(e){null!==e.candidate&&this._signal(e.candidate)}},{key:"_onDescription",value:function _onDescription(e){var t=this;this._rtcConnection.setLocalDescription(e).then(function(){return t._signal(t._rtcConnection.localDescription)})["catch"](a.e.tag(PeerConnector))}},{key:"_onDataChannel",value:function _onDataChannel(e){var t=new Mt(e.channel||e.target),r=null;if(this._lastIceCandidate)try{r=Bt.candidateToNetAddress(this._lastIceCandidate)}catch(i){a.w(PeerConnector,"Failed to parse IP from ICE candidate: "+this._lastIceCandidate)}else a.w(PeerConnector,"No ICE candidate seen for inbound connection");var n=new Xt(t,Ze.RTC,r,this._peerAddress);this.fire("connection",n)}},{key:"nonce",get:function get(){return this._nonce}},{key:"peerAddress",get:function get(){return this._peerAddress}}]);return PeerConnector}(i);r.register(Nt);var Ot=function(e){(0,_inherits3["default"])(OutboundPeerConnector,e);function OutboundPeerConnector(e,t,r){(0,_classCallCheck3["default"])(this,OutboundPeerConnector);var n=(0,_possibleConstructorReturn3["default"])(this,(OutboundPeerConnector.__proto__||(0,_getPrototypeOf2["default"])(OutboundPeerConnector)).call(this,e,r,t.peerId,t));n._peerAddress=t;var i=n._rtcConnection.createDataChannel("data-channel");i.binaryType="arraybuffer";i.onopen=function(e){return n._onDataChannel(e)};n._rtcConnection.createOffer().then(function(e){return n._onDescription(e)})["catch"](a.e.tag(OutboundPeerConnector));return n}return OutboundPeerConnector}(Nt);r.register(Ot);var Rt=function(e){(0,_inherits3["default"])(InboundPeerConnector,e);function InboundPeerConnector(e,t,r,n){(0,_classCallCheck3["default"])(this,InboundPeerConnector);var a=(0,_possibleConstructorReturn3["default"])(this,(InboundPeerConnector.__proto__||(0,_getPrototypeOf2["default"])(InboundPeerConnector)).call(this,e,t,r,null));a._rtcConnection.ondatachannel=function(e){e.channel.onopen=function(e){return a._onDataChannel(e)}};a.onSignal(n);return a}return InboundPeerConnector}(Nt);r.register(Rt);var Mt=function(e){(0,_inherits3["default"])(WebRtcDataChannel,e);function WebRtcDataChannel(e){(0,_classCallCheck3["default"])(this,WebRtcDataChannel);var t=(0,_possibleConstructorReturn3["default"])(this,(WebRtcDataChannel.__proto__||(0,_getPrototypeOf2["default"])(WebRtcDataChannel)).call(this));C.that(e.ordered,"WebRtc data channel not ordered");t._channel=e;t._channel.onmessage=function(e){return t._onMessage(e.data||e)};t._channel.onclose=function(){return t._onClose()};t._channel.onerror=function(e){return t.fire("error",e,t)};return t}(0,_createClass3["default"])(WebRtcDataChannel,[{key:"_onMessage",value:function _onMessage(e){var t=this;if(e instanceof Blob){var r=new FileReader;r.onloadend=function(){return(0,_get3["default"])(WebRtcDataChannel.prototype.__proto__||(0,_getPrototypeOf2["default"])(WebRtcDataChannel.prototype),"_onMessage",t).call(t,r.result)};r.readAsArrayBuffer(e)}else(0,_get3["default"])(WebRtcDataChannel.prototype.__proto__||(0,_getPrototypeOf2["default"])(WebRtcDataChannel.prototype),"_onMessage",this).call(this,e)}},{key:"sendChunk",value:function sendChunk(e){this._channel.send(e)}},{key:"close",value:function close(){this._channel.close()}},{key:"readyState",get:function get(){return s.ReadyState.fromString(this._channel.readyState)}}]);return WebRtcDataChannel}(s);r.register(Mt);var Bt=function(){function WebRtcUtils(){(0,_classCallCheck3["default"])(this,WebRtcUtils)}(0,_createClass3["default"])(WebRtcUtils,null,[{key:"candidateToNetAddress",value:function candidateToNetAddress(e){var t=e.candidate.split(" ");return t.length<6?null:Ut.fromIP(t[4])}}]);return WebRtcUtils}();r.register(Bt);var zt=function(e){(0,_inherits3["default"])(WebSocketConnector,e);function WebSocketConnector(e){(0,_classCallCheck3["default"])(this,WebSocketConnector);var t=(0,_possibleConstructorReturn3["default"])(this,(WebSocketConnector.__proto__||(0,_getPrototypeOf2["default"])(WebSocketConnector)).call(this));if(e.peerAddress.protocol===Ze.WS){t._wss=l.newWebSocketServer(e);t._wss.on("connection",function(e){return t._onConnection(e)});a.d(WebSocketConnector,"WebSocketConnector listening on port "+e.peerAddress.port)}t._timers=new _;return t}(0,_createClass3["default"])(WebSocketConnector,[{key:"connect",value:function connect(e){var t=this;if(e.protocol!==Ze.WS)throw"Malformed peerAddress";var r="connect_"+e;if(this._timers.timeoutExists(r)){a.w(WebSocketConnector,"Already connecting to "+e);return!1}var n=l.newWebSocket("wss://"+e.host+":"+e.port,{handshakeTimeout:WebSocketConnector.CONNECT_TIMEOUT});n.binaryType="arraybuffer";n.onopen=function(){t._timers.clearTimeout(r);n.onerror=function(){};var a=n._socket&&n._socket.remoteAddress?Ut.fromIP(n._socket.remoteAddress):null,i=new Xt(new Lt(n),Ze.WS,a,e);t.fire("connection",i)};n.onerror=function(n){t._timers.clearTimeout(r);t.fire("error",e,n)};this._timers.setTimeout(r,function(){t._timers.clearTimeout(r);n.onerror=function(){};n.onopen=function(){a.w(WebSocketConnector,"Connection to "+e+" succeeded after timeout - closing it");n.close()};t.fire("error",e,"timeout")},WebSocketConnector.CONNECT_TIMEOUT);return!0}},{key:"_onConnection",value:function _onConnection(e){var t=Ut.fromIP(e._socket.remoteAddress),r=new Xt(new Lt(e),Ze.WS,t,null);this.fire("connection",r)}}]);return WebSocketConnector}(i);zt.CONNECT_TIMEOUT=5e3;r.register(zt);var Lt=function(e){(0,_inherits3["default"])(WebSocketDataChannel,e);function WebSocketDataChannel(e){(0,_classCallCheck3["default"])(this,WebSocketDataChannel);var t=(0,_possibleConstructorReturn3["default"])(this,(WebSocketDataChannel.__proto__||(0,_getPrototypeOf2["default"])(WebSocketDataChannel)).call(this));t._ws=e;t._ws.onmessage=function(e){return t._onMessage(e.data||e)};t._ws.onclose=function(){return t._onClose()};t._ws.onerror=function(e){return t.fire("error",e)};return t}(0,_createClass3["default"])(WebSocketDataChannel,[{key:"close",value:function close(){this._ws.close()}},{key:"sendChunk",value:function sendChunk(e){this._ws.send(e)}},{key:"readyState",get:function get(){return this._ws.readyState}}]);return WebSocketDataChannel}(s);r.register(Lt);var Ut=function(){(0,_createClass3["default"])(NetAddress,null,[{key:"fromIP",value:function fromIP(e){return new NetAddress(hr.sanitizeIP(e))}}]);function NetAddress(e){(0,_classCallCheck3["default"])(this,NetAddress);this._ip=e}(0,_createClass3["default"])(NetAddress,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).writeVarLengthString(this._ip);return e}},{key:"equals",value:function equals(e){return e instanceof NetAddress&&this._ip===e.ip}},{key:"hashCode",value:function hashCode(){return this.toString()}},{key:"toString",value:function toString(){return""+this._ip}},{key:"isPseudo",value:function isPseudo(){return!this._ip||NetAddress.UNKNOWN.equals(this)}},{key:"isPrivate",value:function isPrivate(){return this.isPseudo()||hr.isPrivateIP(this._ip)}},{key:"serializedSize",get:function get(){return T.varLengthStringSize(this._ip)}},{key:"ip",get:function get(){return this._ip}}],[{key:"unserialize",value:function unserialize(e){var t=e.readVarLengthString();return t?NetAddress.fromIP(t):NetAddress.UNSPECIFIED}}]);return NetAddress}();Ut.UNSPECIFIED=new Ut("");Ut.UNKNOWN=new Ut("<unknown>");r.register(Ut);var Dt=function(e){(0,_inherits3["default"])(PeerId,e);(0,_createClass3["default"])(PeerId,null,[{key:"copy",value:function copy(e){return e?new PeerId(new Uint8Array(e._obj)):e}}]);function PeerId(e){(0,_classCallCheck3["default"])(this,PeerId);return(0,_possibleConstructorReturn3["default"])(this,(PeerId.__proto__||(0,_getPrototypeOf2["default"])(PeerId)).call(this,e,Uint8Array,PeerId.SERIALIZED_SIZE))}(0,_createClass3["default"])(PeerId,[{key:"serialize",value:function serialize(e){(e=e||new T(this.serializedSize)).write(this._obj);return e}},{key:"subarray",value:function subarray(e,t){return this._obj.subarray(e,t)}},{key:"equals",value:function equals(e){return e instanceof PeerId&&(0,_get3["default"])(PeerId.prototype.__proto__||(0,_getPrototypeOf2["default"])(PeerId.prototype),"equals",this).call(this,e)}},{key:"toString",value:function toString(){return this.toHex()}},{key:"serializedSize",get:function get(){return PeerId.SERIALIZED_SIZE}}],[{key:"unserialize",value:function unserialize(e){return new PeerId(e.read(PeerId.SERIALIZED_SIZE))}},{key:"fromBase64",value:function fromBase64(e){return new PeerId(w.fromBase64(e))}},{key:"fromHex",value:function fromHex(e){return new PeerId(w.fromHex(e))}}]);return PeerId}(L);Dt.SERIALIZED_SIZE=16;r.register(Dt);var Ht=function(){function PeerAddress(e,t,r,n,a,i,s){(0,_classCallCheck3["default"])(this,PeerAddress);if(!I.isUint8(i))throw new Error("Malformed distance");if(null!==a&&!(a instanceof H))throw new Error("Malformed publicKey");this._protocol=e;this._services=t;this._timestamp=r;this._netAddress=n||Ut.UNSPECIFIED;this._publicKey=a;this._distance=i;this._signature=s}(0,_createClass3["default"])(PeerAddress,[{key:"serialize",value:function serialize(e){if(!this._publicKey)throw new Error("PeerAddress without publicKey may not be serialized.");if(!this._signature)throw new Error("PeerAddress without signature may not be serialized.");(e=e||new T(this.serializedSize)).writeUint8(this._protocol);e.writeUint32(this._services);e.writeUint64(this._timestamp);this._netAddress.isPrivate()?Ut.UNSPECIFIED.serialize(e):this._netAddress.serialize(e);this._publicKey.serialize(e);e.writeUint8(this._distance);this._signature.serialize(e);return e}},{key:"serializeContent",value:function serializeContent(e){(e=e||new T(this.serializedContentSize)).writeUint8(this._protocol);e.writeUint32(this._services);e.writeUint64(this._timestamp);return e}},{key:"equals",value:function equals(e){return e instanceof PeerAddress&&this.protocol===e.protocol&&(!this.publicKey||!e.publicKey||this.publicKey.equals(e.publicKey))&&(!this.peerId||!e.peerId||this.peerId.equals(e.peerId))}},{key:"verifySignature",value:function verifySignature(){this._signatureVerified===undefined&&(this._signatureVerified=this.signature.verify(this.publicKey,this.serializeContent()));return this._signatureVerified}},{key:"isSeed",value:function isSeed(){return 0===this._timestamp}},{key:"exceedsAge",value:function exceedsAge(){if(this.isSeed())return!1;var e=Date.now()-this.timestamp;switch(this.protocol){case Ze.WS:return e>qt.MAX_AGE_WEBSOCKET;case Ze.RTC:return e>qt.MAX_AGE_WEBRTC;case Ze.DUMB:return e>qt.MAX_AGE_DUMB}return!1}},{key:"serializedSize",get:function get(){return 13+this._netAddress.serializedSize+this._publicKey.serializedSize+1+this._signature.serializedSize}},{key:"serializedContentSize",get:function get(){return 13}},{key:"protocol",get:function get(){return this._protocol}},{key:"services",get:function get(){return this._services}},{key:"timestamp",get:function get(){return this._timestamp}},{key:"netAddress",get:function get(){return this._netAddress.isPseudo()?null:this._netAddress},set:function set(e){this._netAddress=e||Ut.UNSPECIFIED}},{key:"publicKey",get:function get(){return this._publicKey}},{key:"peerId",get:function get(){return this._publicKey?this._publicKey.toPeerId():null}},{key:"distance",get:function get(){return this._distance},set:function set(e){this._distance=e}},{key:"signature",get:function get(){return this._signature},set:function set(e){if(0===this._distance){this._signature=e;this._signatureVerified=undefined}}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint8();switch(t){case Ze.WS:return Gt.unserialize(e);case Ze.RTC:return Kt.unserialize(e);case Ze.DUMB:return Ft.unserialize(e);default:throw"Malformed PeerAddress protocol "+t}}}]);return PeerAddress}();r.register(Ht);var Gt=function(e){(0,_inherits3["default"])(WsPeerAddress,e);(0,_createClass3["default"])(WsPeerAddress,null,[{key:"seed",value:function seed(e,t,r){var n=r?new H(w.fromHex(r)):null;return new WsPeerAddress(h.FULL,0,Ut.UNSPECIFIED,n,0,e,t)}}]);function WsPeerAddress(e,t,r,n,a,i,s,o){(0,_classCallCheck3["default"])(this,WsPeerAddress);var u=(0,_possibleConstructorReturn3["default"])(this,(WsPeerAddress.__proto__||(0,_getPrototypeOf2["default"])(WsPeerAddress)).call(this,Ze.WS,e,t,r,n,a,o));if(!i)throw new Error("Malformed host");if(!I.isUint16(s))throw new Error("Malformed port");u._host=i;u._port=s;return u}(0,_createClass3["default"])(WsPeerAddress,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(WsPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(WsPeerAddress.prototype),"serialize",this).call(this,e);e.writeVarLengthString(this._host);e.writeUint16(this._port);return e}},{key:"serializeContent",value:function serializeContent(e){e=e||new T(this.serializedContentSize);(0,_get3["default"])(WsPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(WsPeerAddress.prototype),"serializeContent",this).call(this,e);e.writeVarLengthString(this._host);e.writeUint16(this._port);return e}},{key:"globallyReachable",value:function globallyReachable(){return hr.hostGloballyReachable(this.host)}},{key:"equals",value:function equals(e){return(0,_get3["default"])(WsPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(WsPeerAddress.prototype),"equals",this).call(this,e)&&e instanceof WsPeerAddress&&(!!this.peerId&&!!e.peerId||this._host===e.host&&this._port===e.port)}},{key:"hashCode",value:function hashCode(){return this.peerId?"wss:///"+this.peerId:"wss://"+this._host+":"+this._port+"/"}},{key:"toString",value:function toString(){return"wss://"+this._host+":"+this._port+"/"+(this.peerId?this.peerId:"")}},{key:"withoutId",value:function withoutId(){return new WsPeerAddress(this.services,this.timestamp,this.netAddress,null,this.distance,this.host,this.port)}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(WsPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(WsPeerAddress.prototype),"serializedSize",this)+T.varLengthStringSize(this._host)+2}},{key:"serializedContentSize",get:function get(){return(0,_get3["default"])(WsPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(WsPeerAddress.prototype),"serializedContentSize",this)+T.varLengthStringSize(this._host)+2}},{key:"host",get:function get(){return this._host}},{key:"port",get:function get(){return this._port}}],[{key:"unserialize",value:function unserialize(e){var t=e.readUint32(),r=e.readUint64(),n=Ut.unserialize(e),a=H.unserialize(e),i=e.readUint8(),s=W.unserialize(e);return new WsPeerAddress(t,r,n,a,i,e.readVarLengthString(),e.readUint16(),s)}}]);return WsPeerAddress}(Ht);r.register(Gt);var Kt=function(e){(0,_inherits3["default"])(RtcPeerAddress,e);function RtcPeerAddress(e,t,r,n,a,i){(0,_classCallCheck3["default"])(this,RtcPeerAddress);return(0,_possibleConstructorReturn3["default"])(this,(RtcPeerAddress.__proto__||(0,_getPrototypeOf2["default"])(RtcPeerAddress)).call(this,Ze.RTC,e,t,r,n,a,i))}(0,_createClass3["default"])(RtcPeerAddress,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(RtcPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(RtcPeerAddress.prototype),"serialize",this).call(this,e);return e}},{key:"equals",value:function equals(e){return(0,_get3["default"])(RtcPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(RtcPeerAddress.prototype),"equals",this).call(this,e)&&e instanceof RtcPeerAddress}},{key:"hashCode",value:function hashCode(){return this.toString()}},{key:"toString",value:function toString(){return"rtc:///"+this.peerId}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(RtcPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(RtcPeerAddress.prototype),"serializedSize",this)}}],[{key:"unserialize",value:function unserialize(e){return new RtcPeerAddress(e.readUint32(),e.readUint64(),Ut.unserialize(e),H.unserialize(e),e.readUint8(),W.unserialize(e))}}]);return RtcPeerAddress}(Ht);r.register(Kt);var Ft=function(e){(0,_inherits3["default"])(DumbPeerAddress,e);function DumbPeerAddress(e,t,r,n,a,i){(0,_classCallCheck3["default"])(this,DumbPeerAddress);return(0,_possibleConstructorReturn3["default"])(this,(DumbPeerAddress.__proto__||(0,_getPrototypeOf2["default"])(DumbPeerAddress)).call(this,Ze.DUMB,e,t,r,n,a,i))}(0,_createClass3["default"])(DumbPeerAddress,[{key:"serialize",value:function serialize(e){e=e||new T(this.serializedSize);(0,_get3["default"])(DumbPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(DumbPeerAddress.prototype),"serialize",this).call(this,e);return e}},{key:"equals",value:function equals(e){return(0,_get3["default"])(DumbPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(DumbPeerAddress.prototype),"equals",this).call(this,e)&&e instanceof DumbPeerAddress}},{key:"hashCode",value:function hashCode(){return this.toString()}},{key:"toString",value:function toString(){return"dumb:///"+this.peerId}},{key:"serializedSize",get:function get(){return(0,_get3["default"])(DumbPeerAddress.prototype.__proto__||(0,_getPrototypeOf2["default"])(DumbPeerAddress.prototype),"serializedSize",this)}}],[{key:"unserialize",value:function unserialize(e){return new DumbPeerAddress(e.readUint32(),e.readUint64(),Ut.unserialize(e),H.unserialize(e),e.readUint8(),W.unserialize(e))}}]);return DumbPeerAddress}(Ht);r.register(Ft);var jt=function(){function PeerAddressState(e){(0,_classCallCheck3["default"])(this,PeerAddressState);this.peerAddress=e;this.state=PeerAddressState.NEW;this.lastConnected=-1;this.bannedUntil=-1;this.banBackoff=qt.INITIAL_FAILED_BACKOFF;this._signalRouter=new Wt(e);this._failedAttempts=0;this._closeTypes=new _map2["default"]}(0,_createClass3["default"])(PeerAddressState,[{key:"close",value:function close(e){if(e){this._closeTypes.has(e)?this._closeTypes.set(e,this._closeTypes.get(e)+1):this._closeTypes.set(e,1);this.state!==PeerAddressState.BANNED&&($t.isBanningType(e)?this.state=PeerAddressState.BANNED:$t.isFailingType(e)?this.state=PeerAddressState.FAILED:this.state=PeerAddressState.TRIED)}}},{key:"equals",value:function equals(e){return e instanceof PeerAddressState&&this.peerAddress.equals(e.peerAddress)}},{key:"hashCode",value:function hashCode(){return this.peerAddress.hashCode()}},{key:"toString",value:function toString(){return"PeerAddressState{peerAddress="+this.peerAddress+", state="+this.state+", lastConnected="+this.lastConnected+", failedAttempts="+this.failedAttempts+", bannedUntil="+this.bannedUntil+"}"}},{key:"signalRouter",get:function get(){return this._signalRouter}},{key:"maxFailedAttempts",get:function get(){switch(this.peerAddress.protocol){case Ze.RTC:return qt.MAX_FAILED_ATTEMPTS_RTC;case Ze.WS:return qt.MAX_FAILED_ATTEMPTS_WS;default:return 0}}},{key:"failedAttempts",get:function get(){return this._signalRouter.bestRoute?this._signalRouter.bestRoute.failedAttempts:this._failedAttempts},set:function set(e){if(this._signalRouter.bestRoute){this._signalRouter.bestRoute.failedAttempts=e;this._signalRouter.updateBestRoute()}else this._failedAttempts=e}}]);return PeerAddressState}();jt.NEW=1;jt.ESTABLISHED=2;jt.TRIED=3;jt.FAILED=4;jt.BANNED=5;r.register(jt);var Wt=function(){function SignalRouter(e){(0,_classCallCheck3["default"])(this,SignalRouter);this.peerAddress=e;this._bestRoute=null;this._routes=new v}(0,_createClass3["default"])(SignalRouter,[{key:"addRoute",value:function addRoute(e,t,r){var n=this._routes.get(e),a=new Vt(e,t,r);n&&(a.failedAttempts=n.failedAttempts);this._routes.add(a);if(!this._bestRoute||a.score>this._bestRoute.score||a.score===this._bestRoute.score&&r>this._bestRoute.timestamp){this._bestRoute=a;this.peerAddress.distance=this._bestRoute.distance}}},{key:"deleteBestRoute",value:function deleteBestRoute(){this._bestRoute&&this.deleteRoute(this._bestRoute.signalChannel)}},{key:"deleteRoute",value:function deleteRoute(e){this._routes.remove(e);this._bestRoute&&this._bestRoute.signalChannel.equals(e)&&this.updateBestRoute()}},{key:"deleteAllRoutes",value:function deleteAllRoutes(){this._bestRoute=null;this._routes=new v}},{key:"hasRoute",value:function hasRoute(){return this._routes.length>0}},{key:"updateBestRoute",value:function updateBestRoute(){var e=null,t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._routes.values());!(t=(a=i.next()).done);t=!0){var s=a.value;(null===e||s.score>e.score||s.score===e.score&&s.timestamp>e.timestamp)&&(e=s)}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}this._bestRoute=e;this._bestRoute?this.peerAddress.distance=this._bestRoute.distance:this.peerAddress.distance=qt.MAX_DISTANCE+1}},{key:"equals",value:function equals(e){return e instanceof jt&&this.peerAddress.equals(e.peerAddress)}},{key:"hashCode",value:function hashCode(){return this.peerAddress.hashCode()}},{key:"toString",value:function toString(){return"PeerAddressState{peerAddress="+this.peerAddress+", state="+this.state+", lastConnected="+this.lastConnected+", failedAttempts="+this.failedAttempts+", bannedUntil="+this.bannedUntil+"}"}},{key:"bestRoute",get:function get(){return this._bestRoute}}]);return SignalRouter}();r.register(Wt);var Vt=function(){function SignalRoute(e,t,r){(0,_classCallCheck3["default"])(this,SignalRoute);this.failedAttempts=0;this.timestamp=r;this._signalChannel=e;this._distance=t}(0,_createClass3["default"])(SignalRoute,[{key:"equals",value:function equals(e){return e instanceof SignalRoute&&this._signalChannel.equals(e._signalChannel)}},{key:"hashCode",value:function hashCode(){return this._signalChannel.hashCode()}},{key:"toString",value:function toString(){return"SignalRoute{signalChannel="+this._signalChannel+", distance="+this._distance+", timestamp="+this.timestamp+", failedAttempts="+this.failedAttempts+"}"}},{key:"signalChannel",get:function get(){return this._signalChannel}},{key:"distance",get:function get(){return this._distance}},{key:"score",get:function get(){return(qt.MAX_DISTANCE-this._distance)/2*(1-this.failedAttempts/qt.MAX_FAILED_ATTEMPTS_RTC)}}]);return SignalRoute}();r.register(Vt);var qt=function(e){(0,_inherits3["default"])(PeerAddressBook,e);function PeerAddressBook(e){(0,_classCallCheck3["default"])(this,PeerAddressBook);var t=(0,_possibleConstructorReturn3["default"])(this,(PeerAddressBook.__proto__||(0,_getPrototypeOf2["default"])(PeerAddressBook)).call(this));t._store=new v;t._peerIds=new y;t._networkConfig=e;t.add(null,PeerAddressBook.SEED_PEERS);setInterval(function(){return t._housekeeping()},PeerAddressBook.HOUSEKEEPING_INTERVAL);return t}(0,_createClass3["default"])(PeerAddressBook,[{key:"values",value:function values(){return this._store.values()}},{key:"_get",value:function _get(e){if(e instanceof Gt){var t=this._store.get(e.withoutId());if(t)return t}return this._store.get(e)}},{key:"getState",value:function getState(e){return this._get(e)}},{key:"get",value:function get(e){var t=this._get(e);return t?t.peerAddress:null}},{key:"getByPeerId",value:function getByPeerId(e){var t=this._peerIds.get(e);return t?t.peerAddress:null}},{key:"getChannelByPeerId",value:function getChannelByPeerId(e){var t=this._peerIds.get(e);return t&&t.signalRouter.bestRoute?t.signalRouter.bestRoute.signalChannel:null}},{key:"query",value:function query(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1e3,n=Date.now(),a=[],i=!0,s=!1,o=undefined;try{for(var u,c=(0,_getIterator3["default"])(this._store.values());!(i=(u=c.next()).done);i=!0){var l=u.value;if(l.state!==jt.BANNED&&l.state!==jt.FAILED){var h=l.peerAddress;if(!h.isSeed()&&0!=(h.protocol&e)&&0!=(h.services&t)){l.state===jt.ESTABLISHED&&l.signalRouter.bestRoute&&(l.signalRouter.bestRoute.timestamp=n);if(!h.exceedsAge()){a.push(h);if(a.length>=r)break}}}}}catch(f){s=!0;o=f}finally{try{!i&&c["return"]&&c["return"]()}finally{if(s)throw o}}return a}},{key:"add",value:function add(e,t){var r=Array.isArray(t)?t:[t],n=[],a=!0,i=!1,s=undefined;try{for(var o,u=(0,_getIterator3["default"])(r);!(a=(o=u.next()).done);a=!0){var c=o.value;this._add(e,c)&&n.push(c)}}catch(l){i=!0;s=l}finally{try{!a&&u["return"]&&u["return"]()}finally{if(i)throw s}}n.length&&this.fire("added",n,this)}},{key:"_add",value:function _add(e,t){if(this._store.length>=PeerAddressBook.MAX_SIZE)return!1;if(this._networkConfig.peerAddress.equals(t))return!1;if(e&&t.exceedsAge()){a.d(PeerAddressBook,"Ignoring address "+t+" - too old ("+new Date(t.timestamp)+")");return!1}if(t.timestamp>Date.now()+PeerAddressBook.MAX_TIMESTAMP_DRIFT){a.d(PeerAddressBook,"Ignoring addresses "+t+" - timestamp in the future");return!1}if(t.protocol===Ze.RTC){t.distance++;if(t.distance>PeerAddressBook.MAX_DISTANCE){a.d(PeerAddressBook,"Ignoring address "+t+" - max distance exceeded");var r=this._get(t);r&&r.signalRouter.deleteRoute(e);return!1}}var n=this._get(t);if(n){var i=n.peerAddress;if(n.state===jt.BANNED)return!1;if(i.isSeed())return!1;i.netAddress&&!t.netAddress&&(t.netAddress=i.netAddress);if(t.protocol===Ze.WS&&i.timestamp>=t.timestamp)return!1}else{n=new jt(t);this._store.add(n);t.protocol===Ze.RTC&&this._peerIds.put(t.peerId,n)}t.protocol===Ze.RTC&&n.signalRouter.addRoute(e,t.distance,t.timestamp);n.peerAddress=t;return!0}},{key:"established",value:function established(e,t){var r=this._get(t);if(!r){r=new jt(t);t.protocol===Ze.RTC&&this._peerIds.put(t.peerId,r);this._store.add(r)}r.state=jt.ESTABLISHED;r.lastConnected=Date.now();r.failedAttempts=0;r.bannedUntil=-1;r.banBackoff=PeerAddressBook.INITIAL_FAILED_BACKOFF;r.peerAddress.isSeed()||(r.peerAddress=t);t.protocol===Ze.RTC&&r.signalRouter.addRoute(e,t.distance,t.timestamp)}},{key:"close",value:function close(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null,n=this._get(t);if(n){n.close(r);e&&this._removeBySignalChannel(e);if($t.isBanningType(r))this._ban(t);else if($t.isFailingType(r)){n.failedAttempts++;if(n.failedAttempts>=n.maxFailedAttempts)if(n.banBackoff>=PeerAddressBook.MAX_FAILED_BACKOFF)this._remove(t);else{n.bannedUntil=Date.now()+n.banBackoff;n.banBackoff=Math.min(PeerAddressBook.MAX_FAILED_BACKOFF,2*n.banBackoff)}}t.protocol===Ze.DUMB&&this._remove(t)}}},{key:"unroutable",value:function unroutable(e,t){if(t){var r=this._get(t);if(r)if(r.signalRouter.bestRoute&&r.signalRouter.bestRoute.signalChannel.equals(e)){r.signalRouter.deleteBestRoute();r.signalRouter.hasRoute()||this._remove(r.peerAddress)}else a.w(PeerAddressBook,"Got unroutable for "+t+" on a channel other than the best route.")}}},{key:"_ban",value:function _ban(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:PeerAddressBook.DEFAULT_BAN_TIME,r=this._get(e);if(!r){r=new jt(e);this._store.add(r)}r.state=jt.BANNED;r.bannedUntil=Date.now()+t;r.signalRouter.deleteAllRoutes()}},{key:"isBanned",value:function isBanned(e){var t=this._get(e);return t&&t.state===jt.BANNED&&!t.peerAddress.isSeed()}},{key:"_remove",value:function _remove(e){var t=this._get(e);if(t)if(t.peerAddress.isSeed())this._ban(e,t.banBackoff);else{e.protocol===Ze.RTC&&this._peerIds.remove(e.peerId);t.state!==jt.BANNED&&this._store.remove(e)}}},{key:"_removeBySignalChannel",value:function _removeBySignalChannel(e){var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._store.values());!(t=(a=i.next()).done);t=!0){var s=a.value;if(s.peerAddress.protocol===Ze.RTC){s.signalRouter.deleteRoute(e);s.signalRouter.hasRoute()||this._remove(s.peerAddress)}}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"_housekeeping",value:function _housekeeping(){var e=Date.now(),t=[],r=!0,n=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(this._store.values());!(r=(s=o.next()).done);r=!0){var u=s.value,c=u.peerAddress;switch(u.state){case jt.NEW:case jt.TRIED:case jt.FAILED:if(c.exceedsAge()){a.d(PeerAddressBook,"Deleting old peer address "+c);this._remove(c)}if(u.state===jt.FAILED&&u.failedAttempts>=u.maxFailedAttempts&&u.bannedUntil>0&&u.bannedUntil<=e){u.bannedUntil=-1;u.failedAttempts=0;t.push(c)}break;case jt.BANNED:if(u.bannedUntil<=e)if(c.isSeed()){u.state=jt.NEW;u.failedAttempts=0;u.bannedUntil=-1;t.push(c)}else this._store.remove(c);break;case jt.ESTABLISHED:u.signalRouter.bestRoute&&(u.signalRouter.bestRoute.timestamp=e)}}}catch(l){n=!0;i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(n)throw i}}t.length&&this.fire("added",t,this)}},{key:"knownAddressesCount",get:function get(){return this._store.length}}]);return PeerAddressBook}(i);qt.MAX_AGE_WEBSOCKET=18e5;qt.MAX_AGE_WEBRTC=6e5;qt.MAX_AGE_DUMB=6e4;qt.MAX_DISTANCE=4;qt.MAX_FAILED_ATTEMPTS_WS=3;qt.MAX_FAILED_ATTEMPTS_RTC=2;qt.MAX_TIMESTAMP_DRIFT=6e5;qt.HOUSEKEEPING_INTERVAL=6e4;qt.DEFAULT_BAN_TIME=6e5;qt.INITIAL_FAILED_BACKOFF=3e4;qt.MAX_FAILED_BACKOFF=6e5;qt.MAX_SIZE=M.isBrowser()?1e4:2e5;qt.SEED_PEERS=[Gt.seed("dev.nimiq-network.com",8080,"e65e39616662f2c16d62dc08915e5a1d104619db8c2b9cf9b389f96c8dce9837")];r.register(qt);var $t=function(){function CloseType(){(0,_classCallCheck3["default"])(this,CloseType)}(0,_createClass3["default"])(CloseType,null,[{key:"isBanningType",value:function isBanningType(e){return e>=100&&e<200}},{key:"isFailingType",value:function isFailingType(e){return e>=200}}]);return CloseType}();$t.GET_BLOCKS_TIMEOUT=1;$t.GET_CHAIN_PROOF_TIMEOUT=2;$t.GET_ACCOUNTS_TREE_CHUNK_TIMEOUT=3;$t.GET_HEADER_TIMEOUT=4;$t.INVALID_ACCOUNTS_TREE_CHUNK=5;$t.ACCOUNTS_TREE_CHUNCK_ROOT_HASH_MISMATCH=6;$t.INVALID_CHAIN_PROOF=7;$t.RECEIVED_WRONG_HEADER=8;$t.DID_NOT_GET_REQUESTED_HEADER=9;$t.ABORTED_SYNC=10;$t.GET_ACCOUNTS_PROOF_TIMEOUT=11;$t.GET_TRANSACTIONS_PROOF_TIMEOUT=12;$t.GET_TRANSACTION_RECEIPTS_TIMEOUT=13;$t.INVALID_ACCOUNTS_PROOF=14;$t.ACCOUNTS_PROOF_ROOT_HASH_MISMATCH=15;$t.INCOMPLETE_ACCOUNTS_PROOF=16;$t.INVALID_BLOCK=17;$t.INVALID_CHAIN_PROOF=18;$t.INVALID_TRANSACTION_PROOF=19;$t.SENDING_PING_MESSAGE_FAILED=22;$t.SENDING_OF_VERSION_MESSAGE_FAILED=29;$t.DUPLICATE_CONNECTION=30;$t.PEER_IS_BANNED=31;$t.CONNECTION_LIMIT_PER_IP=32;$t.MANUAL_NETWORK_DISCONNECT=33;$t.MANUAL_WEBSOCKET_DISCONNECT=34;$t.MAX_PEER_COUNT_REACHED=35;$t.PEER_CONNECTION_RECYCLED=36;$t.PEER_CONNECTION_RECYCLED_INBOUND_EXCHANGE=37;$t.RECEIVED_INVALID_BLOCK=100;$t.BLOCKCHAIN_SYNC_FAILED=101;$t.RECEIVED_INVALID_HEADER=102;$t.RECEIVED_TRANSACTION_NOT_MATCHING_OUR_SUBSCRIPTION=103;$t.ADDR_MESSAGE_TOO_LARGE=104;$t.INVALID_ADDR=105;$t.ADDR_NOT_GLOBALLY_REACHABLE=106;$t.INVALID_SIGNAL_TTL=107;$t.INVALID_SIGNATURE=108;$t.INCOMPATIBLE_VERSION=109;$t.INVALID_PUBLIC_KEY_IN_VERACK_MESSAGE=110;$t.INVALID_SIGNATURE_IN_VERACK_MESSAGE=111;$t.DIFFERENT_GENESIS_BLOCK=112;$t.INVALID_PEER_ADDRESS_IN_VERSION_MESSAGE=113;$t.UNEXPECTED_PEER_ADDRESS_IN_VERSION_MESSAGE=114;$t.CLOSED_BY_REMOTE=200;$t.PING_TIMEOUT=201;$t.CONNECTION_FAILED=202;$t.NETWORK_ERROR=203;$t.VERSION_TIMEOUT=204;$t.VERACK_TIMEOUT=205;r.register($t);var Xt=function(e){(0,_inherits3["default"])(NetworkConnection,e);function NetworkConnection(e,t,r,n){(0,_classCallCheck3["default"])(this,NetworkConnection);var a=(0,_possibleConstructorReturn3["default"])(this,(NetworkConnection.__proto__||(0,_getPrototypeOf2["default"])(NetworkConnection)).call(this));a._channel=e;a._protocol=t;a._netAddress=r;a._peerAddress=n;a._bytesSent=0;a._bytesReceived=0;a._inbound=!n;a._closed=!1;a._lastError=null;a._id=NetworkConnection._instanceCount++;a._channel.on("message",function(e){return a._onMessage(e)});a._channel.on("close",function(){return a._onClose($t.CLOSED_BY_REMOTE,"Closed by remote")});a._channel.on("error",function(e){return a._onError(e)});return a}(0,_createClass3["default"])(NetworkConnection,[{key:"_onMessage",value:function _onMessage(e){if(!this._closed){this._bytesReceived+=e.byteLength||e.length;this.fire("message",e,this)}}},{key:"_onError",value:function _onError(e){this._lastError=e;this.fire("error",e,this)}},{key:"_onClose",value:function _onClose(e,t){if(!this._closed){this._closed=!0;if(e===$t.CLOSED_BY_REMOTE&&this._lastError){e=$t.NETWORK_ERROR;t=this._lastError}this.fire("close",e,t,this)}}},{key:"_close",value:function _close(e,t){this._onClose(e,t);this._channel.close()}},{key:"_isChannelOpen",value:function _isChannelOpen(){return this._channel.readyState===s.ReadyState.OPEN}},{key:"_isChannelClosing",value:function _isChannelClosing(){return this._channel.readyState===s.ReadyState.CLOSING}},{key:"_isChannelClosed",value:function _isChannelClosed(){return this._channel.readyState===s.ReadyState.CLOSED}},{key:"send",value:function send(e){var t=this._peerAddress||this._netAddress;if(this._closed)return!1;if(this._isChannelClosing()||this._isChannelClosed()){a.w(NetworkConnection,"Not sending data to "+t+" - channel closing/closed ("+this._channel.readyState+")");this._onClose();return!1}if(!this._isChannelOpen()){a.w(NetworkConnection,"Not sending data to "+t+" - channel not open ("+this._channel.readyState+")");return!1}try{this._channel.send(e);this._bytesSent+=e.byteLength||e.length;return!0}catch(r){a.e(NetworkConnection,"Failed to send data to "+t+": "+(r.message||r));return!1}}},{key:"expectMessage",value:function expectMessage(e,t,r,n){this._channel.expectMessage(e,t,r,n)}},{key:"isExpectingMessage",value:function isExpectingMessage(e){return this._channel.isExpectingMessage(e)}},{key:"close",value:function close(e,t){var r=this._inbound?"inbound":"outbound";a.d(NetworkConnection,"Closing "+r+" connection #"+this._id+" "+(this._peerAddress||this._netAddress)+(t?" - "+t:"")+" ("+e+")");this._close(e,t)}},{key:"equals",value:function equals(e){return e instanceof NetworkConnection&&this._id===e.id}},{key:"hashCode",value:function hashCode(){return this._id.toString()}},{key:"toString",value:function toString(){return"NetworkConnection{id="+this._id+", protocol="+this._protocol+", peerAddress="+this._peerAddress+", netAddress="+this._netAddress+"}"}},{key:"id",get:function get(){return this._id}},{key:"protocol",get:function get(){return this._protocol}},{key:"peerAddress",get:function get(){return this._peerAddress},set:function set(e){this._peerAddress=e}},{key:"netAddress",get:function get(){return this._netAddress},set:function set(e){this._netAddress=e}},{key:"bytesSent",get:function get(){return this._bytesSent}},{key:"bytesReceived",get:function get(){return this._bytesReceived}},{key:"inbound",get:function get(){return this._inbound}},{key:"outbound",get:function get(){return!this._inbound}},{key:"closed",get:function get(){return this._closed}}]);return NetworkConnection}(i);Xt._instanceCount=0;r.register(Xt);var Yt=function(e){(0,_inherits3["default"])(PeerChannel,e);function PeerChannel(e){(0,_classCallCheck3["default"])(this,PeerChannel);var t=(0,_possibleConstructorReturn3["default"])(this,(PeerChannel.__proto__||(0,_getPrototypeOf2["default"])(PeerChannel)).call(this));t._conn=e;t._conn.on("message",function(e){return t._onMessage(e)});t.bubble(t._conn,"close","error");return t}(0,_createClass3["default"])(PeerChannel,[{key:"_onMessage",value:function _onMessage(e){var t=null,r=null;try{var n=new T(e);r=It.peekType(n);t=It.parse(n)}catch(i){a.w(PeerChannel,"Failed to parse message from "+(this.peerAddress||this.netAddress),i.message||i);if(!r||r===Je.Type.REJECT){this.close($t.FAILED_TO_PARSE_MESSAGE_TYPE,"Failed to parse message type");return}this.reject(r,_t.Code.REJECT_MALFORMED,i.message||i);return}if(t)try{this.fire(PeerChannel.Event[t.type],t,this);this.fire("message-log",t,this)}catch(i){a.w(PeerChannel,"Error while processing "+t.type+" message from "+(this.peerAddress||this.netAddress)+": "+i)}}},{key:"expectMessage",value:function expectMessage(e,t,r,n){this._conn.expectMessage(e,t,r,n)}},{key:"isExpectingMessage",value:function isExpectingMessage(e){return this._conn.isExpectingMessage(e)}},{key:"_send",value:function _send(e){return this._conn.send(e.serialize())}},{key:"close",value:function close(e,t){this._conn.close(e,t)}},{key:"version",value:function version(e,t,r){return this._send(new yt(d.CODE,e,Se.GENESIS.HASH,t,r))}},{key:"verack",value:function verack(e,t){return this._send(new vt(e,t))}},{key:"inv",value:function inv(e){return this._send(new st(e))}},{key:"notFound",value:function notFound(e){return this._send(new ct(e))}},{key:"getData",value:function getData(e){return this._send(new ot(e))}},{key:"getHeader",value:function getHeader(e){return this._send(new ut(e))}},{key:"block",value:function block(e){return this._send(new et(e))}},{key:"header",value:function header(e){return this._send(new nt(e))}},{key:"tx",value:function tx(e,t){return this._send(new gt(e,t))}},{key:"getBlocks",value:function getBlocks(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:it.VECTORS_MAX_COUNT,r=!(arguments.length>2&&arguments[2]!==undefined)||arguments[2];return this._send(new rt(e,t,r?rt.Direction.FORWARD:rt.Direction.BACKWARD))}},{key:"mempool",value:function mempool(){return this._send(new lt)}},{key:"reject",value:function reject(e,t,r,n){return this._send(new _t(e,t,r,n))}},{key:"subscribe",value:function subscribe(e){return this._send(new pt(e))}},{key:"addr",value:function addr(e){return this._send(new Qe(e))}},{key:"getAddr",value:function getAddr(e,t){return this._send(new tt(e,t))}},{key:"ping",value:function ping(e){return this._send(new ht(e))}},{key:"pong",value:function pong(e){return this._send(new ft(e))}},{key:"signal",value:function signal(e,t,r,n,a,i,s,o){return this._send(new dt(e,t,r,n,a,i,s,o))}},{key:"getAccountsProof",value:function getAccountsProof(e,t){return this._send(new mt(e,t))}},{key:"accountsProof",value:function accountsProof(e,t){return this._send(new kt(e,t))}},{key:"getChainProof",value:function getChainProof(){return this._send(new Ct)}},{key:"chainProof",value:function chainProof(e){return this._send(new bt(e))}},{key:"getAccountsTreeChunk",value:function getAccountsTreeChunk(e,t){return this._send(new At(e,t))}},{key:"accountsTreeChunk",value:function accountsTreeChunk(e,t){return this._send(new wt(e,t))}},{key:"getTransactionsProof",value:function getTransactionsProof(e,t){return this._send(new Tt(e,t))}},{key:"transactionsProof",value:function transactionsProof(e,t){return this._send(new St(e,t))}},{key:"getTransactionReceipts",value:function getTransactionReceipts(e){return this._send(new xt(e))}},{key:"transactionReceipts",value:function transactionReceipts(e){return this._send(new Et(e))}},{key:"equals",value:function equals(e){return e instanceof PeerChannel&&this._conn.equals(e.connection)}},{key:"hashCode",value:function hashCode(){return this._conn.hashCode()}},{key:"toString",value:function toString(){return"PeerChannel{conn="+this._conn+"}"}},{key:"connection",get:function get(){return this._conn}},{key:"id",get:function get(){return this._conn.id}},{key:"protocol",get:function get(){return this._conn.protocol}},{key:"peerAddress",get:function get(){return this._conn.peerAddress},set:function set(e){this._conn.peerAddress=e}},{key:"netAddress",get:function get(){return this._conn.netAddress},set:function set(e){this._conn.netAddress=e}},{key:"closed",get:function get(){return this._conn.closed}}]);return PeerChannel}(i);r.register(Yt);Yt.Event={};Yt.Event[Je.Type.VERSION]="version";Yt.Event[Je.Type.INV]="inv";Yt.Event[Je.Type.GET_DATA]="get-data";Yt.Event[Je.Type.GET_HEADER]="get-header";Yt.Event[Je.Type.NOT_FOUND]="not-found";Yt.Event[Je.Type.GET_BLOCKS]="get-blocks";Yt.Event[Je.Type.BLOCK]="block";Yt.Event[Je.Type.HEADER]="header";Yt.Event[Je.Type.TX]="tx";Yt.Event[Je.Type.MEMPOOL]="mempool";Yt.Event[Je.Type.REJECT]="reject";Yt.Event[Je.Type.SUBSCRIBE]="subscribe";Yt.Event[Je.Type.ADDR]="addr";Yt.Event[Je.Type.GET_ADDR]="get-addr";Yt.Event[Je.Type.PING]="ping";Yt.Event[Je.Type.PONG]="pong";Yt.Event[Je.Type.SIGNAL]="signal";Yt.Event[Je.Type.GET_CHAIN_PROOF]="get-chain-proof";Yt.Event[Je.Type.CHAIN_PROOF]="chain-proof";Yt.Event[Je.Type.GET_ACCOUNTS_PROOF]="get-accounts-proof";Yt.Event[Je.Type.ACCOUNTS_PROOF]="accounts-proof";Yt.Event[Je.Type.GET_ACCOUNTS_TREE_CHUNK]="get-accounts-tree-chunk";Yt.Event[Je.Type.ACCOUNTS_TREE_CHUNK]="accounts-tree-chunk";Yt.Event[Je.Type.GET_TRANSACTIONS_PROOF]="get-transactions-proof";Yt.Event[Je.Type.TRANSACTIONS_PROOF]="transactions-proof";Yt.Event[Je.Type.GET_TRANSACTION_RECEIPTS]="get-transaction-receipts";Yt.Event[Je.Type.TRANSACTION_RECEIPTS]="transaction-receipts";Yt.Event[Je.Type.VERACK]="verack";var Zt=function(e){(0,_inherits3["default"])(NetworkAgent,e);function NetworkAgent(e,t,r,n){(0,_classCallCheck3["default"])(this,NetworkAgent);var a=(0,_possibleConstructorReturn3["default"])(this,(NetworkAgent.__proto__||(0,_getPrototypeOf2["default"])(NetworkAgent)).call(this));a._blockchain=e;a._addresses=t;a._networkConfig=r;a._channel=n;a._peer=null;a._knownAddresses=new v;a._timers=new _;a._versionReceived=!1;a._verackReceived=!1;a._versionSent=!1;a._verackSent=!1;a._versionAttempts=0;a._peerAddressVerified=!1;a._peerChallengeNonce=null;a._pingTimes=new _map2["default"];a._challengeNonce=new Uint8Array(yt.CHALLENGE_SIZE);x.lib.getRandomValues(a._challengeNonce);n.on("version",function(e){return a._onVersion(e)});n.on("verack",function(e){return a._onVerAck(e)});n.on("addr",function(e){return a._onAddr(e)});n.on("get-addr",function(e){return a._onGetAddr(e)});n.on("ping",function(e){return a._onPing(e)});n.on("pong",function(e){return a._onPong(e)});n.on("close",function(){return a._onClose()});return a}(0,_createClass3["default"])(NetworkAgent,[{key:"relayAddresses",value:function relayAddresses(e){var t=this;if(this._versionReceived&&this._versionSent){var r=e.filter(function(e){if(e.protocol===Ze.RTC&&e.distance>=qt.MAX_DISTANCE)return!1;if(e.protocol===Ze.DUMB)return!1;var r=t._knownAddresses.get(e);return!e.isSeed()&&(!r||r.timestamp<Date.now()-NetworkAgent.RELAY_THROTTLE)});if(r.length){this._channel.addr(r);var n=!0,a=!1,i=undefined;try{for(var s,o=(0,_getIterator3["default"])(r);!(n=(s=o.next()).done);n=!0){var u=s.value;this._knownAddresses.add(u)}}catch(c){a=!0;i=c}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}}}}},{key:"handshake",value:function handshake(){var e=this;if(!this._versionSent)if(this._channel.version(this._networkConfig.peerAddress,this._blockchain.headHash,this._challengeNonce)){this._versionSent=!0;this._versionReceived?this._peerAddressVerified&&this._sendVerAck():this._timers.setTimeout("version",function(){e._timers.clearTimeout("version");e._channel.close($t.VERSION_TIMEOUT,"version timeout")},NetworkAgent.HANDSHAKE_TIMEOUT);this._timers.setTimeout("verack",function(){e._timers.clearTimeout("verack");e._channel.close($t.VERACK_TIMEOUT,"verack timeout")},NetworkAgent.HANDSHAKE_TIMEOUT)}else{this._versionAttempts++;if(this._versionAttempts>=NetworkAgent.VERSION_ATTEMPTS_MAX){this._channel.close($t.SENDING_OF_VERSION_MESSAGE_FAILED,"sending of version message failed");return}setTimeout(this.handshake.bind(this),NetworkAgent.VERSION_RETRY_DELAY)}}},{key:"_onVersion",value:function _onVersion(e){var t=this;a.d(NetworkAgent,function(){return"[VERSION] "+e.peerAddress+" "+e.headHash.toBase64()});var r=Date.now();if(this._canAcceptMessage(e))if(this._versionReceived)a.d(NetworkAgent,function(){return"Ignoring duplicate version message from "+t._channel.peerAddress});else{this._timers.clearTimeout("version");if(d.isCompatible(e.version))if(Se.GENESIS.HASH.equals(e.genesisHash))if(e.peerAddress.verifySignature()){var n=e.peerAddress;if(this._channel.peerAddress){if(!this._channel.peerAddress.equals(n)){this._channel.close($t.UNEXPECTED_PEER_ADDRESS_IN_VERSION_MESSAGE,"unexpected peerAddress in version message");return}this._peerAddressVerified=!0}if(!n.netAddress||n.netAddress.isPseudo()){var i=this._addresses.get(n);i&&i.netAddress&&(n.netAddress=i.netAddress)}this._channel.peerAddress=n;this._peer=new dr(this._channel,e.version,e.headHash,n.timestamp-r);this._peerChallengeNonce=e.challengeNonce;this._versionReceived=!0;this.fire("version",this._peer,this);if(!this._channel.closed)if(this._versionSent){this._peerAddressVerified&&this._sendVerAck();this._verackReceived&&this._finishHandshake()}else this.handshake()}else this._channel.close($t.INVALID_PEER_ADDRESS_IN_VERSION_MESSAGE,"invalid peerAddress in version message");else this._channel.close($t.DIFFERENT_GENESIS_BLOCK,"different genesis block ("+e.genesisHash+")");else{this._channel.reject(Je.Type.VERSION,_t.Code.REJECT_OBSOLETE,"incompatible version (ours="+d.CODE+", theirs="+e.version+")");this._channel.close($t.INCOMPATIBLE_VERSION,"incompatible version (ours="+d.CODE+", theirs="+e.version+")")}}}},{key:"_sendVerAck",value:function _sendVerAck(){C.that(this._peerAddressVerified);var e=w.concatTypedArrays(this._channel.peerAddress.peerId.serialize(),this._peerChallengeNonce),t=W.create(this._networkConfig.keyPair.privateKey,this._networkConfig.keyPair.publicKey,e);this._channel.verack(this._networkConfig.keyPair.publicKey,t);this._verackSent=!0}},{key:"_onVerAck",value:function _onVerAck(e){var t=this;a.d(NetworkAgent,function(){return"[VERACK] from "+t._channel.peerAddress});if(this._canAcceptMessage(e))if(this._verackReceived)a.d(NetworkAgent,function(){return"Ignoring duplicate verack message from "+t._channel.peerAddress});else{this._timers.clearTimeout("verack");if(e.publicKey.toPeerId().equals(this._channel.peerAddress.peerId)){var r=w.concatTypedArrays(this._networkConfig.peerAddress.peerId.serialize(),this._challengeNonce);if(e.signature.verify(e.publicKey,r)){if(!this._peerAddressVerified){this._peerAddressVerified=!0;this._sendVerAck()}this._knownAddresses.add(this._channel.peerAddress);this._verackReceived=!0;this._verackSent&&this._finishHandshake()}else this._channel.close($t.INVALID_SIGNATURE_IN_VERACK_MESSAGE,"Invalid signature in verack message")}else this._channel.close($t.INVALID_PUBLIC_KEY_IN_VERACK_MESSAGE,"Invalid public key in verack message")}}},{key:"_finishHandshake",value:function _finishHandshake(){var e=this;this._timers.setInterval("connectivity",function(){return e._checkConnectivity()},NetworkAgent.CONNECTIVITY_CHECK_INTERVAL);this._timers.setInterval("announce-addr",function(){return e._channel.addr([e._networkConfig.peerAddress])},NetworkAgent.ANNOUNCE_ADDR_INTERVAL);this.fire("handshake",this._peer,this);this._requestAddresses()}},{key:"_requestAddresses",value:function _requestAddresses(){this._channel.getAddr(this._networkConfig.protocolMask,this._networkConfig.services.accepted)}},{key:"_onAddr",value:function _onAddr(e){if(this._canAcceptMessage(e))if(e.addresses.length>1e3){a.w(NetworkAgent,"Rejecting addr message - too many addresses");this._channel.close($t.ADDR_MESSAGE_TOO_LARGE,"addr message too large")}else{var t=!0,r=!1,n=undefined;try{for(var i,s=(0,_getIterator3["default"])(e.addresses);!(t=(i=s.next()).done);t=!0){var o=i.value;if(!o.verifySignature()){this._channel.close($t.INVALID_ADDR,"invalid addr");return}if(o.protocol===Ze.WS&&!o.globallyReachable()){this._channel.close($t.ADDR_NOT_GLOBALLY_REACHABLE,"addr not globally reachable");return}this._knownAddresses.add(o)}}catch(u){r=!0;n=u}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}this._addresses.add(this._channel,e.addresses);this.fire("addr",e.addresses,this)}}},{key:"_onGetAddr",value:function _onGetAddr(e){var t=this;if(this._canAcceptMessage(e)){var r=this._addresses.query(e.protocolMask,e.serviceMask).filter(function(e){if(e.protocol===Ze.RTC&&e.distance>=qt.MAX_DISTANCE)return!1;var r=t._knownAddresses.get(e);return!r||r.timestamp<Date.now()-NetworkAgent.RELAY_THROTTLE});r.length&&this._channel.addr(r)}}},{key:"_checkConnectivity",value:function _checkConnectivity(){var e=this,t=I.randomUint32();if(this._channel.ping(t)){this._pingTimes.set(t,Date.now());this._timers.setTimeout("ping_"+t,function(){e._timers.clearTimeout("ping_"+t);e._channel.close($t.PING_TIMEOUT,"ping timeout");e._pingTimes["delete"](t)},NetworkAgent.PING_TIMEOUT)}else this._channel.close($t.SENDING_PING_MESSAGE_FAILED,"sending ping message failed")}},{key:"_onPing",value:function _onPing(e){this._canAcceptMessage(e)&&this._channel.pong(e.nonce)}},{key:"_onPong",value:function _onPong(e){this._timers.clearTimeout("ping_"+e.nonce);var t=this._pingTimes.get(e.nonce);if(t){var r=Date.now()-t;r>0&&this.fire("ping-pong",r);this._pingTimes["delete"](e.nonce)}}},{key:"_onClose",value:function _onClose(){this._timers.clearAll()}},{key:"_canAcceptMessage",value:function _canAcceptMessage(e){if(!this._versionReceived&&e.type!==Je.Type.VERSION){a.w(NetworkAgent,"Discarding '"+(Yt.Event[e.type]||e.type)+"' message from "+this._channel+" - no version message received previously");return!1}if(this._versionReceived&&!this._verackReceived&&e.type!==Je.Type.VERACK){a.w(NetworkAgent,"Discarding '"+(Yt.Event[e.type]||e.type)+"' message from "+this._channel+" - no verack message received previously");return!1}return!0}},{key:"channel",get:function get(){return this._channel}},{key:"peer",get:function get(){return this._peer}}]);return NetworkAgent}(i);Zt.HANDSHAKE_TIMEOUT=4e3;Zt.PING_TIMEOUT=1e4;Zt.CONNECTIVITY_CHECK_INTERVAL=6e4;Zt.ANNOUNCE_ADDR_INTERVAL=3e5;Zt.RELAY_THROTTLE=12e4;Zt.VERSION_ATTEMPTS_MAX=10;Zt.VERSION_RETRY_DELAY=500;r.register(Zt);var Jt=function(){function PeerConnectionStatistics(){(0,_classCallCheck3["default"])(this,PeerConnectionStatistics);this._latencies=[];this._messages=new y}(0,_createClass3["default"])(PeerConnectionStatistics,[{key:"reset",value:function reset(){this._latencies=[];this._messages=new y}},{key:"addLatency",value:function addLatency(e){this._latencies.push(e)}},{key:"addMessage",value:function addMessage(e){this._messages.put(e.type,this._messages.contains(e.type)?this._messages.get(e.type)+1:1)}},{key:"getMessageCount",value:function getMessageCount(e){return this._messages.contains(e)?this._messages.get(e):0}},{key:"latencyMedian",get:function get(){var e=this._latencies.length;if(0===e)return 0;this._latencies.sort(function(e,t){return e-t});return e%2==0?Math.round((this._latencies[e/2-1]+this._latencies[e/2])/2):this._latencies[(e-1)/2]}}]);return PeerConnectionStatistics}();r.register(Jt);var Qt=function(){(0,_createClass3["default"])(PeerConnection,null,[{key:"getOutbound",value:function getOutbound(e){var t=new PeerConnection;t._peerAddress=e;t._state=er.CONNECTING;return t}},{key:"getInbound",value:function getInbound(e){var t=new PeerConnection;t._networkConnection=e;return t}}]);function PeerConnection(){(0,_classCallCheck3["default"])(this,PeerConnection);this._id=PeerConnection._instanceCount++;this._peerAddress=null;this._networkConnection=null;this._peerChannel=null;this._networkAgent=null;this._peer=null;this._state=er.NEW;this._closingType=null;this._score=null;this._establishedSince=null;this._statistics=new Jt}(0,_createClass3["default"])(PeerConnection,[{key:"state",get:function get(){return this._state}},{key:"peerAddress",get:function get(){return this._peerAddress},set:function set(e){this._peerAddress=e}},{key:"networkConnection",get:function get(){return this._networkConnection},set:function set(e){this._networkConnection=e;this._state=er.CONNECTED}},{key:"peerChannel",get:function get(){return this._peerChannel},set:function set(e){this._peerChannel=e}},{key:"networkAgent",get:function get(){return this._networkAgent},set:function set(e){this._networkAgent=e;this._state=er.NEGOTIATING}},{key:"peer",get:function get(){return this._peer},set:function set(e){var t=this;this._peer=e;this._state=er.ESTABLISHED;this._establishedSince=Date.now();this._networkAgent.on("ping-pong",function(e){return t._statistics.addLatency(e)});this._peerChannel.on("message-log",function(e){return t._statistics.addMessage(e)})}},{key:"score",get:function get(){return this._score},set:function set(e){this._score=e}},{key:"establishedSince",get:function get(){return this._establishedSince}},{key:"ageEstablished",get:function get(){return Date.now()-this.establishedSince}},{key:"statistics",get:function get(){return this._statistics}}]);return PeerConnection}();Qt._instanceCount=0;r.register(Qt);var er=function PeerConnectionState(){(0,_classCallCheck3["default"])(this,PeerConnectionState)};er.NEW=1;er.CONNECTING=2;er.CONNECTED=3;er.NEGOTIATING=4;er.ESTABLISHED=5;r.register(er);var tr=function(){function SignalProcessor(e,t,r){(0,_classCallCheck3["default"])(this,SignalProcessor);this._addresses=e;this._networkConfig=t;this._rtcConnector=r;this._forwards=new rr}(0,_createClass3["default"])(SignalProcessor,[{key:"onSignal",value:function onSignal(e,t){if(t.ttl>lr.SIGNAL_TTL_INITIAL)e.close($t.INVALID_SIGNAL_TTL,"invalid signal ttl");else if(!t.hasPayload()||t.verifySignature()){var r=this._networkConfig.peerAddress.peerId;if(t.senderId.equals(r))a.w(SignalProcessor,"Received signal from myself to "+t.recipientId+" from "+e.peerAddress+" (myId: "+r+")");else{if(t.isUnroutable()&&this._forwards.signalForwarded(t.recipientId,t.senderId,t.nonce)){var n=this._addresses.getByPeerId(t.senderId);this._addresses.unroutable(e,n)}if(t.recipientId.equals(r)){if(this._rtcConnector.isValidSignal(t)&&(t.isUnroutable()||t.isTtlExceeded())){var i=this._addresses.getByPeerId(t.senderId);this._addresses.unroutable(e,i)}this._rtcConnector.onSignal(e,t)}else if(t.ttl<=0){a.d(SignalProcessor,"Discarding signal from "+t.senderId+" to "+t.recipientId+" - TTL reached");0===t.flags&&e.signal(t.recipientId,t.senderId,t.nonce,lr.SIGNAL_TTL_INITIAL,dt.Flag.TTL_EXCEEDED)}else{var s=this._addresses.getChannelByPeerId(t.recipientId);if(s)if(s.peerAddress.equals(e.peerAddress)){a.w(SignalProcessor,"Discarding signal from "+t.senderId+" to "+t.recipientId+" - shortest route via sending peer");0===t.flags&&e.signal(t.recipientId,t.senderId,t.nonce,lr.SIGNAL_TTL_INITIAL,dt.Flag.UNROUTABLE)}else{s.signal(t.senderId,t.recipientId,t.nonce,t.ttl-1,t.flags,t.payload,t.senderPubKey,t.signature);0===t.flags&&this._forwards.add(t.senderId,t.recipientId,t.nonce)}else{a.d(SignalProcessor,"Failed to forward signal from "+t.senderId+" to "+t.recipientId+" - no route found");0===t.flags&&e.signal(t.recipientId,t.senderId,t.nonce,lr.SIGNAL_TTL_INITIAL,dt.Flag.UNROUTABLE)}}}}else e.close($t.INVALID_SIGNATURE,"invalid signature")}}]);return SignalProcessor}();r.register(tr);var rr=function(){function SignalStore(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1e3;(0,_classCallCheck3["default"])(this,SignalStore);this._maxSize=e;this._queue=new m;this._store=new y}(0,_createClass3["default"])(SignalStore,[{key:"add",value:function add(e,t,r){if(this.contains(e,t,r)){var n=new nr(e,t,r);this._store.put(n,Date.now());this._queue.remove(n);this._queue.enqueue(n)}else{if(this.length>=this._maxSize){var a=this._queue.dequeue();this._store.remove(a)}var i=new nr(e,t,r);this._queue.enqueue(i);this._store.put(i,Date.now())}}},{key:"contains",value:function contains(e,t,r){var n=new nr(e,t,r);return this._store.contains(n)}},{key:"signalForwarded",value:function signalForwarded(e,t,r){var n=new nr(e,t,r),a=this._store.get(n);if(!a)return!1;var i=a+nr.SIGNAL_MAX_AGE>Date.now();if(!i){var s=this._queue.dequeueUntil(n),o=!0,u=!1,c=undefined;try{for(var l,h=(0,_getIterator3["default"])(s);!(o=(l=h.next()).done);o=!0){var f=l.value;this._store.remove(f)}}catch(_){u=!0;c=_}finally{try{!o&&h["return"]&&h["return"]()}finally{if(u)throw c}}}return i}},{key:"length",get:function get(){return this._queue.length}}]);return SignalStore}();rr.SIGNAL_MAX_AGE=10;r.register(rr);var nr=function(){function ForwardedSignal(e,t,r){(0,_classCallCheck3["default"])(this,ForwardedSignal);this._senderId=e;this._recipientId=t;this._nonce=r}(0,_createClass3["default"])(ForwardedSignal,[{key:"equals",value:function equals(e){return e instanceof ForwardedSignal&&this._senderId.equals(e._senderId)&&this._recipientId.equals(e._recipientId)&&this._nonce===e._nonce}},{key:"hashCode",value:function hashCode(){return this.toString()}},{key:"toString",value:function toString(){return"ForwardedSignal{senderId="+this._senderId+", recipientId="+this._recipientId+", nonce="+this._nonce+"}"}}]);return ForwardedSignal}();r.register(nr);var ar=function(e){(0,_inherits3["default"])(ConnectionPool,e);function ConnectionPool(e,t,r,n){(0,_classCallCheck3["default"])(this,ConnectionPool);var a=(0,_possibleConstructorReturn3["default"])(this,(ConnectionPool.__proto__||(0,_getPrototypeOf2["default"])(ConnectionPool)).call(this));a._addresses=e;a._networkConfig=t;a._blockchain=r;a._time=n;a._connectionsByPeerAddress=new y;a._connectionsByNetAddress=new y;a._bytesSent=0;a._bytesReceived=0;a._wsConnector=new zt(a._networkConfig);a._wsConnector.on("connection",function(e){return a._onConnection(e)});a._wsConnector.on("error",function(e,t){return a._onConnectError(e,t)});a._rtcConnector=new Pt(a._networkConfig);a._rtcConnector.on("connection",function(e){return a._onConnection(e)});a._rtcConnector.on("error",function(e,t){return a._onConnectError(e,t)});a._peerCountWs=0;a._peerCountRtc=0;a._peerCountDumb=0;a._peerCountFull=0;a._peerCountLight=0;a._peerCountNano=0;a._connectingCount=0;a._inboundCount=0;a._signalProcessor=new tr(e,t,a._rtcConnector);a._allowInboundExchange=!1;return a}(0,_createClass3["default"])(ConnectionPool,[{key:"values",value:function values(){return(0,_from2["default"])(this._connectionsByPeerAddress.values())}},{key:"getConnectionByPeerAddress",value:function getConnectionByPeerAddress(e){return this._connectionsByPeerAddress.get(e)}},{key:"getConnectionsByNetAddress",value:function getConnectionsByNetAddress(e){return this._connectionsByNetAddress.get(e)||[]}},{key:"isEstablished",value:function isEstablished(e){var t=this.getConnectionByPeerAddress(e);return t&&t.state===er.ESTABLISHED}},{key:"_add",value:function _add(e){e.peerAddress&&this._connectionsByPeerAddress.put(e.peerAddress,e)}},{key:"_remove",value:function _remove(e){e.peerAddress&&this._connectionsByPeerAddress.remove(e.peerAddress);e.networkConnection&&e.networkConnection.netAddress&&this._removeNetAddress(e,e.networkConnection.netAddress)}},{key:"_addNetAddress",value:function _addNetAddress(e,t){this._connectionsByNetAddress.contains(t)?this._connectionsByNetAddress.get(t).push(e):this._connectionsByNetAddress.put(t,[e])}},{key:"_removeNetAddress",value:function _removeNetAddress(e,t){if(this._connectionsByNetAddress.contains(t)){var r=this._connectionsByNetAddress.get(t),n=r.indexOf(e);n>=0&&r.splice(n,1);0===r.length&&this._connectionsByNetAddress.remove(t)}}},{key:"_hasPriority",value:function _hasPriority(e){return 0===this.peerCountFull&&h.isFullNode(e.services)}},{key:"_checkOutboundConnectionRequest",value:function _checkOutboundConnectionRequest(e){if(null===e)return!1;if(e.protocol!==Ze.WS&&e.protocol!==Ze.RTC){a.e(lr,"Cannot connect to {$this.peerAddress} - unsupported protocol");return!1}if(this._addresses.isBanned(e)){a.e(lr,"Connecting to banned address "+e);return!1}if(this.getConnectionByPeerAddress(e)){a.e(lr,"Duplicate connection to "+e);return!1}if(e.netAddress&&!e.netAddress.isPseudo()&&this.getConnectionsByNetAddress(e.netAddress).length>lr.PEER_COUNT_PER_IP_MAX){a.e(ConnectionPool,"connection limit per ip ("+lr.PEER_COUNT_PER_IP_MAX+") reached");return!1}if(this.peerCount>=lr.PEER_COUNT_MAX&&!this._hasPriority(e)){a.e(ConnectionPool,"max peer count reached ("+lr.PEER_COUNT_MAX+")");return!1}return!0}},{key:"_checkConnection",value:function _checkConnection(e){if(e.netAddress&&!e.netAddress.isPseudo()&&this.getConnectionsByNetAddress(e.netAddress).length>=lr.PEER_COUNT_PER_IP_MAX){e.close($t.CONNECTION_LIMIT_PER_IP,"connection limit per ip ("+lr.PEER_COUNT_PER_IP_MAX+") reached");return!1}if(!(!(this.peerCount>=lr.PEER_COUNT_MAX)||e.outbound&&this._hasPriority(e.peerAddress)||e.inbound&&this._allowInboundExchange)){e.close($t.MAX_PEER_COUNT_REACHED,"max peer count reached ("+lr.PEER_COUNT_MAX+")");return!1}return!0}},{key:"_checkHandshake",value:function _checkHandshake(e,t){if(this.isEstablished(t.peerAddress)){e.peerChannel.close($t.DUPLICATE_CONNECTION,"Duplicate connection to "+t.peerAddress+" (post-handshake)");return!1}if(this._addresses.isBanned(t.peerAddress)){e.peerChannel.close($t.PEER_IS_BANNED,"Connection with banned address "+t.peerAddress+" (post-handshake)");return!1}if(t.netAddress&&!t.netAddress.isPseudo()&&this.getConnectionsByNetAddress(t.netAddress).length>lr.PEER_COUNT_PER_IP_MAX){e.peerChannel.close($t.CONNECTION_LIMIT_PER_IP,"connection limit per ip ("+lr.PEER_COUNT_PER_IP_MAX+") reached (post-handshake)");return!1}return!0}},{key:"connectOutbound",value:function connectOutbound(e){if(!this._checkOutboundConnectionRequest(e))return!1;var t=Qt.getOutbound(e);this._add(t);var r=!1;if(e.protocol===Ze.WS)r=this._wsConnector.connect(e);else{var n=this._addresses.getChannelByPeerId(e.peerId);r=this._rtcConnector.connect(e,n)}if(!r){this._remove(t);a.d(lr,"Outbound attempt not connecting: "+e);return!1}this._connectingCount++;return!0}},{key:"_onConnection",value:function _onConnection(e){var t=this,r=void 0;if(e.outbound){this._connectingCount--;r=this.getConnectionByPeerAddress(e.peerAddress);C.that(r,"Connecting to outbound peer address not stored "+e.peerAddress);C.that(r.state===er.CONNECTING,"PeerConnection state not CONNECTING "+e.peerAddress)}else{r=Qt.getInbound(e);this._inboundCount++}r.networkConnection=e;e.on("close",function(e,n){return t._onClose(r,e,n)});if(this._checkConnection(e)){e.netAddress&&!e.netAddress.isPseudo()&&this._addNetAddress(r,e.netAddress);var n=e.inbound?"inbound":"outbound";a.d(ConnectionPool,"Connection established ("+n+") #"+e.id+" "+(e.netAddress||e.peerAddress||"<pending>"));this.fire("connection",e);var i=new Yt(e);i.on("signal",function(e){return t._signalProcessor.onSignal(i,e)});r.peerChannel=i;var s=new Zt(this._blockchain,this._addresses,this._networkConfig,i);s.on("version",function(e){return t._checkHandshake(r,e)});s.on("handshake",function(e){return t._onHandshake(r,e)});r.networkAgent=s;s.handshake()}}},{key:"_onHandshake",value:function _onHandshake(e,t){this.peerCount>=lr.PEER_COUNT_MAX&&this.fire("recycling-request");if(e.networkConnection.inbound){e.peerAddress=t.peerAddress;this._add(e);this._inboundCount--}e.peer=t;t.netAddress&&!t.netAddress.isPseudo()&&this.getConnectionsByNetAddress(t.netAddress).indexOf(e)<0&&this._addNetAddress(e,t.netAddress);this._updateConnectedPeerCount(t.peerAddress,1);this._addresses.established(t.channel,t.peerAddress);this.fire("peer-joined",t);this.fire("peers-changed");a.d(ConnectionPool,function(){return"[PEER-JOINED] "+t.peerAddress+" "+t.netAddress+" (version="+t.version+", services="+t.peerAddress.services+", headHash="+t.headHash.toBase64()+")"})}},{key:"_onClose",value:function _onClose(e,t,r){this._bytesSent+=e.networkConnection.bytesSent;this._bytesReceived+=e.networkConnection.bytesReceived;e.peerAddress&&this._addresses.close(e.peerChannel,e.peerAddress,t);this._remove(e);if(e.state===er.ESTABLISHED){this._updateConnectedPeerCount(e.peerAddress,-1);this.fire("peer-left",e.peer);this.fire("peers-changed");var n=((e.networkConnection.bytesSent+e.networkConnection.bytesReceived)/1e3).toFixed(2);a.d(ConnectionPool,"[PEER-LEFT] "+e.peerAddress+" "+e.peer.netAddress+" (version="+e.peer.version+", transferred="+n+" kB, closingType="+t+" "+r+")")}else if(e.networkConnection.inbound){this._inboundCount--;a.w(ConnectionPool,"Inbound connection closed pre-handshake: "+r+" ("+t+")")}else{a.w(ConnectionPool,"Connection to "+e.peerAddress+" closed pre-handshake: "+r+" ("+t+")");this.fire("connect-error",e.peerAddress,r+" ("+t+")")}this.fire("close",e,t,r)}},{key:"_onConnectError",value:function _onConnectError(e,t){a.w(ConnectionPool,"Connection to "+e+" failed"+("string"==typeof t?" - "+t:""));var r=this.getConnectionByPeerAddress(e);C.that(r&&r.state===er.CONNECTING);this._remove(r);this._connectingCount--;this._addresses.close(null,e,$t.CONNECTION_FAILED);this.fire("connect-error",e,t)}},{key:"_updateConnectedPeerCount",value:function _updateConnectedPeerCount(e,t){switch(e.protocol){case Ze.WS:this._peerCountWs+=t;break;case Ze.RTC:this._peerCountRtc+=t;break;case Ze.DUMB:this._peerCountDumb+=t;break;default:a.w(qt,"Unknown protocol "+e.protocol)}h.isFullNode(e.services)?this._peerCountFull+=t:h.isLightNode(e.services)?this._peerCountLight+=t:this._peerCountNano+=t}},{key:"disconnect",value:function disconnect(e){var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this.values());!(t=(a=i.next()).done);t=!0){var s=a.value;s.peerChannel&&s.peerChannel.close($t.MANUAL_NETWORK_DISCONNECT,e||"manual network disconnect")}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}}},{key:"disconnectWebSocket",value:function disconnectWebSocket(){var e=!0,t=!1,r=undefined;try{for(var n,a=(0,_getIterator3["default"])(this.values());!(e=(n=a.next()).done);e=!0){var i=n.value;i.peerChannel&&i.peerAddress&&i.peerAddress.protocol===Ze.WS&&i.channel.close($t.MANUAL_WEBSOCKET_DISCONNECT,"manual websocket disconnect")}}catch(s){t=!0;r=s}finally{try{!e&&a["return"]&&a["return"]()}finally{if(t)throw r}}}},{key:"peerCountWs",get:function get(){return this._peerCountWs}},{key:"peerCountRtc",get:function get(){return this._peerCountRtc}},{key:"peerCountDumb",get:function get(){return this._peerCountDumb}},{key:"peerCount",get:function get(){return this._peerCountWs+this._peerCountRtc+this._peerCountDumb}},{key:"peerCountFull",get:function get(){return this._peerCountFull}},{key:"peerCountLight",get:function get(){return this._peerCountLight}},{key:"peerCountNano",get:function get(){return this._peerCountNano}},{key:"connectingCount",get:function get(){return this._connectingCount}},{key:"count",get:function get(){return this._connectionsByPeerAddress.length+this._inboundCount}},{key:"bytesSent",get:function get(){return this._bytesSent+this.values().reduce(function(e,t){return e+(t.networkConnection?t.networkConnection.bytesSent:0)},0)}},{key:"bytesReceived",get:function get(){return this._bytesReceived+this.values().reduce(function(e,t){return e+(t.networkConnection?t.networkConnection.bytesReceived:0)},0)}},{key:"allowInboundExchange",set:function set(e){this._allowInboundExchange=e}}]);return ConnectionPool}(i);r.register(ar);var ir=function(e){(0,_inherits3["default"])(PeerScorer,e);function PeerScorer(e,t,r){(0,_classCallCheck3["default"])(this,PeerScorer);var n=(0,_possibleConstructorReturn3["default"])(this,(PeerScorer.__proto__||(0,_getPrototypeOf2["default"])(PeerScorer)).call(this));n._networkConfig=e;n._addresses=t;n._connections=r;n._connectionScores=null;return n}(0,_createClass3["default"])(PeerScorer,[{key:"pickAddress",value:function pickAddress(){for(var e=this._addresses.values(),t=e.length,r=Math.floor(Math.random()*t),n=Math.min(t,1e3),a=new y,i=0;i<t;i++){var s=e[(r+i)%t],o=this._scoreAddress(s);if(o>=0){a.put(o,s);if(a.length>=n)break}}if(0===a.length)return null;var u=a.keys().sort(function(e,t){return t-e});return a.get(u[0]).peerAddress}},{key:"_scoreAddress",value:function _scoreAddress(e){var t=e.peerAddress;if(!this._networkConfig.canConnect(t.protocol))return-1;if(t.exceedsAge())return-1;if(this._connections.getConnectionByPeerAddress(t))return-1;if(t.exceedsAge())return-1;var r=(this._scoreProtocol(t)+this._scoreServices(t))*(t.timestamp/1e3+1);switch(e.state){case jt.BANNED:return-1;case jt.NEW:case jt.TRIED:return r;case jt.FAILED:return(1-(e.failedAttempts+1)/e.maxFailedAttempts)*r;default:return-1}}},{key:"_scoreProtocol",value:function _scoreProtocol(e){var t=1;this._connections.peerCountWs<2?t*=e.protocol===Ze.WS?3:1:t*=e.protocol===Ze.RTC?3:1;e.protocol===Ze.RTC&&(t*=1+(qt.MAX_DISTANCE-e.distance)/2);return t}},{key:"_scoreServices",value:function _scoreServices(e){return this._connections.peerCount>2&&0===this._connections.peerCountFull&&h.isFullNode(e.services)?10:0}},{key:"scoreConnections",value:function scoreConnections(){var e=[],t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._connections.values());!(t=(a=i.next()).done);t=!0){var s=a.value;if(s.state===er.ESTABLISHED){if(s.ageEstablished>PeerScorer._getMinAge(s.peerAddress)){s.score=this._scoreConnection(s);e.push(s)}s.statistics.reset()}}}catch(o){r=!0;n=o}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}this._connectionScores=e.sort(function(e,t){return t.score-e.score})}},{key:"recycleConnections",value:function recycleConnections(e,t,r){if(this._connectionScores)for(;e>0&&this._connectionScores.length>0;){var n=this._connectionScores.pop();if(n.state===er.ESTABLISHED){n.peerChannel.close(t,""+r);e--}}}},{key:"_scoreConnection",value:function _scoreConnection(e){var t=this._scoreConnectionAge(e),r=e.networkConnection.inbound?0:1,n=0;this._connections.peerCountWs/this._connections.peerCount<PeerScorer.BEST_PROTOCOL_WS_DISTRIBUTION&&e.peerAddress.protocol===Ze.WS&&(n=1);var a=e.statistics.latencyMedian,i=0;a>0&&a<Zt.PING_TIMEOUT&&(i=1-a/Zt.PING_TIMEOUT);return.4*t+.2*r+.2*n+.2*i}},{key:"_scoreConnectionAge",value:function _scoreConnectionAge(e){var t=function score(e,t,r){return Math.max(Math.min(1-(e-t)/r,1),0)},r=e.ageEstablished,n=e.peerAddress.services;return h.isFullNode(n)?r/(2*PeerScorer.BEST_AGE_FULL)+.5:h.isLightNode(n)?t(r,PeerScorer.BEST_AGE_LIGHT,PeerScorer.MAX_AGE_LIGHT):t(r,PeerScorer.BEST_AGE_NANO,PeerScorer.MAX_AGE_NANO)}},{key:"connectionScores",get:function get(){return this._connectionScores}},{key:"lowestConnectionScore",get:function get(){return this._connectionScores&&this._connectionScores.length>0?this._connectionScores[this._connectionScores.length-1].score:null}}],[{key:"_getMinAge",value:function _getMinAge(e){return h.isFullNode(e.services)?PeerScorer.MIN_AGE_FULL:h.isLightNode(e.services)?PeerScorer.MIN_AGE_LIGHT:PeerScorer.MIN_AGE_NANO}}]);return PeerScorer}(i);ir.MIN_AGE_FULL=3e5;ir.BEST_AGE_FULL=864e5;ir.MIN_AGE_LIGHT=12e4;ir.BEST_AGE_LIGHT=9e5;ir.MAX_AGE_LIGHT=216e5;ir.MIN_AGE_NANO=6e4;ir.BEST_AGE_NANO=3e5;ir.MAX_AGE_NANO=18e5;ir.BEST_PROTOCOL_WS_DISTRIBUTION=.15;r.register(ir);var sr=function(){(0,_createClass3["default"])(NetworkConfig,null,[{key:"getDefault",value:function getDefault(){return M.supportsWebRTC()?new ur:new cr}}]);function NetworkConfig(e){(0,_classCallCheck3["default"])(this,NetworkConfig);this._protocolMask=e;this._keyPair=null;this._peerId=null;this._services=null}(0,_createClass3["default"])(NetworkConfig,[{key:"initPersistent",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee287(){var e;return _regenerator2["default"].wrap(function _callee287$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return fr.getPersistent();case 2:e=t.sent;t.next=5;return this._init(e);case 5:case"end":return t.stop()}},_callee287,this)}));return function initPersistent(){return e.apply(this,arguments)}}()},{key:"initVolatile",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee288(){var e;return _regenerator2["default"].wrap(function _callee288$(t){for(;;)switch(t.prev=t.next){case 0:e=fr.createVolatile();t.next=3;return this._init(e);case 3:case"end":return t.stop()}},_callee288,this)}));return function initVolatile(){return e.apply(this,arguments)}}()},{key:"_init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee289(e){var t;return _regenerator2["default"].wrap(function _callee289$(r){for(;;)switch(r.prev=r.next){case 0:if(!this._keyPair){r.next=2;break}return r.abrupt("return");case 2:r.next=4;return e.get("keys");case 4:if(t=r.sent){r.next=9;break}t=G.generate();r.next=9;return e.put("keys",t);case 9:this._keyPair=t;this._peerId=t.publicKey.toPeerId();case 11:case"end":return r.stop()}},_callee289,this)}));return function _init(t){return e.apply(this,arguments)}}()},{key:"canConnect",value:function canConnect(e){return 0!=(e&this._protocolMask)}},{key:"protocolMask",get:function get(){return this._protocolMask}},{key:"keyPair",get:function get(){return this._keyPair}},{key:"publicKey",get:function get(){return this._keyPair.publicKey}},{key:"peerId",get:function get(){return this._peerId}},{key:"services",get:function get(){return this._services},set:function set(e){this._services=e}},{key:"peerAddress",get:function get(){throw new Error("Not implemented")}}]);return NetworkConfig}();r.register(sr);var or=function(e){(0,_inherits3["default"])(WsNetworkConfig,e);function WsNetworkConfig(e,t,r,n){(0,_classCallCheck3["default"])(this,WsNetworkConfig);var a=(0,_possibleConstructorReturn3["default"])(this,(WsNetworkConfig.__proto__||(0,_getPrototypeOf2["default"])(WsNetworkConfig)).call(this,Ze.WS));a._host=e;a._port=t;a._key=r;a._cert=n;a._sslConfig={key:a._key,cert:a._cert};return a}(0,_createClass3["default"])(WsNetworkConfig,[{key:"sslConfig",get:function get(){return this._sslConfig}},{key:"peerAddress",get:function get(){if(!this._services||!this._keyPair)throw"PeerAddress is not configured.";var e=new Gt(this._services.provided,Date.now(),Ut.UNSPECIFIED,this.publicKey,0,this._host,this._port);if(!e.globallyReachable())throw"PeerAddress not globally reachable.";e.signature=W.create(this._keyPair.privateKey,this.publicKey,e.serializeContent());return e}}]);return WsNetworkConfig}(sr);r.register(or);var ur=function(e){(0,_inherits3["default"])(RtcNetworkConfig,e);function RtcNetworkConfig(){(0,_classCallCheck3["default"])(this,RtcNetworkConfig);var e=(0,_possibleConstructorReturn3["default"])(this,(RtcNetworkConfig.__proto__||(0,_getPrototypeOf2["default"])(RtcNetworkConfig)).call(this,Ze.WS|Ze.RTC));e._rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.nimiq-network.com:19302"}]};return e}(0,_createClass3["default"])(RtcNetworkConfig,[{key:"rtcConfig",get:function get(){return this._rtcConfig}},{key:"peerAddress",get:function get(){if(!this._services||!this._keyPair)throw"PeerAddress is not configured.";var e=new Kt(this._services.provided,Date.now(),Ut.UNSPECIFIED,this.publicKey,0);e.signature=W.create(this._keyPair.privateKey,this.publicKey,e.serializeContent());return e}}]);return RtcNetworkConfig}(sr);r.register(ur);var cr=function(e){(0,_inherits3["default"])(DumbNetworkConfig,e);function DumbNetworkConfig(){(0,_classCallCheck3["default"])(this,DumbNetworkConfig);return(0,_possibleConstructorReturn3["default"])(this,(DumbNetworkConfig.__proto__||(0,_getPrototypeOf2["default"])(DumbNetworkConfig)).call(this,Ze.WS))}(0,_createClass3["default"])(DumbNetworkConfig,[{key:"peerAddress",get:function get(){if(!this._services||!this._keyPair)throw"PeerAddress is not configured.";var e=new Ft(this._services.provided,Date.now(),Ut.UNSPECIFIED,this.publicKey,0);e.signature=W.create(this._keyPair.privateKey,this.publicKey,e.serializeContent());return e}}]);return DumbNetworkConfig}(sr);r.register(cr);var lr=function(e){(0,_inherits3["default"])(Network,e);function Network(e,t,r){(0,_classCallCheck3["default"])(this,Network);var n=(0,_possibleConstructorReturn3["default"])(this,(Network.__proto__||(0,_getPrototypeOf2["default"])(Network)).call(this));n._blockchain=e;n._networkConfig=t;n._time=r;n._autoConnect=!1;n._backoff=Network.CONNECT_BACKOFF_INITIAL;n._backedOff=!1;n._addresses=new qt(n._networkConfig);n._addresses.on("added",function(e){n._relayAddresses(e);n._checkPeerCount()});n._connections=new ar(n._addresses,t,e,r);n._connections.on("peer-joined",function(e){return n._onPeerJoined(e)});n._connections.on("peer-left",function(e){return n._onPeerLeft(e)});n._connections.on("peers-changed",function(){return n._onPeersChanged()});n._connections.on("recycling-request",function(){return n._onRecyclingRequest()});n._connections.on("connect-error",function(){return n._checkPeerCount()});n._scorer=new ir(n._networkConfig,n._addresses,n._connections);n._houseKeepingIntervalId=null;return n}(0,_createClass3["default"])(Network,[{key:"connect",value:function connect(){var e=this;this._autoConnect=!0;this._houseKeepingIntervalId=setInterval(function(){return e._housekeeping()},Network.HOUSEKEEPING_INTERVAL);this._checkPeerCount()}},{key:"disconnect",value:function disconnect(e){this._autoConnect=!1;clearInterval(this._houseKeepingIntervalId);this._connections.disconnect(e)}},{key:"disconnectWebSocket",value:function disconnectWebSocket(){this._autoConnect=!1;this._connections.disconnectWebSocket()}},{key:"_onPeerJoined",value:function _onPeerJoined(e){this._updateTimeOffset();this._relayAddresses([e.peerAddress]);this.fire("peer-joined",e)}},{key:"_onPeerLeft",value:function _onPeerLeft(e){this._updateTimeOffset();this.fire("peer-left",e)}},{key:"_onPeersChanged",value:function _onPeersChanged(){this._checkPeerCount();this.fire("peers-changed")}},{key:"_onRecyclingRequest",value:function _onRecyclingRequest(){this._scorer.recycleConnections(1,$t.PEER_CONNECTION_RECYCLED_INBOUND_EXCHANGE,"Peer connection recycled inbound exchange");this._connections.allowInboundExchange=null!==this._scorer.lowestConnectionScore&&this._scorer.lowestConnectionScore<Network.SCORE_INBOUND_EXCHANGE}},{key:"_relayAddresses",value:function _relayAddresses(e){if(!(e.length>10))for(var t=this._connections.values(),r=0;r<Network.PEER_COUNT_RELAY;++r){var n=g.randomElement(t);n&&n.state===er.ESTABLISHED&&n.networkAgent&&n.networkAgent.relayAddresses(e)}}},{key:"_checkPeerCount",value:function _checkPeerCount(){var e=this;if(this._autoConnect&&(this._connections.count<Network.PEER_COUNT_DESIRED||0===this._connections.peerCountFull)&&this._connections.connectingCount<Network.CONNECTING_COUNT_MAX){var t=this._scorer.pickAddress();if(!t){if(!this._backedOff){this._backedOff=!0;var r=this._backoff;this._backoff=Math.min(Network.CONNECT_BACKOFF_MAX,2*r);setTimeout(function(){e._backedOff=!1;e._checkPeerCount()},r);0===this._connections.count&&this.fire("disconnected")}return}if(!this._connections.connectOutbound(t)){this._addresses.close(null,t,$t.CONNECTION_FAILED);setTimeout(function(){return e._checkPeerCount()},0)}}this._backoff=Network.CONNECT_BACKOFF_INITIAL}},{key:"_updateTimeOffset",value:function _updateTimeOffset(){var e=[0];this._connections.values().forEach(function(t){t.state===er.ESTABLISHED&&e.push(t.networkAgent.peer.timeOffset)});var t=e.length;e.sort(function(e,t){return e-t});var r=void 0;r=t%2==0?Math.round((e[t/2-1]+e[t/2])/2):e[(t-1)/2];this._time.offset=Math.max(Math.min(r,Network.TIME_OFFSET_MAX),-Network.TIME_OFFSET_MAX)}},{key:"_housekeeping",value:function _housekeeping(){this._scorer.scoreConnections();if(this.peerCount>Network.PEER_COUNT_RECYCLING_ACTIVE){var e=.19*(this.peerCount-Network.PEER_COUNT_RECYCLING_ACTIVE)/(Network.PEER_COUNT_MAX-Network.PEER_COUNT_RECYCLING_ACTIVE)+.01,t=Math.ceil(this.peerCount*e);this._scorer.recycleConnections(t,$t.PEER_CONNECTION_RECYCLED,"Peer connection recycled")}this._connections.allowInboundExchange=null!==this._scorer.lowestConnectionScore&&this._scorer.lowestConnectionScore<Network.SCORE_INBOUND_EXCHANGE}},{key:"time",get:function get(){return this._time}},{key:"peerCount",get:function get(){return this._connections.peerCount}},{key:"peerCountWebSocket",get:function get(){return this._connections.peerCountWs}},{key:"peerCountWebRtc",get:function get(){return this._connections.peerCountRtc}},{key:"peerCountDumb",get:function get(){return this._connections.peerCountDumb}},{key:"peerCountConnecting",get:function get(){return this._connections.connectingCount}},{key:"knownAddressesCount",get:function get(){return this._addresses.knownAddressesCount}},{key:"bytesSent",get:function get(){return this._connections.bytesSent}},{key:"bytesReceived",get:function get(){return this._connections.bytesReceived}}]);return Network}(i);lr.PEER_COUNT_MAX=M.isBrowser()?15:5e4;lr.PEER_COUNT_PER_IP_MAX=M.isBrowser()?2:25;lr.PEER_COUNT_RECYCLING_ACTIVE=M.isBrowser()?5:1e3;lr.PEER_COUNT_DESIRED=6;lr.PEER_COUNT_RELAY=4;lr.CONNECTING_COUNT_MAX=2;lr.SIGNAL_TTL_INITIAL=3;lr.ADDRESS_UPDATE_DELAY=1e3;lr.CONNECT_BACKOFF_INITIAL=1e3;lr.CONNECT_BACKOFF_MAX=3e5;lr.TIME_OFFSET_MAX=9e5;lr.HOUSEKEEPING_INTERVAL=3e5;lr.SCORE_INBOUND_EXCHANGE=.5;r.register(lr);var hr=function(){function NetUtils(){(0,_classCallCheck3["default"])(this,NetUtils)}(0,_createClass3["default"])(NetUtils,null,[{key:"isPrivateIP",value:function isPrivateIP(e){if(NetUtils.isLocalIP(e))return!0;if(NetUtils.isIPv4Address(e)){var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(NetUtils.IPv4_PRIVATE_NETWORK);!(t=(a=i.next()).done);t=!0){var s=a.value;if(NetUtils.isIPv4inSubnet(e,s))return!0}}catch(u){r=!0;n=u}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return!1}if(NetUtils.isIPv6Address(e)){var o=e.toLowerCase().split(":");return NetUtils.isIPv4Address(o[o.length-1])?NetUtils.isPrivateIP(o[o.length-1]):64512==(-512&parseInt(o[0],16))||65152==(-64&parseInt(o[0],16))}throw"Malformed IP address "+e}},{key:"isLocalIP",value:function isLocalIP(e){var t=NetUtils._normalizeIP(e);return NetUtils.isIPv4Address(e)?"127.0.0.1"===t:"::1"===t}},{key:"isIPv4inSubnet",value:function isIPv4inSubnet(e,t){var r=t.split("/"),n=(0,_slicedToArray3["default"])(r,2),a=n[0],i=n[1];i=-1<<32-parseInt(i);return(NetUtils._IPv4toLong(e)&i)===NetUtils._IPv4toLong(a)}},{key:"isIPv4Address",value:function isIPv4Address(e){var t=e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return!!t&&parseInt(t[1])<=255&&parseInt(t[2])<=255&&parseInt(t[3])<=255&&parseInt(t[4])<=255}},{key:"isIPv6Address",value:function isIPv6Address(e){var t=e.toLowerCase().split(":");if(t.length>8||t.length<3)return!1;for(var r=NetUtils.isIPv4Address(t[t.length-1]),n=!1,a=0;a<t.length;++a){if(!(/^[a-f0-9]{0,4}$/.test(t[a])||a===t.length-1&&r&&t.length<8))return!1;if(0===t[a].length&&a>0&&a<t.length-1){if(n)return!1;n=!0}}if(r)for(var i=0;i<t.length-2;++i)if(!/^0{0,4}$/.test(t[i]))return!1;return 0===t[0].length?0===t[1].length:0===t[t.length-1].length?0===t[t.length-2].length:r&&t.length<7?n:!(t.length<8)||n}},{key:"sanitizeIP",value:function sanitizeIP(e){var t=NetUtils._normalizeIP(e);if(NetUtils.IP_BLACKLIST.indexOf(t)>=0)throw"Malformed IP address "+e;return t}},{key:"hostGloballyReachable",value:function hostGloballyReachable(e){return!NetUtils.isIPv4Address(e)&&!NetUtils.isIPv6Address(e)&&!!e.match(/.+\..+$/)}},{key:"_normalizeIP",value:function _normalizeIP(e){if(NetUtils.isIPv4Address(e)){var t=e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return parseInt(t[1])+"."+parseInt(t[2])+"."+parseInt(t[3])+"."+parseInt(t[4])}if(NetUtils.isIPv6Address(e)){var r=(e=e.toLowerCase()).split(":");if(NetUtils.isIPv4Address(r[r.length-1]))return NetUtils._normalizeIP(r[r.length-1]);var n=r.indexOf("");if(n>=0){r[n]="0";n>0&&""===r[n-1]&&(r[n-1]="0");n<r.length-1&&""===r[n+1]&&(r[n+1]="0");for(var a=8-r.length,i=0;i<a;++i)r.splice(n,0,"0")}for(var s=-1,o=0,u=-1,c=1,l=0;l<r.length;++l){r[l]=r[l].replace(/^0+([a-f0-9])/,"$1");if("0"===r[l])u<0?u=l:c++;else if(u>=0&&c>o){s=u;o=c;u=-1;c=1}}if(u>=0&&c>o){s=u;o=c}if(s>=0&&o>1){if(o===r.length)return"::";0===s||s+o===r.length?r.splice(s,o,":"):r.splice(s,o,"")}return r.join(":")}throw"Malformed IP address "+e}},{key:"_IPv4toLong",value:function _IPv4toLong(e){var t=e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return(parseInt(t[1])<<24)+(parseInt(t[2])<<16)+(parseInt(t[3])<<8)+parseInt(t[4])}}]);return NetUtils}();hr.IP_BLACKLIST=["0.0.0.0","255.255.255.255","::"];hr.IPv4_PRIVATE_NETWORK=["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","100.64.0.0/10","169.254.0.0/16"];r.register(hr);var fr=function(){(0,_createClass3["default"])(PeerKeyStore,null,[{key:"getPersistent",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee290(){var e;return _regenerator2["default"].wrap(function _callee290$(t){for(;;)switch(t.prev=t.next){case 0:if(PeerKeyStore._instance){t.next=6;break}(e=new JDB.JungleDB("peer-key",PeerKeyStore.VERSION)).createObjectStore(PeerKeyStore.KEY_DATABASE,new _r);t.next=5;return e.connect();case 5:PeerKeyStore._instance=new PeerKeyStore(e.getObjectStore(PeerKeyStore.KEY_DATABASE));case 6:return t.abrupt("return",PeerKeyStore._instance);case 7:case"end":return t.stop()}},_callee290,this)}));return function getPersistent(){return e.apply(this,arguments)}}()},{key:"createVolatile",value:function createVolatile(){return new PeerKeyStore(JDB.JungleDB.createVolatileObjectStore())}}]);function PeerKeyStore(e){(0,_classCallCheck3["default"])(this,PeerKeyStore);this._store=e}(0,_createClass3["default"])(PeerKeyStore,[{key:"get",value:function get(e){return this._store.get(e)}},{key:"put",value:function put(e,t){return this._store.put(e,t)}}]);return PeerKeyStore}();fr._instance=null;fr.VERSION=2;fr.KEY_DATABASE="keys";r.register(fr);var _r=function(){function PeerKeyStoreCodec(){(0,_classCallCheck3["default"])(this,PeerKeyStoreCodec)}(0,_createClass3["default"])(PeerKeyStoreCodec,[{key:"encode",value:function encode(e){return e.serialize()}},{key:"decode",value:function decode(e,t){return G.unserialize(new T(e))}},{key:"valueEncoding",get:function get(){return"binary"}}]);return PeerKeyStoreCodec}(),dr=function(){function Peer(e,t,r,n){(0,_classCallCheck3["default"])(this,Peer);this._channel=e;this._version=t;this._headHash=r;this._timeOffset=n;this._setNetAddress()}(0,_createClass3["default"])(Peer,[{key:"_setNetAddress",value:function _setNetAddress(){if(this.channel.netAddress){this.peerAddress.netAddress&&!this.peerAddress.netAddress.equals(this.channel.netAddress)&&a.w(Peer,"Got different netAddress "+this.channel.netAddress+" for "+this.peerAddress+" - advertised was "+this.peerAddress.netAddress);this.channel.netAddress.isPrivate()||(this.peerAddress.netAddress=this.channel.netAddress)}else this.channel.peerAddress.netAddress?this.channel.netAddress=this.channel.peerAddress.netAddress:this.channel.netAddress=Ut.UNKNOWN}},{key:"equals",value:function equals(e){return e instanceof Peer&&this._channel.equals(e.channel)}},{key:"hashCode",value:function hashCode(){return this._channel.hashCode()}},{key:"toString",value:function toString(){return"Peer{version="+this._version+", headHash="+this._headHash+", peerAddress="+this.peerAddress+", netAddress="+this.netAddress+"}"}},{key:"channel",get:function get(){return this._channel}},{key:"version",get:function get(){return this._version}},{key:"headHash",get:function get(){return this._headHash}},{key:"timeOffset",get:function get(){return this._timeOffset}},{key:"id",get:function get(){return this._channel.id}},{key:"peerAddress",get:function get(){return this._channel.peerAddress}},{key:"netAddress",get:function get(){return this._channel.netAddress}}]);return Peer}();r.register(dr);var pr=function(e){(0,_inherits3["default"])(Miner,e);function Miner(e,t,r,n,a){var i=arguments.length>5&&arguments[5]!==undefined?arguments[5]:new Uint8Array(0);(0,_classCallCheck3["default"])(this,Miner);var s=(0,_possibleConstructorReturn3["default"])(this,(Miner.__proto__||(0,_getPrototypeOf2["default"])(Miner)).call(this));s._blockchain=e;s._accounts=t;s._mempool=r;s._time=n;s._address=a;s._extraData=i;s._hashCount=0;s._lastHashrate=0;s._hashrateWorker=null;s._hashrate=0;s._lastHashCounts=[];s._totalHashCount=0;s._lastElapsed=[];s._totalElapsed=0;s._workerPool=new Sr;if("object"===("undefined"==typeof navigator?"undefined":(0,_typeof3["default"])(navigator))&&navigator.hardwareConcurrency)s.threads=Math.ceil(navigator.hardwareConcurrency/2);else if(M.isNodeJs()){var o=require("os").cpus().length;s.threads=Math.ceil(o/2);1===o&&(s.throttleAfter=2)}else s.threads=1;s._workerPool.on("share",function(e){return s._onWorkerShare(e)});s._workerPool.on("no-share",function(e){return s._onWorkerShare(e)});s._mempoolChanged=!1;s._restarting=!1;s._lastRestart=0;s._submittingBlock=!1;s._mempool.on("transactions-ready",function(){return s._startWork()});s._mempool.on("transaction-added",function(){return s._mempoolChanged=!0});return s}(0,_createClass3["default"])(Miner,[{key:"startWork",value:function startWork(){var e=this;if(!this.working){this._hashCount=0;this._lastElapsed=[];this._lastHashCounts=[];this._totalHashCount=0;this._totalElapsed=0;this._lastHashrate=Date.now();this._hashrateWorker=setInterval(function(){return e._updateHashrate()},1e3);this._retry=0;this.fire("start",this);this._startWork()["catch"](a.w.tag(Miner))}}},{key:"_startWork",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee291(){var e,t=this;return _regenerator2["default"].wrap(function _callee291$(r){for(;;)switch(r.prev=r.next){case 0:if(this.working&&!this._restarting){r.next=2;break}return r.abrupt("return");case 2:r.prev=2;this._lastRestart=Date.now();this._restarting=!0;this._mempoolChanged=!1;this._retry=0;r.next=9;return this.getNextBlock();case 9:e=r.sent;a.i(Miner,"Starting work on "+e.header+", transactionCount="+e.transactionCount+", hashrate="+this._hashrate+" H/s");this._workerPool.startMiningOnBlock(e)["catch"](a.w.tag(Miner));r.next=19;break;case 14:r.prev=14;r.t0=r["catch"](2);a.w(Miner,"Failed to start work, retrying in 100ms");this.stopWork();setTimeout(function(){return t.startWork()},100);case 19:r.prev=19;this._restarting=!1;return r.finish(19);case 22:case"end":return r.stop()}},_callee291,this,[[2,14,19,22]])}));return function _startWork(){return e.apply(this,arguments)}}()},{key:"_onWorkerShare",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee292(e){return _regenerator2["default"].wrap(function _callee292$(t){for(;;)switch(t.prev=t.next){case 0:this._hashCount+=this._workerPool.noncesPerRun;if(!e.block||!e.block.prevHash.equals(this._blockchain.headHash)){t.next=29;break}a.d(Miner,function(){return"Received share: "+e.nonce+" / "+e.hash.toHex()});if(!_e.isProofOfWork(e.hash,e.block.target)||this._submittingBlock){t.next=29;break}e.block.header.nonce=e.nonce;this._submittingBlock=!0;t.next=8;return e.block.header.verifyProofOfWork();case 8:if(!t.sent){t.next=22;break}this.fire("block-mined",e.block,this);t.next=12;return this._blockchain.pushBlock(e.block);case 12:t.t0=t.sent;if(!(t.t0<0)){t.next=19;break}this._submittingBlock=!1;this._startWork()["catch"](a.w.tag(Miner));return t.abrupt("return");case 19:this._submittingBlock=!1;case 20:t.next=29;break;case 22:t.t1=a;t.t2=Miner;t.next=26;return e.block.header.pow();case 26:t.t3=t.sent;t.t4="Ignoring invalid share: "+t.t3;t.t1.d.call(t.t1,t.t2,t.t4);case 29:this._mempoolChanged&&this._lastRestart+Miner.MIN_TIME_ON_BLOCK<Date.now()&&this._startWork()["catch"](a.w.tag(Miner));case 30:case"end":return t.stop()}},_callee292,this)}));return function _onWorkerShare(t){return e.apply(this,arguments)}}()},{key:"getNextBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee293(){var e,t,r,n;return _regenerator2["default"].wrap(function _callee293$(a){for(;;)switch(a.prev=a.next){case 0:this._retry++;a.prev=1;a.next=4;return this._blockchain.getNextTarget();case 4:e=a.sent;a.next=7;return this._getNextInterlink(e);case 7:t=a.sent;a.next=10;return this._getNextBody(t.serializedSize);case 10:r=a.sent;a.next=13;return this._getNextHeader(e,t,r);case 13:n=a.sent;a.next=16;return this._blockchain.getNextTarget();case 16:a.t0=a.sent;a.t1=e;if(a.t0===a.t1){a.next=20;break}return a.abrupt("return",this.getNextBlock());case 20:return a.abrupt("return",new Se(n,t,r));case 23:a.prev=23;a.t2=a["catch"](1);if(!(this._retry<=3)){a.next=27;break}return a.abrupt("return",this.getNextBlock());case 27:throw a.t2;case 28:case"end":return a.stop()}},_callee293,this,[[1,23]])}));return function getNextBlock(){return e.apply(this,arguments)}}()},{key:"_getNextHeader",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee294(e,t,r){var n,a,i,s,o,u,c,l,h;return _regenerator2["default"].wrap(function _callee294$(f){for(;;)switch(f.prev=f.next){case 0:n=this._blockchain.headHash;a=t.hash();i=this._blockchain.height+1;f.next=5;return this._accounts.transaction();case 5:s=f.sent;o=void 0;f.prev=7;f.next=10;return s.commitBlockBody(r,i,this._blockchain.transactionCache);case 10:f.next=12;return s.hash();case 12:o=f.sent;f.next=15;return s.abort();case 15:f.next=22;break;case 17:f.prev=17;f.t0=f["catch"](7);f.next=21;return s.abort();case 21:throw new Error("Invalid block body: "+f.t0.message);case 22:u=r.hash();c=this._getNextTimestamp();l=_e.targetToCompact(e);h=0;return f.abrupt("return",new le(n,a,u,o,l,i,c,h));case 27:case"end":return f.stop()}},_callee294,this,[[7,17]])}));return function _getNextHeader(t,r,n){return e.apply(this,arguments)}}()},{key:"_getNextInterlink",value:function _getNextInterlink(e){return this._blockchain.head.getNextInterlink(e)}},{key:"_getNextBody",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee295(e){var t,r,n;return _regenerator2["default"].wrap(function _callee295$(a){for(;;)switch(a.prev=a.next){case 0:t=z.BLOCK_SIZE_MAX-le.SERIALIZED_SIZE-e-fe.getMetadataSize(this._extraData);a.next=3;return this._mempool.getTransactionsForBlock(t);case 3:r=a.sent;a.next=6;return this._accounts.gatherToBePrunedAccounts(r,this._blockchain.height+1,this._blockchain.transactionCache);case 6:n=a.sent;return a.abrupt("return",new fe(this._address,r,this._extraData,n));case 8:case"end":return a.stop()}},_callee295,this)}));return function _getNextBody(t){return e.apply(this,arguments)}}()},{key:"_getNextTimestamp",value:function _getNextTimestamp(){var e=Math.floor(this._time.now()/1e3);return Math.max(e,this._blockchain.head.timestamp+1)}},{key:"stopWork",value:function stopWork(){if(this.working){clearInterval(this._hashrateWorker);this._hashrateWorker=null;this._hashrate=0;this._lastElapsed=[];this._lastHashCounts=[];this._totalHashCount=0;this._totalElapsed=0;this._workerPool.stop();this.fire("stop",this);a.i(Miner,"Stopped work")}}},{key:"_updateHashrate",value:function _updateHashrate(){var e=(Date.now()-this._lastHashrate)/1e3,t=this._hashCount;this._hashCount=0;this._lastHashrate=Date.now();this._lastElapsed.push(e);this._lastHashCounts.push(t);this._totalElapsed+=e;this._totalHashCount+=t;if(this._lastElapsed.length>Miner.MOVING_AVERAGE_MAX_SIZE){var r=this._lastElapsed.shift(),n=this._lastHashCounts.shift();this._totalElapsed-=r;this._totalHashCount-=n}this._hashrate=Math.round(this._totalHashCount/this._totalElapsed);this.fire("hashrate-changed",this._hashrate,this)}},{key:"address",get:function get(){return this._address}},{key:"working",get:function get(){return!!this._hashrateWorker}},{key:"hashrate",get:function get(){return this._hashrate}},{key:"threads",get:function get(){return this._workerPool.poolSize},set:function set(e){this._workerPool.poolSize=e}},{key:"throttleWait",get:function get(){return this._workerPool.cycleWait},set:function set(e){this._workerPool.cycleWait=e}},{key:"throttleAfter",get:function get(){return this._workerPool.runsPerCycle},set:function set(e){this._workerPool.runsPerCycle=e}}]);return Miner}(i);pr.MIN_TIME_ON_BLOCK=1e4;pr.MOVING_AVERAGE_MAX_SIZE=10;r.register(pr);var gr=function(){(0,_createClass3["default"])(Wallet,null,[{key:"generate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee296(){return _regenerator2["default"].wrap(function _callee296$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return x.prepareSyncCryptoWorker();case 2:return e.abrupt("return",new Wallet(G.generate()));case 3:case"end":return e.stop()}},_callee296,this)}));return function generate(){return e.apply(this,arguments)}}()},{key:"loadPlain",value:function loadPlain(e){"string"==typeof e&&(e=w.fromHex(e));if(!e||0===e.byteLength)throw new Error("Invalid wallet seed");return new Wallet(G.unserialize(new T(e)))}},{key:"loadEncrypted",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee297(e,t){return _regenerator2["default"].wrap(function _callee297$(r){for(;;)switch(r.prev=r.next){case 0:"string"==typeof e&&(e=w.fromHex(e));"string"==typeof t&&(t=w.fromAscii(t));r.t0=Wallet;r.next=5;return G.fromEncrypted(new T(e),t);case 5:r.t1=r.sent;return r.abrupt("return",new r.t0(r.t1));case 7:case"end":return r.stop()}},_callee297,this)}));return function loadEncrypted(t,r){return e.apply(this,arguments)}}()}]);function Wallet(e){(0,_classCallCheck3["default"])(this,Wallet);this._keyPair=e;this._address=this._keyPair.publicKey.toAddress()}(0,_createClass3["default"])(Wallet,[{key:"createTransaction",value:function createTransaction(e,t,r,n){var a=new ye(this._keyPair.publicKey,e,t,r,n);a.signature=W.create(this._keyPair.privateKey,this._keyPair.publicKey,a.serializeContent());return a}},{key:"exportPlain",value:function exportPlain(){return this._keyPair.serialize()}},{key:"exportEncrypted",value:function exportEncrypted(e,t){"string"==typeof e&&(e=w.fromAscii(e));"string"==typeof t&&(t=w.fromAscii(t));return this._keyPair.exportEncrypted(e,t)}},{key:"lock",value:function lock(e){"string"==typeof e&&(e=w.fromAscii(e));return this.keyPair.lock(e)}},{key:"relock",value:function relock(){this.keyPair.relock()}},{key:"unlock",value:function unlock(e){"string"==typeof e&&(e=w.fromAscii(e));return this.keyPair.unlock(e)}},{key:"equals",value:function equals(e){return e instanceof Wallet&&this.keyPair.equals(e.keyPair)&&this.address.equals(e.address)}},{key:"isLocked",get:function get(){return this.keyPair.isLocked}},{key:"address",get:function get(){return this._address}},{key:"publicKey",get:function get(){return this._keyPair.publicKey}},{key:"keyPair",get:function get(){return this._keyPair}}]);return Wallet}();r.register(gr);var yr=function(e){(0,_inherits3["default"])(MultiSigWallet,e);(0,_createClass3["default"])(MultiSigWallet,null,[{key:"fromPublicKeys",value:function fromPublicKeys(e,t,r){if(0===r.length)throw new Error("publicKeys may not be empty");if(t<=0)throw new Error("minSignatures must be greater than 0");if(!r.some(function(t){return t.equals(e.publicKey)}))throw new Error("Own publicKey must be part of publicKeys");(r=r.slice()).sort(function(e,t){return e.compare(t)});var n=[].concat((0,_toConsumableArray3["default"])(g.k_combinations(r,t))).map(function(e){return H.sum(e)});return new MultiSigWallet(e,t,n)}},{key:"_loadMultiSig",value:function _loadMultiSig(e,t){for(var r=t.readUint8(),n=t.readUint8(),a=[],i=0;i<n;++i)a.push(H.unserialize(t));return new MultiSigWallet(e,r,a)}},{key:"loadPlain",value:function loadPlain(e){"string"==typeof e&&(e=w.fromHex(e));if(!e||0===e.byteLength)throw new Error("Invalid wallet seed");var t=new T(e),r=G.unserialize(t);return MultiSigWallet._loadMultiSig(r,t)}},{key:"loadEncrypted",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee298(e,t){var r,n;return _regenerator2["default"].wrap(function _callee298$(a){for(;;)switch(a.prev=a.next){case 0:"string"==typeof e&&(e=w.fromHex(e));"string"==typeof t&&(t=w.fromAscii(t));r=new T(e);a.next=5;return G.fromEncrypted(r,t);case 5:n=a.sent;return a.abrupt("return",MultiSigWallet._loadMultiSig(n,r));case 7:case"end":return a.stop()}},_callee298,this)}));return function loadEncrypted(t,r){return e.apply(this,arguments)}}()}]);function MultiSigWallet(e,t,r){(0,_classCallCheck3["default"])(this,MultiSigWallet);var n=(0,_possibleConstructorReturn3["default"])(this,(MultiSigWallet.__proto__||(0,_getPrototypeOf2["default"])(MultiSigWallet)).call(this,e));n._minSignatures=t;n._publicKeys=r;n._publicKeys.sort(function(e,t){return e.compare(t)});var a=P.computeRoot(n._publicKeys);n._address=q.fromHash(a);return n}(0,_createClass3["default"])(MultiSigWallet,[{key:"exportPlain",value:function exportPlain(){var e=new T(this.exportedSize);this._keyPair.serialize(e);e.writeUint8(this._minSignatures);e.writeUint8(this._publicKeys.length);var t=!0,r=!1,n=undefined;try{for(var a,i=(0,_getIterator3["default"])(this._publicKeys);!(t=(a=i.next()).done);t=!0){a.value.serialize(e)}}catch(s){r=!0;n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}},{key:"exportEncrypted",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee299(e,t){var r,n,a,i,s,o;return _regenerator2["default"].wrap(function _callee299$(u){for(;;)switch(u.prev=u.next){case 0:"string"==typeof e&&(e=w.fromAscii(e));"string"==typeof t&&(t=w.fromAscii(t));r=new T(this.encryptedExportedSize);u.t0=r;u.next=6;return this._keyPair.exportEncrypted(e,t);case 6:u.t1=u.sent;u.t0.write.call(u.t0,u.t1);r.writeUint8(this._minSignatures);r.writeUint8(this._publicKeys.length);n=!0;a=!1;i=undefined;u.prev=13;for(s=(0,_getIterator3["default"])(this._publicKeys);!(n=(o=s.next()).done);n=!0)o.value.serialize(r);u.next=21;break;case 17:u.prev=17;u.t2=u["catch"](13);a=!0;i=u.t2;case 21:u.prev=21;u.prev=22;!n&&s["return"]&&s["return"]();case 24:u.prev=24;if(!a){u.next=27;break}throw i;case 27:return u.finish(24);case 28:return u.finish(21);case 29:return u.abrupt("return",r);case 30:case"end":return u.stop()}},_callee299,this,[[13,17,21,29],[22,,24,28]])}));return function exportEncrypted(t,r){return e.apply(this,arguments)}}()},{key:"createTransaction",value:function createTransaction(e,t,r,n){return new ve(this._address,$.Type.BASIC,e,$.Type.BASIC,t,r,n,pe.Flag.NONE,new Uint8Array(0))}},{key:"createCommitment",value:function createCommitment(){return j.generate()}},{key:"signTransaction",value:function signTransaction(e,t,r,n){(t=t.slice()).sort(function(e,t){return e.compare(t)});return V.create(this._keyPair.privateKey,this._keyPair.publicKey,t,n,r,e.serializeContent())}},{key:"completeTransaction",value:function completeTransaction(e,t,r,n){if(n.length!==this._minSignatures)throw"Not enough signatures to complete this transaction";var a=W.fromPartialSignatures(r,n),i=ge.multiSig(t,this._publicKeys,a);e.proof=i.serialize();return e}},{key:"encryptedExportedSize",get:function get(){return this._keyPair.encryptedSize+1+1+this._publicKeys.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"exportedSize",get:function get(){return this._keyPair.serializedSize+1+1+this._publicKeys.reduce(function(e,t){return e+t.serializedSize},0)}},{key:"minSignatures",get:function get(){return this._minSignatures}},{key:"publicKeys",get:function get(){return this._publicKeys}}]);return MultiSigWallet}(gr);r.register(yr);var vr=function(){function WalletStore(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"wallet";(0,_classCallCheck3["default"])(this,WalletStore);this._jdb=new JDB.JungleDB(e,WalletStore.VERSION);this._walletStore=null;this._multiSigStore=null;return this._init()}(0,_createClass3["default"])(WalletStore,[{key:"_init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee300(){return _regenerator2["default"].wrap(function _callee300$(e){for(;;)switch(e.prev=e.next){case 0:this._walletStore=this._jdb.createObjectStore(WalletStore.WALLET_DATABASE,new kr);this._multiSigStore=this._jdb.createObjectStore(WalletStore.MULTISIG_WALLET_DATABASE,new kr);e.next=4;return this._jdb.connect();case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}},_callee300,this)}));return function _init(){return e.apply(this,arguments)}}()},{key:"hasDefault",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee301(e){var t;return _regenerator2["default"].wrap(function _callee301$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return this._walletStore.get("default");case 2:t=e.sent;return e.abrupt("return",!!t);case 4:case"end":return e.stop()}},_callee301,this)}));return function hasDefault(t){return e.apply(this,arguments)}}()},{key:"getDefault",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee302(e){var t,r,n;return _regenerator2["default"].wrap(function _callee302$(a){for(;;)switch(a.prev=a.next){case 0:a.next=2;return this._walletStore.get("default");case 2:if(t=a.sent){a.next=12;break}a.next=6;return gr.generate();case 6:r=a.sent;a.next=9;return this.put(r);case 9:a.next=11;return this.setDefault(r.address);case 11:return a.abrupt("return",r);case 12:n=new q(t);return a.abrupt("return",this.get(n,e));case 14:case"end":return a.stop()}},_callee302,this)}));return function getDefault(t){return e.apply(this,arguments)}}()},{key:"setDefault",value:function setDefault(e){var t=e.serialize();return this._walletStore.put("default",t)}},{key:"get",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee303(e,t){var r,n;return _regenerator2["default"].wrap(function _callee303$(a){for(;;)switch(a.prev=a.next){case 0:r=e.toBase64();a.next=3;return this._walletStore.get(r);case 3:n=a.sent;if(!t){a.next=6;break}return a.abrupt("return",gr.loadEncrypted(n,t));case 6:return a.abrupt("return",gr.loadPlain(n));case 7:case"end":return a.stop()}},_callee303,this)}));return function get(t,r){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee304(e,t,r){var n,a;return _regenerator2["default"].wrap(function _callee304$(i){for(;;)switch(i.prev=i.next){case 0:n=e.address.toBase64();a=null;if(!t){i.next=8;break}i.next=5;return e.exportEncrypted(t,r);case 5:a=i.sent;i.next=9;break;case 8:a=e.exportPlain();case 9:return i.abrupt("return",this._walletStore.put(n,a));case 10:case"end":return i.stop()}},_callee304,this)}));return function put(t,r,n){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee305(e){var t,r,n;return _regenerator2["default"].wrap(function _callee305$(a){for(;;)switch(a.prev=a.next){case 0:t=e.toBase64();r=this._walletStore.transaction();a.next=4;return r.remove(t);case 4:a.next=6;return this._walletStore.get("default");case 6:if(!(n=a.sent)){a.next=12;break}n=new q(n);if(!e.equals(n)){a.next=12;break}a.next=12;return r.remove("default");case 12:return a.abrupt("return",r.commit());case 13:case"end":return a.stop()}},_callee305,this)}));return function remove(t){return e.apply(this,arguments)}}()},{key:"list",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee306(){var e;return _regenerator2["default"].wrap(function _callee306$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._walletStore.keys();case 2:e=t.sent;return t.abrupt("return",(0,_from2["default"])(e).filter(function(e){return"default"!==e}).map(function(e){return q.fromBase64(e)}));case 4:case"end":return t.stop()}},_callee306,this)}));return function list(){return e.apply(this,arguments)}}()},{key:"getMultiSig",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee307(e,t){var r,n;return _regenerator2["default"].wrap(function _callee307$(a){for(;;)switch(a.prev=a.next){case 0:r=e.toBase64();a.next=3;return this._multiSigStore.get(r);case 3:n=a.sent;if(!t){a.next=6;break}return a.abrupt("return",yr.loadEncrypted(n,t));case 6:return a.abrupt("return",yr.loadPlain(n));case 7:case"end":return a.stop()}},_callee307,this)}));return function getMultiSig(t,r){return e.apply(this,arguments)}}()},{key:"putMultiSig",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee308(e,t,r){var n,a;return _regenerator2["default"].wrap(function _callee308$(i){for(;;)switch(i.prev=i.next){case 0:n=e.address.toBase64();a=null;if(!t){i.next=8;break}i.next=5;return e.exportEncrypted(t,r);case 5:a=i.sent;i.next=9;break;case 8:a=e.exportPlain();case 9:return i.abrupt("return",this._multiSigStore.put(n,a));case 10:case"end":return i.stop()}},_callee308,this)}));return function putMultiSig(t,r,n){return e.apply(this,arguments)}}()},{key:"removeMultiSig",value:function removeMultiSig(e){var t=e.toBase64();return this._multiSigStore.remove(t)}},{key:"listMultiSig",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee309(){var e;return _regenerator2["default"].wrap(function _callee309$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._multiSigStore.keys();case 2:e=t.sent;return t.abrupt("return",(0,_from2["default"])(e).map(function(e){return q.fromBase64(e)}));case 4:case"end":return t.stop()}},_callee309,this)}));return function listMultiSig(){return e.apply(this,arguments)}}()},{key:"close",value:function close(){return this._jdb.close()}}]);return WalletStore}();r.register(vr);vr._instance=null;vr.VERSION=1;vr.WALLET_DATABASE="wallets";vr.MULTISIG_WALLET_DATABASE="multisig-wallets";var kr=function(){function WalletStoreCodec(){(0,_classCallCheck3["default"])(this,WalletStoreCodec)}(0,_createClass3["default"])(WalletStoreCodec,[{key:"encode",value:function encode(e){return e}},{key:"decode",value:function decode(e,t){return new Uint8Array(e)}},{key:"valueEncoding",get:function get(){return"binary"}}]);return WalletStoreCodec}(),mr=function(){function IWorker(){(0,_classCallCheck3["default"])(this,IWorker)}(0,_createClass3["default"])(IWorker,null,[{key:"createProxy",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee310(e,t,r){return _regenerator2["default"].wrap(function _callee310$(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new(IWorker.Proxy(e))(r,t));case 1:case"end":return n.stop()}},_callee310,this)}));return function createProxy(t,r,n){return e.apply(this,arguments)}}()},{key:"startWorkerForProxy",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee311(e,t,r){return _regenerator2["default"].wrap(function _callee311$(n){for(;;)switch(n.prev=n.next){case 0:if(IWorker._workersSupported){n.next=6;break}n.next=3;return IWorker._workerImplementation[e.name].init(t);case 3:return n.abrupt("return",IWorker._workerImplementation[e.name]);case 6:r||(r=Nimiq._path+"worker.js");return n.abrupt("return",IWorker.createProxy(e,t,new Worker(window.URL.createObjectURL(new Blob(["Nimiq = {_path: '"+Nimiq._path+"'}; importScripts('"+r.replace(/'/g,"")+"');"])))));case 8:case"end":return n.stop()}},_callee311,this)}));return function startWorkerForProxy(t,r,n){return e.apply(this,arguments)}}()},{key:"startWorkerPoolForProxy",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee312(e,t,r,n){return _regenerator2["default"].wrap(function _callee312$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new(IWorker.Pool(e))(function(t){return IWorker.startWorkerForProxy(e,t,n)},t,r).start());case 1:case"end":return a.stop()}},_callee312,this)}));return function startWorkerPoolForProxy(t,r,n,a){return e.apply(this,arguments)}}()},{key:"stubBaseOnMessage",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee313(e){var t;return _regenerator2["default"].wrap(function _callee313$(r){for(;;)switch(r.prev=r.next){case 0:r.prev=0;if("init"!==e.data.command){r.next=12;break}if(!IWorker._workerImplementation[e.data.args[0]]){r.next=9;break}r.next=5;return IWorker._workerImplementation[e.data.args[0]].init(e.data.args[1]);case 5:t=r.sent;self.postMessage({status:"OK",result:t,id:e.data.id});r.next=10;break;case 9:self.postMessage({status:"error",result:"Unknown worker!",id:e.data.id});case 10:r.next=13;break;case 12:self.postMessage({status:"error",result:"Worker not yet initialized!",id:e.data.id});case 13:r.next=18;break;case 15:r.prev=15;r.t0=r["catch"](0);self.postMessage({status:"error",result:r.t0,id:e.data.id});case 18:case"end":return r.stop()}},_callee313,this,[[0,15]])}));return function stubBaseOnMessage(t){return e.apply(this,arguments)}}()},{key:"prepareForWorkerUse",value:function prepareForWorkerUse(e,t){IWorker._insideWebWorker&&(self.onmessage=IWorker.stubBaseOnMessage);IWorker._workerImplementation=IWorker._workerImplementation||{};IWorker._workerImplementation[e.name]=t}},{key:"fireModuleLoaded",value:function fireModuleLoaded(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"Module";if("function"==typeof IWorker._moduleLoadedCallbacks[e]){IWorker._moduleLoadedCallbacks[e]();IWorker._moduleLoadedCallbacks[e]=null}}},{key:"_loadBrowserScript",value:function _loadBrowserScript(e,t){var r=document.getElementsByTagName("head")[0],n=document.createElement("script");n.type="text/javascript";n.src=e;var a=function ret(){return window.setTimeout(t,100)};n.onreadystatechange=a;n.onload=a;r.appendChild(n)}},{key:"Proxy",value:function Proxy(e){var t=function(t){(0,_inherits3["default"])(proxyClass,t);function proxyClass(t,r){var n;(0,_classCallCheck3["default"])(this,proxyClass);var a=(0,_possibleConstructorReturn3["default"])(this,(proxyClass.__proto__||(0,_getPrototypeOf2["default"])(proxyClass)).call(this));a._name=r;a._messageId=0;a._worker=t;a._worker.onmessage=a._receive.bind(a);a._waiting=new _map2["default"];return n=a._invoke("init",[e.name,r]).then(function(){return a}),(0,_possibleConstructorReturn3["default"])(a,n)}(0,_createClass3["default"])(proxyClass,[{key:"_receive",value:function _receive(e){var t=this._waiting.get(e.data.id);if(t){this._waiting["delete"](e.data.id);"OK"===e.data.status?t.resolve(e.data.result):"error"===e.data.status&&t.error(e.data.result)}else a.w(WorkerProxy,"Unknown reply",e)}},{key:"importScript",value:function importScript(e){return this._invoke("importScript",[e])}},{key:"importWasm",value:function importWasm(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"Module";return this._invoke("importWasm",[e,t])}},{key:"_invoke",value:function _invoke(e){var t=this,r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return new _promise2["default"](function(n,a){var i={command:e,args:r,id:t._messageId++};t._waiting.set(i.id,{resolve:n,error:a});t._worker.postMessage(i)})}},{key:"destroy",value:function destroy(){return this._invoke("destroy")}}]);return proxyClass}(e),r=!0,n=!1,i=undefined;try{for(var s,o=function _loop6(){var r=s.value;"function"==typeof e.prototype[r]&&"constructor"!==r&&(t.prototype[r]=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this._invoke(r,t)})},u=(0,_getIterator3["default"])((0,_getOwnPropertyNames2["default"])(e.prototype));!(r=(s=u.next()).done);r=!0)o()}catch(c){n=!0;i=c}finally{try{!r&&u["return"]&&u["return"]()}finally{if(n)throw i}}return t}},{key:"Stub",value:function Stub(e){var Stub=function(e){(0,_inherits3["default"])(Stub,e);function Stub(){(0,_classCallCheck3["default"])(this,Stub);return(0,_possibleConstructorReturn3["default"])(this,(Stub.__proto__||(0,_getPrototypeOf2["default"])(Stub)).call(this))}(0,_createClass3["default"])(Stub,[{key:"_result",value:function _result(e,t,r){self.postMessage({status:t,result:r,id:e.data.id})}},{key:"_onmessage",value:function _onmessage(e){var t=this;try{var r=this._invoke(e.data.command,e.data.args);r instanceof _promise2["default"]?r.then(function(r){t._result(e,"OK",r)}):this._result(e,"OK",r)}catch(n){this._result(e,"error",n.message||n)}}},{key:"importScript",value:function importScript(e){var t=this,r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"Module";if(r&&IWorker._global[r]&&IWorker._global[r].asm)return!1;"undefined"!=typeof Nimiq&&Nimiq._path&&(e=""+Nimiq._path+e);"string"==typeof __dirname&&-1===e.indexOf("/")&&(e=__dirname+"/"+e);var n,a=IWorker._global[r]||{};return new _promise2["default"]((n=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee314(n,i){return _regenerator2["default"].wrap(function _callee314$(t){for(;;)switch(t.prev=t.next){case 0:if(!r){t.next=9;break}t.t0=(0,_typeof3["default"])(a.preRun);t.next="undefined"===t.t0?4:"function"===t.t0?6:"object"===t.t0?8:9;break;case 4:a.preRun=function(){return n(!0)};return t.abrupt("break",9);case 6:a.preRun=[a,function(){return n(!0)}];return t.abrupt("break",9);case 8:a.preRun.push(function(){return n(!0)});case 9:if("function"!=typeof importScripts){t.next=16;break}t.next=12;return new _promise2["default"](function(t){IWorker._moduleLoadedCallbacks[r]=t;importScripts(e)});case 12:IWorker._global[r]=IWorker._global[r](a);r||n(!0);t.next=24;break;case 16:if("object"!==("undefined"==typeof window?"undefined":(0,_typeof3["default"])(window))){t.next=23;break}t.next=19;return new _promise2["default"](function(t){IWorker._loadBrowserScript(e,t)});case 19:IWorker._global[r]=IWorker._global[r](a);r||n(!0);t.next=24;break;case 23:if("function"==typeof require){IWorker._global[r]=require(e)(a);r||n(!0)}else i("No way to load scripts.");case 24:case"end":return t.stop()}},_callee314,t)})),function(e,t){return n.apply(this,arguments)}))}},{key:"importWasm",value:function importWasm(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"Module";"undefined"!=typeof Nimiq&&Nimiq._path&&(e=""+Nimiq._path+e);"string"==typeof __dirname&&-1===e.indexOf("/")&&(e=__dirname+"/"+e);if(!IWorker._global.WebAssembly){a.w(IWorker,"No support for WebAssembly available.");return _promise2["default"].resolve(!1)}return new _promise2["default"](function(r){try{if(M.isNodeJs()){require("fs").readFile(e,function(n,i){if(n){a.w(IWorker,"Failed to access WebAssembly module "+e+": "+n);r(!1)}else{IWorker._global[t]=IWorker._global[t]||{};IWorker._global[t].wasmBinary=function toUint8Array(e){for(var t=new Uint8Array(e.length),r=0;r<e.length;++r)t[r]=e[r];return t}(i);r(!0)}})}else{var n=new XMLHttpRequest;n.open("GET",e,!0);n.responseType="arraybuffer";n.onload=function(){IWorker._global[t]=IWorker._global[t]||{};IWorker._global[t].wasmBinary=n.response;r(!0)};n.onerror=function(){a.w(IWorker,"Failed to access WebAssembly module "+e);r(!1)};n.send(null)}}catch(i){a.w(IWorker,"Failed to access WebAssembly module "+e);r(!1)}})}},{key:"init",value:function init(e){var t=this;this._name=e;if(IWorker._insideWebWorker){self.name=e;self.onmessage=function(e){return t._onmessage(e)}}}},{key:"_invoke",value:function _invoke(e,t){return this[e].apply(this,t)}},{key:"destroy",value:function destroy(){IWorker._insideWebWorker&&self.close()}}]);return Stub}(e),t=!0,r=!1,n=undefined;try{for(var i,s=function _loop7(){var t=i.value;"function"==typeof e.prototype[t]&&"constructor"!==t&&(Stub.prototype[t]=function(){throw"Not implemented in IWorker Stub: "+t})},o=(0,_getIterator3["default"])((0,_getOwnPropertyNames2["default"])(e.prototype));!(t=(i=o.next()).done);t=!0)s()}catch(u){r=!0;n=u}finally{try{!t&&o["return"]&&o["return"]()}finally{if(r)throw n}}return Stub}},{key:"Pool",value:function Pool(e){var t=function(e){(0,_inherits3["default"])(poolClass,e);function poolClass(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"pool",r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1;(0,_classCallCheck3["default"])(this,poolClass);var n=(0,_possibleConstructorReturn3["default"])(this,(poolClass.__proto__||(0,_getPrototypeOf2["default"])(poolClass)).call(this));n._proxyInitializer=e;n._name=t;n._poolSize=r;n._workers=[];n._freeWorkers=[];n._waitingCalls=[];return n}(0,_createClass3["default"])(poolClass,[{key:"start",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee315(){return _regenerator2["default"].wrap(function _callee315$(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return this._updateToSize();case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},_callee315,this)}));return function start(){return e.apply(this,arguments)}}()},{key:"destroy",value:function destroy(){this._poolSize=0;return this._updateToSize()}},{key:"_invoke",value:function _invoke(e,t){var r=this;return IWorker._workersSupported?new _promise2["default"](function(n,i){r._waitingCalls.push({name:e,args:t,resolve:n,error:i});var s=r._freeWorkers.shift();s&&r._step(s)["catch"](a.w.tag(IWorker))}):this._workers[0][e].apply(this._workers[0],t)}},{key:"_step",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee316(e){var t;return _regenerator2["default"].wrap(function _callee316$(r){for(;;)switch(r.prev=r.next){case 0:t=this._waitingCalls.shift();case 1:if(!t){r.next=19;break}r.prev=2;r.t0=t;r.next=6;return e[t.name].apply(e,t.args);case 6:r.t1=r.sent;r.t0.resolve.call(r.t0,r.t1);r.next=13;break;case 10:r.prev=10;r.t2=r["catch"](2);t.error(r.t2);case 13:if(-1!==this._workers.indexOf(e)){r.next=16;break}e.destroy();return r.abrupt("return");case 16:t=this._waitingCalls.shift();r.next=1;break;case 19:this._freeWorkers.push(e);case 20:case"end":return r.stop()}},_callee316,this,[[2,10]])}));return function _step(t){return e.apply(this,arguments)}}()},{key:"_updateToSize",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee317(){var e,t,r,n,i,s,o,u,c,l;return _regenerator2["default"].wrap(function _callee317$(h){for(;;)switch(h.prev=h.next){case 0:if("undefined"==typeof Worker&&this._poolSize>1){a.d(IWorker,"Pool of size larger than 1 requires WebWorker support.");this._poolSize=1}e=[];for(;this._workers.length+e.length<this._poolSize;)e.push(this._proxyInitializer(this._name+"#"+(this._workers.length+e.length)));h.next=5;return _promise2["default"].all(e);case 5:t=h.sent;r=!0;n=!1;i=undefined;h.prev=9;for(s=(0,_getIterator3["default"])(t);!(r=(o=s.next()).done);r=!0){u=o.value;this._workers.push(u);this._step(u)["catch"](a.w.tag(IWorker))}h.next=17;break;case 13:h.prev=13;h.t0=h["catch"](9);n=!0;i=h.t0;case 17:h.prev=17;h.prev=18;!r&&s["return"]&&s["return"]();case 20:h.prev=20;if(!n){h.next=23;break}throw i;case 23:return h.finish(20);case 24:return h.finish(17);case 25:for(;this._workers.length>this._poolSize;){c=this._freeWorkers.shift()||this._workers.pop();if((l=this._workers.indexOf(c))>=0){this._workers.splice(l,1);c.destroy()}}return h.abrupt("return",this);case 27:case"end":return h.stop()}},_callee317,this,[[9,13,17,25],[18,,20,24]])}));return function _updateToSize(){return e.apply(this,arguments)}}()},{key:"poolSize",get:function get(){return this._poolSize},set:function set(e){this._poolSize=e;this._updateToSize()["catch"](a.w.tag(IWorker))}}]);return poolClass}(e),r=!0,n=!1,i=undefined;try{for(var s,o=function _loop8(){var r=s.value;"function"==typeof e.prototype[r]&&"constructor"!==r&&(t.prototype[r]=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this._invoke(r,t)})},u=(0,_getIterator3["default"])((0,_getOwnPropertyNames2["default"])(e.prototype));!(r=(s=u.next()).done);r=!0)o()}catch(c){n=!0;i=c}finally{try{!r&&u["return"]&&u["return"]()}finally{if(n)throw i}}return t}},{key:"_workersSupported",get:function get(){return"undefined"!=typeof Worker}},{key:"areWorkersAsync",get:function get(){return IWorker._workersSupported}},{key:"_insideWebWorker",get:function get(){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}},{key:"_global",get:function get(){return"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:null}}]);return IWorker}();mr._moduleLoadedCallbacks={};mr._workerImplementation={};r.register(mr);var br=function(){function CryptoWorker(){(0,_classCallCheck3["default"])(this,CryptoWorker)}(0,_createClass3["default"])(CryptoWorker,[{key:"computeBlake2b",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee318(e){return _regenerator2["default"].wrap(function _callee318$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee318,this)}));return function computeBlake2b(t){return e.apply(this,arguments)}}()},{key:"computeArgon2d",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee319(e){return _regenerator2["default"].wrap(function _callee319$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee319,this)}));return function computeArgon2d(t){return e.apply(this,arguments)}}()},{key:"computeArgon2dBatch",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee320(e){return _regenerator2["default"].wrap(function _callee320$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee320,this)}));return function computeArgon2dBatch(t){return e.apply(this,arguments)}}()},{key:"computeSha256",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee321(e){return _regenerator2["default"].wrap(function _callee321$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee321,this)}));return function computeSha256(t){return e.apply(this,arguments)}}()},{key:"kdf",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee322(e,t,r){return _regenerator2["default"].wrap(function _callee322$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee322,this)}));return function kdf(t,r,n){return e.apply(this,arguments)}}()},{key:"publicKeyDerive",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee323(e){return _regenerator2["default"].wrap(function _callee323$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee323,this)}));return function publicKeyDerive(t){return e.apply(this,arguments)}}()},{key:"commitmentCreate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee324(e){return _regenerator2["default"].wrap(function _callee324$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee324,this)}));return function commitmentCreate(t){return e.apply(this,arguments)}}()},{key:"scalarsAdd",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee325(e,t){return _regenerator2["default"].wrap(function _callee325$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee325,this)}));return function scalarsAdd(t,r){return e.apply(this,arguments)}}()},{key:"commitmentsAggregate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee326(e){return _regenerator2["default"].wrap(function _callee326$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee326,this)}));return function commitmentsAggregate(t){return e.apply(this,arguments)}}()},{key:"publicKeysHash",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee327(e){return _regenerator2["default"].wrap(function _callee327$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee327,this)}));return function publicKeysHash(t){return e.apply(this,arguments)}}()},{key:"publicKeyDelinearize",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee328(e,t){return _regenerator2["default"].wrap(function _callee328$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee328,this)}));return function publicKeyDelinearize(t,r){return e.apply(this,arguments)}}()},{key:"publicKeysDelinearizeAndAggregate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee329(e,t){return _regenerator2["default"].wrap(function _callee329$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee329,this)}));return function publicKeysDelinearizeAndAggregate(t,r){return e.apply(this,arguments)}}()},{key:"privateKeyDelinearize",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee330(e,t,r){return _regenerator2["default"].wrap(function _callee330$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee330,this)}));return function privateKeyDelinearize(t,r,n){return e.apply(this,arguments)}}()},{key:"delinearizedPartialSignatureCreate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee331(e,t,r,n,a,i){return _regenerator2["default"].wrap(function _callee331$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee331,this)}));return function delinearizedPartialSignatureCreate(t,r,n,a,i,s){return e.apply(this,arguments)}}()},{key:"signatureCreate",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee332(e,t,r){return _regenerator2["default"].wrap(function _callee332$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee332,this)}));return function signatureCreate(t,r,n){return e.apply(this,arguments)}}()},{key:"signatureVerify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee333(e,t,r){return _regenerator2["default"].wrap(function _callee333$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee333,this)}));return function signatureVerify(t,r,n){return e.apply(this,arguments)}}()},{key:"blockVerify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee334(e,t,r,n){return _regenerator2["default"].wrap(function _callee334$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee334,this)}));return function blockVerify(t,r,n,a){return e.apply(this,arguments)}}()}]);return CryptoWorker}();br.ARGON2_HASH_SIZE=32;br.BLAKE2_HASH_SIZE=32;br.SHA256_HASH_SIZE=32;br.PUBLIC_KEY_SIZE=32;br.PRIVATE_KEY_SIZE=32;br.MULTISIG_RANDOMNESS_SIZE=32;br.SIGNATURE_SIZE=64;br.PARTIAL_SIGNATURE_SIZE=32;br.SIGNATURE_HASH_SIZE=64;r.register(br);var Cr=function(e){(0,_inherits3["default"])(CryptoWorkerImpl,e);function CryptoWorkerImpl(){(0,_classCallCheck3["default"])(this,CryptoWorkerImpl);var e=(0,_possibleConstructorReturn3["default"])(this,(CryptoWorkerImpl.__proto__||(0,_getPrototypeOf2["default"])(CryptoWorkerImpl)).call(this));e._superInit=(0,_get3["default"])(CryptoWorkerImpl.prototype.__proto__||(0,_getPrototypeOf2["default"])(CryptoWorkerImpl.prototype),"init",e);return e}(0,_createClass3["default"])(CryptoWorkerImpl,[{key:"init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee335(e){var t,r,n;return _regenerator2["default"].wrap(function _callee335$(a){for(;;)switch(a.prev=a.next){case 0:if(mr._insideWebWorker){x._workerSync=this;x._workerAsync=this}a.next=3;return this._superInit.call(this,e);case 3:a.next=5;return this.importWasm("worker-wasm.wasm");case 5:if(!a.sent){a.next=10;break}a.next=8;return this.importScript("worker-wasm.js");case 8:a.next=12;break;case 10:a.next=12;return this.importScript("worker-js.js");case 12:t=Module._get_static_memory_start();if(!((r=Module._get_static_memory_size())<br.PUBLIC_KEY_SIZE+br.PRIVATE_KEY_SIZE+br.SIGNATURE_SIZE)){a.next=16;break}throw Error("Static memory too small");case 16:n=t;this._pubKeyPointer=n;this._pubKeyBuffer=new Uint8Array(Module.HEAP8.buffer,n,br.PUBLIC_KEY_SIZE);n+=br.PUBLIC_KEY_SIZE;this._privKeyPointer=n;this._privKeyBuffer=new Uint8Array(Module.HEAP8.buffer,n,br.PRIVATE_KEY_SIZE);n+=br.PRIVATE_KEY_SIZE;this._signaturePointer=n;this._signatureBuffer=new Uint8Array(Module.HEAP8.buffer,n,br.SIGNATURE_SIZE);n+=br.SIGNATURE_SIZE;this._messagePointer=n;this._messageBuffer=new Uint8Array(Module.HEAP8.buffer,n,t+r-n);case 28:case"end":return a.stop()}},_callee335,this)}));return function init(t){return e.apply(this,arguments)}}()},{key:"computeBlake2b",value:function computeBlake2b(e){var t=void 0;try{t=Module.stackSave();var r=Module.stackAlloc(br.BLAKE2_HASH_SIZE),n=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,n,e.length).set(e);var i=Module._nimiq_blake2(r,n,e.length);if(0!==i)throw i;var s=new Uint8Array(br.BLAKE2_HASH_SIZE);s.set(new Uint8Array(Module.HEAPU8.buffer,r,br.BLAKE2_HASH_SIZE));return s}catch(o){a.w(CryptoWorkerImpl,o);throw o}finally{t!==undefined&&Module.stackRestore(t)}}},{key:"computeArgon2d",value:function computeArgon2d(e){var t=void 0;try{t=Module.stackSave();var r=Module.stackAlloc(br.ARGON2_HASH_SIZE),n=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,n,e.length).set(e);var i=Module._nimiq_argon2(r,n,e.length,512);if(0!==i)throw i;var s=new Uint8Array(br.ARGON2_HASH_SIZE);s.set(new Uint8Array(Module.HEAPU8.buffer,r,br.ARGON2_HASH_SIZE));return s}catch(o){a.w(CryptoWorkerImpl,o);throw o}finally{t!==undefined&&Module.stackRestore(t)}}},{key:"computeArgon2dBatch",value:function computeArgon2dBatch(e){var t=[],r=void 0;try{r=Module.stackSave();var n=Module.stackAlloc(br.ARGON2_HASH_SIZE),i=Module.stackSave(),s=!0,o=!1,u=undefined;try{for(var c,l=(0,_getIterator3["default"])(e);!(s=(c=l.next()).done);s=!0){var h=c.value;Module.stackRestore(i);var f=Module.stackAlloc(h.length);new Uint8Array(Module.HEAPU8.buffer,f,h.length).set(h);var _=Module._nimiq_argon2(n,f,h.length,512);if(0!==_)throw _;var d=new Uint8Array(br.ARGON2_HASH_SIZE);d.set(new Uint8Array(Module.HEAPU8.buffer,n,br.ARGON2_HASH_SIZE));t.push(d)}}catch(p){o=!0;u=p}finally{try{!s&&l["return"]&&l["return"]()}finally{if(o)throw u}}return t}catch(g){a.w(CryptoWorkerImpl,g);throw g}finally{r!==undefined&&Module.stackRestore(r)}}},{key:"computeSha256",value:function computeSha256(e){var t=void 0;try{t=Module.stackSave();var r=Module.stackAlloc(br.SHA256_HASH_SIZE),n=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,n,e.length).set(e);Module._nimiq_sha256(r,n,e.length);var i=new Uint8Array(br.SHA256_HASH_SIZE);i.set(new Uint8Array(Module.HEAPU8.buffer,r,br.SHA256_HASH_SIZE));return i}catch(s){a.w(CryptoWorkerImpl,s);throw s}finally{t!==undefined&&Module.stackRestore(t)}}},{key:"kdf",value:function kdf(e,t,r){var n=void 0;try{n=Module.stackSave();var i=Module.stackAlloc(br.ARGON2_HASH_SIZE),s=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,s,e.length).set(e);var o=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,o,t.length).set(t);var u=Module._nimiq_kdf(i,s,e.length,o,t.length,512,r);if(0!==u)throw u;var c=new Uint8Array(br.ARGON2_HASH_SIZE);c.set(new Uint8Array(Module.HEAPU8.buffer,i,br.ARGON2_HASH_SIZE));return c}catch(l){a.w(CryptoWorkerImpl,l);throw l}finally{n!==undefined&&Module.stackRestore(n)}}},{key:"publicKeyDerive",value:function publicKeyDerive(e){var t=new Uint8Array(br.PUBLIC_KEY_SIZE);if(e.byteLength!==br.PRIVATE_KEY_SIZE)throw Error("Wrong buffer size.");this._privKeyBuffer.set(e);Module._ed25519_public_key_derive(this._pubKeyPointer,this._privKeyPointer);this._privKeyBuffer.fill(0);t.set(this._pubKeyBuffer);return t}},{key:"commitmentCreate",value:function commitmentCreate(e){var t=void 0;try{t=Module.stackSave();var r=Module.stackAlloc(br.PUBLIC_KEY_SIZE),n=Module.stackAlloc(br.PRIVATE_KEY_SIZE),i=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,i,e.length).set(e);var s=Module._ed25519_create_commitment(n,r,i);if(1!==s)throw new Error("Secret must not be 0 or 1: "+s);var o=new Uint8Array(br.PUBLIC_KEY_SIZE),u=new Uint8Array(br.PRIVATE_KEY_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,r,br.PUBLIC_KEY_SIZE));u.set(new Uint8Array(Module.HEAPU8.buffer,n,br.PRIVATE_KEY_SIZE));return{commitment:o,secret:u}}catch(c){a.w(CryptoWorkerImpl,c);throw c}finally{t!==undefined&&Module.stackRestore(t)}}},{key:"scalarsAdd",value:function scalarsAdd(e,t){if(e.byteLength!==br.PARTIAL_SIGNATURE_SIZE||t.byteLength!==br.PARTIAL_SIGNATURE_SIZE)throw Error("Wrong buffer size.");var r=void 0;try{r=Module.stackSave();var n=Module.stackAlloc(br.PARTIAL_SIGNATURE_SIZE),i=Module.stackAlloc(e.length),s=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,i,e.length).set(e);new Uint8Array(Module.HEAPU8.buffer,s,t.length).set(t);Module._ed25519_add_scalars(n,i,s);var o=new Uint8Array(br.PARTIAL_SIGNATURE_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,n,br.PARTIAL_SIGNATURE_SIZE));return o}catch(u){a.w(CryptoWorkerImpl,u);throw u}finally{r!==undefined&&Module.stackRestore(r)}}},{key:"commitmentsAggregate",value:function commitmentsAggregate(e){if(e.some(function(e){return e.byteLength!==br.PUBLIC_KEY_SIZE}))throw Error("Wrong buffer size.");for(var t=new Uint8Array(e.length*br.PUBLIC_KEY_SIZE),r=0;r<e.length;++r)t.set(e[r],r*br.PUBLIC_KEY_SIZE);var n=void 0;try{n=Module.stackSave();var i=Module.stackAlloc(br.PUBLIC_KEY_SIZE),s=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,s,t.length).set(t);Module._ed25519_aggregate_commitments(i,s,e.length);var o=new Uint8Array(br.PUBLIC_KEY_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,i,br.PUBLIC_KEY_SIZE));return o}catch(u){a.w(CryptoWorkerImpl,u);throw u}finally{n!==undefined&&Module.stackRestore(n)}}},{key:"publicKeysHash",value:function publicKeysHash(e){if(e.some(function(e){return e.byteLength!==br.PUBLIC_KEY_SIZE}))throw Error("Wrong buffer size.");for(var t=new Uint8Array(e.length*br.PUBLIC_KEY_SIZE),r=0;r<e.length;++r)t.set(e[r],r*br.PUBLIC_KEY_SIZE);var n=void 0;try{n=Module.stackSave();var i=Module.stackAlloc(br.SIGNATURE_HASH_SIZE),s=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,s,t.length).set(t);Module._ed25519_hash_public_keys(i,s,e.length);var o=new Uint8Array(br.SIGNATURE_HASH_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,i,br.SIGNATURE_HASH_SIZE));return o}catch(u){a.w(CryptoWorkerImpl,u);throw u}finally{n!==undefined&&Module.stackRestore(n)}}},{key:"publicKeyDelinearize",value:function publicKeyDelinearize(e,t){if(e.byteLength!==br.PUBLIC_KEY_SIZE||t.byteLength!==br.SIGNATURE_HASH_SIZE)throw Error("Wrong buffer size.");var r=void 0;try{r=Module.stackSave();var n=Module.stackAlloc(br.PUBLIC_KEY_SIZE),i=Module.stackAlloc(e.length),s=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,i,e.length).set(e);new Uint8Array(Module.HEAPU8.buffer,s,t.length).set(t);Module._ed25519_delinearize_public_key(n,s,i);var o=new Uint8Array(br.PUBLIC_KEY_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,n,br.PUBLIC_KEY_SIZE));return o}catch(u){a.w(CryptoWorkerImpl,u);throw u}finally{r!==undefined&&Module.stackRestore(r)}}},{key:"publicKeysDelinearizeAndAggregate",value:function publicKeysDelinearizeAndAggregate(e,t){if(e.some(function(e){return e.byteLength!==br.PUBLIC_KEY_SIZE})||t.byteLength!==br.SIGNATURE_HASH_SIZE)throw Error("Wrong buffer size.");for(var r=new Uint8Array(e.length*br.PUBLIC_KEY_SIZE),n=0;n<e.length;++n)r.set(e[n],n*br.PUBLIC_KEY_SIZE);var i=void 0;try{i=Module.stackSave();var s=Module.stackAlloc(br.PUBLIC_KEY_SIZE),o=Module.stackAlloc(r.length),u=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,o,r.length).set(r);new Uint8Array(Module.HEAPU8.buffer,u,t.length).set(t);Module._ed25519_aggregate_delinearized_public_keys(s,u,o,e.length);var c=new Uint8Array(br.PUBLIC_KEY_SIZE);c.set(new Uint8Array(Module.HEAPU8.buffer,s,br.PUBLIC_KEY_SIZE));return c}catch(l){a.w(CryptoWorkerImpl,l);throw l}finally{i!==undefined&&Module.stackRestore(i)}}},{key:"privateKeyDelinearize",value:function privateKeyDelinearize(e,t,r){if(e.byteLength!==br.PRIVATE_KEY_SIZE||t.byteLength!==br.PUBLIC_KEY_SIZE||r.byteLength!==br.SIGNATURE_HASH_SIZE)throw Error("Wrong buffer size.");var n=void 0;try{n=Module.stackSave();var i=Module.stackAlloc(br.PUBLIC_KEY_SIZE),s=Module.stackAlloc(e.length),o=Module.stackAlloc(t.length),u=Module.stackAlloc(r.length);new Uint8Array(Module.HEAPU8.buffer,s,e.length).set(e);new Uint8Array(Module.HEAPU8.buffer,o,t.length).set(t);new Uint8Array(Module.HEAPU8.buffer,u,r.length).set(r);Module._ed25519_derive_delinearized_private_key(i,u,o,s);var c=new Uint8Array(br.PRIVATE_KEY_SIZE);c.set(new Uint8Array(Module.HEAPU8.buffer,i,br.PRIVATE_KEY_SIZE));return c}catch(l){a.w(CryptoWorkerImpl,l);throw l}finally{n!==undefined&&Module.stackRestore(n)}}},{key:"delinearizedPartialSignatureCreate",value:function delinearizedPartialSignatureCreate(e,t,r,n,i,s){if(e.some(function(e){return e.byteLength!==br.PUBLIC_KEY_SIZE})||t.byteLength!==br.PRIVATE_KEY_SIZE||r.byteLength!==br.PUBLIC_KEY_SIZE||n.byteLength!==br.PRIVATE_KEY_SIZE||i.byteLength!==br.PUBLIC_KEY_SIZE)throw Error("Wrong buffer size.");for(var o=new Uint8Array(e.length*br.PUBLIC_KEY_SIZE),u=0;u<e.length;++u)o.set(e[u],u*br.PUBLIC_KEY_SIZE);var c=void 0;try{c=Module.stackSave();var l=Module.stackAlloc(br.PARTIAL_SIGNATURE_SIZE),h=Module.stackAlloc(o.length),f=Module.stackAlloc(t.length),_=Module.stackAlloc(r.length),d=Module.stackAlloc(n.length),p=Module.stackAlloc(i.length),g=Module.stackAlloc(s.length);new Uint8Array(Module.HEAPU8.buffer,h,o.length).set(o);new Uint8Array(Module.HEAPU8.buffer,f,t.length).set(t);new Uint8Array(Module.HEAPU8.buffer,_,r.length).set(r);new Uint8Array(Module.HEAPU8.buffer,d,n.length).set(n);new Uint8Array(Module.HEAPU8.buffer,p,i.length).set(i);new Uint8Array(Module.HEAPU8.buffer,g,s.length).set(s);Module._ed25519_delinearized_partial_sign(l,g,s.length,p,d,h,e.length,_,f);var y=new Uint8Array(br.PARTIAL_SIGNATURE_SIZE);y.set(new Uint8Array(Module.HEAPU8.buffer,l,br.PARTIAL_SIGNATURE_SIZE));return y}catch(v){a.w(CryptoWorkerImpl,v);throw v}finally{c!==undefined&&Module.stackRestore(c)}}},{key:"signatureCreate",value:function signatureCreate(e,t,r){var n=new Uint8Array(br.SIGNATURE_SIZE),a=r.byteLength;if(a>this._messageBuffer.byteLength||t.byteLength!==br.PUBLIC_KEY_SIZE||e.byteLength!==br.PRIVATE_KEY_SIZE)throw Error("Wrong buffer size.");this._messageBuffer.set(r);this._pubKeyBuffer.set(t);this._privKeyBuffer.set(e);Module._ed25519_sign(this._signaturePointer,this._messagePointer,a,this._pubKeyPointer,this._privKeyPointer);this._privKeyBuffer.fill(0);n.set(this._signatureBuffer);return n}},{key:"signatureVerify",value:function signatureVerify(e,t,r){var n=t.byteLength;if(r.byteLength!==br.SIGNATURE_SIZE||t.byteLength>this._messageBuffer.byteLength||e.byteLength!==br.PUBLIC_KEY_SIZE)throw Error("Wrong buffer size.");this._signatureBuffer.set(r);this._messageBuffer.set(t);this._pubKeyBuffer.set(e);return!!Module._ed25519_verify(this._signaturePointer,this._messagePointer,n,this._pubKeyPointer)}},{key:"blockVerify",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee336(e,t,r,n){var a,i,s,o,u,c;return _regenerator2["default"].wrap(function _callee336$(l){for(;;)switch(l.prev=l.next){case 0:Se.GENESIS||(Se.GENESIS={HASH:U.unserialize(new T(n))});a=Se.unserialize(new T(e));for(i=0;i<t.length;i++)a.body.transactions[i]._valid=t[i];l.next=5;return a._verify(r);case 5:s=l.sent;l.next=8;return a.header.pow();case 8:o=l.sent;u=a.interlink.hash();c=a.body.hash();return l.abrupt("return",{valid:s,pow:o.serialize(),interlinkHash:u.serialize(),bodyHash:c.serialize()});case 12:case"end":return l.stop()}},_callee336,this)}));return function blockVerify(t,r,n,a){return e.apply(this,arguments)}}()}]);return CryptoWorkerImpl}(mr.Stub(br));mr.prepareForWorkerUse(br,new Cr);var wr=function(){function MinerWorker(){(0,_classCallCheck3["default"])(this,MinerWorker)}(0,_createClass3["default"])(MinerWorker,[{key:"multiMine",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee337(e,t,r,n){return _regenerator2["default"].wrap(function _callee337$(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},_callee337,this)}));return function multiMine(t,r,n,a){return e.apply(this,arguments)}}()}]);return MinerWorker}();r.register(wr);var Ar=function(e){(0,_inherits3["default"])(MinerWorkerImpl,e);function MinerWorkerImpl(){(0,_classCallCheck3["default"])(this,MinerWorkerImpl);var e=(0,_possibleConstructorReturn3["default"])(this,(MinerWorkerImpl.__proto__||(0,_getPrototypeOf2["default"])(MinerWorkerImpl)).call(this));e._superInit=(0,_get3["default"])(MinerWorkerImpl.prototype.__proto__||(0,_getPrototypeOf2["default"])(MinerWorkerImpl.prototype),"init",e);return e}(0,_createClass3["default"])(MinerWorkerImpl,[{key:"init",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee338(e){return _regenerator2["default"].wrap(function _callee338$(t){for(;;)switch(t.prev=t.next){case 0:t.next=2;return this._superInit.call(this,e);case 2:t.next=4;return this.importWasm("worker-wasm.wasm");case 4:if(!t.sent){t.next=9;break}t.next=7;return this.importScript("worker-wasm.js");case 7:t.next=11;break;case 9:t.next=11;return this.importScript("worker-js.js");case 11:case"end":return t.stop()}},_callee338,this)}));return function init(t){return e.apply(this,arguments)}}()},{key:"multiMine",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee339(e,t,r,n){var i,s,o,u;return _regenerator2["default"].wrap(function _callee339$(c){for(;;)switch(c.prev=c.next){case 0:i=new Uint8Array(32);s=void 0,o=void 0;c.prev=2;s=Module._malloc(i.length);o=Module._malloc(e.length);Module.HEAPU8.set(e,o);if((u=Module._nimiq_argon2_target(s,o,e.length,t,r,n,512))!==n){c.next=9;break}return c.abrupt("return",!1);case 9:i.set(new Uint8Array(Module.HEAPU8.buffer,s,i.length));return c.abrupt("return",{hash:i,nonce:u});case 13:c.prev=13;c.t0=c["catch"](2);a.w(MinerWorkerImpl,c.t0);throw c.t0;case 17:c.prev=17;s!==undefined&&Module._free(s);o!==undefined&&Module._free(o);return c.finish(17);case 21:case"end":return c.stop()}},_callee339,this,[[2,13,17,21]])}));return function multiMine(t,r,n,a){return e.apply(this,arguments)}}()}]);return MinerWorkerImpl}(mr.Stub(wr));mr.prepareForWorkerUse(wr,new Ar);var Sr=function(e){(0,_inherits3["default"])(MinerWorkerPool,e);function MinerWorkerPool(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;(0,_classCallCheck3["default"])(this,MinerWorkerPool);var t=(0,_possibleConstructorReturn3["default"])(this,(MinerWorkerPool.__proto__||(0,_getPrototypeOf2["default"])(MinerWorkerPool)).call(this,function(e){return mr.startWorkerForProxy(wr,e)},"miner",e));t._miningEnabled=!1;t._activeNonces=[];t._block=null;t._noncesPerRun=256;t._observable=new i;t._shareCompact=z.BLOCK_TARGET_MAX;t._runsPerCycle=Infinity;t._cycleWait=100;t._superUpdateToSize=(0,_get3["default"])(MinerWorkerPool.prototype.__proto__||(0,_getPrototypeOf2["default"])(MinerWorkerPool.prototype),"_updateToSize",t);if(M.isNodeJs()){var r=require(__dirname+"/nimiq_node");t.multiMine=function(e,t,n,a){var i=this;return new _promise2["default"](function(s,o){r.nimiq_argon2_target_async((u=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee340(t){var r;return _regenerator2["default"].wrap(function _callee340$(n){for(;;)switch(n.prev=n.next){case 0:n.prev=0;if(t!==a){n.next=5;break}s(!1);n.next=11;break;case 5:e.writePos-=4;e.writeUint32(t);n.next=9;return x.argon2d(e);case 9:r=n.sent;s({hash:r,nonce:t});case 11:n.next=16;break;case 13:n.prev=13;n.t0=n["catch"](0);o(n.t0);case 16:case"end":return n.stop()}},_callee340,i,[[0,13]])})),function(e){return u.apply(this,arguments)}),e,t,n,a,512);var u})}}return t}(0,_createClass3["default"])(MinerWorkerPool,[{key:"on",value:function on(e,t){this._observable.on(e,t)}},{key:"off",value:function off(e,t){this._observable.off(e,t)}},{key:"startMiningOnBlock",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee341(e){var t,r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:e.nBits;return _regenerator2["default"].wrap(function _callee341$(n){for(;;)switch(n.prev=n.next){case 0:this._block=e;this._shareCompact=r;if(this._miningEnabled){n.next=10;break}n.next=5;return this._updateToSize();case 5:this._activeNonces=[];this._miningEnabled=!0;for(t=0;t<this.poolSize;++t)this._startMiner();n.next=11;break;case 10:this._activeNonces=[{minNonce:0,maxNonce:0}];case 11:case"end":return n.stop()}},_callee341,this)}));return function startMiningOnBlock(t){return e.apply(this,arguments)}}()},{key:"stop",value:function stop(){this._miningEnabled=!1}},{key:"_updateToSize",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee342(){return _regenerator2["default"].wrap(function _callee342$(e){for(;;)switch(e.prev=e.next){case 0:if(M.isNodeJs()){e.next=3;break}e.next=3;return this._superUpdateToSize.call(this);case 3:for(;this._miningEnabled&&this._activeNonces.length<this.poolSize;)this._startMiner();case 4:case"end":return e.stop()}},_callee342,this)}));return function _updateToSize(){return e.apply(this,arguments)}}()},{key:"_startMiner",value:function _startMiner(){var e=0===this._activeNonces.length?0:Math.max.apply(null,this._activeNonces.map(function(e){return e.maxNonce})),t={minNonce:e,maxNonce:e+this._noncesPerRun};this._activeNonces.push(t);this._singleMiner(t)["catch"](function(e){return a.e(MinerWorkerPool,e)})}},{key:"_singleMiner",value:function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee343(e){var t,r,n,a,i,s,o=this;return _regenerator2["default"].wrap(function _callee343$(u){for(;;)switch(u.prev=u.next){case 0:t=0;case 1:if(!(this._miningEnabled&&(mr.areWorkersAsync||M.isNodeJs()||0===t)&&t<this._runsPerCycle)){u.next=19;break}t++;r=this._block;u.next=6;return this.multiMine(r.header.serialize(),this._shareCompact,e.minNonce,e.maxNonce);case 6:if(n=u.sent){a=new U(n.hash);this._observable.fire("share",{block:r,nonce:n.nonce,hash:a})}else this._observable.fire("no-share",{nonce:e.maxNonce});if(!(this._activeNonces.length>this.poolSize)){u.next=13;break}this._activeNonces.splice(this._activeNonces.indexOf(e),1);return u.abrupt("return");case 13:i=Math.max.apply(null,this._activeNonces.map(function(e){return e.maxNonce}));s={minNonce:i,maxNonce:i+this._noncesPerRun};this._activeNonces.splice(this._activeNonces.indexOf(e),1,s);e=s;case 17:u.next=1;break;case 19:this._miningEnabled&&setTimeout(function(){return o._singleMiner(e)},this._cycleWait);case 20:case"end":return u.stop()}},_callee343,this)}));return function _singleMiner(t){return e.apply(this,arguments)}}()},{key:"noncesPerRun",get:function get(){return this._noncesPerRun},set:function set(e){this._noncesPerRun=e}},{key:"runsPerCycle",get:function get(){return this._runsPerCycle},set:function set(e){this._runsPerCycle=e}},{key:"cycleWait",get:function get(){return this._cycleWait},set:function set(e){this._cycleWait=e}}]);return MinerWorkerPool}(mr.Pool(wr));r.register(Sr);e._loaded=!0;"function"==typeof e._onload&&e._onload()}(Nimiq);
//# sourceMappingURL=web-babel.js.map
